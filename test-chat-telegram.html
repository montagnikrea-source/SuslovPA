<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç —á–∞—Ç–∞ –∏ Telegram —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #0a0a0a;
      color: #00ff00;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { border-bottom: 2px solid #00ff00; padding-bottom: 10px; margin-bottom: 20px; }
    h2 { margin-top: 20px; margin-bottom: 10px; color: #00ffff; }
    .test-section { 
      background: #1a1a1a;
      border: 1px solid #00ff00;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
    }
    .status { 
      display: inline-block;
      padding: 5px 10px;
      margin: 5px 0;
      border-radius: 3px;
      font-weight: bold;
    }
    .status.success { background: #00ff00; color: #000; }
    .status.error { background: #ff0000; color: #fff; }
    .status.pending { background: #ffff00; color: #000; }
    .status.info { background: #00ffff; color: #000; }
    button { 
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px 5px 5px 0;
      border-radius: 3px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #00cc00; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    .log { 
      background: #000;
      border: 1px solid #00ff00;
      padding: 10px;
      margin: 10px 0;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      font-family: "Courier New", monospace;
    }
    .log-entry { margin: 3px 0; }
    .log-entry.success { color: #00ff00; }
    .log-entry.error { color: #ff0000; }
    .log-entry.warning { color: #ffff00; }
    .log-entry.info { color: #00ffff; }
    .iframe-container { 
      background: #1a1a1a;
      border: 1px solid #00ff00;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    iframe { 
      width: 100%;
      height: 600px;
      border: none;
      border-radius: 3px;
    }
    .checklist { padding-left: 20px; }
    .checklist li { margin: 5px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì± –¢–µ—Å—Ç —á–∞—Ç–∞ –∏ Telegram —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h1>
    
    <div class="test-section">
      <h2>1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–∞—Ç–∞</h2>
      <button onclick="checkChatStructure()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
      <button onclick="checkMessagesStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</button>
      <div id="chat-structure-log" class="log"></div>
    </div>

    <div class="test-section">
      <h2>2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h2>
      <button onclick="checkTelegramConfig()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥</button>
      <button onclick="checkProxyAvailability()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏</button>
      <button onclick="checkTelegramTokenStatus()">–°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞</button>
      <div id="telegram-config-log" class="log"></div>
    </div>

    <div class="test-section">
      <h2>3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h2>
      <button onclick="checkSyncStatus()">–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
      <button onclick="testLocalMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
      <button onclick="testTelegramMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
      <div id="sync-log" class="log"></div>
    </div>

    <div class="test-section">
      <h2>4Ô∏è‚É£ Live —á–∞—Ç –Ω–∞ —Å–∞–π—Ç–µ</h2>
      <div class="iframe-container">
        <iframe src="https://suslovpa.vercel.app/noninput.html#chat"></iframe>
      </div>
      <p>‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) –≤ iframe –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤</p>
    </div>

    <div class="test-section">
      <h2>üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫</h2>
      <ul class="checklist">
        <li>‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫</li>
        <li>‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage</li>
        <li>‚úÖ Telegram –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞</li>
        <li>‚úÖ –ü—Ä–æ–∫—Å–∏ API –¥–æ—Å—Ç—É–ø–µ–Ω</li>
        <li>‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è</li>
        <li>‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Telegram</li>
        <li>‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è</li>
      </ul>
    </div>
  </div>

  <script>
    function log(id, message, type = 'info') {
      const logEl = document.getElementById(id);
      if (!logEl) return;
      
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function checkChatStructure() {
      const id = 'chat-structure-log';
      document.getElementById(id).innerHTML = '';
      
      log(id, '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ...', 'info');
      
      try {
        const response = await fetch('https://suslovpa.vercel.app/noninput.html');
        const html = await response.text();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–∞—Ç–∞
        const checks = [
          { name: 'id="chatMessages"', pattern: /id="chatMessages"/ },
          { name: 'id="messageInput"', pattern: /id="messageInput"/ },
          { name: 'class="MultiUserChatSystem"', pattern: /class\s+MultiUserChatSystem/ },
          { name: 'sendMessage function', pattern: /sendMessage\s*\(/ },
          { name: 'loadTelegramMessages', pattern: /loadTelegramMessages/ },
        ];
        
        let passed = 0;
        for (const check of checks) {
          const found = check.pattern.test(html);
          log(id, `${found ? '‚úÖ' : '‚ùå'} ${check.name}`, found ? 'success' : 'error');
          if (found) passed++;
        }
        
        log(id, `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${passed}/${checks.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ`, 'info');
      } catch (e) {
        log(id, `‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      }
    }

    function checkMessagesStorage() {
      const id = 'chat-structure-log';
      log(id, '–ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage...', 'info');
      
      try {
        const messages = localStorage.getItem('multiUserChat_messages');
        const users = localStorage.getItem('multiUserChat_users');
        
        if (messages) {
          const count = JSON.parse(messages).length;
          log(id, `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${count} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ localStorage`, 'success');
        } else {
          log(id, '‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–π –≤ localStorage –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)', 'warning');
        }
        
        if (users) {
          log(id, `‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–π–¥–µ–Ω—ã`, 'success');
        }
      } catch (e) {
        log(id, `‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ localStorage: ${e.message}`, 'error');
      }
    }

    async function checkTelegramConfig() {
      const id = 'telegram-config-log';
      document.getElementById(id).innerHTML = '';
      
      log(id, '–ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...', 'info');
      
      try {
        const response = await fetch('https://suslovpa.vercel.app/noninput.html');
        const html = await response.text();
        
        const checks = [
          { name: 'TELEGRAM_BOT_TOKEN defined', pattern: /TELEGRAM_BOT_TOKEN/ },
          { name: 'telegramConfig', pattern: /telegramConfig\s*=\s*\{/ },
          { name: 'API –ø—Ä–æ–∫—Å–∏ URL', pattern: /\/api\/telegram/ },
          { name: 'sendTelegramRequest method', pattern: /sendTelegramRequest/ },
        ];
        
        let passed = 0;
        for (const check of checks) {
          const found = check.pattern.test(html);
          log(id, `${found ? '‚úÖ' : '‚ùå'} ${check.name}`, found ? 'success' : 'error');
          if (found) passed++;
        }
        
        log(id, `–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${passed}/${checks.length} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤`, 'info');
      } catch (e) {
        log(id, `‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      }
    }

    async function checkProxyAvailability() {
      const id = 'telegram-config-log';
      log(id, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∫—Å–∏ API...', 'pending');
      
      const proxyUrls = [
        'https://pavell.vercel.app/api/telegram',
        'https://suslovpa.vercel.app/api/telegram',
        'https://api.telegram.org',
      ];
      
      for (const url of proxyUrls) {
        try {
          const response = await fetch(url, { 
            method: 'HEAD', 
            mode: 'cors',
            timeout: 5000 
          }).catch(e => Promise.resolve(null));
          
          if (response && response.ok || response?.status === 405) {
            log(id, `‚úÖ –ü—Ä–æ–∫—Å–∏ –¥–æ—Å—Ç—É–ø–µ–Ω: ${url}`, 'success');
          } else if (response) {
            log(id, `‚ö†Ô∏è –ü—Ä–æ–∫—Å–∏ –æ—Ç–≤–µ—Ç–∏–ª (${response.status}): ${url}`, 'warning');
          } else {
            log(id, `‚ùå –ü—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${url}`, 'error');
          }
        } catch (e) {
          log(id, `‚ö†Ô∏è ${url} - CORS –∏–ª–∏ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞`, 'warning');
        }
      }
    }

    async function checkTelegramTokenStatus() {
      const id = 'telegram-config-log';
      log(id, '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞...', 'info');
      
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ù–ï –¥–æ–ª–∂–µ–Ω)
        if (typeof window.TELEGRAM_BOT_TOKEN !== 'undefined' && window.TELEGRAM_BOT_TOKEN) {
          log(id, '‚ùå –û–ü–ê–°–ù–û: –¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ window.TELEGRAM_BOT_TOKEN', 'error');
          log(id, '   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —Ç–æ–∫–µ–Ω–∞', 'warning');
        } else {
          log(id, '‚úÖ –¢–æ–∫–µ–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)', 'success');
          log(id, '‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã —Ç–æ–∫–µ–Ω–∞', 'success');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–∫—Å–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        const response = await fetch('https://suslovpa.vercel.app/noninput.html');
        const html = await response.text();
        
        if (html.includes('apiUrl:')) {
          log(id, '‚úÖ –ü—Ä–æ–∫—Å–∏ URL —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
        }
      } catch (e) {
        log(id, `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω: ${e.message}`, 'warning');
      }
    }

    async function checkSyncStatus() {
      const id = 'sync-log';
      document.getElementById(id).innerHTML = '';
      
      log(id, '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...', 'info');
      
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
        const messages = localStorage.getItem('multiUserChat_messages');
        const messageCount = messages ? JSON.parse(messages).length : 0;
        
        log(id, `üìä –õ–æ–∫–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}`, 'info');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const response = await fetch('https://suslovpa.vercel.app/noninput.html');
        const html = await response.text();
        
        if (html.includes('startTelegramPolling')) {
          log(id, '‚úÖ Polling Telegram —Å–æ–æ–±—â–µ–Ω–∏–π –≤–∫–ª—é—á–µ–Ω', 'success');
        }
        
        if (html.includes('loadTelegramMessages')) {
          log(id, '‚úÖ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'success');
        }
        
        log(id, '‚ÑπÔ∏è –û—Ç–∫—Ä–æ–π—Ç–µ https://suslovpa.vercel.app/noninput.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ', 'info');
        log(id, '‚ÑπÔ∏è –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ª–æ–≥–æ–≤', 'info');
      } catch (e) {
        log(id, `‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      }
    }

    function testLocalMessage() {
      const id = 'sync-log';
      log(id, '–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...', 'pending');
      
      try {
        const testMessage = {
          id: Date.now(),
          text: 'üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ' + new Date().toLocaleTimeString(),
          author: 'Tester',
          timestamp: new Date().toISOString(),
        };
        
        const messages = JSON.parse(localStorage.getItem('multiUserChat_messages') || '[]');
        messages.push(testMessage);
        localStorage.setItem('multiUserChat_messages', JSON.stringify(messages));
        
        log(id, `‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`, 'success');
        log(id, `üìù ${testMessage.text}`, 'info');
      } catch (e) {
        log(id, `‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      }
    }

    async function testTelegramMessage() {
      const id = 'sync-log';
      log(id, '–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram...', 'pending');
      
      try {
        const testMsg = `üß™ –¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${new Date().toLocaleTimeString()}`;
        
        // –ü—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
        const response = await fetch('https://pavell.vercel.app/api/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            method: 'sendMessage',
            params: {
              chat_id: '@noninput',
              text: testMsg
            }
          })
        }).catch(e => ({ ok: false, error: e.message }));
        
        if (response && response.ok) {
          log(id, '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏', 'success');
        } else {
          log(id, '‚ö†Ô∏è –ü—Ä–æ–∫—Å–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞)', 'warning');
          log(id, '‚ÑπÔ∏è –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –Ω—É–∂–µ–Ω –¥–µ–π—Å—Ç–≤—É—é—â–∏–π Telegram –±–æ—Ç —Ç–æ–∫–µ–Ω', 'info');
        }
      } catch (e) {
        log(id, `‚ö†Ô∏è ${e.message}`, 'warning');
        log(id, '‚ÑπÔ∏è –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏', 'info');
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      log('chat-structure-log', '‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
    });
  </script>
</body>
</html>
