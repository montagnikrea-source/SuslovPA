<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Frequency Scanner ‚Äî Neuro Homeostasis J‚Üí0 (with AdSense Auto Ads)</title>

  <!-- (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –£–∫–∞–∂–∏ –∞–∫–∫–∞—É–Ω—Ç AdSense –¥–ª—è –º–µ—Ç–∞-—Å–∫–∞–Ω–µ—Ä–æ–≤ -->
  <meta name="google-adsense-account" content="ca-pub-1128500581050725">

  <!-- ‚úÖ Google AdSense Auto Ads (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–ª–∞–º–∞) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1128500581050725"
          crossorigin="anonymous"></script>

  <!-- Firebase –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root { --bg:#f3f5f7; --panel:#fff; --muted:#556; --bar:#e8ebef; }
    html,body{margin:0;background:var(--bg);font:14px/1.45 system-ui,Segoe UI,Arial}
    .main-container{display:flex;gap:24px;max-width:1400px;margin:24px auto;padding:24px}
    .wrap{flex:1;padding:24px;background:var(--panel);border-radius:16px;box-shadow:0 2px 22px rgba(0,0,0,.07)}
    .chat-container{width:350px;background:var(--panel);border-radius:16px;box-shadow:0 2px 22px rgba(0,0,0,.07);padding:20px;display:flex;flex-direction:column;height:fit-content;position:sticky;top:24px}
    h1{margin:0 0 10px}
    #loading{margin:6px 0 12px}
    #loading .bg{height:18px;border-radius:8px;background:var(--bar);overflow:hidden}
    #loading .fill{height:100%;width:0%;background:linear-gradient(90deg,#0a7cff 60%,#69b7ff);transition:width .25s ease-out}
    #statusText{color:var(--muted);margin-top:6px}
    .row{margin-top:12px}
    .lbl{margin:10px 0 6px}
    .bar{height:18px;border-radius:8px;background:var(--bar);overflow:hidden}
    .f{height:100%;background:linear-gradient(90deg,#0a7cff 60%,#69b7ff);width:0%}
    .i{height:100%;background:linear-gradient(90deg,#18b56c 60%,#9ef0c5);width:0%}
    .c{height:100%;background:linear-gradient(90deg,#ff9800 60%,#ffd699);width:0%}
    #info{margin-top:14px;font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap;color:#222}
    .hint{color:#444;margin-top:8px}

    /* –†–µ–∑–µ—Ä–≤ –≤—ã—Å–æ—Ç—ã –ø–æ–¥ —Ä—É—á–Ω–æ–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫, —á—Ç–æ–±—ã –≤–µ—Ä—Å—Ç–∫–∞ –Ω–µ ¬´–ø—Ä—ã–≥–∞–ª–∞¬ª (–µ—Å–ª–∏ —Ä–µ—à–∏—à—å –≤–∫–ª—é—á–∏—Ç—å) */
    .ad-placeholder { min-height: 250px; display:block; text-align:center; margin:16px 0; background:transparent; }

    /* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ */
    .chat-header{text-align:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #e8ebef}
    .chat-header h3{margin:0;color:#333;font-size:18px}
    .chat-messages{height:400px;overflow-y:auto;border:1px solid #e8ebef;border-radius:8px;padding:12px;margin-bottom:16px;background:#fafbfc}
    .message{margin-bottom:12px;padding:8px 12px;border-radius:12px;max-width:85%;word-wrap:break-word}
    .message.user{background:#007bff;color:white;margin-left:auto}
    .message.other{background:#f1f3f5;color:#333}
    .message-meta{font-size:11px;opacity:0.7;margin-top:4px}
    .chat-input{display:flex;gap:8px}
    .chat-input input{flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .chat-input button{padding:10px 16px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;transition:background-color 0.3s}
    .chat-input button:hover{background:#0056b3}
    .chat-input button:disabled{background:#6c757d;cursor:wait;opacity:0.7}
    .chat-input button:disabled{background:#ccc;cursor:not-allowed}
    .message-count{text-align:center;color:#666;font-size:12px;margin-bottom:8px}
    .filter-notice{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:8px;border-radius:6px;font-size:12px;margin-bottom:12px}
    .online-count{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:8px;border-radius:6px;font-size:12px;margin-bottom:8px;text-align:center}
    .username-input{margin-bottom:12px}
    .username-input input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .message.system{background:#e2e3e5;color:#6c757d;font-style:italic;margin:5px auto;text-align:center;max-width:95%}

    @media (max-width: 1200px) {
      .main-container{flex-direction:column}
      .chat-container{width:100%;position:relative;top:0}
    }
    
    .nav-header {
      background: #f8f9fa;
      padding: 10px 0;
      margin-bottom: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .nav-header a {
      margin: 0 10px;
      color: #007bff;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .nav-header a:hover {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>
<div class="nav-header">
  <a href="../">üè† –ì–ª–∞–≤–Ω–∞—è</a>
  <a href="./">üìä Frequency Scanner</a>
  <a href="../about.html">üìñ –û –Ω–∞—Å</a>
  <a href="../contact.html">üìß –ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
  <a href="../privacy-policy.html">üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</a>
</div>

<div class="main-container">
<div class="wrap">
  <h1>Frequency Scanner ‚Äî Homeostatic Zero-Target (CPU-only, Neuro J‚Üí0)</h1>

  <div id="loading">
    <div class="bg"><div id="loadingBar" class="fill"></div></div>
    <div id="statusText">–ü–ª–∞–≤–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ‚Ä¶</div>
  </div>

  <div class="row">
    <div class="lbl">–ß–∞—Å—Ç–æ—Ç–∞ —Ñ–ª—É–∫—Ç—É–∞—Ü–∏–π (–ì—Ü): <span id="freqValue">0</span></div>
    <div class="bar"><div id="freqBar" class="f"></div></div>

    <div class="lbl">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (%): <span id="inertiaValue">0</span></div>
    <div class="bar"><div id="inertiaBar" class="i"></div></div>

    <div class="lbl">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <span id="confValue">0</span></div>
    <div class="bar"><div id="confBar" class="c"></div></div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç/—Ä—É—á–Ω. –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ–π—Ä–æ–æ–±—É—á–µ–Ω–∏—è -->
  <div class="row controls" style="margin-top:18px;padding:12px;border-radius:12px;background:#f7f9fb;border:1px solid #e7ecf2">
    <div class="lbl" style="margin-top:0">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è (–æ–Ω–ª–∞–π–Ω):</div>
    <div style="display:grid;grid-template-columns:180px 1fr 80px 84px;gap:8px;align-items:center">
      <div>Learning rate (lr)</div>
      <input id="lrSlider" type="range" min="0.001" max="0.2" step="0.001" value="0.030"/>
      <div><span id="lrVal">0.030</span></div>
      <label style="display:flex;gap:6px;align-items:center;white-space:nowrap"><input id="lrAuto" type="checkbox" checked/> AUTO</label>

      <div>L2-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è (l2)</div>
      <input id="l2Slider" type="range" min="0.0" max="0.01" step="0.0001" value="0.0001"/>
      <div><span id="l2Val">0.0001</span></div>
      <label style="display:flex;gap:6px;align-items:center;white-space:nowrap"><input id="l2Auto" type="checkbox" checked/> AUTO</label>

      <div>–°–º–µ—à–∏–≤–∞–Ω–∏–µ NN/PI (mix)</div>
      <input id="mixSlider" type="range" min="0.0" max="1.0" step="0.01" value="0.75"/>
      <div><span id="mixVal">0.75</span></div>
      <label style="display:flex;gap:6px;align-items:center;white-space:nowrap"><input id="mixAuto" type="checkbox" checked/> AUTO</label>
    </div>
    <div class="hint" style="margin-top:8px">AUTO ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏; —Å–Ω–∏–º–∏—Ç–µ —Ñ–ª–∞–∂–æ–∫, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Ä—É—á–Ω—É—é.</div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       –ù–ï–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô —Ä—É—á–Ω–æ–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫ (Responsive)
       –í–ù–ò–ú–ê–ù–ò–ï: –ß—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª, –∑–∞–º–µ–Ω–∏ data-ad-slot –Ω–∞ —Å–≤–æ–π –≤ –∫–∞–±–∏–Ω–µ—Ç–µ AdSense.
       –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Auto Ads ‚Äî –æ—Å—Ç–∞–≤—å —ç—Ç–æ—Ç –±–ª–æ–∫ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.
  <ins class="adsbygoogle ad-placeholder"
       data-ad-client="ca-pub-1128500581050725"
       data-ad-slot="REPLACE_WITH_YOUR_SLOT_ID_1"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

  <div id="info"></div>
  <div class="hint">–¶–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ ‚Äî J‚Üí0: |œÜ|, |Œîf|, Var(Œîf), |u|, (1‚àíconf), (1‚àíinertia) ‚Üí 0. –ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ —Å lock-–∑–∞—â–∏—Ç–æ–π –∏ –∞–≤—Ç–æ/—Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º lr/l2/mix.</div>
</div>

<!-- –ß–∞—Ç —Å –æ—Ç–∑—ã–≤–∞–º–∏ -->
<div class="chat-container">
  <div class="chat-header">
    <h3>üí¨ –û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
  </div>
  
  <div class="filter-notice">
    üõ°Ô∏è –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º
  </div>
  
  <div class="online-count" id="onlineCount">
    üë• –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º: <span id="connectionStatus">–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...</span>
  </div>
  
  <div class="username-input">
    <input type="text" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="20">
  </div>
  
  <div class="message-count">
    –°–æ–æ–±—â–µ–Ω–∏–π: <span id="messageCount">0</span>
  </div>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message system">
      <div>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç! –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ Frequency Scanner.</div>
      <div class="message-meta">–°–∏—Å—Ç–µ–º–∞ ‚Ä¢ —Å–µ–π—á–∞—Å</div>
    </div>
  </div>
  
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200">
    <button id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

</div>

<!-- ====== –û–ü–ò–°–ê–ù–ò–Ø (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å) ====== -->
<section id="how-it-works" style="max-width:960px;margin:24px auto;padding:18px 20px;background:#fff;border-radius:16px;box-shadow:0 2px 22px rgba(0,0,0,.07);font:14px/1.55 system-ui,Segoe UI,Arial">
  <h2 style="margin:0 0 12px">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
  <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑–º–µ—Ä—è–µ—Ç ¬´–º–∏–∫—Ä–æ–¥—Ä–æ–∂–∞–Ω–∏–µ¬ª CPU, –∏–∑–≤–ª–µ–∫–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—ã (Goertzel), —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–∑—É (Kalman) –∏ –æ–Ω–ª–∞–π–Ω–æ–≤–æ–π –º–∏–Ω–∏-–Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –ø–æ–¥–±–∏—Ä–∞–µ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, —Å—Ç—Ä–µ–º—è—Å—å –∫ <b>J‚Üí0</b>. –í—Å—Ç—Ä–æ–µ–Ω–∞ lock-–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.</p>
</section>

<section id="use-cases" style="max-width:960px;margin:24px auto;padding:18px 20px;background:#fff;border-radius:16px;box-shadow:0 2px 22px rgba(0,0,0,.07);font:14px/1.55 system-ui,Segoe UI,Arial">
  <h2 style="margin:0 0 12px">–ì–¥–µ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å</h2>
  <ul style="margin:6px 0 0 18px">
    <li>–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–æ–≤/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–º–µ–Ω—å—à–µ –¥–∂–∏—Ç—Ç–µ—Ä–∞ ‚Üí –º–µ–Ω—å—à–µ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–ø–ª–∞).</li>
    <li>–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞/–∏–≥—Ä—ã: —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∞–≥–æ–≤ –∏ –∞–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –∫ —Ç–∏–∫—Ä–µ–π—Ç—É.</li>
    <li>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞/–§–ê–ü–ß/–®–ò–ú: –æ–Ω–ª–∞–π–Ω-–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤.</li>
  </ul>
</section>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     –ù–ï–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô —Ä—É—á–Ω–æ–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Responsive)
     –ó–∞–º–µ–Ω–∏ data-ad-slot –Ω–∞ —Å–≤–æ–π. –î–ª—è Auto Ads —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ.
<ins class="adsbygoogle ad-placeholder"
     data-ad-client="ca-pub-1128500581050725"
     data-ad-slot="REPLACE_WITH_YOUR_SLOT_ID_2"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

<script>
/* ====================== CPU-—Å—ç–º–ø–ª–µ—Ä ====================== */

// –°–∏—Å—Ç–µ–º–∞ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ —Å Firebase
class MultiUserChatSystem {
  constructor() {
    this.messages = [];
    this.badWords = this.initBadWordsFilter();
    this.username = '';
    this.userId = this.generateUserId();
    this.onlineUsers = new Set();
    this.lastActivity = Date.now();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
    this.initFirebase();
    this.updateMessageCount();
  }

  initFirebase() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–ª–∞—á–Ω–æ–≥–æ —á–∞—Ç–∞');
    this.initCloudChat();
  }

  initCloudChat() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ - localStorage —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π localStorage —Å case-–∫–ª—é—á–æ–º –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    this.sharedKey = 'frequency_scanner_shared_chat';
    this.lastSyncTime = 0;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    this.loadSharedMessages();
    
    // –ò–º–∏—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    this.simulateMultiUserActivity();
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç
    this.pollInterval = setInterval(() => {
      this.checkForUpdates();
    }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    
    this.isLocalMode = false;
    this.updateConnectionStatus('–ø–æ–¥–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å)');
  }

  loadSharedMessages() {
    try {
      const sharedData = localStorage.getItem(this.sharedKey);
      if (sharedData) {
        const parsed = JSON.parse(sharedData);
        this.messages = parsed.messages || [];
        this.lastSyncTime = parsed.lastUpdate || 0;
      } else {
        this.messages = [];
        this.initializeSharedChat();
      }
      
      this.updateMessageCount();
      this.renderMessages();
      console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', this.messages.length);
    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      this.messages = [];
    }
  }

  initializeSharedChat() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    const welcomeMessages = [
      {
        id: 'welcome_1',
        text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç Frequency Scanner! üéâ',
        username: '–°–∏—Å—Ç–µ–º–∞',
        userId: 'system',
        timestamp: Date.now() - 10000,
        isCurrentUser: false,
        wasFiltered: false
      },
      {
        id: 'welcome_2', 
        text: '–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏ –¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º',
        username: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
        userId: 'moderator',
        timestamp: Date.now() - 5000,
        isCurrentUser: false,
        wasFiltered: false
      }
    ];
    
    this.messages = welcomeMessages;
    this.saveSharedMessages();
  }

  saveSharedMessages() {
    try {
      const sharedData = {
        messages: this.messages.slice(-100), // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        lastUpdate: Date.now(),
        userCount: this.getUserCount()
      };
      
      localStorage.setItem(this.sharedKey, JSON.stringify(sharedData));
      this.lastSyncTime = sharedData.lastUpdate;
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
      window.dispatchEvent(new StorageEvent('storage', {
        key: this.sharedKey,
        newValue: JSON.stringify(sharedData)
      }));
      
      console.log('–°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ');
      return true;
    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      return false;
    }
  }

  checkForUpdates() {
    try {
      const sharedData = localStorage.getItem(this.sharedKey);
      if (sharedData) {
        const parsed = JSON.parse(sharedData);
        
        if (parsed.lastUpdate > this.lastSyncTime) {
          // –ï—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
          
          const newMessages = parsed.messages || [];
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          newMessages.forEach(msg => {
            if (!this.messages.find(existing => existing.id === msg.id)) {
              this.messages.push({
                ...msg,
                isCurrentUser: msg.userId === this.userId
              });
            }
          });
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º
          this.messages.sort((a, b) => a.timestamp - b.timestamp);
          this.messages = this.messages.slice(-50);
          
          this.lastSyncTime = parsed.lastUpdate;
          this.updateMessageCount();
          this.renderMessages();
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
      this.showActiveUsers();
      
    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
    }
  }

  simulateMultiUserActivity() {
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç "–¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    const demoUsers = ['–ê–ª–µ–∫—Å–µ–π', '–ú–∞—Ä–∏—è', '–î–º–∏—Ç—Ä–∏–π', '–ê–Ω–Ω–∞', '–°–µ—Ä–≥–µ–π'];
    const demoMessages = [
      '–ß–∞—Å—Ç–æ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!',
      '–ö—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–æ–±–æ–≤–∞–ª –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ö–∞–ª–º–∞–Ω–∞?',
      '–ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å —Å—Ç–∞–±–∏–ª—å–Ω–æ üëç',
      '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ä–∞–±–æ—Ç–µ',
      '–•–æ—Ä–æ—à–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö!',
      '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ –∞–ª–≥–æ—Ä–∏—Ç–º –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –Ω–∞–≥—Ä—É–∑–∫–µ'
    ];

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è
    setTimeout(() => {
      if (Math.random() < 0.3) { // 30% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
        const randomUser = demoUsers[Math.floor(Math.random() * demoUsers.length)];
        const randomMessage = demoMessages[Math.floor(Math.random() * demoMessages.length)];
        
        this.addSimulatedMessage(randomMessage, randomUser);
      }
      
      // –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      this.simulateMultiUserActivity();
    }, Math.random() * 30000 + 15000); // –û—Ç 15 –¥–æ 45 —Å–µ–∫—É–Ω–¥
  }

  addSimulatedMessage(text, username) {
    const message = {
      id: 'sim_' + Date.now() + '_' + Math.random(),
      text: text,
      username: username,
      userId: 'simulated_' + username,
      timestamp: Date.now(),
      isCurrentUser: false,
      wasFiltered: false
    };

    this.messages.push(message);
    this.saveSharedMessages();
    this.updateMessageCount();
    this.renderMessages();
  }

  getUserCount() {
    // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    return Math.floor(Math.random() * 8) + 2; // –û—Ç 2 –¥–æ 9 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω
  showActiveUsers() {
    const userCountElement = document.getElementById('userCount');
    if (userCountElement) {
      const activeUsers = this.getUserCount();
      const lastActivity = localStorage.getItem('chatLastActivity');
      const now = Date.now();
      
      // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –Ω–µ–¥–∞–≤–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ 2 –º–∏–Ω—É—Ç), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const recentActivity = lastActivity && (now - parseInt(lastActivity)) < 120000;
      const displayCount = recentActivity ? Math.max(activeUsers, 3) : activeUsers;
      
      userCountElement.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: ${displayCount}`;
      userCountElement.style.color = displayCount > 2 ? '#4CAF50' : '#9e9e9e';
    }
  }
  
  // –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  simulateUserActivity() {
    localStorage.setItem('chatLastActivity', Date.now().toString());
    this.showActiveUsers();
  }

  fallbackToLocal() {
    // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
    this.isLocalMode = true;
    this.messages = this.loadLocalMessages();
    this.simulateOtherUsers();
    this.renderMessages();
    this.updateConnectionStatus('–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º');
  }

  updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    if (statusElement) {
      statusElement.textContent = status;
      
      // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
      const container = statusElement.closest('.online-count');
      if (container) {
        if (status.includes('–ø–æ–¥–∫–ª—é—á–µ–Ω') || status.includes('–æ–Ω–ª–∞–π–Ω')) {
          container.style.background = '#d4edda';
          container.style.borderColor = '#c3e6cb';
          container.style.color = '#155724';
        } else if (status.includes('–æ—à–∏–±–∫–∞') || status.includes('–ª–æ–∫–∞–ª—å–Ω—ã–π')) {
          container.style.background = '#f8d7da';
          container.style.borderColor = '#f5c6cb';
          container.style.color = '#721c24';
        } else {
          container.style.background = '#fff3cd';
          container.style.borderColor = '#ffeaa7';
          container.style.color = '#856404';
        }
      }
    }
  }

  simulateOtherUsers() {
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    const demoMessages = [
      { text: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ! üëç", username: "–ê–ª–µ–∫—Å–µ–π", timestamp: Date.now() - 300000 },
      { text: "–ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è", username: "–ú–∞—Ä–∏—è", timestamp: Date.now() - 180000 },
      { text: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ö–∞–ª–º–∞–Ω–∞ –∑–¥–µ—Å—å?", username: "–î–º–∏—Ç—Ä–∏–π", timestamp: Date.now() - 120000 }
    ];

    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
    if (this.messages.length === 0) {
      setTimeout(() => {
        demoMessages.forEach((msg, index) => {
          setTimeout(() => {
            this.addDemoMessage(msg.text, msg.username, msg.timestamp);
          }, index * 2000);
        });
      }, 3000);
    }
  }

  addDemoMessage(text, username, timestamp) {
    const message = {
      id: Date.now() + Math.random(),
      text: text,
      username: username,
      timestamp: timestamp,
      isCurrentUser: false,
      wasFiltered: false
    };
    this.messages.push(message);
    this.saveLocalMessages();
    this.updateMessageCount();
    this.renderMessages();
  }

  setupRealtimeListeners() {
    if (!this.database) return;

    // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    this.database.ref('chat/messages').on('child_added', (snapshot) => {
      const message = snapshot.val();
      if (message && message.userId !== this.userId) {
        this.addMessageToUI(message);
      }
    });

    // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    this.database.ref('chat/online').on('value', (snapshot) => {
      const online = snapshot.val() || {};
      this.updateOnlineCount(Object.keys(online).length);
    });
  }

  trackOnlineUsers() {
    if (!this.database) return;

    const userRef = this.database.ref(`chat/online/${this.userId}`);
    userRef.set({
      username: this.username || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π',
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
    userRef.onDisconnect().remove();

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      userRef.update({ timestamp: firebase.database.ServerValue.TIMESTAMP });
    }, 30000);
  }

  generateUserId() {
    return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  initBadWordsFilter() {
    return [
      // –†—É—Å—Å–∫–∏–π
      '–¥—É—Ä–∞–∫', '–∏–¥–∏–æ—Ç', '—Ç—É–ø–æ–π', '–¥–µ–±–∏–ª', '—É—Ä–æ–¥', '–≥–∞–¥', '–º—Ä–∞–∑—å', '—Å–≤–æ–ª–æ—á—å', '–ø–æ–¥–æ–Ω–æ–∫', '–≥–æ–≤–Ω–æ',
      '—Ö—Ä–µ–Ω—å', '—Ñ–∏–≥–Ω—è', '–±–ª–∏–Ω', '—á–µ—Ä—Ç', '–¥—å—è–≤–æ–ª', '—É–±–ª—é–¥–æ–∫', '—Å–∫–æ—Ç–∏–Ω–∞', '–∂–∏–≤–æ—Ç–Ω–æ–µ', '–∑–∞—Ä–∞–∑–∞',
      // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π  
      'stupid', 'idiot', 'fool', 'moron', 'jerk', 'ass', 'damn', 'shit', 'crap', 'hell',
      'dumb', 'loser', 'freak', 'retard', 'bitch', 'bastard', 'asshole', 'dickhead',
      // –î—Ä—É–≥–∏–µ —è–∑—ã–∫–∏...
      'tonto', 'idiota', 'est√∫pido', 'con', 'stupide', 'cr√©tin', 'dumm', 'scheisse'
    ];
  }

  filterMessage(text) {
    let filteredText = text.toLowerCase();
    let hasBlockedWord = false;

    for (const word of this.badWords) {
      const regex = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
      if (regex.test(filteredText)) {
        hasBlockedWord = true;
        filteredText = filteredText.replace(regex, '***');
      }
    }

    const suspiciousPatterns = [
      /(.)\1{4,}/g,
      /[!@#$%^&*]{3,}/g,
      /(.)(.)\1\2{2,}/g,
    ];

    for (const pattern of suspiciousPatterns) {
      if (pattern.test(text)) {
        hasBlockedWord = true;
        filteredText = filteredText.replace(pattern, '***');
      }
    }

    return {
      text: hasBlockedWord ? filteredText : text,
      wasFiltered: hasBlockedWord
    };
  }

  loadLocalMessages() {
    try {
      const saved = localStorage.getItem('multiUserChatMessages');
      return saved ? JSON.parse(saved) : [];
    } catch (e) {
      return [];
    }
  }

  saveLocalMessages() {
    try {
      localStorage.setItem('multiUserChatMessages', JSON.stringify(this.messages.slice(-50)));
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ localStorage');
    }
  }

  addMessage(text) {
    console.log('addMessage –≤—ã–∑–≤–∞–Ω–∞ —Å —Ç–µ–∫—Å—Ç–æ–º:', text); // –û—Ç–ª–∞–¥–∫–∞
    
    const filtered = this.filterMessage(text);
    const currentUsername = document.getElementById('usernameInput').value.trim() || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π';
    
    const message = {
      id: this.userId + '_' + Date.now() + '_' + Math.random(),
      text: filtered.text,
      username: currentUsername,
      userId: this.userId,
      timestamp: Date.now(),
      isCurrentUser: true,
      wasFiltered: filtered.wasFiltered
    };

    console.log('–°–æ–∑–¥–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message); // –û—Ç–ª–∞–¥–∫–∞

    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
    this.messages.push(message);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (!this.isLocalMode) {
      const success = this.saveSharedMessages();
      if (success) {
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º');
        this.updateConnectionStatus('–ø–æ–¥–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å)');
      } else {
        console.warn('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ');
        this.updateConnectionStatus('–æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    } else {
      this.saveLocalMessages();
    }

    this.addMessageToUI(message);

    console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∞—Å—Å–∏–≤, –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', this.messages.length); // –û—Ç–ª–∞–¥–∫–∞

    return filtered.wasFiltered;
  }

  addMessageToUI(message) {
    this.updateMessageCount();
    this.renderMessages();
  }

  updateMessageCount() {
    const countElement = document.getElementById('messageCount');
    if (countElement) {
      countElement.textContent = this.messages.length;
    }
  }

  updateOnlineCount(count) {
    const onlineElement = document.getElementById('onlineUsers');
    if (onlineElement) {
      onlineElement.textContent = Math.max(1, count);
    }
  }

  renderMessages() {
    const container = document.getElementById('chatMessages');
    if (!container) return;

    const systemMessage = container.querySelector('.message.system');
    container.innerHTML = '';
    
    if (systemMessage) {
      container.appendChild(systemMessage);
    }

    const recentMessages = this.messages.slice(-20);
    
    recentMessages.forEach(message => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.isCurrentUser ? 'user' : 'other'}`;
      
      const timeStr = new Date(message.timestamp).toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });

      let filteredIndicator = message.wasFiltered ? ' üõ°Ô∏è' : '';
      const username = message.username || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π';

      messageDiv.innerHTML = `
        <div>${this.escapeHtml(message.text)}</div>
        <div class="message-meta">${username} ‚Ä¢ ${timeStr}${filteredIndicator}</div>
      `;

      container.appendChild(messageDiv);
    });

    container.scrollTop = container.scrollHeight;
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞
let multiUserChat;

function sendMessage() {
  console.log('sendMessage –≤—ã–∑–≤–∞–Ω–∞'); // –û—Ç–ª–∞–¥–∫–∞
  
  const input = document.getElementById('messageInput');
  const button = document.getElementById('sendButton');
  
  if (!input) {
    console.error('–≠–ª–µ–º–µ–Ω—Ç messageInput –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  if (!multiUserChat) {
    console.error('multiUserChat –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    if (button) button.disabled = false;
    return;
  }

  const text = input.value.trim();
  console.log('–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:', text); // –û—Ç–ª–∞–¥–∫–∞
  
  if (!text) {
    console.log('–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
    return;
  }

  // –ë–ª–æ–∫–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
  if (button) {
    button.disabled = true;
    button.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  }
  input.disabled = true;

  try {
    const wasFiltered = multiUserChat.addMessage(text);

    if (wasFiltered) {
      setTimeout(() => {
        alert('‚ö†Ô∏è –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–ª–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –±—ã–ª–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ.');
      }, 100);
    }

    // –°–∏–º—É–ª–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    multiUserChat.simulateUserActivity();

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';
    console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
  }

  // –ë—ã—Å—Ç—Ä–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
  setTimeout(() => {
    if (button) {
      button.disabled = false;
      button.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }
    input.disabled = false;
    input.focus();
  }, 300); // –£–º–µ–Ω—å—à–∏–ª–∏ –≤—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç'); // –û—Ç–ª–∞–¥–∫–∞
  
  try {
    multiUserChat = new MultiUserChatSystem();
    console.log('–ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ'); // –û—Ç–ª–∞–¥–∫–∞
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    setTimeout(() => {
      if (multiUserChat && multiUserChat.showActiveUsers) {
        multiUserChat.showActiveUsers();
      }
    }, 1000);
    
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    window.addEventListener('storage', (e) => {
      if (e.key === multiUserChat.sharedKey && e.newValue) {
        console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ');
        multiUserChat.checkForUpdates();
      }
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞:', error);
  }

  // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
  const sendButton = document.getElementById('sendButton');
  if (sendButton) {
    sendButton.addEventListener('click', function() {
      console.log('–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞'); // –û—Ç–ª–∞–¥–∫–∞
      sendMessage();
    });
    console.log('–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–∞'); // –û—Ç–ª–∞–¥–∫–∞
  } else {
    console.error('–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        console.log('Enter –Ω–∞–∂–∞—Ç'); // –û—Ç–ª–∞–¥–∫–∞
        sendMessage();
      }
    });
    console.log('–ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–æ'); // –û—Ç–ª–∞–¥–∫–∞
  } else {
    console.error('–ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  }
});

class CpuJitterSampler {
  static RB_SIZE=16384; static MASK=CpuJitterSampler.RB_SIZE-1;
  constructor(){
    this.rb=new Float64Array(CpuJitterSampler.RB_SIZE);
    this.ts=new Float64Array(CpuJitterSampler.RB_SIZE);
    this.widx=0;
    this.target_ms=2.0; this.iters=800; this.iters_min=120; this.iters_max=150000;
    this.alpha=0.008; this.ema=0; this.rms=0;
    this.dynamic_n=64; this.actual_fs=500;
    this.sample_count=0; this.last_widx=0; this.last_check=performance.now(); this.stall_count=0;
    this._medBuf=new Float64Array(9); this._mi=0; this._mlen=0;
  }
  _kernel(n){let x=1.0001; for(let i=0;i<n;i++){x*=1.00000001; x/=1.000000009;}}
  _median9(x){const n=this._mlen<9?++this._mlen:9; this._medBuf[this._mi]=x; this._mi=(this._mi+1)%9; const t=Array.from(this._medBuf.slice(0,n)).sort((a,b)=>a-b); return t[(n>>1)];}
  sample(){
    const t0=performance.now(); this._kernel(this.iters);
    let dt=performance.now()-t0; dt=this._median9(dt);
    if(!this.ema) this.ema=dt; this.ema=(1-this.alpha)*this.ema+this.alpha*dt;
    const jitter=dt-this.ema; const idx=(this.widx++)&CpuJitterSampler.MASK;
    this.rb[idx]=jitter; this.ts[idx]=t0; this.sample_count++;
    this.rms=(1-this.alpha)*this.rms + this.alpha*jitter*jitter;
    if((this.sample_count & 0x7F)===0){
      const ratio=this.ema/Math.max(0.25,this.target_ms);
      const k=Math.max(0.65,Math.min(1.5,1/ratio));
      this.iters=Math.max(this.iters_min, Math.min(this.iters_max, Math.round(this.iters*k)));
      this.actual_fs=1000/Math.max(0.25,this.ema);
      this.dynamic_n=Math.max(48, Math.min(512, Math.ceil(0.30*this.actual_fs)));
    }
  }
  checkStall(){
    const now=performance.now();
    if(now-this.last_check>1000 && this.widx===this.last_widx){
      this.stall_count++;
      if(this.stall_count>2){
        this.iters=Math.max(this.iters_min,(this.iters/1.8)|0);
        this.target_ms=Math.min(6.0,this.target_ms*1.12);
        this.stall_count=0;
      }
      return true;
    }
    this.last_check=now; this.last_widx=this.widx; this.stall_count=0; return false;
  }
}

/* ======================= Goertzel ======================= */
class Goertzel{
  init(n,fs,f){this.N=n;const k=Math.floor(0.5+n*f/fs);const w=2*Math.PI*k/n;
    this.cw=Math.cos(w); this.sw=Math.sin(w); this.s1=0; this.s2=0;}
  push(x){const s=x+2*this.cw*this.s1 - this.s2; this.s2=this.s1; this.s1=s;}
  result(){const re=this.s1 - this.s2*this.cw, im=this.s2*this.sw;
    const mag=Math.hypot(re,im)/(this.N>1?(this.N/2):1); const ph=Math.atan2(im,re);
    return {mag, ph};
  }
}

/* ===================== OutputBlender ==================== */
class OutputBlender{
  constructor(){this.ready=false;this.ramp=0;this.last={f:0,conf:0,inertia:0,state:'SEARCHING'};}
  blend(cur,step=0.18){ if(!this.ready){this.last={...cur};this.ready=true;this.ramp=Math.min(1,this.ramp+step);return cur;}
    const a=Math.min(1,this.ramp+step);this.ramp=a; const mix=(p,q)=>p*(1-a)+q*a;
    const out={f:mix(this.last.f,cur.f),conf:mix(this.last.conf,cur.conf),inertia:mix(this.last.inertia,cur.inertia),state:cur.state};
    this.last=out; return out;
  }
  hold(step=0.08){ this.ramp=Math.min(1,this.ramp+step); return this.last; }
}

/* ======================== Kalman ======================== */
class Kalman{
  constructor(x0,v0,qpos,qvel){ this.qp=qpos; this.qv=qvel; this.reset(x0,v0); }
  reset(x,v){ this.x=x; this.v=v; this.p00=1; this.p01=0; this.p10=0; this.p11=1; }
  predict(dt){
    this.x += this.v*dt;
    this.p00 += dt*(this.p10+this.p01) + dt*dt*this.p11;
    this.p01 += dt*this.p11; this.p10 += dt*this.p11;
    this.p00 += this.qp; this.p11 += this.qv;
  }
  update(z,r){
    const y=z-this.x, s=this.p00+r; if(Math.abs(s)<1e-9) return;
    const k0=this.p00/s, k1=this.p10/s;
    this.x += k0*y; this.v += k1*y;
    const p00=this.p00, p01=this.p01;
    this.p00 -= k0*p00; this.p01 -= k0*p01;
    this.p10 -= k1*p00; this.p11 -= k1*p01;
  }
}

/* =================== –ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ (—Å lock) =================== */
class NeuroHomeo {
  constructor(){
    this.w_phi=1.0; this.w_df=0.8; this.w_var=0.9; this.w_u=0.7; this.w_c=0.9; this.w_i=0.7;
    this.a = 0.12;
    this.emaAbsPhi=0; this.emaAbsDf=0; this.emaVarDf=0; this.emaAbsU=0; this.emaOneMinConf=1; this.emaOneMinIner=1;

    const H=8; const D=9; this.H=H; this.D=D;
    this.W1=new Float64Array(H*D); this.b1=new Float64Array(H);
    this.W2=new Float64Array(H);     this.b2=0;
    const r1=Math.sqrt(2/(D)); for(let i=0;i<H*D;i++) this.W1[i]=(Math.random()*2-1)*r1;
    for(let i=0;i<H;i++) this.b1[i]=0;
    const r2=Math.sqrt(2/(H)); for(let i=0;i<H;i++) this.W2[i]=(Math.random()*2-1)*r2;
    this.b2=0;

    this.lr=0.03; this.l2=1e-4; this.mix=0.75; // –∞–≤—Ç–æ/—Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∏–∂–µ
    this.aggr=1.0; this.I=0; this.Imax=3.0; this.Kp=0.35; this.Ki=0.10;
    this.prevJ=null; this.prevAggr=null; this.eps=1e-6;
    this._x=new Float64Array(D); this._h=new Float64Array(H); this._h_lin=new Float64Array(H);

    // lock-–∑–∞—â–∏—Ç–∞
    this.locked=false; this.lockUntil=0; this.lockMs=3000;
    this.lrBase=this.lr; this.lrMin=0.003; this.lrRecoverMs=3000; this.lastUnlockTime=performance.now();
    this.snap=null;
    this.spikeJ=0.25; this.dropC=0.25;
  }
  snapshot(){ this.snap={ W1:new Float64Array(this.W1), b1:new Float64Array(this.b1), W2:new Float64Array(this.W2), b2:this.b2, aggr:this.aggr }; }
  restore(){ if(this.snap){ this.W1.set(this.snap.W1); this.b1.set(this.snap.b1); this.W2.set(this.snap.W2); this.b2=this.snap.b2; this.aggr=this.snap.aggr; } }

  _features({phi, df, u, conf, inertia, fs, peak}){
    const clip=(v,a,b)=>Math.max(a,Math.min(b,v));
    const mphi=clip(Math.abs(phi)/Math.PI, 0, 1);
    const mdf =clip(Math.abs(df)/50, 0, 1);
    const mu  =clip(Math.abs(u)/300, 0, 1);
    const mc  =clip(1-conf, 0, 1);
    const mi  =clip(1-inertia, 0, 1);
    const mfs =clip(fs/240, 0, 1);
    const mpk =clip(peak/2.5, 0, 1);
    const sDf =clip(Math.sqrt(Math.max(0,this.emaVarDf))/50, 0, 1);
    this._x.set([1, mphi, mdf, sDf, mu, mc, mi, mfs, mpk]);
    return this._x;
  }
  updateMetrics({phi, df, u, conf, inertia}){
    const a=this.a;
    this.emaAbsPhi = (1-a)*this.emaAbsPhi + a*Math.abs(phi);
    this.emaAbsDf  = (1-a)*this.emaAbsDf  + a*Math.abs(df);
    this.emaVarDf  = (1-a)*this.emaVarDf  + a*(df*df);
    this.emaAbsU   = (1-a)*this.emaAbsU   + a*Math.abs(u);
    this.emaOneMinConf = (1-a)*this.emaOneMinConf + a*(1 - Math.max(0,Math.min(1,conf)));
    this.emaOneMinIner = (1-a)*this.emaOneMinIner + a*(1 - Math.max(0,Math.min(1,inertia)));
  }
  cost(){
    const sigmaDf = Math.sqrt(Math.max(0, this.emaVarDf));
    return  this.w_phi*this.emaAbsPhi + this.w_df*this.emaAbsDf + this.w_var*sigmaDf
          + this.w_u*this.emaAbsU + this.w_c*this.emaOneMinConf + this.w_i*this.emaOneMinIner;
  }
  _forward(x){
    const H=this.H, D=this.D; const h=this._h, hl=this._h_lin;
    for(let i=0;i<H;i++){
      let s=this.b1[i]; const off=i*D; for(let j=0;j<D;j++) s+=this.W1[off+j]*x[j];
      hl[i]=s; h[i]=Math.tanh(s);
    }
    let y=this.b2; for(let i=0;i<H;i++) y+=this.W2[i]*h[i];
    const aggr = 0.5 + 1.5*(1/(1+Math.exp(-y)));
    return {y, aggr};
  }
  _backward(dJdy){
    const H=this.H, D=this.D, x=this._x, h=this._h, hl=this._h_lin;
    const dJdb2 = dJdy; for(let i=0;i<H;i++){ const dW2 = dJdy * h[i] + this.l2*this.W2[i]; this.W2[i] -= this.lr * dW2; }
    this.b2 -= this.lr * dJdb2;
    const dJdh = new Float64Array(H); for(let i=0;i<H;i++) dJdh[i] = dJdy * this.W2[i];
    for(let i=0;i<H;i++){
      const sech2 = 1 - Math.tanh(hl[i])**2; const g = dJdh[i]*sech2; const off=i*D;
      for(let j=0;j<D;j++){ const dW1 = g * x[j] + this.l2*this.W1[off+j]; this.W1[off+j] -= this.lr * dW1; }
      this.b1[i] -= this.lr * g;
    }
  }
  maybeLock(J, conf, inertia){
    const now=performance.now();
    if(this.prevJ==null){ this.snapshot(); return; }
    const relSpike = (J - this.prevJ) / Math.max(1e-6, Math.abs(this.prevJ));
    const poor = ((1-conf) > this.dropC) || ((1-inertia) > this.dropC);
    if(relSpike > this.spikeJ && poor){
      this.restore();
      this.locked = true; this.lockUntil = now + this.lockMs;
      this.lr = Math.max(this.lrMin, this.lrBase*0.25);
    }
    if(this.locked && now >= this.lockUntil){
      this.locked = false; this.lastUnlockTime = now;
    }
  }
  recoverLr(){
    if(this.locked) return;
    const t = Math.min(1, (performance.now() - this.lastUnlockTime)/this.lrRecoverMs);
    this.lr = this.lrBase*(0.25 + 0.75*t);
  }
  step(state){
    const {phi, df, u, conf, inertia, fs, peak} = state;
    const x = this._features({phi, df, u, conf, inertia, fs, peak});
    const {y, aggr:aggr_nn} = this._forward(x);

    const J = this.cost();
    this.maybeLock(J, conf, inertia);

    const e = -J; this.I = Math.max(-this.Imax, Math.min(this.Imax, this.I + this.Ki*e));
    let aggr_pi = this.aggr + this.Kp*e + this.I; aggr_pi = Math.max(0.5, Math.min(2.0, aggr_pi));

    let aggr;
    if(this.locked){ aggr = aggr_pi; }
    else {
      const noise = (Math.random()*2-1)*0.03;
      aggr = Math.max(0.5, Math.min(2.0, this.mix*aggr_nn + (1-this.mix)*aggr_pi + noise));
    }

    if(!this.locked && this.prevJ!==null && this.prevAggr!==null){
      const dJdaggr = (J - this.prevJ) / (aggr - this.prevAggr + this.eps);
      const sig = 1/(1+Math.exp(-y));
      const daggr_dy = 1.5*sig*(1-sig) + 1e-6;
      let dJdy = dJdaggr * daggr_dy; dJdy = Math.max(-5, Math.min(5, dJdy));
      this._backward(dJdy);
    }

    if(!this.locked) this.snapshot();
    this.recoverLr();

    this.prevJ = J; this.prevAggr = aggr; this.aggr = aggr;

    const snr = Math.max(0.05, Math.min(1.0, conf));
    const baseFrac = 0.035 + 0.025*snr; let bw = fs * baseFrac * aggr; bw = Math.max(1.5, Math.min(fs/3, bw));
    const zeta = 0.8 + 0.5*(1 - snr)*(2.0 - aggr)/1.5; const twoPiBw = 2*Math.PI*bw; const scale = 1/Math.max(40, fs);
    let kp = (2*zeta*twoPiBw) * scale; let kv = (twoPiBw*twoPiBw) * scale * 0.25; let ki = kp * 0.12 * (0.25 + 0.75*snr);
    const slew = 10 + 140 * snr * aggr; const eco = 0.88 + 0.12*snr; kp*=eco; kv*=eco; ki*=eco;
    return { J, aggr, kp:Math.max(1e-4,kp), kv:Math.max(1e-5,kv), ki:Math.max(1e-6,ki), slew };
  }
}

/* ====================== –ß–∞—Å—Ç–æ—Ç–Ω—ã–π —Å–∫–∞–Ω–µ—Ä ====================== */
class FrequencyScanner{
  constructor(s){
    this.s=s; this.kf=new Kalman(0,0,0.001,0.008);
    this.vco=0; this.phi=0; this.inertia=0; this.state='SEARCHING';

    this.r=0; this.N=this.s.dynamic_n;
    this.hopRatio = Math.min(0.4, Math.max(0.1, 0.9 / Math.sqrt((this.s.actual_fs||60)/60)));
    this.hop=Math.max(8, Math.floor(this.N*this.hopRatio));
    this.booted=false;

    this.win=new Float64Array(this.N);
    this.block=new Float64Array(this.N);
    this.tst=new Float64Array(this.N);
    this._needWin=true;

    this.fmax=50; this.fstep=0.1; this.maxPoints=240;

    this.phase_dead=0.02;
    this.f_ema=0;

    this.out_f=0; this.out_conf=0; this.out_inertia=0; this.out_state='SEARCHING';
    this.out_peak=0; this.dt=0; this.fs=0;

    this.u_int=0; this.u_int_max=3.0;
    this.lastUpdateMs=performance.now();

    this.kp=0.1; this.kv=0.01; this.ki=0.002; this.slew=40;

    this.tuner = new NeuroHomeo();
    this.lastDfApplied = 0;
  }

  _wrap(a){ return Math.atan2(Math.sin(a), Math.cos(a)); }
  _ensureWin(){ if(!this._needWin) return; const N=this.N; for(let n=0;n<N;n++) this.win[n]=0.5*(1-Math.cos(2*Math.PI*n/(N-1))); this._needWin=false; }
  _refresh(){
    if(this.N!==this.s.dynamic_n){
      this.N=this.s.dynamic_n;
      this.hopRatio = Math.min(0.4, Math.max(0.1, 0.9 / Math.sqrt((this.s.actual_fs||60)/60)));
      this.hop=Math.max(8, Math.floor(this.N*this.hopRatio));
      this.win=new Float64Array(this.N); this.block=new Float64Array(this.N); this.tst=new Float64Array(this.N);
      this._needWin=true;
    }
    this._ensureWin();
  }
  needCount(){ return this.booted ? this.hop : this.N; }
  _grab(){
    this._refresh();
    const need=this.needCount();
    const avail=(this.s.widx - this.r) & CpuJitterSampler.MASK;
    if(avail < need) return false;

    for(let i=0;i<this.N;i++){
      const idx=(this.r + i) & CpuJitterSampler.MASK;
      this.block[i]=this.s.rb[idx]*this.win[i];
      this.tst[i]=this.s.ts[idx];
    }
    const total=this.tst[this.N-1]-this.tst[0];
    this.dt=(total/1000)/Math.max(1,(this.N-1));
    this.fs=1.0/Math.max(1e-6,this.dt);

    this.r=(this.r+need) & CpuJitterSampler.MASK;
    this.booted=true;
    return true;
  }
  _evalAt(f){ const g=new Goertzel(); g.init(this.N,this.fs,Math.max(0,Math.min(this.fmax,f))); for(let i=0;i<this.N;i++) g.push(this.block[i]); return g.result(); }

  processOnce(){
    if(!this._grab()) return;

    this.fmax = Math.min(100, this.s.actual_fs/2);
    this.fstep= Math.max(0.02, this.fmax/260);

    let fmin=0, fmax=this.fmax, fstep=this.fstep;
    if(this.state==='TRACKING'){
      const span=0.10*this.fmax;
      fmin=Math.max(0, this.vco - span);
      fmax=Math.min(this.fmax, this.vco + span);
      fstep=Math.max(this.fstep/5, 0.01);
    }
    let steps=Math.floor((fmax-fmin)/fstep);
    if(steps>this.maxPoints) fstep=(fmax-fmin)/this.maxPoints;

    let bestF=this.vco, bestMag=-1, best=null, sumMag=0, cnt=0;
    for(let f=fmin; f<=fmax+1e-9; f+=fstep){
      const r=this._evalAt(f);
      sumMag+=r.mag; cnt++;
      if(r.mag>bestMag){bestMag=r.mag; bestF=f; best=r;}
    }
    const avgMag=cnt?(sumMag/cnt):0;
    const cur=best || this._evalAt(this.vco);

    let local=Number.EPSILON;
    for(let df=-2; df<=2; ++df) local += this._evalAt(this.vco + df*fstep).mag;
    const conf=Math.max(0, Math.min(1, (local>0 ? cur.mag/local : 0)));
    const peak=(avgMag>0)?(cur.mag/avgMag):0;
    this.out_peak=peak;

    if(conf>0.07 || peak>1.05) this.inertia += 0.40*(1 - this.inertia);
    else this.inertia *= 0.988;
    this.inertia=Math.max(0, Math.min(1, this.inertia));

    if(this.inertia<0.05 && this.state==='TRACKING') this.state='SEARCHING';
    else if(this.inertia>0.34 && this.state==='SEARCHING'){ this.state='TRACKING'; this.kf.reset(0,0); }

    if(this.state!=='TRACKING'){
      if(!this.f_ema) this.f_ema=bestF;
      const searchGain=Math.min(0.6, 0.08 + 0.52*Math.min(1,peak/1.2));
      this.f_ema=(1-searchGain)*this.f_ema + searchGain*bestF;
      this.vco=this.f_ema;
    }

    let ephi = this._wrap(cur.ph - this.phi);
    if(Math.abs(ephi) < this.phase_dead) ephi = 0;

    this.kf.predict(this.dt);
    const rMeas = 0.05 + (1 - conf)*3.0 + (1 - this.inertia)*10.0;
    this.kf.update(ephi, rMeas);
    const u = this.kf.x;

    const df_obs = bestF - this.vco;
    let u_ctrl = this.kp*u + this.kv*this.kf.v + this.u_int;

    // –∞–≤—Ç–æ/—Ä—É—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–±–µ—Ä—ë–º –∏–∑ UI)
    // –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ –ø–µ—Ä–µ–¥ processOnce()

    // —à–∞–≥ —Ç—é–Ω–µ—Ä–∞ (–¥–∞—ë—Ç –Ω–æ–≤—ã–µ kp/kv/ki/slew)
    const neu = this.tuner.step({
      phi:ephi, df:df_obs, u:u_ctrl, conf, inertia:this.inertia, fs:this.fs, peak
    });

    this.u_int += neu.ki * ephi * this.dt;
    const uMax=this.u_int_max * (0.8 + 1.2*conf);
    this.u_int=Math.max(-uMax, Math.min(uMax, this.u_int));

    u_ctrl = neu.kp*u + neu.kv*this.kf.v + this.u_int;

    const now=performance.now();
    const dtMs=Math.max(1, now - this.lastUpdateMs);
    this.lastUpdateMs = now;
    const maxStep = neu.slew * (dtMs/1000);

    const df_applied = Math.max(-maxStep, Math.min(maxStep, u_ctrl));
    if(df_applied !== u_ctrl) this.u_int *= 0.95;
    this.lastDfApplied = df_applied;

    this.vco = Math.max(0, Math.min(this.fmax, this.vco + df_applied));
    this.phi = this._wrap(this.phi + 2*Math.PI*this.vco*this.dt);

    this.kp=neu.kp; this.kv=neu.kv; this.ki=neu.ki; this.slew=neu.slew;

    this.out_f=this.vco; this.out_conf=conf; this.out_inertia=this.inertia; this.out_state=this.state;
  }
}

/* ============================ UI ============================ */
document.addEventListener('DOMContentLoaded',()=>{
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤—ã—à–µ)
  
  const s=new CpuJitterSampler();
  const scan=new FrequencyScanner(s);
  const blender=new OutputBlender();

  // –ú—è–≥–∫–∞—è —Ñ–æ–Ω–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (CPU worker)
  let worker=null;
  try{
    const code=`let it=900,tick=12;
onmessage=e=>{it=e.data.it||it;tick=e.data.dt||tick;};
function step(){let x=1.0001;for(let i=0;i<it;i++){x*=1.00000001;x/=1.000000009;} setTimeout(()=>postMessage(1),tick);}
setInterval(step,12);`;
    worker=new Worker(URL.createObjectURL(new Blob([code],{type:'application/javascript'})));
    worker.onmessage=()=>{};
  }catch(_){}

  const $=id=>document.getElementById(id);
  const setT=(id,v)=>{const el=$(id); if(el) el.textContent=v;};
  const setW=(id,p)=>{const el=$(id); if(el) el.style.width=Math.max(0,Math.min(100,p)).toFixed(0)+'%';};

  // === –°–ª–∞–π–¥–µ—Ä—ã –∏ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º—ã ===
  const lrSlider=$('lrSlider');
  const l2Slider=$('l2Slider');
  const mixSlider=$('mixSlider');
  const lrVal=$('lrVal'); const l2Val=$('l2Val'); const mixVal=$('mixVal');
  const lrAuto=$('lrAuto'); const l2Auto=$('l2Auto'); const mixAuto=$('mixAuto');

  // –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –∞–≤—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const AUTO = { lrMin:0.005, lrMax:0.080, l2Min:0.00005, l2Max:0.0030, mixMin:0.30, mixMax:0.95 };

  function weightsNorm2(t){
    let ssum=0; for(let i=0;i<t.W1.length;i++) ssum+=t.W1[i]*t.W1[i];
    for(let i=0;i<t.W2.length;i++) ssum+=t.W2[i]*t.W2[i];
    return Math.sqrt(ssum/(t.W1.length+t.W2.length));
  }

  function render(out){
    const fmax=Math.max(1, scan.fmax);
    setT('freqValue', out.f.toFixed(2)); setW('freqBar', 100*out.f/fmax);
    setT('inertiaValue', (out.inertia*100).toFixed(0)); setW('inertiaBar', out.inertia*100);
    setT('confValue', out.conf.toFixed(2)); setW('confBar', out.conf*100);

    setT('info',
      `–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${out.state} | f=${out.f.toFixed(3)} –ì—Ü | `+
      `–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: ${(out.inertia*100).toFixed(0)}% | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${out.conf.toFixed(2)} | `+
      `fs: ${s.actual_fs.toFixed(1)} –ì—Ü | N: ${s.dynamic_n} (hop=${scan.hop}) | `+
      `kp=${scan.kp.toFixed(4)} kv=${scan.kv.toFixed(5)} ki=${scan.ki.toFixed(5)}`
    );
  }

  function emulateLoad(it){ let x=1.0001; for(let i=0;i<it;i++){ x*=1.00000001; x/=1.000000009; } }

  function loop(){
    try{
      const needCnt=scan.needCount();
      const avail=((s.widx - scan.r) & CpuJitterSampler.MASK);
      const need = (avail < needCnt);

      if(need){
        for(let i=0;i<180;i++) s.sample();
        if(!worker) emulateLoad(450);
        const fill=Math.min(100, (avail/Math.max(1,needCnt))*100);
        setW('loadingBar', fill);
        setT('statusText', `–ü–ª–∞–≤–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ‚Ä¶ (${fill.toFixed(0)}%)`);
        render(blender.hold());
        return setTimeout(loop, 80);
      }

      // === AUTO/Manual –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —à–∞–≥–æ–º ===
      const confPrev = scan.out_conf || 0;
      const inerPrev = scan.out_inertia || 0;
      const peakPrev = scan.out_peak || 0;
      const Jprev    = scan.tuner.prevJ;

      // lr
      if(lrAuto && lrAuto.checked){
        let trend = 0; if(Jprev!=null && scan.tuner._lastJforAuto!=null){ trend = (scan.tuner._lastJforAuto - Jprev); }
        scan.tuner._lastJforAuto = Jprev==null ? 0 : Jprev;
        const stability = Math.min(1, Math.max(0, 0.5*confPrev + 0.5*inerPrev));
        const speedBias = (trend>0 ? 0.2 : (trend<0 ? -0.2 : 0));
        let lrAutoVal = AUTO.lrMin + (AUTO.lrMax-AUTO.lrMin)*(0.65*stability + 0.35*Math.max(0,peakPrev/2.0)) + speedBias*(AUTO.lrMax-AUTO.lrMin)*0.25;
        if(scan.tuner.locked) lrAutoVal = Math.max(AUTO.lrMin, lrAutoVal*0.3);
        lrAutoVal = Math.min(AUTO.lrMax, Math.max(AUTO.lrMin, lrAutoVal));
        scan.tuner.lrBase = lrAutoVal;
        lrSlider.value = lrAutoVal.toFixed(3);
        lrVal.textContent = lrAutoVal.toFixed(3) + ' (auto)';
      } else {
        scan.tuner.lrBase = parseFloat(lrSlider.value);
        lrVal.textContent = parseFloat(lrSlider.value).toFixed(3);
      }

      // l2
      if(l2Auto && l2Auto.checked){
        const wnorm = weightsNorm2(scan.tuner);
        const poor  = (1-confPrev)+(1-inerPrev);
        let l2AutoVal = AUTO.l2Min + (AUTO.l2Max-AUTO.l2Min)*(0.6*poor + 0.4*Math.min(1, wnorm/0.8));
        if(scan.tuner.locked) l2AutoVal = Math.min(AUTO.l2Max, l2AutoVal*1.4);
        l2AutoVal = Math.min(AUTO.l2Max, Math.max(AUTO.l2Min, l2AutoVal));
        scan.tuner.l2 = l2AutoVal;
        l2Slider.value = l2AutoVal.toFixed(4);
        l2Val.textContent = l2AutoVal.toFixed(4) + ' (auto)';
      } else {
        scan.tuner.l2 = parseFloat(l2Slider.value);
        l2Val.textContent = parseFloat(l2Slider.value).toFixed(4);
      }

      // mix
      if(mixAuto && mixAuto.checked){
        const stability = Math.min(1, Math.max(0, 0.5*confPrev + 0.5*inerPrev));
        let mixAutoVal = 0.30 + (0.95-0.30)*stability;
        if(scan.tuner.locked) mixAutoVal = Math.max(0.30, mixAutoVal*0.6);
        mixAutoVal = Math.min(0.95, Math.max(0.30, mixAutoVal));
        scan.tuner.mix = mixAutoVal;
        mixSlider.value = mixAutoVal.toFixed(2);
        mixVal.textContent = mixAutoVal.toFixed(2) + ' (auto)';
      } else {
        scan.tuner.mix = parseFloat(mixSlider.value);
        mixVal.textContent = parseFloat(mixSlider.value).toFixed(2);
      }

      // –û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥
      scan.processOnce();

      // –∞–≤—Ç–æ-–Ω–∞–≥—Ä—É–∑–∫–∞ CPU –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–π —á–∞—Å—Ç–æ—Ç—ã —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è
      const peak=scan.out_peak||0;
      if(worker){
        const base=700;
        const extra=Math.max(0, Math.min(8000, Math.round((1.0 - Math.min(1, peak/1.2))*6000)));
        worker.postMessage({it: base+extra, dt:12});
      }

      if(s.actual_fs < 45) setT('statusText','–ù–∏–∑–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è (<45 –ì—Ü). –î–æ–±–∞–≤—å—Ç–µ –ª—ë–≥–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.');
      else setT('statusText','–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è‚Ä¶ (neuro-homeostasis J‚Üí0)');

      render(blender.blend({ f:scan.out_f, conf:scan.out_conf, inertia:scan.out_inertia, state:scan.out_state }));
      setTimeout(loop, 160);
    }catch(e){
      setT('info', `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.`);
      console.error(e);
      setTimeout(loop, 700);
    }
  }
  loop();
});
</script>

</body>
</html>
