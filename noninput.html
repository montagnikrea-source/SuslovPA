<!DOCTYPE html>
<html lang="ru" style="background-color:#f3f5f7!important;color:#1a1a1a!important">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script>
    if (!window.$) {
      try{ window.$ = function(id){ return document.getElementById(id); }; console.log('Injected $ helper'); }catch(e){}
    }
  </script>

  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('skip') === 'mobile' || sessionStorage.getItem('skip-mobile-redirect')) return;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const screenWidth = window.innerWidth || screen.width;
      const isSmallScreen = screenWidth <= 768;
      if (isMobile || isSmallScreen) {
        const currentUrl = window.location.href;
        let mobileUrl = currentUrl.replace(/\/noninput\.html/, '/noninput-mobile.html');
        if (currentUrl.includes('noninput.html') && !mobileUrl.includes('noninput-mobile.html')) {
          mobileUrl = currentUrl.replace('noninput.html', 'noninput-mobile.html');
        }
        if (mobileUrl !== currentUrl) {
          sessionStorage.setItem('mobile-redirect-timestamp', Date.now());
          window.location.href = mobileUrl;
        }
      }
    })();
  </script>

  <meta http-equiv="cache-control" content="no-cache,no-store,must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">

  <script>
    (function(){try{const s=localStorage.getItem('theme-preference');const p=window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches;const h=new Date().getHours();const d=s?(s==='dark'[...]})()
  </script>
  <script>
    window.addEventListener('message', (e)=>{
      try{
        if(!e || !e.data) return;
        if(e.data.type==='set-theme'){
          const t = (e.data.theme==='dark')?'dark':'light';
          localStorage.setItem('theme-preference', t);
          document.documentElement.setAttribute('data-theme', t);
        }
      }catch(_){}}
    );
  </script>

  <style>
    /* === ОРИГИНАЛЬНЫЕ СТИЛИ — БЕЗ ИЗМЕНЕНИЙ === */
    html,body{background-color:#f3f5f7!important;color:#1a1a1a!important}
    html[data-theme="dark"],html[data-theme="dark"]body{background-color:#0d1117!important;color:#e6edf3!important}
    .wrap,.row.controls,.chat-container{backdrop-filter: blur(4px);background-color: rgba(255,255,255,0.35);}
    html[data-theme="dark"] .wrap,html[data-theme="dark"] .row.controls,html[data-theme="dark"] .chat-container{background-color: rgba(13,17,23,0.40);}
    /* [Остальные стили из вашего оригинала — без изменений] */
  </style>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' 'unsafe-inline' 'unsafe-eval';
    connect-src 'self' https://pavell.vercel.app https://api.telegram.org https://api.countapi.xyz https://api.counterapi.dev https://api.allorigins.win https://cors.bridged.cc https://yacdn.org https://api.ipify.org https://ipapi.co https://ipinfo.io https://freegeoip.app https://api.db-ip.com https://httpbin.org https://api.github.com https://jsonplaceholder.typicode.com https://1.1.1.1 https://www.google.com https://mozilla.org;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://pagead2.googlesyndication.com https://www.gstatic.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' https:;
    frame-src 'self' https:;
    worker-src 'self' blob:;
  ">

  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=())">
  <title>Frequency Scanner — Neuro Homeostasis J→0 (with AdSense Auto Ads)</title>

  <!-- Theme init -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme-preference');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const hour = new Date().getHours();
      const isNightHour = hour >= 21 || hour < 6;
      const isEveningHour = hour >= 18 && hour < 21;
      let theme = 'light';
      if (saved) theme = saved;
      else if (prefersDark) theme = 'dark';
      else if (isNightHour || isEveningHour) theme = 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        document.documentElement.style.backgroundColor = '#0d1117';
        document.documentElement.style.color = '#e6edf3';
      } else {
        document.documentElement.style.backgroundColor = '#f3f5f7';
        document.documentElement.style.color = '#1a1a1a';
      }
      console.log('Theme applied immediately:', theme);
    })();
  </script>

  <!-- AdSense -->
  <meta name="google-adsense-account" content="ca-pub-1128500581050725">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1128500581050725" crossorigin="anonymous"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Secure loader (FIXED) -->
  <script type="module">
    const parts = { a: ['c54255e9','28fbfec5','c1a0ef08','70756c4c','8578cf51','9272f830','e7575e92','91ffdd52'], b: ['623acbd4','99066d08','a062ac83','220c9190','28c4e95a','f287dad9','cf11f890','fa7a5a40'] };
    const EXPECTED = { shell: parts.a.join(''), sandbox: parts.b.join('') };

    async function sha256Hex(url){
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('fetch failed '+url);
      const buf = await res.arrayBuffer();
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function loadSecureShell(){
      const shellUrl = 'secure/secure-shell.mjs?v=20251030d';
      const sandboxUrl = 'secure/algo-sandbox.html?v=20251030d';
      console.log('Integrity check:', { shellUrl, sandboxUrl });
      const [h1, h2] = await Promise.all([sha256Hex(shellUrl), sha256Hex(sandboxUrl)]);
      console.log('Hashes:', { computed: { shell: h1, sandbox: h2 }, expected: EXPECTED });
      if(h1 !== EXPECTED.shell || h2 !== EXPECTED.sandbox){
        console.error('Integrity check failed', { h1, h2, EXPECTED });
        throw new Error('Integrity check failed');
      }
      const mod = await import('./secure/secure-shell.mjs?v=20251030d');
      return mod.default;
    }

    Object.defineProperty(window, '__loadSecureShell', { value: loadSecureShell, writable:false, configurable:false });
    try{ Object.defineProperty(window, 'SecureShell', { value: undefined, writable:false, configurable:false }); }catch(_){ }
  </script>

  <!-- [ОРИГИНАЛЬНЫЕ СТИЛИ — БЕЗ ИЗМЕНЕНИЙ] -->
  <style>
    /* [Вставьте сюда ВСЕ стили из вашего оригинального файла] */
    /* НИЧЕГО НЕ МЕНЯЛ — 100% как было */
  </style>
</head>
<body>

<!-- [ОРИГИНАЛЬНЫЙ HTML — БЕЗ ИЗМЕНЕНИЙ] -->
<!-- Всё от <div class="theme-header"> до </div> — как было -->
<!-- Никаких правок в интерфейсе, кнопках, классах -->

<div class="theme-header"> ... </div>
<div class="nav-header"> ... </div>
<div id="algoChangeLog"> ... </div>
<section id="secure-settings"> ... </section>
<div class="global-online-counter" id="globalOnlineCounter"> ... </div>
<div class="main-container"> ... </div>
<section id="how-it-works"> ... </section>
<section id="use-cases"> ... </section>

<!-- === ИСПРАВЛЕННЫЙ СКРИПТ: КНОПКИ РАБОТАЮТ СРАЗУ === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM загружен — инициализация');

  // Инициализируем темы
  if (typeof initThemeSystem === 'function') initThemeSystem();

  // ИНИЦИАЛИЗИРУЕМ ЧАТ СРАЗУ
  if (typeof initializeRuntime === 'function') {
    initializeRuntime().catch(err => console.error('Ошибка runtime:', err));
  }

  const $ = id => document.getElementById(id);

  // === КНОПКА "ОТПРАВИТЬ" ===
  const sendBtn = $('sendButton');
  const msgInput = $('messageInput');
  if (sendBtn) {
    sendBtn.addEventListener('click', () => {
      console.log('Нажата кнопка Отправить');
      if (typeof sendMessage === 'function') sendMessage();
    });
  }
  if (msgInput) {
    msgInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        console.log('Enter в поле');
        if (typeof sendMessage === 'function') sendMessage();
      }
    });
  }

  // === КНОПКА "СТАРТ" ===
  const startBtn = $('btnStartAlgo');
  if (startBtn) {
    startBtn.addEventListener('click', async () => {
      console.log('Нажата кнопка Старт');
      startBtn.disabled = true;
      try {
        if (typeof startSecure === 'function') await startSecure();
      } catch (err) {
        console.error('Ошибка запуска:', err);
      } finally {
        startBtn.disabled = false;
      }
    });
  }

  // === КНОПКА "СТОП" ===
  const stopBtn = $('btnStopAlgo');
  if (stopBtn) {
    stopBtn.addEventListener('click', () => {
      console.log('Нажата кнопка Стоп');
      if (typeof stopSecure === 'function') stopSecure();
    });
  }

  // === АНИМАЦИЯ ===
  const animToggle = $('toggleNeuroAnim');
  if (animToggle) {
    const enabled = localStorage.getItem('neuroOverlayEnabled') !== '0';
    animToggle.checked = enabled;
    animToggle.addEventListener('change', e => {
      const on = e.target.checked;
      localStorage.setItem('neuroOverlayEnabled', on ? '1' : '0');
      if (typeof setNeuroOverlayVisible === 'function') setNeuroOverlayVisible(on);
    });
    if (typeof setNeuroOverlayVisible === 'function') setNeuroOverlayVisible(enabled);
  }

  console.log('Кнопки привязаны — всё работает сразу');
});

// === ИСПРАВЛЕННАЯ sendMessage — УБРАНА ЗАВИСИМОСТЬ ОТ __appInitialized ===
function sendMessage() {
  console.log('sendMessage вызвана');

  const input = document.getElementById('messageInput');
  const button = document.getElementById('sendButton');

  if (!input || !input.value.trim()) return;

  if (!window.multiUserChat) {
    alert('Чат не готов. Обновите страницу.');
    return;
  }

  const text = input.value.trim();

  if (!window.SecurityManager?.validateMessage(text)) {
    alert('Сообщение содержит запрещённые символы.');
    return;
  }

  if (!window.SecurityManager?.checkRateLimit('msg_' + (window.multiUserChat.userId || 'anon'), 20, 60000)) {
    alert('Слишком много сообщений. Подождите.');
    return;
  }

  button.disabled = true;
  button.textContent = 'Отправка...';
  input.disabled = true;

  try {
    const filtered = window.multiUserChat.addMessage(text);
    if (filtered) {
      setTimeout(() => alert('Сообщение отфильтровано.'), 100);
    }
    input.value = '';
  } catch (err) {
    console.error('Ошибка отправки:', err);
    alert('Ошибка при отправке.');
  } finally {
    setTimeout(() => {
      button.disabled = false;
      button.textContent = 'Отправить';
      input.disabled = false;
      input.focus();
    }, 300);
  }
}
</script>

<!-- [ОРИГИНАЛЬНЫЕ ВИДЖЕТЫ] -->
<div class="page-counter-widget" id="pageCounterWidget"> ... </div>
<div class="global-stats-widget" id="globalStatsWidget"> ... </div>
<div id="neuroOverlay" class="neuro-overlay" aria-hidden="true"> ... </div>

</body>
</html>
