<!DOCTYPE html>
<html lang="ru" style="background-color:#f3f5f7!important;color:#1a1a1a!important">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- DOM helper $ -->
  <script>
    if (!window.$) {
      try{ window.$ = function(id){ return document.getElementById(id); }; console.log('Injected $ helper'); }catch(e){}
    }
  </script>

  <!-- Mobile Redirect -->
  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('skip') === 'mobile' || sessionStorage.getItem('skip-mobile-redirect')) return;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const screenWidth = window.innerWidth || screen.width;
      const isSmallScreen = screenWidth <= 768;
      if (isMobile || isSmallScreen) {
        const currentUrl = window.location.href;
        let mobileUrl = currentUrl.replace(/\/noninput\.html/, '/noninput-mobile.html');
        if (currentUrl.includes('noninput.html') && !mobileUrl.includes('noninput-mobile.html')) {
          mobileUrl = currentUrl.replace('noninput.html', 'noninput-mobile.html');
        }
        if (mobileUrl !== currentUrl) {
          sessionStorage.setItem('mobile-redirect-timestamp', Date.now());
          window.location.href = mobileUrl;
        }
      }
    })();
  </script>

  <meta http-equiv="cache-control" content="no-cache,no-store,must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">

  <!-- ИСПРАВЛЕНО: Полный скрипт темы -->
  <script>
    (function(){
      try {
        const s = localStorage.getItem('theme-preference');
        const p = window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches;
        const h = new Date().getHours();
        const d = s ? (s === 'dark') : p ? 'dark' : (h >= 21 || h < 6) ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', d);
        console.log('Theme preference loaded:', d);
      } catch(e) { console.warn('Theme load error:', e); }
    })();
  </script>

  <script>
    window.addEventListener('message', (e) => {
      try {
        if (!e || !e.data) return;
        if (e.data.type === 'set-theme') {
          const t = (e.data.theme === 'dark') ? 'dark' : 'light';
          localStorage.setItem('theme-preference', t);
          document.documentElement.setAttribute('data-theme', t);
        }
      } catch(_) {}
    });
  </script>

  <style>
    /* [ВСЕ ВАШИ ОРИГИНАЛЬНЫЕ СТИЛИ — БЕЗ ИЗМЕНЕНИЙ] */
    html,body{background-color:#f3f5f7!important;color:#1a1a1a!important}
    html[data-theme="dark"],html[data-theme="dark"]body{background-color:#0d1117!important;color:#e6edf3!important}
    .wrap,.row.controls,.chat-container{backdrop-filter: blur(4px);background-color: rgba(255,255,255,0.35);}
    html[data-theme="dark"] .wrap,html[data-theme="dark"] .row.controls,html[data-theme="dark"] .chat-container{background-color: rgba(13,17,23,0.40);}
    /* ... (все остальные стили из вашего файла) ... */
    /* ===== СВЕТЛАЯ ТЕМА (по умолчанию) ===== */
    :root {
      --bg: #f3f5f7; --bg-secondary: #e8ebef; --panel: #ffffff; --panel-hover: #f8f9fa;
      --text: #1a1a1a; --text-secondary: #666666; --text-muted: #999999;
      --border: #e0e0e0; --border-light: #e8ebef;
      --shadow: rgba(0, 0, 0, 0.07); --shadow-lg: rgba(0, 0, 0, 0.12);
      --primary: #0a7cff; --primary-light: #69b7ff; --success: #18b56c; --success-light: #9ef0c5;
      --warning: #ff9800; --warning-light: #ffd699; --info: #007bff; --info-dark: #0056b3; --danger: #dc3545;
      --chat-user-bg: #007bff; --chat-user-text: #ffffff;
      --chat-other-bg: #f1f3f5; --chat-other-text: #333333;
      --chat-system-bg: #e2e3e5; --chat-system-text: #6c757d;
      --transition: all 0.3s ease;
    }
    html[data-theme="dark"] {
      --bg: #0d1117; --bg-secondary: #161b22; --panel: #1a1f26; --panel-hover: #21262d;
      --text: #e6edf3; --text-secondary: #a0a8b8; --text-muted: #8b949e;
      --border: #30363d; --border-light: #21262d;
      --shadow: rgba(0,0,0,0.3); --shadow-lg: rgba(0,0,0,0.5);
      --primary: #58a6ff; --primary-light: #79c0ff; --success: #3fb950; --success-light: #56d364;
      --warning: #ffa657; --warning-light: #ffb563; --info: #58a6ff; --info-dark: #1f6feb; --danger: #f85149;
      --chat-user-bg: #1f6feb; --chat-user-text: #ffffff;
      --chat-other-bg: #21262d; --chat-other-text: #e6edf3;
      --chat-system-bg: #262c36; --chat-system-text: #8b949e;
    }
    /* [Остальные стили — как у вас] */
    .start-btn{background:linear-gradient(90deg,#7F5AF0,#2CB67D);border:none;color:#fff;font-weight:700;letter-spacing:0.2px;box-shadow:0 10px 24px rgba(127,90,240,0.28),0 6px 16px rgba(44,182,125,0.18);transition:transform .15s ease,box-shadow .15s ease,filter .15s ease}
    .start-btn:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(127,90,240,0.36),0 8px 18px rgba(44,182,125,0.22);filter:saturate(1.05)}
    .neuro-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);backdrop-filter:blur(4px);display:none;z-index:2000;pointer-events:none}
    .neuro-overlay.visible{display:block;animation:overlayFade 200ms ease-out}
    @keyframes overlayFade{from{opacity:0}to{opacity:1}}
    /* ... и т.д. */
  </style>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://pavell.vercel.app https://api.telegram.org https://api.countapi.xyz https://api.counterapi.dev https://api.allorigins.win https://cors.bridged.cc https://yacdn.org https://api.ipify.org https://ipapi.co https://ipinfo.io https://freegeoip.app https://api.db-ip.com https://httpbin.org https://api.github.com https://jsonplaceholder.typicode.com https://1.1.1.1 https://www.google.com https://mozilla.org; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://pagead2.googlesyndication.com https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; frame-src 'self' https:; worker-src 'self' blob:;">

  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <!-- УДАЛЕНО: X-Frame-Options (только через HTTP) -->
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=())">

  <title>Frequency Scanner — Neuro Homeostasis J→0 (with AdSense Auto Ads)</title>

  <!-- Theme inline -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme-preference');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const hour = new Date().getHours();
      const isNightHour = hour >= 21 || hour < 6;
      const isEveningHour = hour >= 18 && hour < 21;
      let theme = 'light';
      if (saved) theme = saved;
      else if (prefersDark) theme = 'dark';
      else if (isNightHour || isEveningHour) theme = 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        document.documentElement.style.backgroundColor = '#0d1117';
        document.documentElement.style.color = '#e6edf3';
      } else {
        document.documentElement.style.backgroundColor = '#f3f5f7';
        document.documentElement.style.color = '#1a1a1a';
      }
      console.log('Theme applied immediately (inline):', theme);
    })();
  </script>

  <!-- Favicon 404 — ИСПРАВЛЕНО: Прозрачный 1x1 пиксель -->
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">

  <!-- AdSense -->
  <meta name="google-adsense-account" content="ca-pub-1128500581050725">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1128500581050725" crossorigin="anonymous"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Secure loader (v=20251030d) -->
  <script type="module">
    const parts = { a: ['c54255e9','28fbfec5','c1a0ef08','70756c4c','8578cf51','9272f830','e7575e92','91ffdd52'], b: ['623acbd4','99066d08','a062ac83','220c9190','28c4e95a','f287dad9','cf11f890','fa7a5a40'] };
    const EXPECTED = { shell: parts.a.join(''), sandbox: parts.b.join('') };

    async function sha256Hex(url){
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('fetch failed '+url);
      const buf = await res.arrayBuffer();
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function loadSecureShell(){
      const shellUrl = 'secure/secure-shell.mjs?v=20251030d';
      const sandboxUrl = 'secure/algo-sandbox.html?v=20251030d';
      console.log('Integrity check:', { shellUrl, sandboxUrl });
      const [h1, h2] = await Promise.all([sha256Hex(shellUrl), sha256Hex(sandboxUrl)]);
      console.log('Hashes:', { computed: { shell: h1, sandbox: h2 }, expected: EXPECTED });
      if(h1 !== EXPECTED.shell || h2 !== EXPECTED.sandbox){
        console.error('Integrity check failed', { h1, h2, EXPECTED });
        throw new Error('Integrity check failed');
      }
      const mod = await import('./secure/secure-shell.mjs?v=20251030d');
      return mod.default;
    }

    Object.defineProperty(window, '__loadSecureShell', { value: loadSecureShell, writable:false, configurable:false });
    try{ Object.defineProperty(window, 'SecureShell', { value: undefined, writable:false, configurable:false }); }catch(_){ }
  </script>
</head>
<body>

<!-- [ВАШ ОРИГИНАЛЬНЫЙ HTML — БЕЗ ИЗМЕНЕНИЙ] -->
<div class="theme-header"> ... </div>
<div class="nav-header"> ... </div>
<div id="algoChangeLog"> ... </div>
<section id="secure-settings"> ... </section>
<div class="global-online-counter" id="globalOnlineCounter"> ... </div>
<div class="main-container"> ... </div>
<section id="how-it-works"> ... </section>
<section id="use-cases"> ... </section>

<!-- === ИСПРАВЛЕННЫЙ СКРИПТ: КНОПКИ + ФУНКЦИИ === -->
<script>
'use strict';
window.escapeHtml = function(text) {
  if (typeof text !== 'string') return text;
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text.replace(/[&<>"']/g, m => map[m]);
};

const checkLocalStorage = () => {
  try {
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.match(/script|eval|function|constructor/gi)) {
        console.warn('Suspicious key in localStorage:', key);
        localStorage.removeItem(key);
      }
    });
  } catch(e) { console.warn('Cannot check localStorage'); }
};
checkLocalStorage();

// === ИСПРАВЛЕНО: Функция анимации ===
function setNeuroOverlayVisible(visible) {
  const overlay = document.getElementById('neuroOverlay');
  if (!overlay) return;
  overlay.classList.toggle('visible', visible);
  if (visible) {
    overlay.style.display = 'block';
  } else {
    setTimeout(() => { if (!overlay.classList.contains('visible')) overlay.style.display = 'none'; }, 200);
  }
}

// === ИСПРАВЛЕНО: Заглушки для startSecure / stopSecure (если их нет) ===
window.startSecure = window.startSecure || async function() {
  console.warn('startSecure не реализован — заглушка');
  const status = $('startStatus');
  if (status) status.textContent = 'Запуск...';
  await new Promise(r => setTimeout(r, 1000));
  if (status) status.textContent = 'Запущено (заглушка)';
};

window.stopSecure = window.stopSecure || function() {
  console.warn('stopSecure не реализован — заглушка');
  const status = $('startStatus');
  if (status) status.textContent = 'Остановлено';
};

document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM загружен — инициализация интерфейса');

  if (typeof initThemeSystem === 'function') initThemeSystem();
  if (typeof initializeRuntime === 'function') {
    initializeRuntime().catch(err => console.error('Ошибка runtime:', err));
  }

  const $ = id => document.getElementById(id);

  // Кнопка "Отправить"
  const sendButton = $('sendButton');
  const messageInput = $('messageInput');
  if (sendButton) {
    sendButton.addEventListener('click', () => {
      console.log('Кнопка Отправить нажата');
      sendMessage();
    });
  }
  if (messageInput) {
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        console.log('Enter в поле');
        sendMessage();
      }
    });
  }

  // Кнопка "Старт"
  const startBtn = $('btnStartAlgo');
  if (startBtn) {
    startBtn.addEventListener('click', async () => {
      console.log('Кнопка Старт нажата');
      startBtn.disabled = true;
      try {
        await startSecure();
      } catch (err) {
        console.error('Ошибка запуска алгоритма:', err);
      } finally {
        startBtn.disabled = false;
      }
    });
  }

  // Кнопка "Стоп"
  const stopBtn = $('btnStopAlgo');
  if (stopBtn) {
    stopBtn.addEventListener('click', () => {
      console.log('Кнопка Стоп нажата');
      stopSecure();
    });
  }

  // Анимация
  const animToggle = $('toggleNeuroAnim');
  if (animToggle) {
    const enabled = localStorage.getItem('neuroOverlayEnabled') !== '0';
    animToggle.checked = enabled;
    animToggle.addEventListener('change', e => {
      const on = e.target.checked;
      localStorage.setItem('neuroOverlayEnabled', on ? '1' : '0');
      setNeuroOverlayVisible(on);
    });
    setNeuroOverlayVisible(enabled);
  }

  console.log('Все кнопки привязаны — работают сразу');
});

function sendMessage() {
  console.log('sendMessage вызвана');
  const input = document.getElementById('messageInput');
  const button = document.getElementById('sendButton');
  if (!input || !input.value.trim()) return;
  if (!window.multiUserChat) {
    alert('Чат не инициализирован. Обновите страницу.');
    return;
  }
  const text = input.value.trim();
  if (!window.SecurityManager?.validateMessage(text)) {
    alert('Сообщение содержит запрещённые символы.');
    return;
  }
  if (!window.SecurityManager?.checkRateLimit('msg_' + (window.multiUserChat.userId || 'anon'), 20, 60000)) {
    alert('Слишком много сообщений. Подождите.');
    return;
  }
  button.disabled = true; button.textContent = 'Отправка...'; input.disabled = true;
  try {
    const filtered = window.multiUserChat.addMessage(text);
    if (filtered) setTimeout(() => alert('Сообщение отфильтровано.'), 100);
    input.value = '';
  } catch (err) {
    console.error('Ошибка отправки:', err);
    alert('Ошибка при отправке.');
  } finally {
    setTimeout(() => {
      button.disabled = false; button.textContent = 'Отправить'; input.disabled = false; input.focus();
    }, 300);
  }
}
</script>

<!-- Виджеты -->
<div class="page-counter-widget" id="pageCounterWidget"> ... </div>
<div class="global-stats-widget" id="globalStatsWidget"> ... </div>
<div id="neuroOverlay" class="neuro-overlay" aria-hidden="true"> ... </div>
</body>
</html>
