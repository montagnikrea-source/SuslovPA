<!DOCTYPE html>
<html lang="ru" style="background-color:#f3f5f7!important;color:#1a1a1a!important">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- DOM helper $ -->
  <script>
    if (!window.$) {
      try{ window.$ = function(id){ return document.getElementById(id); }; console.log('Injected $ helper'); }catch(e){}
    }
  </script>

  <!-- Mobile Redirect -->
  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('skip') === 'mobile' || sessionStorage.getItem('skip-mobile-redirect')) return;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const screenWidth = window.innerWidth || screen.width;
      const isSmallScreen = screenWidth <= 768;
      if (isMobile || isSmallScreen) {
        const currentUrl = window.location.href;
        let mobileUrl = currentUrl.replace(/\/noninput\.html/, '/noninput-mobile.html');
        if (currentUrl.includes('noninput.html') && !mobileUrl.includes('noninput-mobile.html')) {
          mobileUrl = currentUrl.replace('noninput.html', 'noninput-mobile.html');
        }
        if (mobileUrl !== currentUrl) {
          sessionStorage.setItem('mobile-redirect-timestamp', Date.now());
          window.location.href = mobileUrl;
        }
      }
    })();
  </script>

  <meta http-equiv="cache-control" content="no-cache,no-store,must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">

  <!-- Theme init -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme-preference');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const hour = new Date().getHours();
      const isNightHour = hour >= 21 || hour < 6;
      const isEveningHour = hour >= 18 && hour < 21;
      let theme = 'light';
      if (saved) theme = saved;
      else if (prefersDark) theme = 'dark';
      else if (isNightHour || isEveningHour) theme = 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.style.backgroundColor = theme === 'dark' ? '#0d1117' : '#f3f5f7';
      document.documentElement.style.color = theme === 'dark' ? '#e6edf3' : '#1a1a1a';
      console.log('Theme applied:', theme);
    })();
  </script>

  <style>
    /* === БАЗОВЫЕ ЦВЕТА === */
    html,body{background-color:#f3f5f7!important;color:#1a1a1a!important}
    html[data-theme="dark"],html[data-theme="dark"]body{background-color:#0d1117!important;color:#e6edf3!important}
    .wrap,.row.controls,.chat-container{
      backdrop-filter: blur(4px);
      background-color: rgba(255,255,255,0.35);
    }
    html[data-theme="dark"] .wrap,
    html[data-theme="dark"] .row.controls,
    html[data-theme="dark"] .chat-container{
      background-color: rgba(13,17,23,0.40);
    }

    /* === CSS ПЕРЕМЕННЫЕ === */
    :root {
      --bg: #f3f5f7; --bg-secondary: #e8ebef; --panel: #ffffff; --panel-hover: #f8f9fa;
      --text: #1a1a1a; --text-secondary: #666666; --text-muted: #999999;
      --border: #e0e0e0; --border-light: #e8ebef;
      --shadow: rgba(0,0,0,0.07); --shadow-lg: rgba(0,0,0,0.12);
      --primary: #0a7cff; --primary-light: #69b7ff; --success: #18b56c; --success-light: #9ef0c5;
      --warning: #ff9800; --warning-light: #ffd699; --info: #007bff; --info-dark: #0056b3; --danger: #dc3545;
      --chat-user-bg: #007bff; --chat-user-text: #ffffff;
      --chat-other-bg: #f1f3f5; --chat-other-text: #333333;
      --chat-system-bg: #e2e3e5; --chat-system-text: #6c757d;
      --transition: all 0.3s ease;
    }
    html[data-theme="dark"] {
      --bg: #0d1117; --bg-secondary: #161b22; --panel: #1a1f26; --panel-hover: #21262d;
      --text: #e6edf3; --text-secondary: #a0a8b8; --text-muted: #8b949e;
      --border: #30363d; --border-light: #21262d;
      --shadow: rgba(0,0,0,0.3); --shadow-lg: rgba(0,0,0,0.5);
      --primary: #58a6ff; --primary-light: #79c0ff; --success: #3fb950; --success-light: #56d364;
      --warning: #ffa657; --warning-light: #ffb563; --info: #58a6ff; --info-dark: #1f6feb; --danger: #f85149;
      --chat-user-bg: #1f6feb; --chat-user-text: #ffffff;
      --chat-other-bg: #21262d; --chat-other-text: #e6edf3;
      --chat-system-bg: #262c36; --chat-system-text: #8b949e;
    }

    /* === СТИЛИ ИНТЕРФЕЙСА === */
    * { transition: var(--transition); }
    html, body { margin: 0; font: 14px/1.45 system-ui, Segoe UI, Arial; }
    .theme-header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px var(--shadow); position: sticky; top: 0; z-index: 1000; }
    .theme-header h2 { margin: 0; font-size: 18px; color: var(--text); }
    .theme-controls { display: flex; gap: 12px; align-items: center; }
    .theme-toggle { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 6px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--text); font-size: 14px; }
    .theme-toggle:hover { background: var(--panel-hover); border-color: var(--primary); }
    .theme-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--primary); animation: pulse-indicator 2s infinite; }
    @keyframes pulse-indicator { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    .time-display { font-size: 13px; color: var(--text-secondary); padding: 0 8px; }

    .main-container { display: flex; gap: 24px; max-width: 1400px; margin: 24px auto; padding: 24px; }
    .wrap { flex: 1; padding: 24px; background: transparent; border-radius: 16px; box-shadow: 0 2px 22px var(--shadow); border: 1px solid var(--border-light); }
    .chat-container { width: 350px; background: transparent; border-radius: 16px; box-shadow: 0 2px 22px var(--shadow); padding: 20px; display: flex; flex-direction: column; height: fit-content; position: sticky; top: 80px; border: 1px solid var(--border-light); }

    h1 { margin: 0 0 10px; color: var(--text); }
    #loading .bg { height: 18px; border-radius: 8px; background: var(--bg-secondary); overflow: hidden; border: 1px solid var(--border); }
    #loading .fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary) 60%, var(--primary-light)); transition: width 0.25s ease-out; }
    #statusText { color: var(--text-secondary); margin-top: 6px; }

    .row.controls { margin-top: 18px; padding: 12px; border-radius: 12px; background: var(--bg-secondary); border: 1px solid var(--border); }
    .lbl { margin: 10px 0 6px; color: var(--text-secondary); }
    .bar { height: 18px; border-radius: 8px; background: var(--bg-secondary); overflow: hidden; border: 1px solid var(--border); }
    .f { height: 100%; background: linear-gradient(90deg, var(--primary) 60%, var(--primary-light)); width: 0%; }
    .i { height: 100%; background: linear-gradient(90deg, var(--success) 60%, var(--success-light)); width: 0%; }
    .c { height: 100%; background: linear-gradient(90deg, var(--warning) 60%, var(--warning-light)); width: 0%; }

    #info { margin-top: 14px; font-family: ui-monospace, Consolas, monospace; white-space: pre-wrap; color: var(--text); background: transparent; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }

    .chat-header { text-align: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border-light); }
    .chat-header h3 { margin: 0; color: var(--text); font-size: 18px; }
    .online-counter { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 8px 12px; background: linear-gradient(135deg, var(--success-light), var(--primary-light)); border-radius: 8px; border-left: 4px solid var(--success); }
    html[data-theme="dark"] .online-counter { background: linear-gradient(135deg, rgba(63,185,80,0.2), rgba(88,166,255,0.2)); border-left-color: var(--success); }
    .online-users { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text); }
    .online-indicator { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

    .chat-messages { height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px; background: rgba(255,255,255,0.25); }
    html[data-theme="dark"] .chat-messages { background: rgba(13,17,23,0.25); }
    .message { margin-bottom: 12px; padding: 8px 12px; border-radius: 12px; max-width: 85%; word-wrap: break-word; }
    .message.user { background: var(--chat-user-bg); color: var(--chat-user-text); margin-left: auto; box-shadow: 0 2px 8px rgba(7,123,255,0.2); }
    .message.other { background: var(--chat-other-bg); color: var(--chat-other-text); border: 1px solid var(--border); }
    .message.system { background: var(--chat-system-bg); color: var(--chat-system-text); font-style: italic; margin: 5px auto; text-align: center; max-width: 95%; border: 1px solid var(--border); }
    .message-meta { font-size: 11px; opacity: 0.7; margin-top: 4px; }

    .chat-input { display: flex; gap: 8px; }
    .chat-input input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: var(--bg); color: var(--text); }
    .chat-input input::placeholder { color: var(--text-muted); }
    .chat-input button { padding: 10px 16px; background: var(--info); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .chat-input button:hover { background: var(--info-dark); box-shadow: 0 4px 12px rgba(0,123,255,0.3); }
    .chat-input button:disabled { background: var(--text-muted); cursor: not-allowed; opacity: 0.5; }

    .global-online-counter { background: linear-gradient(135deg, var(--success), var(--primary)); color: white; padding: 8px 15px; margin: 10px auto; border-radius: 25px; text-align: center; max-width: 300px; box-shadow: 0 2px 10px rgba(40,167,69,0.3); font-size: 14px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .global-online-pulse { width: 10px; height: 10px; background: #ffffff; border-radius: 50%; animation: globalPulse 2s infinite; }
    @keyframes globalPulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

    .start-btn { background: linear-gradient(90deg,#7F5AF0,#2CB67D); border: none; color: #fff; font-weight: 700; letter-spacing: 0.2px; box-shadow: 0 10px 24px rgba(127,90,240,0.28),0 6px 16px rgba(44,182,125,0.18); transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
    .start-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(127,90,240,0.36),0 8px 18px rgba(44,182,125,0.22); filter: saturate(1.05); }
    .start-btn:active { transform: translateY(0); box-shadow: 0 6px 14px rgba(127,90,240,0.25),0 4px 10px rgba(44,182,125,0.18); }

    .neuro-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); backdrop-filter: blur(4px); display: none; z-index: 2000; pointer-events: none; }
    .neuro-overlay.visible { display: block; animation: overlayFade 200ms ease-out; }
    @keyframes overlayFade { from { opacity: 0; } to { opacity: 1; } }
    .neuro-scene { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .neuro-svg { width: min(1100px,96vw); height: auto; filter: hue-rotate(0deg); animation: rainbowShift 6s linear infinite; }
    @keyframes rainbowShift { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); } }
    .neuro-path { stroke: url(#rg); stroke-width: 3; fill: none; stroke-dasharray: 9 14; animation: pathFlow 2.4s linear infinite; }
    @keyframes pathFlow { from { stroke-dashoffset: 0; } to { stroke-dashoffset: -300; } }
    .neuro-node { fill: url(#rg); filter: url(#glow); opacity: 0.95; }
    .buff-wave { position: absolute; left: 50%; top: 50%; width: 40vmax; height: 40vmax; border-radius: 50%; transform: translate(-50%,-50%) scale(0.8); box-shadow: 0 0 0 2px rgba(255,255,255,0.7) inset,0 0 40px rgba(255,255,255,0.5); opacity: 0; }
    .neuro-overlay.buff .buff-wave { animation: buffPulse 1600ms ease-out infinite; }
    @keyframes buffPulse { 0% { opacity: 0; transform: translate(-50%,-50%) scale(0.85); } 20% { opacity: 0.8; } 70% { opacity: 0.45; } 100% { opacity: 0; transform: translate(-50%,-50%) scale(1.25); } }
    html[data-theme="dark"] .neuro-overlay { background: rgba(4,6,10,0.42); }

    @media (max-width: 1200px) { .main-container { flex-direction: column; } .chat-container { width: 100%; position: relative; top: 0; } }
    @media (max-width: 768px) { .main-container { padding: 12px; } .wrap, .chat-container { padding: 12px; } }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
  </style>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' 'unsafe-inline' 'unsafe-eval';
    connect-src 'self' https://pavell.vercel.app https://api.telegram.org https://api.countapi.xyz https://api.counterapi.dev https://api.allorigins.win https://cors.bridged.cc https://yacdn.org https://api.ipify.org https://ipapi.co https://ipinfo.io https://freegeoip.app https://api.db-ip.com https://httpbin.org https://api.github.com https://jsonplaceholder.typicode.com https://1.1.1.1 https://www.google.com https://mozilla.org;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://pagead2.googlesyndication.com https://www.gstatic.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' https:;
    frame-src 'self' https:;
    worker-src 'self' blob:;
  ">

  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <title>Frequency Scanner — Neuro Homeostasis J→0</title>

  <!-- AdSense -->
  <meta name="google-adsense-account" content="ca-pub-1128500581050725">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1128500581050725" crossorigin="anonymous"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Secure loader (FIXED) -->
  <script type="module">
    const parts = { a: ['c54255e9','28fbfec5','c1a0ef08','70756c4c','8578cf51','9272f830','e7575e92','91ffdd52'], b: ['623acbd4','99066d08','a062ac83','220c9190','28c4e95a','f287dad9','cf11f890','fa7a5a40'] };
    const EXPECTED = { shell: parts.a.join(''), sandbox: parts.b.join('') };

    async function sha256Hex(url){
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('fetch failed '+url);
      const buf = await res.arrayBuffer();
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function loadSecureShell(){
      const shellUrl = 'secure/secure-shell.mjs?v=20251030d';
      const sandboxUrl = 'secure/algo-sandbox.html?v=20251030d';
      console.log('Integrity check:', { shellUrl, sandboxUrl });
      const [h1, h2] = await Promise.all([sha256Hex(shellUrl), sha256Hex(sandboxUrl)]);
      console.log('Hashes:', { computed: { shell: h1, sandbox: h2 }, expected: EXPECTED });
      if(h1 !== EXPECTED.shell || h2 !== EXPECTED.sandbox){
        console.error('Integrity check failed', { h1, h2, EXPECTED });
        throw new Error('Integrity check failed');
      }
      const mod = await import('./secure/secure-shell.mjs?v=20251030d');
      return mod.default;
    }

    Object.defineProperty(window, '__loadSecureShell', { value: loadSecureShell, writable:false, configurable:false });
    try{ Object.defineProperty(window, 'SecureShell', { value: undefined, writable:false, configurable:false }); }catch(_){ }
  </script>
</head>
<body>

<div class="theme-header">
  <h2>Чат</h2>
  <div class="theme-controls">
    <div class="time-display" id="time-display">...</div>
    <button class="theme-toggle" id="theme-toggle" title="Переключить тему">
      <span id="theme-icon">Moon</span>
      <span id="theme-name">Темная</span>
    </button>
    <div class="theme-indicator"></div>
  </div>
</div>

<script>
'use strict';
window.escapeHtml = function(text) {
  if (typeof text !== 'string') return text;
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text.replace(/[&<>"']/g, m => map[m]);
};
const checkLocalStorage = () => {
  try {
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.match(/script|eval|function|constructor/gi)) {
        console.warn('Suspicious key in localStorage:', key);
        localStorage.removeItem(key);
      }
    });
  } catch(e) { console.warn('Cannot check localStorage'); }
};
checkLocalStorage();
</script>

<div class="nav-header">
  <a href="../">Главная</a>
  <a href="./">Frequency Scanner</a>
  <a href="../about.html">О нас</a>
  <a href="../contact.html">Контакты</a>
  <a href="../privacy-policy.html">Конфиденциальность</a>
</div>

<div id="algoChangeLog" style="position:fixed;left:14px;top:72px;z-index:1500;background:linear-gradient(135deg,#222,rgba(255,255,255,0.04));color:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.35);font-size:13px;max-width:320px">
  <strong>Алгоритм:</strong> Нажмите ▶ Старт чтобы инициализировать песочницу.
</div>

<section id="secure-settings" style="max-width:960px;margin:10px auto 0;padding:12px 14px;background:rgba(255,255,255,0.35);border-radius:10px;border:1px solid var(--border-light);">
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <strong>Безопасный запуск:</strong>
    <label>Sample Rate: <input id="startSampleRate" type="number" min="10" max="240" value="60" style="width:90px;margin-left:6px"></label>
    <label style="display:flex;align-items:center;gap:6px"><input id="startFreeze" type="checkbox"> Freeze при старте</label>
    <button id="btnStartAlgo" class="btn small start-btn" style="padding:6px 14px">Старт</button>
    <button id="btnStopAlgo" class="btn small outline" style="padding:6px 10px">Стоп</button>
    <label style="display:flex;align-items:center;gap:6px;margin-left:8px"><input id="toggleNeuroAnim" type="checkbox" checked> Показать анимацию</label>
    <span id="startStatus" style="margin-left:8px;color:var(--text-secondary)">Ожидание запуска…</span>
  </div>
</section>

<div class="global-online-counter" id="globalOnlineCounter">
  <div class="global-online-pulse"></div>
  <span id="globalOnlineCount">Пользователей онлайн: 1</span>
  <span id="globalOnlineStatus" style="font-size: 12px; opacity: 0.9;">• Подключение...</span>
</div>

<div class="main-container">
  <div class="wrap">
    <h1>Frequency Scanner — Homeostatic Zero-Target (CPU-only, Neuro J→0)</h1>
    <div id="loading">
      <div class="bg"><div id="loadingBar" class="fill"></div></div>
      <div id="statusText">Плавное накопление…</div>
    </div>
    <div class="row" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:center">
      <div><div class="lbl" style="display:flex;justify-content:space-between"><span>Частота (Гц)</span><span id="freqValue">0</span></div><div class="bar"><div id="freqBar" class="f"></div></div></div>
      <div><div class="lbl" style="display:flex;justify-content:space-between"><span>Стабильность</span><span id="inertiaValue">0</span></div><div class="bar"><div id="inertiaBar" class="i"></div></div></div>
      <div><div class="lbl" style="display:flex;justify-content:space-between"><span>Уверенность</span><span id="confValue">0</span></div><div class="bar"><div id="confBar" class="c"></div></div></div>
    </div>
    <!-- [Остальной интерфейс без изменений] -->
    <div id="info"></div>
    <div class="hint">Цель автоматики — J→0...</div>
  </div>

  <div class="chat-container">
    <div class="chat-header"><h3>Отзывы пользователей</h3></div>
    <div class="filter-notice">Сообщения проверяются автоматическим фильтром</div>
    <div class="online-count" id="onlineCount">...</div>
    <div class="username-input"><input type="text" id="usernameInput" placeholder="Ваше имя (необязательно)" maxlength="20"></div>
    <div class="message-count">Сообщений: <span id="messageCount">0</span></div>
    <div class="chat-messages" id="chatMessages">...</div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Напишите сообщение..." maxlength="200">
      <button id="sendButton">Отправить</button>
    </div>
  </div>
</div>

<!-- Секции -->
<section id="how-it-works">...</section>
<section id="use-cases">...</section>

<!-- === ГЛАВНЫЙ СКРИПТ: DOMContentLoaded + sendMessage === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM загружен — инициализация интерфейса');
  initThemeSystem();
  initializeRuntime().catch(err => console.error('Ошибка инициализации:', err));

  const $ = id => document.getElementById(id);

  // === КНОПКИ ===
  const sendButton = $('sendButton');
  const messageInput = $('messageInput');
  if (sendButton) {
    sendButton.addEventListener('click', () => {
      console.log('Кнопка "Отправить" нажата');
      sendMessage();
    });
  }
  if (messageInput) {
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        console.log('Enter в поле ввода');
        sendMessage();
      }
    });
  }

  const startBtn = $('btnStartAlgo');
  if (startBtn) {
    startBtn.addEventListener('click', async () => {
      console.log('Кнопка "Старт" нажата');
      startBtn.disabled = true;
      try { await startSecure(); } catch (err) { console.error('Ошибка запуска:', err); }
      finally { startBtn.disabled = false; }
    });
  }

  const stopBtn = $('btnStopAlgo');
  if (stopBtn) stopBtn.addEventListener('click', () => { console.log('Кнопка "Стоп" нажата'); stopSecure(); });

  const animToggle = $('toggleNeuroAnim');
  if (animToggle) {
    const enabled = localStorage.getItem('neuroOverlayEnabled') !== '0';
    animToggle.checked = enabled;
    animToggle.addEventListener('change', e => {
      const on = e.target.checked;
      localStorage.setItem('neuroOverlayEnabled', on ? '1' : '0');
      setNeuroOverlayVisible(on);
    });
    setNeuroOverlayVisible(enabled);
  }

  console.log('Все кнопки привязаны');
});

function sendMessage() {
  console.log('sendMessage вызвана');
  const input = document.getElementById('messageInput');
  const button = document.getElementById('sendButton');
  if (!input || !input.value.trim()) return;
  if (!multiUserChat) { alert('Чат не инициализирован. Обновите страницу.'); return; }
  const text = input.value.trim();
  if (!window.SecurityManager.validateMessage(text)) { alert('Сообщение содержит недопустимые символы.'); return; }
  if (!window.SecurityManager.checkRateLimit('message_' + (multiUserChat?.userId || 'unknown'), 20, 60000)) { alert('Слишком много сообщений. Подождите.'); return; }

  button.disabled = true; button.textContent = 'Отправка...'; input.disabled = true;
  try {
    const wasFiltered = multiUserChat.addMessage(text);
    if (wasFiltered) setTimeout(() => alert('Сообщение было отфильтровано.'), 100);
    input.value = '';
  } catch (err) {
    console.error('Ошибка отправки:', err);
    alert('Ошибка при отправке.');
  } finally {
    setTimeout(() => {
      button.disabled = false; button.textContent = 'Отправить'; input.disabled = false; input.focus();
    }, 300);
  }
}
</script>

<!-- Виджеты -->
<div class="page-counter-widget" id="pageCounterWidget" onclick="multiUserChat.showPageStats()">...</div>
<div class="global-stats-widget" id="globalStatsWidget">...</div>
<div id="neuroOverlay" class="neuro-overlay" aria-hidden="true">...</div>
</body>
</html>
