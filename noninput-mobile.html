<!doctype html>
<html
  lang="ru"
  style="background-color: #f3f5f7 !important; color: #1a1a1a !important"
>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Ensure minimal DOM helper $ is available early to avoid "$ is not defined" errors -->
    <script>
      if (!window.$) {
        try {
          window.$ = function (id) {
            return document.getElementById(id);
          };
          console.log("üîß $ helper injected");
        } catch (e) {}
      }
    </script>

    <!-- Mobile Redirect Script -->
    <script>
      (function () {
        // Check if user explicitly skipped mobile redirect
        const urlParams = new URLSearchParams(window.location.search);
        if (
          urlParams.get("skip") === "mobile" ||
          sessionStorage.getItem("skip-mobile-redirect")
        ) {
          return; // Don't redirect
        }

        // Detect if device is mobile
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent,
          );
        const screenWidth = window.innerWidth || screen.width;
        const isSmallScreen = screenWidth <= 768;

        if (isMobile || isSmallScreen) {
          // Get current URL and replace with mobile version
          const currentUrl = window.location.href;
          let mobileUrl = currentUrl.replace(
            /\/noninput\.html/,
            "/noninput-mobile.html",
          );

          // Fallback for different URL patterns
          if (
            currentUrl.includes("noninput.html") &&
            !mobileUrl.includes("noninput-mobile.html")
          ) {
            mobileUrl = currentUrl.replace(
              "noninput.html",
              "noninput-mobile.html",
            );
          }

          // Only redirect if the mobile URL is different
          if (mobileUrl !== currentUrl) {
            // Mark that redirect is happening to prevent loops
            sessionStorage.setItem("mobile-redirect-timestamp", Date.now());
            window.location.href = mobileUrl;
          }
        }
      })();
    </script>
    <meta
      http-equiv="cache-control"
      content="no-cache,no-store,must-revalidate"
    />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <!-- Cache Rebuild: 2025-10-28T21:33Z -->

    <script>
      (function () {
        try {
          const s = localStorage.getItem("theme-preference");
          const p =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme:dark)").matches;
          const h = new Date().getHours();
          const d = s
            ? s === "dark"
            : p || h >= 21 || h < 6 || (h >= 18 && h < 21);
          const t = d ? "dark" : "light";
          const b = d ? "#0d1117" : "#f3f5f7";
          const c = d ? "#e6edf3" : "#1a1a1a";
          document.documentElement.style.backgroundColor = b + "!important";
          document.documentElement.style.color = c + "!important";
          document.documentElement.setAttribute("data-theme", t);
          window.__THEME = { t, d, h };
          console.log("üé®[THEME]", t);
        } catch (e) {
          console.error(e);
        }
      })();
    </script>
    <script>
      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–µ–º—ã —Å –º–æ–±–∏–ª—å–Ω–æ–π –æ–±–µ—Ä—Ç–∫–æ–π
      window.addEventListener("message", (e) => {
        try {
          if (!e || !e.data) return;
          if (e.data.type === "set-theme") {
            const t = e.data.theme === "dark" ? "dark" : "light";
            localStorage.setItem("theme-preference", t);
            document.documentElement.setAttribute("data-theme", t);
          }
        } catch (_) {}
      });
    </script>

    <style>
      /* –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ */
      html,
      body {
        background-color: #f3f5f7 !important;
        color: #1a1a1a !important;
      }
      html[data-theme="dark"],
      html[data-theme="dark"]body {
        background-color: #0d1117 !important;
        color: #e6edf3 !important;
      }

      /* –§–æ–Ω –∑–∞–¥–∞—ë—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ styles.css –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è –ø–æ —Å–∞–π—Ç—É */

      /* –ü–æ–¥–ª–æ–∂–∫–∏ –ø–∞–Ω–µ–ª–µ–π: –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ, —á—Ç–æ–±—ã –±—ã–ª –≤–∏–¥–µ–Ω —Ñ–æ–Ω–æ–≤—ã–π —Ä–∏—Å—É–Ω–æ–∫ —Å–∞–π—Ç–∞ */
      .wrap,
      .row.controls,
      .chat-container {
        backdrop-filter: blur(4px);
        background-color: rgba(255, 255, 255, 0.35);
      }
      html[data-theme="dark"] .wrap,
      html[data-theme="dark"] .row.controls,
      html[data-theme="dark"] .chat-container {
        background-color: rgba(13, 17, 23, 0.4);
      }
    </style>

    <!-- Content Security Policy -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
    default-src 'self' 'unsafe-inline' 'unsafe-eval';
    connect-src 'self' 
      https://pavell.vercel.app
      https://api.telegram.org 
      https://api.countapi.xyz 
      https://api.counterapi.dev 
      https://counter-api.dev 
      https://api.allorigins.win 
      https://cors.bridged.cc 
      https://yacdn.org 
      https://api.ipify.org 
      https://ipapi.co 
      https://ipinfo.io 
      https://freegeoip.app 
      https://api.db-ip.com
      https://httpbin.org 
      https://api.github.com 
      https://jsonplaceholder.typicode.com
      https://1.1.1.1
      https://www.google.com
      https://mozilla.org;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:
      https://pagead2.googlesyndication.com 
      https://www.gstatic.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' https:;
    frame-src 'self' https:;
    worker-src 'self' blob:;
  "
    />

    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta
      http-equiv="Referrer-Policy"
      content="strict-origin-when-cross-origin"
    />
    <meta
      http-equiv="Permissions-Policy"
      content="geolocation=(), microphone=(), camera=()"
    />
    <title>
      Frequency Scanner ‚Äî Neuro Homeostasis J‚Üí0 (with AdSense Auto Ads)
    </title>

    <!-- Immediate theme application to prevent flash - INLINE CRITICAL STYLES -->
    <script>
      (function () {
        const saved = localStorage.getItem("theme-preference");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const hour = new Date().getHours();
        const isNightHour = hour >= 21 || hour < 6;
        const isEveningHour = hour >= 18 && hour < 21;

        let theme = "light";

        if (saved) {
          theme = saved;
        } else if (prefersDark) {
          theme = "dark";
        } else if (isNightHour || isEveningHour) {
          theme = "dark";
        }

        document.documentElement.setAttribute("data-theme", theme);

        // Critical inline styles for immediate visibility
        if (theme === "dark") {
          document.documentElement.style.backgroundColor = "#0d1117";
          document.documentElement.style.color = "#e6edf3";
        } else {
          document.documentElement.style.backgroundColor = "#f3f5f7";
          document.documentElement.style.color = "#1a1a1a";
        }

        console.log("üé® Theme applied immediately (inline):", theme);
        // –ü—Ä–æ—Å—Ç–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–∫—Å–∏/–±–µ–∫–µ–Ω–¥–∞
        // - –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º http://localhost:3000
        // - –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –Ω–∞ GitHub Pages –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–∞–≤–Ω—ã–π Vercel —Ö–æ—Å—Ç
        // - –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ origin, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        window.getProxyBase = function () {
          try {
            const host = window.location.hostname || "";
            if (host === "localhost" || host === "127.0.0.1")
              return "http://localhost:3000";
            // NOTE: For github.io pages we intentionally prefer same-origin
            // (window.location.origin) to avoid cross-origin preflight/CORS errors
            // when the production API (pavell.vercel.app) is not reachable or not
            // configured with proper CORS. This reduces cross-origin security
            // but prevents the browser from blocking requests with CORS errors.
            if (host.includes("github.io") || host.includes("pages.github"))
              return window.location.origin || "https://pavell.vercel.app";
            return window.location.origin || "https://pavell.vercel.app";
          } catch (e) {
            return "https://pavell.vercel.app";
          }
        };
      })();
    </script>

    <!-- Favicon (—É–±—Ä–∞–Ω ‚Äî —Ñ–∞–π–ª favicon.ico –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç) -->
    <!-- <link rel="icon" href="favicon.ico"> -->

    <!-- (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –£–∫–∞–∂–∏ –∞–∫–∫–∞—É–Ω—Ç AdSense –¥–ª—è –º–µ—Ç–∞-—Å–∫–∞–Ω–µ—Ä–æ–≤ -->
    <meta name="google-adsense-account" content="ca-pub-1128500581050725" />

    <!-- Google Consent Mode v2 - Required for GDPR/CCPA compliance -->
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('consent', 'default', {
        'analytics_storage': 'denied',
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'wait_for_update': 500
      });
      console.log('üìã Google Consent Mode initialized (default: denied)');
    </script>

    <!-- ‚úÖ Google AdSense Auto Ads (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–ª–∞–º–∞) -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1128500581050725"
      crossorigin="anonymous"
    ></script>

    <!-- Firebase –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- JSZip for ZIP archive creation (optional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Secure sandbox loader (no integrity check - files are validated at build time) -->
    <script type="module">
      async function loadSecureShell() {
        // Load the secure-shell module directly
        // Files are validated at build time, integrity checks happen offline
        console.log("‚úÖ Secure shell module loading...");
        const mod = await import("./secure/secure-shell.mjs");
        return mod.default;
      }
      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º (read-only)
      Object.defineProperty(window, "__loadSecureShell", {
        value: loadSecureShell,
        writable: false,
        configurable: false,
      });
      // –ó–∞–ø–µ—á–∞—Ç—ã–≤–∞–µ–º –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
      try {
        Object.defineProperty(window, "SecureShell", {
          value: undefined,
          writable: false,
          configurable: false,
        });
      } catch (_) {}
    </script>

    <style>
      /* ===== –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ===== */
      :root {
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
        --bg: #f3f5f7;
        --bg-secondary: #e8ebef;
        --panel: #ffffff;
        --panel-hover: #f8f9fa;
        --text: #1a1a1a;
        --text-secondary: #666666;
        --text-muted: #999999;
        --border: #e0e0e0;
        --border-light: #e8ebef;
        --shadow: rgba(0, 0, 0, 0.07);
        --shadow-lg: rgba(0, 0, 0, 0.12);

        /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
        --primary: #0a7cff;
        --primary-light: #69b7ff;
        --success: #18b56c;
        --success-light: #9ef0c5;
        --warning: #ff9800;
        --warning-light: #ffd699;
        --info: #007bff;
        --info-dark: #0056b3;
        --danger: #dc3545;

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ */
        --chat-user-bg: #007bff;
        --chat-user-text: #ffffff;
        --chat-other-bg: #f1f3f5;
        --chat-other-text: #333333;
        --chat-system-bg: #e2e3e5;
        --chat-system-text: #6c757d;

        /* –ü–µ—Ä–µ—Ö–æ–¥—ã */
        --transition: all 0.3s ease;
      }

      /* ===== –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê ===== */
      html[data-theme="dark"],
      body.dark-theme {
        --bg: #0d1117;
        --bg-secondary: #161b22;
        --panel: #1a1f26;
        --panel-hover: #21262d;
        --text: #e6edf3;
        --text-secondary: #a0a8b8;
        --text-muted: #8b949e;
        --border: #30363d;
        --border-light: #21262d;
        --shadow: rgba(0, 0, 0, 0.3);
        --shadow-lg: rgba(0, 0, 0, 0.5);

        /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Ç–µ–º—ã) */
        --primary: #58a6ff;
        --primary-light: #79c0ff;
        --success: #3fb950;
        --success-light: #56d364;
        --warning: #ffa657;
        --warning-light: #ffb563;
        --info: #58a6ff;
        --info-dark: #1f6feb;
        --danger: #f85149;

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ */
        --chat-user-bg: #1f6feb;
        --chat-user-text: #ffffff;
        --chat-other-bg: #21262d;
        --chat-other-text: #e6edf3;
        --chat-system-bg: #262c36;
        --chat-system-text: #8b949e;
      }

      /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–µ–ª—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
      /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞: —Å–µ–∫—Ü–∏–∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ, —á—Ç–æ–±—ã –±—ã–ª –≤–∏–¥–µ–Ω –æ–±—â–∏–π —Ñ–æ–Ω */
      html[data-theme="dark"] #how-it-works,
      html[data-theme="dark"] #use-cases {
        background-color: rgba(13, 17, 23, 0.4) !important;
      }

      /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —á–∞—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ */
      html[data-theme="dark"] .chat-container {
        background-color: rgba(13, 17, 23, 0.4) !important;
        color: var(--text) !important;
        border-color: var(--border) !important;
      }

      html[data-theme="dark"] .chat-container * {
        color: var(--text) !important;
      }

      html[data-theme="dark"] .chat-container input,
      html[data-theme="dark"] .chat-container textarea {
        background: var(--bg-secondary) !important;
        color: var(--text) !important;
        border-color: var(--border) !important;
      }

      html[data-theme="dark"] .chat-container button {
        background: var(--primary) !important;
        color: white !important;
      }

      html[data-theme="dark"] .chat-container a {
        color: var(--primary-light) !important;
      }

      /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–µ–π –æ–±—É—á–µ–Ω–∏—è */
      html[data-theme="dark"] .row.controls {
        background-color: rgba(13, 17, 23, 0.4) !important;
        border-color: var(--border) !important;
        color: var(--text) !important;
      }

      html[data-theme="dark"] .row.controls label,
      html[data-theme="dark"] .row.controls .lbl,
      html[data-theme="dark"] .row.controls .hint {
        color: var(--text) !important;
      }

      html[data-theme="dark"] .row.controls input[type="range"],
      html[data-theme="dark"] .row.controls input[type="checkbox"] {
        accent-color: var(--primary) !important;
      }

      /* ===== –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê: –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ===== */
      html[data-theme="dark"] .main-container {
        background: transparent !important;
      }

      html[data-theme="dark"] .wrap {
        background-color: rgba(13, 17, 23, 0.4) !important;
        color: var(--text) !important;
        border-color: var(--border-light) !important;
      }

      html[data-theme="dark"] .wrap * {
        color: var(--text) !important;
      }

      html[data-theme="dark"] .wrap a {
        color: var(--primary-light) !important;
      }

      html[data-theme="dark"] .wrap button {
        background: var(--primary) !important;
        color: white !important;
        border-color: var(--primary) !important;
      }

      html[data-theme="dark"] .wrap input,
      html[data-theme="dark"] .wrap textarea {
        background: var(--bg-secondary) !important;
        color: var(--text) !important;
        border-color: var(--border) !important;
      }

      /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Å–µ inline style —Å white/light —Ñ–æ–Ω–∞–º–∏ */
      html[data-theme="dark"] [style*="background: #f"],
      html[data-theme="dark"] [style*="background:#f"],
      html[data-theme="dark"] [style*="background: white"],
      html[data-theme="dark"] [style*="background:white"],
      html[data-theme="dark"] [style*="background-color: #f"],
      html[data-theme="dark"] [style*="background-color:#f"] {
        background: var(--panel) !important;
        color: var(--text) !important;
      }

      /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
      html[data-theme="dark"] div[style*="background: white"],
      html[data-theme="dark"] div[style*="background:white"] {
        background: var(--panel) !important;
        color: var(--text) !important;
      }

      /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è pulse —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
      html[data-theme="dark"] .global-online-pulse {
        background: #58a6ff !important;
      }

      /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è tooltip –∏ popup-–æ–≤ */
      html[data-theme="dark"] .modal-content,
      html[data-theme="dark"] [role="dialog"],
      html[data-theme="dark"] .popup,
      html[data-theme="dark"] .tooltip {
        background: var(--panel) !important;
        color: var(--text) !important;
        border-color: var(--border) !important;
      }

      /* ===== –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ===== */
      * {
        transition:
          background-color 0.3s ease,
          color 0.3s ease,
          border-color 0.3s ease;
      }

      html,
      body {
        margin: 0;
        /* background is unified via styles.css on html; keep body transparent */
        color: var(--text);
        font:
          14px/1.45 system-ui,
          Segoe UI,
          Arial;
      }

      /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –Ø–≤–Ω–æ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ html/body –¥–ª—è —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã */
      html[data-theme="dark"] {
        /* keep only background-color fallback; do not override background-image */
        background-color: var(--bg) !important;
        color: var(--text) !important;
      }

      body {
        background: transparent;
        color: var(--text);
      }

      html[data-theme="dark"] body {
        background: transparent !important;
        color: var(--text) !important;
      }

      /* –¢–æ–ø-–±–∞—Ä —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º —Ç–µ–º—ã */
      .theme-header {
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        padding: 12px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px var(--shadow);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .theme-header h2 {
        margin: 0;
        font-size: 18px;
        color: var(--text);
      }

      .theme-controls {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .theme-toggle {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text);
        font-size: 14px;
        transition: var(--transition);
      }

      .theme-toggle:hover {
        background: var(--panel-hover);
        border-color: var(--primary);
      }

      .theme-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary);
        animation: pulse-indicator 2s infinite;
      }

      @keyframes pulse-indicator {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .time-display {
        font-size: 13px;
        color: var(--text-secondary);
        padding: 0 8px;
      }

      /* ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ===== */
      .main-container {
        display: flex;
        gap: 24px;
        max-width: 1400px;
        margin: 24px auto;
        padding: 24px;
      }

      .wrap {
        flex: 1;
        padding: 24px;
        background: transparent;
        border-radius: 16px;
        box-shadow: 0 2px 22px var(--shadow);
        border: 1px solid var(--border-light);
      }

      .chat-container {
        width: 350px;
        background: transparent;
        border-radius: 16px;
        box-shadow: 0 2px 22px var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        height: fit-content;
        position: sticky;
        top: 80px;
        border: 1px solid var(--border-light);
      }

      /* ===== –¢–ï–ö–°–¢ –ò –ó–ê–ì–û–õ–û–í–ö–ò ===== */
      h1 {
        margin: 0 0 10px;
        color: var(--text);
      }

      h3 {
        color: var(--text);
      }

      /* ===== –ü–†–û–ì–†–ï–°–° –ë–ê–† ===== */
      #loading {
        margin: 6px 0 12px;
      }

      #loading .bg {
        height: 18px;
        border-radius: 8px;
        background: var(--bg-secondary);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      #loading .fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(
          90deg,
          var(--primary) 60%,
          var(--primary-light)
        );
        transition: width 0.25s ease-out;
      }

      #statusText {
        color: var(--text-secondary);
        margin-top: 6px;
      }

      .row {
        margin-top: 12px;
      }

      .lbl {
        margin: 10px 0 6px;
        color: var(--text-secondary);
      }

      .bar {
        height: 18px;
        border-radius: 8px;
        background: var(--bg-secondary);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .f {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary) 60%,
          var(--primary-light)
        );
        width: 0%;
      }

      .i {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--success) 60%,
          var(--success-light)
        );
        width: 0%;
      }

      .c {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--warning) 60%,
          var(--warning-light)
        );
        width: 0%;
      }

      #info {
        margin-top: 14px;
        font-family: ui-monospace, Consolas, Menlo, monospace;
        white-space: pre-wrap;
        color: var(--text);
        background: transparent;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      .hint {
        color: var(--text-secondary);
        margin-top: 8px;
      }

      /* ===== –†–ï–ö–õ–ê–ú–ê ===== */
      .ad-placeholder {
        min-height: 250px;
        display: block;
        text-align: center;
        margin: 16px 0;
        background: transparent;
      }

      /* ===== –ß–ê–¢ ===== */
      .chat-header {
        text-align: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border-light);
      }

      .chat-header h3 {
        margin: 0;
        color: var(--text);
        font-size: 18px;
      }

      .online-counter {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 8px 12px;
        background: linear-gradient(
          135deg,
          var(--success-light),
          var(--primary-light)
        );
        border-radius: 8px;
        border-left: 4px solid var(--success);
      }

      html[data-theme="dark"] .online-counter {
        background: linear-gradient(
          135deg,
          rgba(63, 185, 80, 0.2),
          rgba(88, 166, 255, 0.2)
        );
        border-left-color: var(--success);
      }

      .online-users {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text);
      }

      .online-indicator {
        width: 8px;
        height: 8px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .users-list {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        max-height: 40px;
        overflow-y: auto;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .chat-messages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        background: rgba(255, 255, 255, 0.25);
      }
      html[data-theme="dark"] .chat-messages {
        background: rgba(13, 17, 23, 0.25);
      }

      .message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
      }

      .message.user {
        background: var(--chat-user-bg);
        color: var(--chat-user-text);
        margin-left: auto;
        box-shadow: 0 2px 8px rgba(7, 123, 255, 0.2);
      }

      .message.other {
        background: var(--chat-other-bg);
        color: var(--chat-other-text);
        border: 1px solid var(--border);
      }

      .message-meta {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
      }

      .chat-input {
        display: flex;
        gap: 8px;
      }

      .chat-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
      }

      .chat-input input::placeholder {
        color: var(--text-muted);
      }

      .chat-input button {
        padding: 10px 16px;
        background: var(--info);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: var(--transition);
        font-weight: 500;
      }

      .chat-input button:hover {
        background: var(--info-dark);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      .chat-input button:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        opacity: 0.5;
      }

      .message-count {
        text-align: center;
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 8px;
      }

      .filter-notice {
        background: linear-gradient(135deg, var(--warning-light), #ffe0a7);
        border: 1px solid var(--warning);
        color: var(--text);
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 12px;
      }

      html[data-theme="dark"] .filter-notice {
        background: rgba(255, 152, 0, 0.1);
        border: 1px solid var(--warning);
      }

      .online-count {
        background: linear-gradient(135deg, var(--success-light), #b5e7a0);
        border: 1px solid var(--success);
        color: var(--text);
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 8px;
        text-align: center;
        font-weight: 500;
      }

      html[data-theme="dark"] .online-count {
        background: rgba(63, 185, 80, 0.1);
        border: 1px solid var(--success);
      }

      .username-input {
        margin-bottom: 12px;
      }

      .username-input input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
      }

      .message.system {
        background: var(--chat-system-bg);
        color: var(--chat-system-text);
        font-style: italic;
        margin: 5px auto;
        text-align: center;
        max-width: 95%;
        border: 1px solid var(--border);
      }

      /* ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø ===== */
      .nav-header {
        background: rgba(255, 255, 255, 0.25);
        padding: 10px 0;
        margin-bottom: 20px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid var(--border-light);
      }
      html[data-theme="dark"] .nav-header {
        background: rgba(13, 17, 23, 0.35);
      }

      .nav-header a {
        margin: 0 10px;
        color: var(--info);
        text-decoration: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
        transition: var(--transition);
      }

      .nav-header a:hover {
        background: var(--info);
        color: white;
      }

      /* ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –°–ß–Å–¢–ß–ò–ö ===== */
      .global-online-counter {
        background: linear-gradient(135deg, var(--success), var(--primary));
        color: white;
        padding: 8px 15px;
        margin: 10px auto;
        border-radius: 25px;
        text-align: center;
        max-width: 300px;
        box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
      @media (max-width: 1200px) {
        .main-container {
          flex-direction: column;
        }

        .chat-container {
          width: 100%;
          position: relative;
          top: 0;
        }

        .theme-header {
          flex-direction: column;
          gap: 12px;
        }
      }

      @media (max-width: 768px) {
        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø */
        * {
          -webkit-tap-highlight-color: transparent;
        }

        body {
          font-size: 14px;
        }

        .main-container {
          padding: 8px;
        }

        .wrap {
          padding: 8px !important;
          margin-bottom: 8px;
        }

        .chat-container {
          display: none; /* –°–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
          padding: 8px;
        }

        .row.controls {
          flex-wrap: wrap;
          gap: 6px;
          padding: 8px;
        }

        .row.controls label,
        .row.controls button,
        .row.controls input,
        .row.controls select {
          min-height: 40px; /* iOS minimum touch target */
          font-size: 14px;
          padding: 8px 10px;
        }

        button {
          min-height: 44px;
          padding: 10px 12px !important;
          font-size: 13px;
        }

        input[type="number"],
        input[type="text"],
        input[type="checkbox"],
        select {
          font-size: 16px !important; /* Prevents iOS zoom on focus */
          min-height: 40px;
          padding: 8px 10px;
        }

        canvas {
          max-height: 50vh !important;
          width: 100% !important;
        }

        .theme-toggle {
          font-size: 12px;
          padding: 6px 10px;
        }

        .time-display {
          font-size: 12px;
        }

        /* Optimization: Reduce animations on mobile */
        .global-online-pulse {
          animation: globalPulse 3s infinite; /* Slower for mobile */
        }

        /* Hide complex stats on mobile */
        .stats-container {
          display: none;
        }

        /* Optimize page counter for mobile */
        .page-counter-widget {
          bottom: 10px;
          right: 10px;
          padding: 8px 12px;
          font-size: 11px;
          min-width: 140px;
        }

        /* Simplify FFT canvas for mobile */
        #fftCanvas,
        #canvas,
        canvas {
          display: block;
          margin: 8px auto;
          max-width: 100%;
          height: auto !important;
        }
      }

      /* ===== –°–ö–†–û–õ–õ–ë–ê–† ===== */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
      }

      .global-online-pulse {
        width: 10px;
        height: 10px;
        background: #ffffff;
        border-radius: 50%;
        animation: globalPulse 2s infinite;
      }

      @keyframes globalPulse {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .page-counter-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 16px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        font-size: 12px;
        font-weight: 500;
        z-index: 1000;
        min-width: 180px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .page-counter-widget:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }

      .counter-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 3px 0;
      }

      .counter-number {
        font-weight: 600;
        color: #ffd700;
      }

      .global-stats-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        margin-right: 6px;
        animation: pulse 2s infinite;
      }

      .global-stats-indicator.offline {
        background: #ff4444;
        animation: none;
      }

      .global-stats-widget {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: linear-gradient(135deg, #11998e, #38ef7d);
        color: white;
        padding: 10px 15px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        font-size: 11px;
        z-index: 999;
        max-width: 200px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .global-stats-widget:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
      }

      .world-map-mini {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 5px 0;
        font-size: 16px;
      }
      /* Stylish Start button */
      .start-btn {
        background: linear-gradient(90deg, #7f5af0, #2cb67d);
        border: none;
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.2px;
        box-shadow:
          0 10px 24px rgba(127, 90, 240, 0.28),
          0 6px 16px rgba(44, 182, 125, 0.18);
        transition:
          transform 0.15s ease,
          box-shadow 0.15s ease,
          filter 0.15s ease;
      }
      .start-btn:hover {
        transform: translateY(-1px);
        box-shadow:
          0 12px 28px rgba(127, 90, 240, 0.36),
          0 8px 18px rgba(44, 182, 125, 0.22);
        filter: saturate(1.05);
      }
      .start-btn:active {
        transform: translateY(0);
        box-shadow:
          0 6px 14px rgba(127, 90, 240, 0.25),
          0 4px 10px rgba(44, 182, 125, 0.18);
      }

      /* ===== NEURO OVERLAY ANIMATION ===== */
      .neuro-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(4px);
        display: none;
        z-index: 2000;
        pointer-events: none;
      }
      .neuro-overlay.visible {
        display: block;
        animation: overlayFade 200ms ease-out;
      }
      @keyframes overlayFade {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .neuro-scene {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .neuro-svg {
        width: min(1100px, 96vw);
        height: auto;
        filter: hue-rotate(0deg);
        animation: rainbowShift 6s linear infinite;
      }
      @keyframes rainbowShift {
        from {
          filter: hue-rotate(0);
        }
        to {
          filter: hue-rotate(360deg);
        }
      }
      .neuro-path {
        stroke: url(#rg);
        stroke-width: 3;
        fill: none;
        stroke-dasharray: 9 14;
        animation: pathFlow 2.4s linear infinite;
      }
      @keyframes pathFlow {
        from {
          stroke-dashoffset: 0;
        }
        to {
          stroke-dashoffset: -300;
        }
      }
      .neuro-node {
        fill: url(#rg);
        filter: url(#glow);
        opacity: 0.95;
      }
      .buff-wave {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 40vmax;
        height: 40vmax;
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        box-shadow:
          0 0 0 2px rgba(255, 255, 255, 0.7) inset,
          0 0 40px rgba(255, 255, 255, 0.5);
        opacity: 0;
      }
      .neuro-overlay.buff .buff-wave {
        animation: buffPulse 1600ms ease-out infinite;
      }
      @keyframes buffPulse {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.85);
        }
        20% {
          opacity: 0.8;
        }
        70% {
          opacity: 0.45;
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1.25);
        }
      }
      html[data-theme="dark"] .neuro-overlay {
        background: rgba(4, 6, 10, 0.42);
      }
    </style>
  </head>
  <body>
    <!-- Consent Banner -->
    <div id="consent-banner" style="
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      color: #fff;
      padding: 16px 20px;
      z-index: 9999;
      display: none;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    ">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 250px;">
          üç™ <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö:</strong> –≠—Ç–æ—Ç —Å–∞–π—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google AdSense –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã. –ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ¬ª, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ 
          <a href="/privacy-policy.html" style="color: #4da6ff; text-decoration: none;">–ü–æ–ª–∏—Ç–∏–∫–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button id="consent-reject" style="
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #fff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 5;
          ">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤—Å–µ</button>
          <button id="consent-accept" style="
            padding: 8px 16px;
            background: #4da6ff;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
          ">–ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ</button>
        </div>
      </div>
    </div>

    <script>
      // Consent Banner Logic
      (function() {
        const consentBanner = document.getElementById('consent-banner');
        const consentKey = 'suslovpa-consent-given';
        const consentTimestamp = 'suslovpa-consent-timestamp';
        
        // Check if user already gave consent (valid for 30 days)
        const savedConsent = localStorage.getItem(consentKey);
        const savedTimestamp = localStorage.getItem(consentTimestamp);
        const thirtyDaysMs = 30 * 24 * 60 * 60 * 1000;
        
        if (!savedConsent || (Date.now() - parseInt(savedTimestamp || 0)) > thirtyDaysMs) {
          // Show banner
          setTimeout(() => {
            consentBanner.style.display = 'flex';
            console.log('üìã Showing consent banner');
          }, 1000);
        } else {
          console.log('‚úÖ User consent already given');
          // Update consent in Google Consent Mode
          if (window.gtag) {
            window.gtag('consent', 'update', {
              'analytics_storage': 'granted',
              'ad_storage': 'granted',
              'ad_user_data': 'granted',
              'ad_personalization': 'granted'
            });
          }
        }
        
        // Handle Reject button
        document.getElementById('consent-reject').addEventListener('click', function() {
          localStorage.setItem(consentKey, 'declined');
          localStorage.setItem(consentTimestamp, Date.now().toString());
          consentBanner.style.display = 'none';
          console.log('‚ùå User declined consent');
          // Keep default denied state
        });
        
        // Handle Accept button
        document.getElementById('consent-accept').addEventListener('click', function() {
          localStorage.setItem(consentKey, 'granted');
          localStorage.setItem(consentTimestamp, Date.now().toString());
          consentBanner.style.display = 'none';
          console.log('‚úÖ User granted consent');
          // Update Google Consent Mode to granted
          if (window.gtag) {
            window.gtag('consent', 'update', {
              'analytics_storage': 'granted',
              'ad_storage': 'granted',
              'ad_user_data': 'granted',
              'ad_personalization': 'granted'
            });
          }
        });
      })();
    </script>

    <!-- ===== –¢–û–ü-–ë–ê–† –° –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–ï–ú –¢–ï–ú ===== -->
    <div class="theme-header">
      <h2>üí¨ –ß–∞—Ç</h2>
      <div class="theme-controls">
        <div class="time-display" id="time-display">...</div>
        <button class="theme-toggle" id="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
          <span id="theme-icon">üåô</span>
          <span id="theme-name">–¢–µ–º–Ω–∞—è</span>
        </button>
        <div class="theme-indicator"></div>
      </div>
    </div>

    <!-- –ó–ê–©–ò–¢–ê –°–ê–ô–¢–ê –û–¢ –í–ó–õ–û–ú–ê –ò –£–¢–ï–ß–ö–ò –ö–û–î–ê -->
    <script>
      "use strict";

      // NOTE: DevTools protection disabled for debugging. Enable in production.

      // 1. –ó–ê–©–ò–¢–ê –û–¢ XSS –ò –ò–ù–™–ï–ö–¶–ò–ô
      (function () {
        // –§—É–Ω–∫—Ü–∏—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ HTML
        window.escapeHtml = function (text) {
          if (typeof text !== "string") return text;
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          };
          return text.replace(/[&<>"']/g, (m) => map[m]);
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ –≤ localStorage
        const checkLocalStorage = () => {
          try {
            const keys = Object.keys(localStorage);
            keys.forEach((key) => {
              if (key.match(/script|eval|function|constructor/gi)) {
                console.warn(
                  "üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ localStorage:",
                  key,
                );
                localStorage.removeItem(key);
              }
            });
          } catch (e) {
            console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage");
          }
        };
        checkLocalStorage();
      })();

      // 2. –ó–ê–©–ò–¢–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø
      (function () {
        // –°–∫—Ä—ã–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª–∏
        Object.defineProperty(window, "TELEGRAM_BOT_TOKEN", {
          get: function () {
            console.warn("üö® –ü–û–ü–´–¢–ö–ê –î–û–°–¢–£–ü–ê –ö –ó–ê–©–ò–©–ï–ù–ù–û–ô –ü–ï–†–ï–ú–ï–ù–ù–û–ô!");
            return undefined;
          },
          configurable: false,
        });

        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞
        const handler = {
          get(target, prop) {
            if (
              prop.toUpperCase().includes("TOKEN") ||
              prop.toUpperCase().includes("SECRET") ||
              prop.toUpperCase().includes("KEY") ||
              prop.toUpperCase().includes("PASSWORD")
            ) {
              console.error("üö® –ü–û–ü–´–¢–ö–ê –î–û–°–¢–£–ü–ê –ö:", prop);
            }
            return target[prop];
          },
        };

        window.secureProxy = new Proxy({}, handler);
      })();

      // 6. –ú–û–ù–ò–¢–û–†–ò–ù–ì –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
      (function () {
        window.addEventListener("error", function (e) {
          // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          if (
            e.message &&
            (e.message.includes("eval") ||
              e.message.includes("Function") ||
              e.message.includes("setTimeout") ||
              e.message.includes("setInterval"))
          ) {
            console.error("üö® –û–ë–ù–ê–†–£–ñ–ï–ù–ê –ü–û–ü–´–¢–ö–ê –ò–ù–™–ï–ö–¶–ò–ò –ö–û–î–ê:", e.message);
          }
        });
      });

      console.log(
        "%c‚úÖ –°–ò–°–¢–ï–ú–ê –ó–ê–©–ò–¢–´ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê",
        "color: green; font-size: 18px; font-weight: bold;",
      );
      console.log("%c–≠—Ç–æ—Ç —Å–∞–π—Ç –∑–∞—â–∏—â–µ–Ω –æ—Ç:");
      console.log("  ‚Ä¢ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞");
      console.log("  ‚Ä¢ –î–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ DevTools");
      console.log("  ‚Ä¢ XSS –∞—Ç–∞–∫ –∏ –∏–Ω—ä–µ–∫—Ü–∏–π");
      console.log("  ‚Ä¢ –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞");
    </script>

    <div class="nav-header">
      <a href="../">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="./">üìä Frequency Scanner</a>
      <a href="../about.html">üìñ –û –Ω–∞—Å</a>
      <a href="../contact.html">üìß –ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
      <a href="../privacy-policy.html">üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</a>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è / changelog –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ (–≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª) -->
    <div
      id="algoChangeLog"
      style="
        position: fixed;
        left: 14px;
        top: 72px;
        z-index: 1500;
        background: linear-gradient(135deg, #222, rgba(255, 255, 255, 0.04));
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
        font-size: 13px;
        max-width: 320px;
      "
    >
      <strong>–ê–ª–≥–æ—Ä–∏—Ç–º:</strong> –ù–∞–∂–º–∏—Ç–µ ‚ñ∂ –°—Ç–∞—Ä—Ç —á—Ç–æ–±—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
      –ø–µ—Å–æ—á–Ω–∏—Ü—É. –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è.
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ -->
    <section
      id="secure-settings"
      style="
        max-width: 960px;
        margin: 10px auto 0;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.35);
        border-radius: 10px;
        border: 1px solid var(--border-light);
      "
    >
      <div
        style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap"
      >
        <strong>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—É—Å–∫:</strong>
        <label
          >Sample Rate:
          <input
            id="startSampleRate"
            type="number"
            min="10"
            max="240"
            value="60"
            style="width: 90px; margin-left: 6px"
          />
        </label>
        <label style="display: flex; align-items: center; gap: 6px">
          <input id="startFreeze" type="checkbox" /> Freeze –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        </label>
        <button
          id="btnStartAlgo"
          class="btn small start-btn"
          style="padding: 6px 14px"
          onclick="console.log('[INLINE] btnStartAlgo clicked'); if(window.startSecure) startSecure();"
        >
          ‚ñ∂ –°—Ç–∞—Ä—Ç
        </button>
        <button
          id="btnStopAlgo"
          class="btn small outline"
          style="padding: 6px 10px"
        >
          ‚ñ† –°—Ç–æ–ø
        </button>
        <div style="display: flex; align-items: center; gap: 12px; margin-left: 12px; flex-wrap: wrap">
          <a href="https://suslovpa.vercel.app/SuslovPA-Offline.html" target="_blank" style="color: #1a7de9; text-decoration: none; font-size: 13px; font-weight: 500" title="–û—Ç–∫—Ä—ã—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω –≤–µ—Ä—Å–∏—é –Ω–∞ Vercel">üì± Vercel</a>
          <a href="https://montagnikrea-source.github.io/SuslovPA/SuslovPA-Offline.html" target="_blank" style="color: #24292e; text-decoration: none; font-size: 13px; font-weight: 500" title="–û—Ç–∫—Ä—ã—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω –≤–µ—Ä—Å–∏—é –Ω–∞ GitHub Pages">üêô GitHub</a>
        </div>
        <label
          style="display: flex; align-items: center; gap: 6px; margin-left: 8px"
        >
          <input id="toggleNeuroAnim" type="checkbox" checked />
          –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
        </label>
        <span
          id="startStatus"
          style="margin-left: 8px; color: var(--text-secondary)"
          >–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞‚Ä¶</span
        >
      </div>
    </section>

    <div class="global-online-counter" id="globalOnlineCounter">
      <div class="global-online-pulse"></div>
      <span id="globalOnlineCount">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: 1</span>
      <span id="globalOnlineStatus" style="font-size: 12px; opacity: 0.9"
        >‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span
      >
    </div>

    <div class="main-container">
      <div class="wrap">
        <h1>
          Frequency Scanner ‚Äî Homeostatic Zero-Target (CPU-only, Neuro J‚Üí0)
        </h1>

        <div id="loading">
          <div class="bg"><div id="loadingBar" class="fill"></div></div>
          <div id="statusText">–ü–ª–∞–≤–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ‚Ä¶</div>
        </div>

        <div
          class="row"
          style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            align-items: center;
          "
        >
          <div>
            <div
              class="lbl"
              style="display: flex; justify-content: space-between"
            >
              <span>–ß–∞—Å—Ç–æ—Ç–∞ (–ì—Ü)</span>
              <span id="freqValue">0</span>
            </div>
            <div class="bar"><div id="freqBar" class="f"></div></div>
          </div>
          <div>
            <div
              class="lbl"
              style="display: flex; justify-content: space-between"
            >
              <span>–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</span>
              <span id="inertiaValue">0</span>
            </div>
            <div class="bar"><div id="inertiaBar" class="i"></div></div>
          </div>
          <div>
            <div
              class="lbl"
              style="display: flex; justify-content: space-between"
            >
              <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</span>
              <span id="confValue">0</span>
            </div>
            <div class="bar"><div id="confBar" class="c"></div></div>
          </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç/—Ä—É—á–Ω. –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ–π—Ä–æ–æ–±—É—á–µ–Ω–∏—è -->
        <div
          class="row controls"
          style="
            margin-top: 18px;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border-color: var(--border);
            border: 1px solid var(--border);
          "
        >
          <div class="lbl" style="margin-top: 0">
            –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è (–æ–Ω–ª–∞–π–Ω):
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 180px 1fr 80px 84px;
              gap: 8px;
              align-items: center;
            "
          >
            <label for="lrSlider">Learning rate (lr)</label>
            <div style="display: grid; grid-template-rows: auto auto; gap: 4px;">
              <input
                id="lrSlider"
                type="range"
                min="0.001"
                max="0.2"
                step="0.001"
                value="0.030"
                aria-label="Learning rate"
              />
              <div style="height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="lrBar" style="height: 100%; background: linear-gradient(90deg, #ff6b6b, #ff9f3d); width: 10%; transition: width 0.1s;"></div>
              </div>
            </div>
            <div><span id="lrVal">0.030</span></div>
            <label
              style="
                display: flex;
                gap: 6px;
                align-items: center;
                white-space: nowrap;
              "
              ><input id="lrAuto" type="checkbox" checked /> AUTO</label
            >

            <label for="l2Slider">L2-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è (l2)</label>
            <div style="display: grid; grid-template-rows: auto auto; gap: 4px;">
              <input
                id="l2Slider"
                type="range"
                min="0.0"
                max="0.01"
                step="0.0001"
                value="0.0001"
                aria-label="L2-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è"
              />
              <div style="height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="l2Bar" style="height: 100%; background: linear-gradient(90deg, #4ecdc4, #44b3aa); width: 1%; transition: width 0.1s;"></div>
              </div>
            </div>
            <div><span id="l2Val">0.0001</span></div>
            <label
              style="
                display: flex;
                gap: 6px;
                align-items: center;
                white-space: nowrap;
              "
              ><input id="l2Auto" type="checkbox" checked /> AUTO</label
            >

            <label for="mixSlider">–°–º–µ—à–∏–≤–∞–Ω–∏–µ NN/PI (mix)</label>
            <div style="display: grid; grid-template-rows: auto auto; gap: 4px;">
              <input
                id="mixSlider"
                type="range"
                min="0.0"
                max="1.0"
                step="0.01"
                value="0.75"
                aria-label="–°–º–µ—à–∏–≤–∞–Ω–∏–µ NN/PI"
              />
              <div style="height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="mixBar" style="height: 100%; background: linear-gradient(90deg, #a8e6cf, #56ab2f); width: 75%; transition: width 0.1s;"></div>
              </div>
            </div>
            <div><span id="mixVal">0.75</span></div>
            <label
              style="
                display: flex;
                gap: 6px;
                align-items: center;
                white-space: nowrap;
              "
              ><input id="mixAuto" type="checkbox" checked /> AUTO</label
            >
          </div>
          <div class="hint" style="margin-top: 8px">
            AUTO ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏; —Å–Ω–∏–º–∏—Ç–µ —Ñ–ª–∞–∂–æ–∫, —á—Ç–æ–±—ã
            —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Ä—É—á–Ω—É—é.
          </div>
        </div>

        <!-- –ù–û–í–û–ï: –ü–∞–Ω–µ–ª—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ -->
        <div
          class="row controls"
          style="
            margin-top: 18px;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border-color: var(--border);
            border: 1px solid var(--border);
          "
        >
          <div class="lbl" style="margin-top: 0">
            üìä –ù–µ–π—Ä–æ-–º–µ—Ç—Ä–∏–∫–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω–æ):
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 10px;
            "
          >
            <div>
              <div class="lbl">–†–µ—Å—É—Ä—Å—ã</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span
                  id="resourceValue"
                  style="font-weight: bold; min-width: 40px"
                  >0%</span
                >
                <div class="bar" style="flex: 1">
                  <div
                    id="resourceBar"
                    class="r"
                    style="background: #ff6b6b"
                  ></div>
                </div>
              </div>
            </div>
            <div>
              <div class="lbl">Learning Rate</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span
                  id="lrAdaptValue"
                  style="font-weight: bold; font-family: monospace"
                  >0.030</span
                >
                <span style="font-size: 11px; color: var(--text-secondary)"
                  >(–∞–≤—Ç–æ)</span
                >
              </div>
            </div>
            <div>
              <div class="lbl">Mix NN/PID</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span id="mixAdaptValue" style="font-weight: bold">0%</span>
                <span style="font-size: 11px; color: var(--text-secondary)"
                  >(–∞–≤—Ç–æ)</span
                >
              </div>
            </div>
            <div>
              <div class="lbl">Kp (–∞–¥–∞–ø—Ç.)</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span
                  id="KpAdaptValue"
                  style="font-weight: bold; font-family: monospace"
                  >0.000</span
                >
                <span style="font-size: 11px; color: var(--text-secondary)"
                  >(–∞–≤—Ç–æ)</span
                >
              </div>
            </div>
            <div>
              <div class="lbl">üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span id="HValue" style="font-weight: bold">4</span>
                <span style="font-size: 11px; color: var(--text-secondary)"
                  >H, D (—Å–∞–º–æ–∫–æ–Ω—Ç—Ä.)</span
                >
              </div>
            </div>
            <div>
              <div class="lbl">–ö–∞—á–µ—Å—Ç–≤–æ (1‚àíJ)</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span id="qualityValue" style="font-weight: bold">0%</span>
                <div class="bar" style="flex: 1">
                  <div id="qualityBar" class="c"></div>
                </div>
              </div>
            </div>
            <div>
              <div class="lbl">–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span
                  id="freezeStatusValue"
                  style="font-weight: bold; color: #00aa00"
                  >üîì Learning</span
                >
                <span style="font-size: 11px; color: var(--text-secondary)"
                  >freeze –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ</span
                >
              </div>
            </div>
            <div>
              <div class="lbl">–¢–æ—á–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <span
                  id="precisionValue"
                  style="font-weight: bold; font-family: monospace"
                  >float64</span
                >
                <span style="font-size: 11px; color: var(--text-secondary)"
                  >(–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è)</span
                >
              </div>
            </div>
          </div>
          <div class="hint" style="margin-top: 8px">
            ‚öôÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ç—å—é (—Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ
            –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–π—Ä–æ–Ω–æ–≤) –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏
            —Ä–µ—Å—É—Ä—Å–∞–º–∏. –í–µ—Å–∞ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ. –í—Å–µ
            –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã cost function –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω—ã.
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       –ù–ï–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô —Ä—É—á–Ω–æ–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫ (Responsive)
       –í–ù–ò–ú–ê–ù–ò–ï: –ß—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª, –∑–∞–º–µ–Ω–∏ data-ad-slot –Ω–∞ —Å–≤–æ–π –≤ –∫–∞–±–∏–Ω–µ—Ç–µ AdSense.
       –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Auto Ads ‚Äî –æ—Å—Ç–∞–≤—å —ç—Ç–æ—Ç –±–ª–æ–∫ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.
  <ins class="adsbygoogle ad-placeholder"
       data-ad-client="ca-pub-1128500581050725"
       data-ad-slot="REPLACE_WITH_YOUR_SLOT_ID_1"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

        <div id="info"></div>
        <div class="hint">
          –¶–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ ‚Äî J‚Üí0: |œÜ|, |Œîf|, Var(Œîf), |u|, (1‚àíconf), (1‚àíinertia)
          ‚Üí 0. –ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ —Å lock-–∑–∞—â–∏—Ç–æ–π –∏ –∞–≤—Ç–æ/—Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
          lr/l2/mix.
        </div>
      </div>

      <!-- –ß–∞—Ç —Å –æ—Ç–∑—ã–≤–∞–º–∏ -->
      <div class="chat-container">
        <div class="chat-header">
          <h3>üí¨ –û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        </div>

        <div class="filter-notice">
          üõ°Ô∏è –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º
        </div>

        <div class="online-count" id="onlineCount">
          <div class="online-counter">
            <div class="online-users">
              <div class="online-indicator"></div>
              <span id="onlineUsersCount">üë• –û–Ω–ª–∞–π–Ω: 1</span>
            </div>
            <div style="font-size: 11px">
              <span id="connectionStatus">–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...</span>
            </div>
          </div>
          <div class="users-list" id="onlineUsersList">
            üì± –í—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ —á–∞—Ç—É
          </div>
          <div
            id="connectionStability"
            style="font-size: 10px; margin-top: 2px; color: #666"
          ></div>
        </div>

        <div
          class="telegram-info"
          style="
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            font-size: 12px;
          "
        >
          üì± <strong>Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:</strong> –ß–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Telegram
          Bot API –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.<br />
          üîó <strong>–ê–∫—Ç–∏–≤–Ω—ã–π –∫–∞–Ω–∞–ª:</strong>
          <a href="https://t.me/noninput" target="_blank" style="color: #1976d2"
            >t.me/noninput</a
          >
          | ü§ñ <strong>–ë–æ—Ç:</strong>
          <a
            href="https://t.me/Inputlagthebot"
            target="_blank"
            style="color: #1976d2"
            >@Inputlagthebot</a
          ><br />
          <button
            onclick="multiUserChat.retryTelegramConnection()"
            style="
              margin-top: 5px;
              padding: 5px 10px;
              background: #2196f3;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram
          </button>
          <button
            onclick="multiUserChat.syncTelegramMessages()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #4caf50;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
          </button>
          <button
            onclick="multiUserChat.testTelegramSending()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #ff9800;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
          </button>
          <button
            onclick="multiUserChat.showTelegramDiagnostics()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #9c27b0;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram
          </button>
          <button
            onclick="multiUserChat.checkBotToken()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #e91e63;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üîë –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω
          </button>
          <button
            onclick="multiUserChat.checkChannelAccess()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #00bcd4;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üì¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–Ω–∞–ª
          </button>
          <button
            onclick="multiUserChat.checkBotSettings()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #9c27b0;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
          </button>
          <button
            onclick="multiUserChat.showVisitorStats()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #ff9800;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üìä –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ —Å–∞–π—Ç–∞
          </button>
          <button
            onclick="multiUserChat.showPageStats()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #795548;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          </button>
          <button
            onclick="multiUserChat.showGlobalStatsDetails()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #009688;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üåç –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </button>
          <button
            onclick="multiUserChat.testGlobalCounter()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #ff5722;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üß™ –¢–µ—Å—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ API
          </button>
          <button
            onclick="multiUserChat.forceUpdateGlobalCounter()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #4caf50;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
          </button>
          <button
            onclick="multiUserChat.diagnoseAPIIssues()"
            style="
              margin-left: 5px;
              padding: 5px 10px;
              background: #9c27b0;
              color: white;
              border: none;
              border-radius: 3px;
              cursor: pointer;
              font-size: 11px;
            "
          >
            üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API</button
          ><br />
          <details style="margin-top: 5px">
            <summary style="cursor: pointer; color: #1976d2">
              üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ –∏ –∫–∞–Ω–∞–ª–∞
            </summary>
            <div style="margin-top: 5px; padding: 5px">
              <strong>ü§ñ –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞:</strong><br />
              1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ @BotFather<br />
              2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot<br />
              3. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Frequency Scanner Chat Bot")<br />
              4. –í–≤–µ–¥–∏—Ç–µ username –±–æ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ "bot", –Ω–∞–ø—Ä–∏–º–µ—Ä:
              "frequency_scanner_bot")<br />
              5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (—Ñ–æ—Ä–º–∞—Ç:
              123456789:AAHxxxxxxxxxxxxxxxx)<br /><br />

              <strong
                >üì¢ –ì–¥–µ –≤–∑—è—Ç—å –∫–∞–Ω–∞–ª –¥–ª—è —á–∞—Ç–∞ - –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:</strong
              ><br /><br />

              <strong>–í–∞—Ä–∏–∞–Ω—Ç 1: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª</strong><br />
              1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏–ª–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ<br />
              2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ "+" –∏–ª–∏ "–ù–æ–≤—ã–π" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É<br />
              3. –í—ã–±–µ—Ä–∏—Ç–µ "–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª"<br />
              4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:<br />
              &nbsp;&nbsp;&nbsp;‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: "Frequency Scanner Chat"<br />
              &nbsp;&nbsp;&nbsp;‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: "–ß–∞—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
              Frequency Scanner"<br />
              5. –ù–∞–∂–º–∏—Ç–µ "–î–∞–ª–µ–µ"<br />
              6. –í—ã–±–µ—Ä–∏—Ç–µ "–ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª"<br />
              7. –ü—Ä–∏–¥—É–º–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä:
              frequency_scanner_chat)<br />
              8. –ù–∞–∂–º–∏—Ç–µ "–ì–æ—Ç–æ–≤–æ"<br /><br />

              <strong>–í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–∞–Ω–∞–ª</strong><br />
              1. –ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–∞–Ω–∞–ª - –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ<br />
              2. –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ (—Ç—Ä–∏ —Ç–æ—á–∫–∏ ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
              –∫–∞–Ω–∞–ª–æ–º")<br />
              3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–Ω–∞–ª –ø—É–±–ª–∏—á–Ω—ã–π<br />
              4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É (–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–∞ t.me/–≤–∞—à–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ)<br /><br />

              <strong>üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª:</strong><br />
              1. –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞<br />
              2. –í—ã–±–µ—Ä–∏—Ç–µ "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"<br />
              3. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"<br />
              4. –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ –ø–æ username (–∫–æ—Ç–æ—Ä—ã–π –≤—ã —Å–æ–∑–¥–∞–ª–∏ —á–µ—Ä–µ–∑
              @BotFather)<br />
              5. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –∏ –¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞:<br />
              &nbsp;&nbsp;&nbsp;‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π<br />
              &nbsp;&nbsp;&nbsp;‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π<br />
              &nbsp;&nbsp;&nbsp;‚úÖ –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π<br /><br />

              <strong>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –∫–æ–¥–µ:</strong><br />
              –ó–∞–º–µ–Ω–∏—Ç–µ –≤ —Ñ–∞–π–ª–µ noninput.html —Å—Ç—Ä–æ–∫–∏:<br />
              <code style="background: #f5f5f5; padding: 2px">
                botToken: '–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê',<br />
                chatId: '@–≤–∞—à–∞_—Å—Å—ã–ª–∫–∞_–∫–∞–Ω–∞–ª–∞' </code
              ><br /><br />

              <strong>üìù –ü—Ä–∏–º–µ—Ä—ã –≥–æ—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong
              ><br />
              ‚Ä¢ @InputlagTest - —Ç–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤<br />
              ‚Ä¢ @frequency_scanner_demo - –¥–µ–º–æ –∫–∞–Ω–∞–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç)<br />
              ‚Ä¢ @your_app_chat - —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª<br /><br />

              <strong>üí° –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong><br />
              ‚Ä¢ –ö–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <u>–ø—É–±–ª–∏—á–Ω—ã–º</u> (–Ω–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º)<br />
              ‚Ä¢ –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–Ω–∞–ª–∞<br />
              ‚Ä¢ –í chatId –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ @ –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º: '@–≤–∞—à_–∫–∞–Ω–∞–ª'<br />
              ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –≤ Telegram<br />
              ‚Ä¢ –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Ü–∏—Ñ—Ä—ã:
              '@my_chat_2024'<br /><br />

              <strong
                >üÜö –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –≤–º–µ—Å—Ç–æ –∫–∞–Ω–∞–ª–∞</strong
              ><br />
              –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –≥—Ä—É–ø–ø—É:<br />
              1. –°–æ–∑–¥–∞–π—Ç–µ "–ù–æ–≤—É—é –≥—Ä—É–ø–ø—É" –≤–º–µ—Å—Ç–æ –∫–∞–Ω–∞–ª–∞<br />
              2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É<br />
              3. –°–¥–µ–ª–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –ø—É–±–ª–∏—á–Ω–æ–π (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –¢–∏–ø –≥—Ä—É–ø–ø—ã ‚Üí
              –ü—É–±–ª–∏—á–Ω–∞—è)<br />
              4. –ü–æ–ª—É—á–∏—Ç–µ chat_id –≥—Ä—É–ø–ø—ã:<br />
              &nbsp;&nbsp;&nbsp;‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É<br />
              &nbsp;&nbsp;&nbsp;‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:
              https://api.telegram.org/bot–í–ê–®_–¢–û–ö–ï–ù/getUpdates<br />
              &nbsp;&nbsp;&nbsp;‚Ä¢ –ù–∞–π–¥–∏—Ç–µ "chat":{"id":-—á–∏—Å–ª–æ–≤–æ–π_id} –∏
              –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ<br /><br />

              <strong>üîç –ï–°–õ–ò –ù–ï –ü–û–î–ö–õ–Æ–ß–ê–ï–¢–°–Ø - –ü–†–û–í–ï–†–¨–¢–ï:</strong><br /><br />

              <strong style="color: #d32f2f"
                >‚ùå –ü—Ä–æ–±–ª–µ–º–∞: "–ù–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Telegram"</strong
              ><br />
              <strong>–†–µ—à–µ–Ω–∏–µ:</strong><br />
              1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram" –≤—ã—à–µ<br />
              2. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—à–∏–±–∫–∏<br />
              3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç @Inputlagthebot –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ /start<br /><br />

              <strong style="color: #d32f2f"
                >‚ùå –ü—Ä–æ–±–ª–µ–º–∞: "–ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –∫–∞–Ω–∞–ª"</strong
              ><br />
              <strong>–†–µ—à–µ–Ω–∏–µ:</strong><br />
              1. –û—Ç–∫—Ä–æ–π—Ç–µ
              <a href="https://t.me/noninput" target="_blank">t.me/noninput</a
              ><br />
              2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–º"<br />
              3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"<br />
              4. –î–æ–±–∞–≤—å—Ç–µ @Inputlagthebot —Å –ø—Ä–∞–≤–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π<br /><br />

              <strong style="color: #d32f2f"
                >‚ùå –ü—Ä–æ–±–ª–µ–º–∞: "–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"</strong
              ><br />
              <strong>–†–µ—à–µ–Ω–∏–µ:</strong><br />
              1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–∞–Ω–∞–ª @noninput —Å—É—â–µ—Å—Ç–≤—É–µ—Ç<br />
              2. –ö–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º (–Ω–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º)<br />
              3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª –∏ –æ–±–Ω–æ–≤–∏—Ç—å chatId –≤ –∫–æ–¥–µ<br /><br />

              <small style="color: #4caf50"
                >‚úÖ <strong>–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ:</strong> –ë–æ—Ç @Inputlagthebot ‚Üí –ö–∞–Ω–∞–ª
                t.me/noninput</small
              >
            </div>
          </details>
        </div>

        <div class="username-input">
          <label
            for="usernameInput"
            class="visually-hidden"
            style="position: absolute; left: -9999px"
            >–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label
          >
          <input
            type="text"
            id="usernameInput"
            placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
            maxlength="20"
            aria-label="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
          />
        </div>

        <div class="message-count">
          –°–æ–æ–±—â–µ–Ω–∏–π: <span id="messageCount">0</span>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message system">
            <div>
              –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç! –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ
              –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ Frequency Scanner.
            </div>
            <div class="message-meta">–°–∏—Å—Ç–µ–º–∞ ‚Ä¢ —Å–µ–π—á–∞—Å</div>
          </div>
        </div>

        <div class="chat-input">
          <label
            for="messageInput"
            class="visually-hidden"
            style="position: absolute; left: -9999px"
            >–°–æ–æ–±—â–µ–Ω–∏–µ</label
          >
          <input
            type="text"
            id="messageInput"
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
            maxlength="200"
            aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ"
          />
          <button id="sendButton" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </div>

    <!-- ====== –û–ü–ò–°–ê–ù–ò–Ø (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å) ====== -->
    <section
      id="how-it-works"
      style="
        max-width: 960px;
        margin: 24px auto;
        padding: 18px 20px;
        background: rgba(255, 255, 255, 0.35);
        color: var(--text);
        border-radius: 16px;
        box-shadow: 0 2px 22px var(--shadow);
        font:
          14px/1.55 system-ui,
          Segoe UI,
          Arial;
      "
    >
      <h2 style="margin: 0 0 12px">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
      <p>
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑–º–µ—Ä—è–µ—Ç ¬´–º–∏–∫—Ä–æ–¥—Ä–æ–∂–∞–Ω–∏–µ¬ª CPU, –∏–∑–≤–ª–µ–∫–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—ã (Goertzel),
        —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–∑—É (Kalman) –∏ –æ–Ω–ª–∞–π–Ω–æ–≤–æ–π –º–∏–Ω–∏-–Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –ø–æ–¥–±–∏—Ä–∞–µ—Ç
        –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, —Å—Ç—Ä–µ–º—è—Å—å –∫ <b>J‚Üí0</b>. –í—Å—Ç—Ä–æ–µ–Ω–∞ lock-–∑–∞—â–∏—Ç–∞ –æ—Ç
        –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.
      </p>
    </section>

    <section
      id="use-cases"
      style="
        max-width: 960px;
        margin: 24px auto;
        padding: 18px 20px;
        background: rgba(255, 255, 255, 0.35);
        color: var(--text);
        border-radius: 16px;
        box-shadow: 0 2px 22px var(--shadow);
        font:
          14px/1.55 system-ui,
          Segoe UI,
          Arial;
      "
    >
      <h2 style="margin: 0 0 12px">–ì–¥–µ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å</h2>
      <ul style="margin: 6px 0 0 18px">
        <li>
          –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–æ–≤/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–º–µ–Ω—å—à–µ –¥–∂–∏—Ç—Ç–µ—Ä–∞ ‚Üí –º–µ–Ω—å—à–µ –ª–∏—à–Ω–µ–≥–æ
          —Ç–µ–ø–ª–∞).
        </li>
        <li>
          –ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞/–∏–≥—Ä—ã: —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∞–≥–æ–≤ –∏ –∞–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –∫ —Ç–∏–∫—Ä–µ–π—Ç—É.
        </li>
        <li>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞/–§–ê–ü–ß/–®–ò–ú: –æ–Ω–ª–∞–π–Ω-–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤.</li>
      </ul>
    </section>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     –ù–ï–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô —Ä—É—á–Ω–æ–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Responsive)
     –ó–∞–º–µ–Ω–∏ data-ad-slot –Ω–∞ —Å–≤–æ–π. –î–ª—è Auto Ads —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ.
<ins class="adsbygoogle ad-placeholder"
     data-ad-client="ca-pub-1128500581050725"
     data-ad-slot="REPLACE_WITH_YOUR_SLOT_ID_2"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

    <script>
      /* ====================== –°–ò–°–¢–ï–ú–ê –¢–ï–ú ====================== */

      function initThemeSystem() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
        function getTimeOfDay() {
          const hour = new Date().getHours();
          if (hour >= 6 && hour < 12) return "morning"; // –£—Ç—Ä–æ
          if (hour >= 12 && hour < 18) return "afternoon"; // –î–µ–Ω—å
          if (hour >= 18 && hour < 21) return "evening"; // –í–µ—á–µ—Ä
          return "night"; // –ù–æ—á—å
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—É—é —Ç–µ–º—É
        function getPreferredTheme() {
          // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
          const savedTheme = localStorage.getItem("theme-preference");
          if (savedTheme) return savedTheme;

          // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ
          if (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
          ) {
            return "dark";
          }

          // 3. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–µ–º–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
          const timeOfDay = getTimeOfDay();
          if (timeOfDay === "night" || timeOfDay === "evening") {
            return "dark";
          }
          return "light";
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
        function applyTheme(theme) {
          const html = document.documentElement;
          const isDark = theme === "dark";

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç
          html.setAttribute("data-theme", theme);

          // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–Ω–æ–ø–∫–∏
          const themeToggle = document.getElementById("theme-toggle");
          const themeIcon = document.getElementById("theme-icon");
          const themeName = document.getElementById("theme-name");

          if (themeToggle) {
            if (isDark) {
              themeIcon.textContent = "‚òÄÔ∏è";
              themeName.textContent = "–°–≤–µ—Ç–ª–∞—è";
              themeToggle.title = "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É";
            } else {
              themeIcon.textContent = "üåô";
              themeName.textContent = "–¢–µ–º–Ω–∞—è";
              themeToggle.title = "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É";
            }
          }

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ
          localStorage.setItem("theme-preference", theme);
          localStorage.setItem("theme-set-at", new Date().toISOString());
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        function updateTime() {
          const timeDisplay = document.getElementById("time-display");
          if (timeDisplay) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            const seconds = String(now.getSeconds()).padStart(2, "0");

            const timeOfDay = getTimeOfDay();
            const timeEmoji = {
              morning: "üåÖ",
              afternoon: "‚òÄÔ∏è",
              evening: "üåÜ",
              night: "üåô",
            }[timeOfDay];

            timeDisplay.textContent = `${timeEmoji} ${hours}:${minutes}:${seconds}`;
          }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const preferredTheme = getPreferredTheme();
        applyTheme(preferredTheme);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        updateTime();
        setInterval(updateTime, 1000);

        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        const themeToggle = document.getElementById("theme-toggle");
        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const current =
              document.documentElement.getAttribute("data-theme") || "light";
            const next = current === "dark" ? "light" : "dark";
            applyTheme(next);
          });
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
        if (window.matchMedia) {
          const darkMode = window.matchMedia("(prefers-color-scheme: dark)");
          darkMode.addEventListener("change", (e) => {
            const userPref = localStorage.getItem("theme-preference");
            if (!userPref) {
              // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ, —Å–ª–µ–¥—É–µ–º —Å–∏—Å—Ç–µ–º–µ
              applyTheme(e.matches ? "dark" : "light");
            }
          });
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–º–µ–Ω—É –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(
          () => {
            const userPref = localStorage.getItem("theme-preference");
            if (!userPref) {
              // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
              const theme = getPreferredTheme();
              applyTheme(theme);
            }
          },
          5 * 60 * 1000,
        ); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
      }

      /* ====================== –ó–ê–©–ò–¢–ê –û–¢ –í–ó–õ–û–ú–ê ====================== */

      // –û–±—ä–µ–∫—Ç –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      window.SecurityManager = {
        // ===== XSS PROTECTION =====
        sanitizeHtml(str) {
          if (typeof str !== "string") return "";
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
            "/": "&#x2F;",
          };
          return str.replace(/[&<>"'\/]/g, (char) => map[char]);
        },

        sanitizeJSON(obj) {
          if (typeof obj === "string") return this.sanitizeHtml(obj);
          if (typeof obj === "object" && obj !== null) {
            if (Array.isArray(obj))
              return obj.map((item) => this.sanitizeJSON(item));
            const result = {};
            for (const key in obj) {
              if (obj.hasOwnProperty(key)) {
                result[key] = this.sanitizeJSON(obj[key]);
              }
            }
            return result;
          }
          return obj;
        },

        // ===== CSRF PROTECTION =====
        _csrfToken: null,
        generateCSRFToken() {
          return (
            "csrf_" +
            Array.from(crypto.getRandomValues(new Uint8Array(32)))
              .map((b) => b.toString(16).padStart(2, "0"))
              .join("")
          );
        },
        getCSRFToken() {
          if (!this._csrfToken) {
            this._csrfToken = this.generateCSRFToken();
            sessionStorage.setItem("csrf_token", this._csrfToken);
          }
          return this._csrfToken;
        },
        validateCSRFToken(token) {
          const stored = sessionStorage.getItem("csrf_token");
          return stored && token === stored;
        },

        // ===== RATE LIMITING =====
        _requestCounts: {},
        checkRateLimit(key, maxRequests = 10, windowMs = 60000) {
          const now = Date.now();
          if (!this._requestCounts[key]) {
            this._requestCounts[key] = [];
          }

          // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤–Ω–µ –æ–∫–Ω–∞
          this._requestCounts[key] = this._requestCounts[key].filter(
            (t) => now - t < windowMs,
          );

          if (this._requestCounts[key].length >= maxRequests) {
            console.warn(`‚ö†Ô∏è Rate limit exceeded for ${key}`);
            return false;
          }

          this._requestCounts[key].push(now);
          return true;
        },

        // ===== INPUT VALIDATION =====
        validateEmail(email) {
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return re.test(email);
        },

        validateUsername(username) {
          // –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ
          const re = /^[a-zA-Z0-9_]{1,32}$/;
          return re.test(username);
        },

        validateMessage(msg) {
          if (typeof msg !== "string") return false;
          if (msg.length < 1 || msg.length > 2000) return false;
          // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –æ–ø–∞—Å–Ω—ã–µ —Ç–µ–≥–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã
          if (/script|javascript:|onerror|onload|eval/i.test(msg)) return false;
          return true;
        },

        // ===== INJECTION PROTECTION =====
        validateURL(url) {
          try {
            const u = new URL(url);
            // –¢–æ–ª—å–∫–æ https –∏ http
            return ["https:", "http:"].includes(u.protocol);
          } catch (e) {
            return false;
          }
        },
      };

      /* ====================== CPU-—Å—ç–º–ø–ª–µ—Ä ====================== */

      // –°–∏—Å—Ç–µ–º–∞ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ —Å Firebase
      class MultiUserChatSystem {
        constructor() {
          this.messages = [];
          this.loadMessagesFromStorage(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          this.badWords = this.initBadWordsFilter();
          this.username = "";
          this.userId = this.generateUserId();
          this.onlineUsers = new Set();
          this.lastActivity = Date.now();
          this.isLocalMode = false; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF –∞—Ç–∞–∫
          this.csrfToken = window.SecurityManager.getCSRFToken();

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ö–æ—Å—Ç–∏–Ω–≥–∞ (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π GitHub Pages –∏ —Ç.–ø.)
          this.isStaticHost =
            /(?:^|\.)github\.io$/i.test(location.hostname) ||
            /(?:^|\.)githubpreview\.dev$/i.test(location.hostname) ||
            /(?:^|\.)github\.dev$/i.test(location.hostname);

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
          this.globalCounter = {
            apis: [
              // --- –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å—á—ë—Ç—á–∏–∫–∏ (—É–º–µ—é—Ç hit/get)
              {
                name: "CountAPI",
                type: "counter", // —É–º–µ–µ—Ç hit/get
                base: "https://api.countapi.xyz",
                hit: "/hit/{ns}/{key}",
                get: "/get/{ns}/{key}",
                cors: true,
                notes: "–ü—Ä–æ—Å—Ç–æ–π –ø—É–±–ª–∏—á–Ω—ã–π —Å—á—ë—Ç—á–∏–∫",
              },
              {
                name: "CounterAPI.dev",
                type: "counter",
                base: "https://api.counterapi.dev",
                hit: "/hit/{ns}/{key}",
                get: "/get/{ns}/{key}",
                cors: true,
                notes: "–ê–Ω–∞–ª–æ–≥ CountAPI",
              },

              // --- –î–∞–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ ¬´–ø–∏–Ω–≥–∏¬ª (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/CORS)
              {
                name: "ipify",
                type: "ping", // —Ç–æ–ª—å–∫–æ GET, –±–µ–∑ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
                base: "https://api.ipify.org",
                get: "/?format=json",
                cors: true,
                notes: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",
              },
              {
                name: "GitHubZen",
                type: "ping",
                base: "https://api.github.com",
                get: "/zen",
                cors: true,
                notes: "–ë—ã—Å—Ç—Ä—ã–π CORS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø–∏–Ω–≥",
              },
              {
                name: "JSONPlaceholder",
                type: "ping",
                base: "https://jsonplaceholder.typicode.com",
                get: "/posts/1",
                cors: true,
                notes: "–ü—É–±–ª–∏—á–Ω—ã–π JSON API –¥–ª—è –ø–∏–Ω–≥–∞",
              },
            ],

            // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
            apiUrls: [
              "https://api.countapi.xyz",
              "https://api.counterapi.dev",
              "https://api.ipify.org",
              "https://api.github.com",
              "https://jsonplaceholder.typicode.com",
            ],

            // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            namespace: "suslovpa-frequency-scanner",
            key: "global-visitors",

            currentApiIndex: 0, // –∏–Ω–¥–µ–∫—Å —Ä–∞–±–æ—á–µ–≥–æ API –∏–∑ –º–∞—Å—Å–∏–≤–∞ apis
            lastWorkingAPI: null, // —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–≤—à–∏–π –æ–±—ä–µ–∫—Ç API
            failedAPIs: new Set(), // –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö API
            isOnline: false,
            lastUpdate: 0,

            retryCount: 0,
            maxRetries: 8,

            // –†–µ–∂–∏–º—ã
            useHybridMode: true, // –≥–∏–±—Ä–∏–¥: —Ä–µ–∞–ª—å–Ω—ã–µ + —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            simulatedCount: 1247, // —Å—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
            successRate: 0, // % —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–ª—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏/–ª–æ–≥–æ–≤)

            // –¢–∞–π–º–∞—É—Ç—ã
            connectionTimeout: 12000, // 12 —Å–µ–∫
          };

          // –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–∞–π—Ç–∞
          this.initVisitorTracking();

          // –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          this.initPageCounter();

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
          this.initFirebase();
          this.updateMessageCount();

          // –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
          this.startGlobalCounter();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        initVisitorTracking() {
          console.log(
            "üåê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π...",
          );

          // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è)
          this._initVisitorTrackingAsync().catch((error) => {
            console.warn(
              "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:",
              error,
            );
          });
        }

        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        async _initVisitorTrackingAsync() {
          try {
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å—á–µ—Ç—á–∏–∫—É
            console.log("üåç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å—á–µ—Ç—á–∏–∫—É –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π...");

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            if (!this.globalCounter || !this.globalCounter.apis) {
              await this.initGlobalCounter();
            }

            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ
            await this.getVisitorInfo();

            console.log(
              "‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ",
            );
            return true;
          } catch (error) {
            console.warn(
              "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:",
              error,
            );
            return false;
          }
        }

        // –ü–æ–¥—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—É—Ç–∏ API
        _fmtPath(tpl, ns, key) {
          return tpl
            .replace("{ns}", encodeURIComponent(ns))
            .replace("{key}", encodeURIComponent(key));
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        async _fetchWithTimeout(url, timeoutMs) {
          const ctrl = new AbortController();
          const to = setTimeout(() => ctrl.abort(), timeoutMs);
          try {
            const res = await fetch(url, {
              signal: ctrl.signal,
              headers: { Accept: "application/json" },
            });
            return res;
          } finally {
            clearTimeout(to);
          }
        }

        // –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–æ —Å—á—ë—Ç—á–∏–∫–∞–º–∏/–ø–∏–Ω–≥–∞–º–∏
        async requestCounter(api, action /* 'hit' | 'get' | 'ping' */) {
          // –ú–µ—Ç–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è
          return { ok: false, error: "API disabled" };
        }

        // –£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–Ω–Ω–µ–∫—Ç —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º ¬´—Ä–µ–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏¬ª ‚Üí ¬´–ø–∏–Ω–≥–∏¬ª ‚Üí ¬´—Å–∏–º—É–ª—è—Ü–∏—è¬ª
        // –í–∞—Ä–∏–∞–Ω—Ç v1: –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤ ‚Üí –ø–∏–Ω–≥ ‚Üí —Å–∏–º—É–ª—è—Ü–∏—è
        async connectToGlobalAPI_v1() {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é (CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ API)
          console.log(
            "üé≠ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å—á–µ—Ç—á–∏–∫—É (—Ä–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏)",
          );

          const cfg = this.globalCounter;
          const sim = await this.simulateGlobalCounter();

          cfg.isOnline = true;
          cfg.lastUpdate = Date.now();
          cfg.retryCount = 0;

          this.updateGlobalStatsWidget(sim, true, null, "—Å–∏–º—É–ª—è—Ü–∏—è");
          // –û—Ç–∫–ª—é—á–∞–µ–º getVisitorInfo - –≤—ã–∑—ã–≤–∞–µ—Ç CORS –æ—à–∏–±–∫–∏
          // this.getVisitorInfo?.();

          return true;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—Ä–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ + API)
        startGlobalCounterUpdates_v1() {
          const tick = async () => {
            try {
              // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å API (–±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è)
              const count = await this.getVisitCount?.();
              this.globalCounter.lastUpdate = Date.now();
              this.updateGlobalStatsWidget(count, true, null, "—Ä–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫");
            } catch (e) {
              console.debug("Update error:", e.message);
            }
          };

          // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å—Ä–∞–∑—É - –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–∏–∑–∏—Ç
          (async () => {
            try {
              const count = await this.recordVisit?.();
              this.globalCounter.lastUpdate = Date.now();
              this.updateGlobalStatsWidget(count, true, null, "—Ä–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫");
            } catch (e) {
              console.debug("Initial visit recording error:", e.message);
            }
          })();

          // –¥–∞–ª–µ–µ –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É (–∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥)
          this._globalCounterTimer && clearInterval(this._globalCounterTimer);
          this._globalCounterTimer = setInterval(tick, 15000);
        }

        // –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
        startGlobalCounter() {
          try {
            Promise.resolve()
              .then(() => this.connectToGlobalAPI())
              .then(() =>
                this.isStaticHost
                  ? this.startGlobalCounterUpdates_v1()
                  : this.startGlobalCounterUpdates(),
              );
          } catch (e) {
            console.warn("Global counter v1 start error:", e);
          }
        }

        // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω–Ω–µ–∫—Ç (–æ–±–ª–µ–≥—á—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è Vercel)
        async connectToGlobalAPI() {
          if (this.isStaticHost) {
            return this.connectToGlobalAPI_v1();
          }

          // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—á–∏–π —Å—á—ë—Ç—á–∏–∫ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏
          const candidates = this.globalCounter?.apiUrls || [
            "https://api.countapi.xyz",
            "https://api.counterapi.dev",
          ];

          for (const apiUrl of candidates) {
            try {
              const res = await this.makeSecureAPIRequest(apiUrl, "get");
              if (res && res.success) {
                const value = res.value;
                this.globalCounter.isOnline = true;
                this.globalCounter.lastUpdate = Date.now();
                this.globalCounter.lastWorkingAPI = {
                  url: apiUrl,
                  name: this.getAPIName(apiUrl),
                };
                this.updateGlobalStatsWidget(value, true, null, "api");
                console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å—á—ë—Ç—á–∏–∫—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä: ${apiUrl}`);
                return true;
              }
            } catch (e) {
              // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º
            }
          }

          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –≤–∫–ª—é—á–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
          this.activateHybridMode?.();
          return true;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
        async initGlobalCounter() {
          console.log("üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞...");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ globalCounter
          if (!this.globalCounter) {
            console.warn(
              "‚ö†Ô∏è globalCounter –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...",
            );
            this.globalCounter = {
              apis: [
                // --- –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å—á—ë—Ç—á–∏–∫–∏ (—É–º–µ—é—Ç hit/get)
                {
                  name: "CountAPI",
                  type: "counter", // —É–º–µ–µ—Ç hit/get
                  base: "https://api.countapi.xyz",
                  hit: "/hit/{ns}/{key}",
                  get: "/get/{ns}/{key}",
                  cors: true,
                  notes: "–ü—Ä–æ—Å—Ç–æ–π –ø—É–±–ª–∏—á–Ω—ã–π —Å—á—ë—Ç—á–∏–∫",
                },
                {
                  name: "CounterAPI.dev",
                  type: "counter",
                  base: "https://api.counterapi.dev",
                  hit: "/hit/{ns}/{key}",
                  get: "/get/{ns}/{key}",
                  cors: true,
                  notes: "–ê–Ω–∞–ª–æ–≥ CountAPI",
                },

                // --- –î–∞–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ ¬´–ø–∏–Ω–≥–∏¬ª (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/CORS)
                {
                  name: "ipify",
                  type: "ping", // —Ç–æ–ª—å–∫–æ GET, –±–µ–∑ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
                  base: "https://api.ipify.org",
                  get: "/?format=json",
                  cors: true,
                  notes: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",
                },
                {
                  name: "GitHubZen",
                  type: "ping",
                  base: "https://api.github.com",
                  get: "/zen",
                  cors: true,
                  notes: "–ë—ã—Å—Ç—Ä—ã–π CORS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø–∏–Ω–≥",
                },
                {
                  name: "JSONPlaceholder",
                  type: "ping",
                  base: "https://jsonplaceholder.typicode.com",
                  get: "/posts/1",
                  cors: true,
                  notes: "–ü—É–±–ª–∏—á–Ω—ã–π JSON API –¥–ª—è –ø–∏–Ω–≥–∞",
                },
              ],

              // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
              apiUrls: [
                "https://api.countapi.xyz",
                "https://api.counterapi.dev",
                "https://api.ipify.org",
                "https://api.github.com",
                "https://jsonplaceholder.typicode.com",
              ],

              // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
              namespace: "suslovpa-frequency-scanner",
              key: "global-visitors",

              currentApiIndex: 0, // –∏–Ω–¥–µ–∫—Å —Ä–∞–±–æ—á–µ–≥–æ API –∏–∑ –º–∞—Å—Å–∏–≤–∞ apis
              lastWorkingAPI: null, // —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–≤—à–∏–π –æ–±—ä–µ–∫—Ç API
              failedAPIs: new Set(), // –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö API
              isOnline: false,
              lastUpdate: 0,

              retryCount: 0,
              maxRetries: 8,

              // –†–µ–∂–∏–º—ã
              useHybridMode: true, // –≥–∏–±—Ä–∏–¥: —Ä–µ–∞–ª—å–Ω—ã–µ + —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
              simulatedCount: 1247, // —Å—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
              successRate: 0, // % —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–ª—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏/–ª–æ–≥–æ–≤)

              // –¢–∞–π–º–∞—É—Ç—ã
              connectionTimeout: 12000, // 12 —Å–µ–∫
            };
          }

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∞)
          if (typeof this.showGlobalCounterLoadingState === "function") {
            this.showGlobalCounterLoadingState("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞...");
          } else {
            console.log(
              "üìä –°—Ç–∞—Ç—É—Å –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞...",
            );
          }

          console.log("‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
          return true;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
        showGlobalCounterLoadingState(message) {
          console.log("üìä –°—Ç–∞—Ç—É—Å –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞:", message);

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –∑–∞–≥—Ä—É–∑–∫–µ
          const widget = document.getElementById("globalStatsWidget");
          if (widget) {
            const loadingDiv = widget.querySelector(
              'div[style*="text-align: center"]',
            );
            if (loadingDiv) {
              loadingDiv.innerHTML = `
          <div style="text-align: center; opacity: 0.7;">
            <div>‚è≥ ${message}</div>
            <div class="loading-status" style="font-size: 11px; margin-top: 5px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
          </div>
        `;
            }
          }

          // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏
          console.log(`üîÑ ${message}`);
        }

        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É API —Å—á–µ—Ç—á–∏–∫–∞
        async connectToGlobalAPIImproved() {
          const config = this.globalCounter;

          console.log(
            "üåç –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–º API —Å—á–µ—Ç—á–∏–∫–æ–≤...",
          );

          // –§–∞–∑–∞ 0: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ API
          this.updateLoadingStatus("üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è API –ø–æ—Ä—è–¥–∫–∞...");
          const optimized = await this.optimizeAPIOrder();
          if (optimized) {
            console.log(
              "‚úÖ API –ø–æ—Ä—è–¥–æ–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
            );
          }

          // –§–∞–∑–∞ 1: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º
          const internetCheck = await this.performQuickInternetCheck();
          if (!internetCheck.success) {
            console.warn("üö´ –ù–µ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
            this.activateOfflineMode("–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞");
            return false;
          }

          console.log(
            `‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç: ${internetCheck.workingServices}/${internetCheck.totalTested} —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã`,
          );
          this.updateLoadingStatus(
            `üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (${internetCheck.workingServices}/${internetCheck.totalTested} —Å–µ—Ä–≤–∏—Å–æ–≤)`,
          );

          // –§–∞–∑–∞ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö API —Å—á–µ—Ç—á–∏–∫–æ–≤
          const workingAPIs = [];
          let bestAPI = null;

          for (
            let apiIndex = 0;
            apiIndex < Math.min(6, config.apiUrls.length);
            apiIndex++
          ) {
            try {
              const apiUrl = config.apiUrls[apiIndex];

              this.updateLoadingStatus(
                `üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API ${apiIndex + 1}/${Math.min(6, config.apiUrls.length)}: ${this.getAPIName(apiUrl)}`,
              );
              console.log(
                `üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API ${apiIndex + 1}: ${apiUrl}`,
              );

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ API —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è —Ä–∞–Ω–µ–µ
              if (config.failedAPIs.has(apiUrl)) {
                console.log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–Ω–µ–µ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π API: ${apiUrl}`);
                continue;
              }

              const result = await this.testAPIEndpoint(
                apiUrl,
                "hit",
                config.connectionTimeout,
              );

              if (
                result.success &&
                result.data &&
                (result.data.value !== undefined ||
                  result.data.count !== undefined)
              ) {
                workingAPIs.push({
                  index: apiIndex,
                  url: apiUrl,
                  data: result.data,
                  responseTime: result.responseTime,
                });

                if (!bestAPI || result.responseTime < bestAPI.responseTime) {
                  bestAPI = {
                    index: apiIndex,
                    url: apiUrl,
                    data: result.data,
                    responseTime: result.responseTime,
                  };
                }

                console.log(
                  `‚úÖ API ${apiIndex + 1} —Ä–∞–±–æ—Ç–∞–µ—Ç: ${result.data.value || result.data.count} (${result.responseTime}–º—Å)`,
                );
              } else {
                config.failedAPIs.add(apiUrl);
                console.log(
                  `‚ùå API ${apiIndex + 1} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${result.error}`,
                );
              }
            } catch (error) {
              config.failedAPIs.add(config.apiUrls[apiIndex]);
              console.warn(`‚ùå API ${apiIndex + 1} –æ—à–∏–±–∫–∞:`, error.message);
            }
          }

          // –§–∞–∑–∞ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          if (bestAPI) {
            // –ù–∞–π–¥–µ–Ω —Ä–∞–±–æ—Ç–∞—é—â–∏–π API
            config.currentApiIndex = bestAPI.index;
            config.lastWorkingAPI = bestAPI;
            config.isOnline = true;
            config.lastUpdate = Date.now();
            config.retryCount = 0;
            config.successRate =
              (workingAPIs.length / Math.min(6, config.apiUrls.length)) * 100;

            const value = bestAPI.data.value || bestAPI.data.count || 1247;

            console.log(
              `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API: ${value} –ø–æ—Å–µ—â–µ–Ω–∏–π (${bestAPI.responseTime}–º—Å)`,
            );
            this.updateGlobalStatsWidget(value, true, null, "api");

            // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            await this.getVisitorInfo();

            return true;
          } else {
            // –§–∞–∑–∞ 4: Fallback –∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º –º–µ—Ç–æ–¥–∞–º
            console.log(
              "üîÑ –û—Å–Ω–æ–≤–Ω—ã–µ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã...",
            );

            const fallbackSuccess = await this.tryFallbackMethods();
            if (fallbackSuccess) {
              return true;
            }

            // –§–∞–∑–∞ 5: –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º (—Å–∏–º—É–ª—è—Ü–∏—è + –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
            console.log("üé≠ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞...");
            this.activateHybridMode();
            return true;
          }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞
        async testAPIEndpoint(apiUrl, action = "get", timeout = 8000) {
          const startTime = performance.now();

          try {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è –∫–∞–∂–¥–æ–≥–æ API
            let testUrl;
            if (apiUrl.includes("countapi.xyz")) {
              testUrl =
                action === "hit"
                  ? `${apiUrl}/hit/frequency-scanner/global`
                  : `${apiUrl}/get/frequency-scanner/global`;
            } else if (apiUrl.includes("counterapi.dev")) {
              testUrl =
                action === "hit"
                  ? `${apiUrl}/v1/frequency-scanner/global/up`
                  : `${apiUrl}/v1/frequency-scanner/global`;
            } else if (apiUrl.includes("counter-api.dev")) {
              testUrl = `${apiUrl}/api/frequency-scanner/global`;
            } else if (apiUrl.includes("httpbin.org")) {
              testUrl = `${apiUrl}/uuid`;
            } else if (apiUrl.includes("api.github.com")) {
              testUrl = `${apiUrl}/zen`;
            } else if (apiUrl.includes("jsonplaceholder.typicode.com")) {
              testUrl = `${apiUrl}`;
            } else {
              testUrl = `${apiUrl}/test`;
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const response = await fetch(testUrl, {
              method:
                apiUrl.includes("counter-api.dev") && action === "hit"
                  ? "POST"
                  : "GET",
              signal: controller.signal,
              headers: {
                Accept: "application/json",
                "Cache-Control": "no-cache",
                "User-Agent": "Mozilla/5.0 (compatible; GlobalCounter/2.0)",
              },
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`,
              );
            }

            const responseTime = Math.round(performance.now() - startTime);

            try {
              const data = await response.json();
              return {
                success: true,
                data: data,
                responseTime: responseTime,
                url: testUrl,
              };
            } catch (jsonError) {
              // –ï—Å–ª–∏ –Ω–µ JSON, –Ω–æ —Å—Ç–∞—Ç—É—Å OK, —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º
              const text = await response.text();
              return {
                success: true,
                data: { value: 1000 + Math.floor(Math.random() * 500) }, // –°–ª—É—á–∞–π–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è non-JSON –æ—Ç–≤–µ—Ç–æ–≤
                responseTime: responseTime,
                url: testUrl,
                rawResponse: text,
              };
            }
          } catch (error) {
            const responseTime = Math.round(performance.now() - startTime);
            return {
              success: false,
              error: error.message,
              responseTime: responseTime,
              url: testUrl,
            };
          }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ API
        getAPIName(url) {
          if (url.includes("visitorbadge.io")) return "VisitorBadge ‚ú®";
          if (url.includes("httpbin.org")) return "HTTPBin üîó";
          if (url.includes("api.github.com")) return "GitHub API üêô";
          if (url.includes("jsonplaceholder")) return "JSONPlaceholder üìù";
          if (url.includes("reqres.in")) return "ReqRes API üß™";
          if (url.includes("api.ipify.org")) return "Ipify API üåê";
          if (url.includes("countapi.xyz")) return "CountAPI üìä";
          if (url.includes("counterapi.dev")) return "CounterAPI üî¢";
          if (url.includes("counter-api.dev")) return "Counter-API ‚ö°";
          if (url.includes("hits.dwyl.com")) return "Hits DWYL üí•";
          if (url.includes("webstats.motigo.com")) return "Motigo Stats üìà";
          if (url.includes("statcounter.com")) return "StatCounter üìã";
          if (url.includes("freecounterstat.com")) return "FreeCounterStat üÜì";
          return "API üîó";
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        activateHybridMode() {
          const config = this.globalCounter;

          config.useHybridMode = true;
          config.isOnline = true; // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–Ω–ª–∞–π–Ω –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ
          config.lastUpdate = Date.now();

          // –ó–∞–ø—É—Å–∫–∞–µ–º —É–º–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é
          const hybridCount = this.generateIntelligentCounter();

          this.updateGlobalStatsWidget(hybridCount, true, null, "–≥–∏–±—Ä–∏–¥–Ω—ã–π");
          console.log(
            `üé≠ –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ${hybridCount} –ø–æ—Å–µ—â–µ–Ω–∏–π`,
          );

          // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–∞–∂–µ –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ
          this.getVisitorInfo();

          // –ü–ª–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ä–µ–∞–ª—å–Ω—ã–º API
          this.scheduleReconnectionAttempts();
        }

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞
        activateOfflineMode(reason) {
          const config = this.globalCounter;

          config.isOnline = false;
          config.lastUpdate = Date.now();

          const offlineCount = this.initLocalCounter();

          this.updateGlobalStatsWidget(offlineCount, false, null, "–æ—Ñ–ª–∞–π–Ω");
          console.log(
            `üì¥ –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º: ${offlineCount} –ø–æ—Å–µ—â–µ–Ω–∏–π (–ø—Ä–∏—á–∏–Ω–∞: ${reason})`,
          );
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        generateIntelligentCounter() {
          try {
            const now = new Date();

            // –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã
            const dayOfYear = Math.floor(
              (now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24),
            );
            const hourOfDay = now.getHours();

            // –°—É—Ç–æ—á–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const activityMultiplier =
              this.getDailyActivityMultiplier(hourOfDay);

            // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º
            const baseKey = "intelligent_counter_base";
            let baseCount = parseInt(localStorage.getItem(baseKey) || "0");

            if (baseCount === 0) {
              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
              baseCount =
                1100 + dayOfYear * 2 + Math.floor(Math.random() * 200);
              localStorage.setItem(baseKey, baseCount.toString());
            }

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å —É—á–µ—Ç–æ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const visitKey = "intelligent_visit_increment";
            const lastVisit = parseInt(localStorage.getItem(visitKey) || "0");
            const currentTime = Date.now();

            if (currentTime - lastVisit > 30000) {
              // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
              const increment = Math.floor(
                activityMultiplier * (Math.random() * 4 + 1),
              ); // +1-5 —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏
              baseCount += increment;
              localStorage.setItem(baseKey, baseCount.toString());
              localStorage.setItem(visitKey, currentTime.toString());

              console.log(
                `üìä –£–º–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ ${increment} (–≤—Ä–µ–º—è: ${hourOfDay}:00, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${activityMultiplier.toFixed(2)})`,
              );
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è
            const variance = Math.floor((Math.random() - 0.5) * 6); // ¬±3
            const finalCount = Math.max(1000, baseCount + variance);

            this.globalCounter.simulatedCount = finalCount;
            return finalCount;
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–º–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞:", error);
            return 1247; // Fallback –∑–Ω–∞—á–µ–Ω–∏–µ
          }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
        getDailyActivityMultiplier(hour) {
          // –ú–æ–¥–µ–ª–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è
          const activityPattern = {
            0: 0.3,
            1: 0.2,
            2: 0.15,
            3: 0.1,
            4: 0.1,
            5: 0.2,
            6: 0.4,
            7: 0.7,
            8: 1.0,
            9: 1.2,
            10: 1.3,
            11: 1.4,
            12: 1.5,
            13: 1.4,
            14: 1.3,
            15: 1.2,
            16: 1.1,
            17: 1.0,
            18: 0.9,
            19: 0.8,
            20: 0.9,
            21: 1.0,
            22: 0.7,
            23: 0.5,
          };

          return activityPattern[hour] || 1.0;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
        initLocalCounter() {
          const localKey = "local_visitor_counter";
          let localCount = parseInt(localStorage.getItem(localKey) || "0");

          if (localCount === 0) {
            localCount = 800 + Math.floor(Math.random() * 400); // 800-1200
          }

          // –ù–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏
          localCount += Math.floor(Math.random() * 3) + 1;
          localStorage.setItem(localKey, localCount.toString());

          return localCount;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ API –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        async optimizeAPIOrder() {
          console.log("üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ API –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...");

          const config = this.globalCounter;
          const testResults = [];

          // –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Å–µ API —Å —Ç–∞–π–º–∞—É—Ç–æ–º
          for (let i = 0; i < config.apiUrls.length; i++) {
            const apiUrl = config.apiUrls[i];
            try {
              const startTime = Date.now();
              const result = await this.testAPIEndpoint(apiUrl, "get", 3000);
              const responseTime = Date.now() - startTime;

              testResults.push({
                url: apiUrl,
                success: result.success,
                responseTime: responseTime,
                score: result.success ? 1000 - responseTime : -1000, // –ë—ã—Å—Ç—Ä—ã–µ API –ø–æ–ª—É—á–∞—é—Ç –≤—ã—Å–æ–∫–∏–π –±–∞–ª–ª
              });
            } catch (error) {
              testResults.push({
                url: apiUrl,
                success: false,
                responseTime: 99999,
                score: -1000,
              });
            }
          }

          // –°–æ—Ä—Ç–∏—Ä—É–µ–º API –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—É—Å–ø–µ—à–Ω—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏)
          testResults.sort((a, b) => b.score - a.score);

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ API
          config.apiUrls = testResults.map((result) => result.url);

          const workingAPIs = testResults.filter((r) => r.success);
          console.log(
            `‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${workingAPIs.length}/${testResults.length} API —Ä–∞–±–æ—Ç–∞—é—Ç`,
          );

          if (workingAPIs.length > 0) {
            const bestAPI = workingAPIs[0];
            console.log(
              `üöÄ –õ—É—á—à–∏–π API: ${this.getAPIName(bestAPI.url)} (${bestAPI.responseTime}–º—Å)`,
            );

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ª—É—á—à–∏–π API
            config.currentApiIndex = 0;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            if (workingAPIs.length >= 3) {
              console.log(
                `üéØ –û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${workingAPIs.length} –±—ã—Å—Ç—Ä—ã—Ö API –¥–æ—Å—Ç—É–ø–Ω—ã`,
              );
            } else if (workingAPIs.length >= 1) {
              console.log(
                `‚ö° –ù–∞–π–¥–µ–Ω—ã —Ä–∞–±–æ—á–∏–µ API: ${workingAPIs.length} –∏–∑ ${testResults.length}`,
              );
            }

            return true;
          }

          return false;
        }

        // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        scheduleReconnectionAttempts() {
          // –ü–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
          setInterval(async () => {
            if (this.globalCounter.useHybridMode) {
              console.log("üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ä–µ–∞–ª—å–Ω—ã–º API...");

              // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö API –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
              this.globalCounter.failedAPIs.clear();

              // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –æ–¥–Ω–æ–º—É –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö API
              const testResult = await this.testAPIEndpoint(
                this.globalCounter.apiUrls[0],
                "get",
                5000,
              );

              if (
                testResult.success &&
                testResult.data &&
                testResult.data.value !== undefined
              ) {
                console.log("‚úÖ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API —É—Å–ø–µ—à–Ω–æ!");

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API
                this.globalCounter.useHybridMode = false;
                this.globalCounter.isOnline = true;
                this.globalCounter.lastUpdate = Date.now();
                this.globalCounter.currentApiIndex = 0;

                this.updateGlobalStatsWidget(
                  testResult.data.value,
                  true,
                  null,
                  "api",
                );

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
                this.showReconnectionNotice();
              }
            }
          }, 120000); // –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        showReconnectionNotice() {
          const notice = document.createElement("div");
          notice.style.cssText = `
      position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #4CAF50, #45a049); 
      color: white; padding: 16px; border-radius: 12px; z-index: 1000;
      font-family: system-ui; font-size: 12px; max-width: 300px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
    `;

          notice.innerHTML = `
      <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <div style="font-size: 18px; margin-right: 8px;">üéâ</div>
        <div style="font-weight: bold;">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!</div>
      </div>
      <div style="line-height: 1.4;">
        –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API —Å—á–µ—Ç—á–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
      </div>
    `;

          document.body.appendChild(notice);

          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
          setTimeout(() => {
            if (notice.parentElement) {
              notice.style.transition =
                "opacity 0.5s ease, transform 0.5s ease";
              notice.style.opacity = "0";
              notice.style.transform = "translateY(-100%)";
              setTimeout(() => notice.remove(), 500);
            }
          }, 5000);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
        updateLoadingStatus(message) {
          const widget = document.getElementById("globalStatsWidget");
          if (!widget) return;

          const statusElement = widget.querySelector(".loading-status");
          if (statusElement) {
            statusElement.textContent = message;
          } else {
            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
            const loadingDiv = widget.querySelector(
              'div[style*="text-align: center"]',
            );
            if (loadingDiv) {
              const statusDiv = loadingDiv.querySelector(
                'div[style*="opacity: 0.7"]',
              );
              if (statusDiv) {
                statusDiv.innerHTML = `<div class="loading-status">${message}</div>`;
              }
            }
          }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö API
        async testFallbackAPI(fallbackAPI) {
          console.log(`üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ API: ${fallbackAPI.name}`);

          try {
            const response = await fetch(fallbackAPI.url, {
              method: "GET",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              timeout: 5000,
            });

            if (response.ok) {
              return {
                success: true,
                name: fallbackAPI.name,
                url: fallbackAPI.url,
              };
            } else {
              throw new Error(`HTTP ${response.status}`);
            }
          } catch (error) {
            console.log(
              `‚ùå –†–µ–∑–µ—Ä–≤–Ω—ã–π API ${fallbackAPI.name} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:`,
              error.message,
            );
            return {
              success: false,
              error: error.message,
              name: fallbackAPI.name,
            };
          }
        }

        // –†–µ–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç API –Ω–∞ Vercel)
        async recordVisit() {
          try {
            const response = await fetch('/api/counter?action=increment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                source: 'noninput-app',
                referrer: document.referrer || 'direct',
                userId: this.getCurrentUserId?.() || null
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.ok) {
              console.log(`‚úÖ –†–µ–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π: ${data.count}`);
              this.globalCounter.simulatedCount = data.count;
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
              localStorage.setItem('real_page_visits_counter', data.count.toString());
              localStorage.setItem('counter_last_sync', new Date().toISOString());
              
              return data.count;
            }
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤–∏–∑–∏—Ç–∞:", error);
            
            // Fallback –Ω–∞ localStorage –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            return this.simulateGlobalCounterLocal();
          }
        }

        // –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è)
        async simulateGlobalCounterLocal() {
          try {
            const COUNTER_KEY = "real_page_visits_counter";
            let visitCount = parseInt(localStorage.getItem(COUNTER_KEY) || "1215");

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π
            visitCount++;
            localStorage.setItem(COUNTER_KEY, visitCount.toString());

            console.log(`üì± –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ (API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω): ${visitCount}`);
            this.globalCounter.simulatedCount = visitCount;
            return visitCount;
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞:", error);
            return 1215;
          }
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å API
        async getVisitCount() {
          try {
            const response = await fetch('/api/counter?action=get', {
              method: 'GET'
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.ok) {
              console.log(`üîç –ü–æ–ª—É—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å API: ${data.count}`);
              this.globalCounter.simulatedCount = data.count;
              return data.count;
            }
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞:", error);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const localCount = parseInt(localStorage.getItem('real_page_visits_counter') || '1215');
            console.log(`üì± –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${localCount}`);
            return localCount;
          }
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—á–µ—Ç—á–∏–∫–∞
        async getCounterStats() {
          try {
            const response = await fetch('/api/counter', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'stats' })
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
            return null;
          }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        async simulateGlobalCounter() {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π API —Å—á–µ—Ç—á–∏–∫
          return await this.recordVisit() || await this.simulateGlobalCounterLocal();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        getDemoCount() {
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –¥–µ–º–æ-–∑–Ω–∞—á–µ–Ω–∏–µ
          const now = new Date();
          const dayOfYear = Math.floor(
            (now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24),
          );

          // –°–æ–∑–¥–∞–µ–º "—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π" —Å—á–µ—Ç—á–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–Ω—è –≥–æ–¥–∞
          return 1000 + dayOfYear * 3 + Math.floor(Math.random() * 50);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ —Å–∏–º—É–ª—è—Ü–∏–∏
        showSimulationNotice() {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          if (localStorage.getItem("simulation_notice_shown")) {
            return;
          }

          setTimeout(() => {
            const notice = document.createElement("div");
            notice.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #ff9800, #f57c00); 
        color: white; padding: 16px; border-radius: 12px; z-index: 1000;
        font-family: system-ui; font-size: 12px; max-width: 320px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
      `;

            notice.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <div style="font-size: 20px; margin-right: 8px;">üé≠</div>
          <div style="font-weight: bold; font-size: 14px;">–†–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏ –∞–∫—Ç–∏–≤–µ–Ω</div>
        </div>
        <div style="margin-bottom: 12px; line-height: 1.4;">
          –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ API —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∞—Å—å –≤ —Ä–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏ —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 11px;">
          <strong>üìä –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
          ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–µ—â–µ–Ω–∏–π<br>
          ‚Ä¢ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞<br>
          ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è<br>
          ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="multiUserChat.diagnoseAPIIssues()" 
                  style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; 
                         padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
            üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
          </button>
          <button onclick="this.closest('[style*=fixed]').remove(); localStorage.setItem('simulation_notice_shown', 'true')" 
                  style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; 
                         padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
            ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ
          </button>
        </div>
      `;

            document.body.appendChild(notice);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
              if (notice.parentElement) {
                notice.style.transition =
                  "opacity 0.5s ease, transform 0.5s ease";
                notice.style.opacity = "0";
                notice.style.transform = "translateX(100%)";
                setTimeout(() => {
                  notice.remove();
                  localStorage.setItem("simulation_notice_shown", "true");
                }, 500);
              }
            }, 15000);
          }, 2000);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ API —Å—á–µ—Ç—á–∏–∫–æ–≤
        showAPIBlockedNotice() {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          if (localStorage.getItem("api_blocked_notice_shown")) {
            return;
          }

          setTimeout(() => {
            const notice = document.createElement("div");
            notice.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #f44336, #d32f2f); 
        color: white; padding: 16px; border-radius: 12px; z-index: 1000;
        font-family: system-ui; font-size: 12px; max-width: 340px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
      `;

            notice.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <div style="font-size: 20px; margin-right: 8px;">üö´</div>
          <div style="font-weight: bold; font-size: 14px;">API —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</div>
        </div>
        <div style="margin-bottom: 12px; line-height: 1.4;">
          –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –≤—Å–µ API —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 11px;">
          <strong>üö´ –ü—Ä–∏—á–∏–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:</strong><br>
          ‚Ä¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–π—Ä–≤–æ–ª –±–ª–æ–∫–∏—Ä—É–µ—Ç API<br>
          ‚Ä¢ –ü—Ä–æ–≤–∞–π–¥–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å—á–µ—Ç—á–∏–∫–∞–º<br>
          ‚Ä¢ –ì–µ–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ<br>
          ‚Ä¢ –ê–Ω—Ç–∏–≤–∏—Ä—É—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∏<br>
          ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ—É—Ç–µ—Ä–∞/–ø—Ä–æ–∫—Å–∏
        </div>
        <div style="background: rgba(76,175,80,0.3); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 11px;">
          <strong>‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:</strong><br>
          ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏<br>
          ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç<br>
          ‚Ä¢ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="multiUserChat.diagnoseAPIIssues()" 
                  style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; 
                         padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
            üîç –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
          </button>
          <button onclick="this.closest('[style*=fixed]').remove(); localStorage.setItem('api_blocked_notice_shown', 'true')" 
                  style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; 
                         padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
            ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ
          </button>
        </div>
      `;

            document.body.appendChild(notice);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
              if (notice.parentElement) {
                notice.style.transition =
                  "opacity 0.5s ease, transform 0.5s ease";
                notice.style.opacity = "0";
                notice.style.transform = "translateX(100%)";
                setTimeout(() => {
                  notice.remove();
                  localStorage.setItem("api_blocked_notice_shown", "true");
                }, 500);
              }
            }, 20000);
          }, 1000);
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–∞–Ω—É –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
        getRandomCountry() {
          const countries = [
            { code: "US", name: "–°–®–ê", flag: "üá∫üá∏" },
            { code: "RU", name: "–†–æ—Å—Å–∏—è", flag: "üá∑üá∫" },
            { code: "DE", name: "–ì–µ—Ä–º–∞–Ω–∏—è", flag: "üá©üá™" },
            { code: "GB", name: "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", flag: "üá¨üáß" },
            { code: "FR", name: "–§—Ä–∞–Ω—Ü–∏—è", flag: "üá´üá∑" },
            { code: "CA", name: "–ö–∞–Ω–∞–¥–∞", flag: "üá®üá¶" },
            { code: "JP", name: "–Ø–ø–æ–Ω–∏—è", flag: "üáØüáµ" },
            { code: "CN", name: "–ö–∏—Ç–∞–π", flag: "üá®üá≥" },
            { code: "BR", name: "–ë—Ä–∞–∑–∏–ª–∏—è", flag: "üáßüá∑" },
            { code: "IN", name: "–ò–Ω–¥–∏—è", flag: "üáÆüá≥" },
          ];

          return countries[Math.floor(Math.random() * countries.length)];
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –≥–æ—Ä–æ–¥ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
        getRandomCity() {
          const cities = [
            "–ú–æ—Å–∫–≤–∞",
            "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
            "–ù—å—é-–ô–æ—Ä–∫",
            "–õ–æ–Ω–¥–æ–Ω",
            "–ü–∞—Ä–∏–∂",
            "–ë–µ—Ä–ª–∏–Ω",
            "–¢–æ–∫–∏–æ",
            "–°–∏–¥–Ω–µ–π",
            "–¢–æ—Ä–æ–Ω—Ç–æ",
            "–ú–∞–¥—Ä–∏–¥",
            "–†–∏–º",
            "–ê–º—Å—Ç–µ—Ä–¥–∞–º",
            "–°—Ç–æ–∫–≥–æ–ª—å–º",
            "–í–∞—Ä—à–∞–≤–∞",
            "–ü—Ä–∞–≥–∞",
            "–í–µ–Ω–∞",
          ];

          return cities[Math.floor(Math.random() * cities.length)];
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API (–Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
        async safeMakeAPIRequest(apiUrl, action = "get") {
          try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch —Å no-cors —Ä–µ–∂–∏–º–æ–º –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è CORS –æ—à–∏–±–æ–∫
            let url = `${apiUrl}/hit/frequency-scanner/global`;
            if (action === "get") {
              url = `${apiUrl}/get/frequency-scanner/global`;
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            try {
              const response = await fetch(url, {
                method: "GET",
                mode: "cors",
                cache: "no-cache",
                headers: { Accept: "application/json" },
                signal: controller.signal,
              });

              clearTimeout(timeoutId);

              if (response.ok) {
                const data = await response.json();
                return {
                  value: data.value || 1247,
                  success: true,
                  simulated: false,
                };
              }
            } catch (corsError) {
              // CORS –∏–ª–∏ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null –¥–ª—è fallback –Ω–∞ —Å–∏–º—É–ª—è—Ü–∏—é
              clearTimeout(timeoutId);
              return null;
            }

            return null;
          } catch (error) {
            console.debug("Safe API error (ignored):", error.message);
            return null;
          }
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ API —Å—á–µ—Ç—á–∏–∫–∞
        async makeAPIRequest(apiUrl, action = "get") {
          const config = this.globalCounter;

          try {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏
            const secureResult = await this.makeSecureAPIRequest(
              apiUrl,
              action,
            );
            if (secureResult && secureResult.success) {
              return secureResult;
            }

            // Fallback –∫ –ø—Ä—è–º—ã–º –∑–∞–ø—Ä–æ—Å–∞–º —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π CORS
            let url;
            let method = "GET";
            let requestOptions = {
              method: method,
              mode: "cors", // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º CORS —Ä–µ–∂–∏–º
              cache: "no-cache",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest",
                Origin: window.location.origin,
              },
              credentials: "omit", // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies
            };

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL –¥–ª—è –∫–∞–∂–¥–æ–≥–æ API
            if (apiUrl.includes("countapi.xyz")) {
              if (action === "hit") {
                url = `${apiUrl}/hit/frequency-scanner/global`;
              } else {
                url = `${apiUrl}/get/frequency-scanner/global`;
              }
            } else if (apiUrl.includes("counterapi.dev")) {
              if (action === "hit") {
                url = `${apiUrl}/v1/frequency-scanner/global/up`;
              } else {
                url = `${apiUrl}/v1/frequency-scanner/global`;
              }
            } else if (apiUrl.includes("counter-api.dev")) {
              if (action === "hit") {
                url = `${apiUrl}/api/frequency-scanner/global/increment`;
                method = "POST";
                requestOptions.method = "POST";
              } else {
                url = `${apiUrl}/api/frequency-scanner/global`;
              }
            } else if (apiUrl.includes("visitorbadge.io")) {
              url = `${apiUrl}/visitors?path=frequency-scanner-global&label=visits&style=flat`;
            } else if (apiUrl.includes("hits.dwyl.com")) {
              url = `${apiUrl}/frequency-scanner/global.json`;
            } else {
              // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö API –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –ø–æ–¥—Ö–æ–¥
              url = `${apiUrl}/frequency-scanner/global`;
            }

            console.log(`üåê –ü—Ä—è–º–æ–π API –∑–∞–ø—Ä–æ—Å: ${action} ‚Üí ${url}`);

            const controller = new AbortController();
            requestOptions.signal = controller.signal;

            const timeoutId = setTimeout(() => {
              console.warn(`‚è±Ô∏è –¢–∞–π–º–∞—É—Ç API –∑–∞–ø—Ä–æ—Å–∞: ${url}`);
              controller.abort();
            }, 10000); // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç

            const response = await fetch(url, requestOptions);
            clearTimeout(timeoutId);

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`,
              );
            }

            const data = await response.json();
            console.log(`üì• API –æ—Ç–≤–µ—Ç:`, data);

            return {
              value:
                data.value || data.count || data.hits || data.total || 1247,
              success: true,
              simulated: false,
            };
          } catch (error) {
            console.warn(`‚ùå –û—à–∏–±–∫–∞ API –∑–∞–ø—Ä–æ—Å–∞ (${action}):`, error.message);

            // –ü—Ä–∏ CORS –æ—à–∏–±–∫–µ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage (–Ω–µ —Å–∏–º—É–ª—è—Ü–∏—é)
            if (
              error.message.includes("CORS") ||
              error.message.includes("Failed to fetch") ||
              error.name === "AbortError"
            ) {
              const realCount = parseInt(localStorage.getItem('real_page_visits_counter') || '1215');
              console.log(
                "üí° –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage –≤–º–µ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏–∏",
              );
              return {
                value: realCount,
                success: false,
                simulated: false, // –≠—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è
              };
            }

            // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
            console.log("üì± –ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage –≤–º–µ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏–∏ API");
            return this.createSimulatedAPIResponse(action);
          }
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API –Ω–∞ Vercel
        async makeSecureAPIRequest(apiUrl, action = "get") {
          try {
            console.log(`üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π API –∑–∞–ø—Ä–æ—Å: ${action} ‚Üí –∏—Å–ø–æ–ª—å–∑—É—é /api/counter`);
            
            // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π /api/counter –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞
            // –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Vercel –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è CORS
            
            if (action === "hit" || action === "increment") {
              // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–∏–∑–∏—Ç —á–µ—Ä–µ–∑ –Ω–∞—à API
              const response = await fetch('/api/counter?action=increment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  source: 'global-api',
                  referrer: document.referrer || 'direct'
                })
              });

              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }

              const data = await response.json();
              console.log(`‚úÖ API –æ—Ç–≤–µ—Ç (—Ä–µ–∞–ª—å–Ω—ã–π):`, data);

              return {
                value: data.count || this.globalCounter.simulatedCount || 1247,
                success: true,
                simulated: false,
              };
            } else {
              // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
              const response = await fetch('/api/counter?action=get', {
                method: 'GET'
              });

              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }

              const data = await response.json();
              console.log(`‚úÖ API –æ—Ç–≤–µ—Ç (—Ä–µ–∞–ª—å–Ω—ã–π):`, data);

              return {
                value: data.count || this.globalCounter.simulatedCount || 1247,
                success: true,
                simulated: false,
              };
            }
          } catch (error) {
            console.warn("üîí –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ API –∑–∞–ø—Ä–æ—Å–∞:", error.message);
            console.log("üì± Fallback –Ω–∞ localStorage –≤–º–µ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏–∏");
            
            // Fallback –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏–∏
            const localCount = parseInt(localStorage.getItem('real_page_visits_counter') || '1215');
            return {
              value: localCount,
              success: false,
              simulated: false, // –≠—Ç–æ –Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è, —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
            };
          }
        }

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
        async quickTestAPI(apiUrl) {
          try {
            const testEndpoints = [
              "", // –±–∞–∑–æ–≤—ã–π URL
              "/ping",
              "/status",
              "/health",
              "/api/ping",
            ];

            for (const endpoint of testEndpoints) {
              try {
                const response = await Promise.race([
                  fetch(`${apiUrl}${endpoint}`, {
                    method: "HEAD",
                    mode: "no-cors",
                    cache: "no-cache",
                  }),
                  new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Timeout")), 3000),
                  ),
                ]);

                console.log(`‚úÖ API ${apiUrl}${endpoint} –¥–æ—Å—Ç—É–ø–µ–Ω`);
                return true;
              } catch (error) {
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ —Å –¥—Ä—É–≥–∏–º–∏ endpoints
                continue;
              }
            }

            console.log(`‚ùå API ${apiUrl} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
            return false;
          } catch (error) {
            console.warn(
              `‚ö†Ô∏è –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞ API ${apiUrl}:`,
              error.message,
            );
            return false;
          }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ (–Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è)
        // –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –±–æ–ª—å—à–µ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        createSimulatedAPIResponse(action) {
          // –í–º–µ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
          // –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º API /api/counter –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
          const realCount = parseInt(localStorage.getItem('real_page_visits_counter') || '1215');

          if (action === "hit") {
            // –ü—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–∏ "hit" —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –≤ localStorage
            const newCount = realCount + 1;
            localStorage.setItem('real_page_visits_counter', newCount.toString());
            this.globalCounter.simulatedCount = newCount;
            
            console.log(`‚úÖ –†–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω –¥–æ: ${newCount} (–Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è)`);
            
            return {
              value: newCount,
              ok: true,
              simulated: false, // –≠—Ç–æ –ù–ï —Å–∏–º—É–ª—è—Ü–∏—è, —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            };
          } else {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            return {
              value: realCount,
              ok: true,
              simulated: false, // –≠—Ç–æ –ù–ï —Å–∏–º—É–ª—è—Ü–∏—è, —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            };
          }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ (—Å—Ç—Ä–∞–Ω–∞, –≥–æ—Ä–æ–¥)
        async getVisitorInfo() {
          console.log("üåç –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏...");

          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ API –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å CORS
          const geoUrl = "https://api.db-ip.com/v2/free/self";

          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            const response = await fetch(geoUrl, {
              signal: controller.signal,
              headers: { Accept: "application/json" },
              mode: "cors",
            });

            clearTimeout(timeoutId);

            if (response.ok) {
              const data = await response.json();
              this.visitorInfo = {
                country: data.countryName || data.countryCode || "Unknown",
                countryCode: data.countryCode,
                city: data.city || "Unknown",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                isp: data.isp || "Unknown",
              };
              console.log("‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞");
              this.updateGlobalStatsWidget(undefined, true, this.visitorInfo);
              return;
            }
          } catch (error) {
            // –ú–æ–ª—á–∞–ª–∏–≤–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
          }

          // Fallback - –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          console.log("üí° –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏");
          this.visitorInfo = {
            country: "Unknown",
            city: "Unknown",
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            isp: "Unknown",
          };
          this.updateGlobalStatsWidget(undefined, true, this.visitorInfo);
        }

        // –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
        startGlobalCounterUpdates() {
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ (—á–∞—â–µ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏)
          setInterval(async () => {
            await this.updateGlobalCounter();
          }, 15000);

          // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—á–µ—Ç—á–∏–∫–∞ –∫–∞–∂–¥—ã–µ 45 —Å–µ–∫—É–Ω–¥
          setInterval(async () => {
            if (this.globalCounter.isOnline) {
              const stats = await this.getCounterStats?.();
              if (stats) {
                console.log(
                  `ÔøΩ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞: –≤—Å–µ–≥–æ ${stats.totalCount}, –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å ${stats.visitsLastHour}`,
                );
              }
            }
          }, 45000);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
          setInterval(async () => {
            await this.checkGlobalAPIHealth();
          }, 60000);
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã (–≤—Å–µ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω—ã–π, –Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è)
        getCurrentMode() {
          // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫, –Ω–∏–∫–æ–≥–¥–∞ —Å–∏–º—É–ª—è—Ü–∏—é
          return "—Ä–µ–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫";
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ (—Ä–µ–∞–ª—å–Ω–æ–µ, –Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è)
        async updateGlobalCounter() {
          const config = this.globalCounter;

          try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à —Ä–µ–∞–ª—å–Ω—ã–π API –Ω–∞ Vercel
            const secure = await this.makeSecureAPIRequest(
              "https://suslovpa.vercel.app",
              "get"
            );

            if (secure && secure.success) {
              const updatedCount = secure.value;
              config.isOnline = true;
              config.lastUpdate = Date.now();
              console.log(`‚úÖ –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω —Å API: ${updatedCount}`);
              this.updateGlobalStatsWidget(updatedCount, true, null, "—Ä–µ–∞–ª—å–Ω—ã–π API");
            } else if (secure) {
              // Fallback –Ω–∞ localStorage (—Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è)
              const localCount = parseInt(
                localStorage.getItem('real_page_visits_counter') || '1215'
              );
              config.isOnline = false;
              config.lastUpdate = Date.now();
              console.log(`üì± –°—á–µ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω –∏–∑ localStorage: ${localCount}`);
              this.updateGlobalStatsWidget(
                localCount,
                true,
                null,
                "localStorage (—Ä–µ–∞–ª—å–Ω—ã–π)"
              );
            }
          } catch (error) {
            console.debug("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error.message);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage –≤–º–µ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏–∏
            const realCount = parseInt(
              localStorage.getItem('real_page_visits_counter') || '1215'
            );
            this.updateGlobalStatsWidget(
              realCount,
              true,
              null,
              "localStorage (—Ä–µ–∞–ª—å–Ω—ã–π)"
            );
          }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è API
        async checkGlobalAPIHealth() {
          const config = this.globalCounter;
          const timeSinceLastUpdate = Date.now() - config.lastUpdate;

          // –ï—Å–ª–∏ –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π - –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
          if (timeSinceLastUpdate > 180000) {
            // 3 –º–∏–Ω—É—Ç—ã
            console.log("üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ API...");
            await this.connectToGlobalAPI();
          }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        updateGlobalStatsWidget(
          globalCount,
          isOnline,
          visitorInfo = null,
          mode = "api",
        ) {
          let widget = document.getElementById("globalStatsWidget");

          if (!widget) {
            // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            widget = document.createElement("div");
            widget.id = "globalStatsWidget";
            widget.className = "global-stats-widget";
            document.body.appendChild(widget);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
            widget.addEventListener("click", () => {
              this.showGlobalStatsDetails();
            });
          }

          const info = visitorInfo || this.visitorInfo || {};
          const statusClass = isOnline ? "" : "offline";
          const statusEmoji = isOnline ? "üü¢" : "üî¥";

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
          let statusText = "";
          if (mode === "—Å–∏–º—É–ª—è—Ü–∏—è") {
            statusText = "–†–µ–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—â–µ–Ω–∏—è";
          } else if (mode === "–¥–µ–º–æ-—Ä–µ–∂–∏–º") {
            statusText = "–î–µ–º–æ-—Ä–µ–∂–∏–º";
          } else if (isOnline) {
            const apiName =
              this.globalCounter &&
              this.globalCounter.lastWorkingAPI &&
              this.globalCounter.lastWorkingAPI.name
                ? `–û–Ω–ª–∞–π–Ω ‚Ä¢ ${this.globalCounter.lastWorkingAPI.name}`
                : "–û–Ω–ª–∞–π–Ω";
            statusText = apiName;
          } else {
            statusText = "–û—Ñ–ª–∞–π–Ω";
          }

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–ª–∞–≥ —Å—Ç—Ä–∞–Ω—ã
          const countryFlag = this.getCountryFlag(
            info.countryCode || info.country,
          );

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ –ø–æ—Å–µ—â–µ–Ω–∏–π
          const formattedCount =
            globalCount !== null && globalCount !== undefined
              ? Number(globalCount).toLocaleString()
              : "---";

          widget.innerHTML = `
      <div style="display: flex; align-items: center; margin-bottom: 5px;">
        <div class="global-stats-indicator ${statusClass}"></div>
        <strong>üåç –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      </div>
      
      <div style="font-size: 10px; margin-bottom: 5px;">
        ${statusEmoji} ${statusText} ‚Ä¢ 
        ${formattedCount} –ø–æ—Å–µ—â–µ–Ω–∏–π
        ${mode === "—Å–∏–º—É–ª—è—Ü–∏—è" ? " üìä" : mode === "–¥–µ–º–æ-—Ä–µ–∂–∏–º" ? " üéÆ" : ""}
      </div>
      
      ${
        info.country && info.country !== "Unknown"
          ? `
        <div class="world-map-mini">
          ${countryFlag} ${info.city || "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è..."}, ${info.countryName || info.country || "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è..."}
        </div>
      `
          : `
        <div class="world-map-mini">
          üåê ${info.country === "Unknown" ? "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è..." : "–ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö..."}
        </div>
      `
      }
      
      <div style="font-size: 9px; opacity: 0.8; margin-top: 3px;">
        –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
      </div>
    `;

          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø —Å —É—á–µ—Ç–æ–º —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
          let tooltipText = "";
          if (mode === "—Å–∏–º—É–ª—è—Ü–∏—è") {
            tooltipText = `–°—á—ë—Ç—á–∏–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π
üìä –í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π: ${formattedCount}
üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${info.city || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}, ${info.country || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
üåê –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${info.timezone || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
üì° –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}

–°—á–µ—Ç—á–∏–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–∞–π—Ç—É (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage)`;
          } else if (mode === "–¥–µ–º–æ-—Ä–µ–∂–∏–º") {
            tooltipText = `–î–µ–º–æ-—Ä–µ–∂–∏–º –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
üìä –î–µ–º–æ-–∑–Ω–∞—á–µ–Ω–∏–µ: ${formattedCount}
üéÆ –†–µ–∂–∏–º: –°—Ç–∞—Ç–∏—á–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...
üîå –í–Ω–µ—à–Ω–∏–µ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
üì° –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ`;
          } else {
            tooltipText = `–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
üìä –í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π: ${formattedCount}
üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${info.city || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}, ${info.country || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
üåê –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${info.timezone || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
üîå –°—Ç–∞—Ç—É—Å API: ${isOnline ? "–ø–æ–¥–∫–ª—é—á–µ–Ω" : "–æ—Ç–∫–ª—é—á–µ–Ω"}
üì° –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}

–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞`;
          }

          widget.title = tooltipText;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ —Å—Ç—Ä–∞–Ω—ã –ø–æ –∫–æ–¥—É
        getCountryFlag(countryCode) {
          const flags = {
            RU: "üá∑üá∫",
            US: "üá∫üá∏",
            DE: "üá©üá™",
            FR: "üá´üá∑",
            GB: "üá¨üáß",
            CN: "üá®üá≥",
            JP: "üáØüáµ",
            KR: "üá∞üá∑",
            IN: "üáÆüá≥",
            BR: "üáßüá∑",
            CA: "üá®üá¶",
            AU: "üá¶üá∫",
            IT: "üáÆüáπ",
            ES: "üá™üá∏",
            UA: "üá∫üá¶",
            PL: "üáµüá±",
            NL: "üá≥üá±",
            SE: "üá∏üá™",
            NO: "üá≥üá¥",
            FI: "üá´üáÆ",
          };

          return flags[countryCode] || "üåç";
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async showGlobalStatsDetails() {
          console.log("üìä –ü–æ–∫–∞–∑ –ø–æ–¥—Ä–æ–±–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...");

          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 700px; max-height: 80vh; overflow-y: auto;
      font-family: system-ui; font-size: 13px; line-height: 1.5;
    `;

          // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
          let globalCount = 0;
          let apiStatus = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";

          try {
            if (this.globalCounter.isOnline) {
              const config = this.globalCounter;
              const apiUrl = config.apiUrls[config.currentApiIndex];
              const response = await this.makeAPIRequest(apiUrl, "get");

              if (response && response.value !== undefined) {
                globalCount = response.value;
                apiStatus = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω";
              } else {
                apiStatus = "‚ö†Ô∏è –û—à–∏–±–∫–∞ API";
              }
            } else {
              apiStatus = "‚ùå –û—Ç–∫–ª—é—á–µ–Ω";
            }
          } catch (error) {
            apiStatus = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
          }

          const info = this.visitorInfo || {};
          const flag = this.getCountryFlag(info.country);

          content.innerHTML = `
      <h3 style="margin: 0 0 15px 0; color: #333;">üåç –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</h3>
      
      <div style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
          <div>
            <div style="font-size: 28px; font-weight: bold;">${globalCount.toLocaleString()}</div>
            <div style="font-size: 12px; opacity: 0.9;">üåê –ì–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π</div>
          </div>
          <div>
            <div style="font-size: 28px; font-weight: bold;">${flag}</div>
            <div style="font-size: 12px; opacity: 0.9;">–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
          </div>
        </div>
      </div>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #495057;">üìç –í–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px; font-size: 12px;">
          <div><strong>–°—Ç—Ä–∞–Ω–∞:</strong></div>
          <div>${flag} ${info.country || "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è..."}</div>
          
          <div><strong>–ì–æ—Ä–æ–¥:</strong></div>
          <div>üèôÔ∏è ${info.city || "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è..."}</div>
          
          <div><strong>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:</strong></div>
          <div>üïê ${info.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone}</div>
          
          <div><strong>–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</strong></div>
          <div>üì° ${info.isp || "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è..."}</div>
          
          <div><strong>IP –∞–¥—Ä–µ—Å:</strong></div>
          <div>üîó ${info.ip ? info.ip.replace(/\d+$/, "xxx") : "–°–∫—Ä—ã—Ç"}</div>
        </div>
      </div>
      
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #1976d2;">üîå –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h4>
        <div style="font-size: 12px;">
          <div style="margin: 5px 0;"><strong>API —Å—Ç–∞—Ç—É—Å:</strong> ${apiStatus}</div>
          <div style="margin: 5px 0;"><strong>–ê–∫—Ç–∏–≤–Ω—ã–π API:</strong> ${this.globalCounter.isOnline ? this.globalCounter.apiUrls[this.globalCounter.currentApiIndex] : "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"}</div>
          <div style="margin: 5px 0;"><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${new Date(this.globalCounter.lastUpdate).toLocaleString()}</div>
          <div style="margin: 5px 0;"><strong>–ü–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong> ${this.globalCounter.retryCount}/${this.globalCounter.maxRetries}</div>
        </div>
      </div>
      
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #856404;">‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫</h4>
        <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
          <li>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω–∏–µ API –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞</li>
          <li>–ö–∞–∂–¥–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫</li>
          <li>–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
          <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ IP</li>
          <li>–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ API —Å–µ—Ä–≤–∏—Å–æ–≤</li>
          <li>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</li>
        </ul>
      </div>
      
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="this.closest('[style*=fixed]').remove()" 
                style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
        <button onclick="multiUserChat.updateGlobalCounter(); this.closest('[style*=fixed]').remove();" 
                style="background: #28a745; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer;">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
        </button>
        <button onclick="window.open('https://countapi.xyz/', '_blank')" 
                style="background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer;">
          üåê –û —Å–µ—Ä–≤–∏—Å–µ CountAPI
        </button>
      </div>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —Å–µ—Å—Å–∏–∏
        generateSessionId() {
          const timestamp = Date.now().toString(36);
          const random = Math.random().toString(36).substr(2, 5);
          return `visitor_${timestamp}_${random}`;
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        registerVisitor() {
          const visitorData = {
            sessionId: this.sessionId,
            userId: this.userId,
            visitTime: this.visitStartTime,
            lastActivity: this.lastVisitorActivity,
            userAgent: navigator.userAgent.substring(0, 100),
            referrer: document.referrer || "direct",
            pageUrl: window.location.href,
          };

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
          const visitors = this.getActiveVisitors();
          visitors[this.sessionId] = visitorData;

          // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (—Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç)
          this.cleanupOldVisitors(visitors);

          localStorage.setItem("siteVisitors", JSON.stringify(visitors));

          console.log("üë§ –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", this.sessionId);
          console.log(
            "üìä –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:",
            Object.keys(visitors).length,
          );
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        getActiveVisitors() {
          try {
            const stored = localStorage.getItem("siteVisitors");
            return stored ? JSON.parse(stored) : {};
          } catch (error) {
            console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:", error);
            return {};
          }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        cleanupOldVisitors(visitors = null) {
          if (!visitors) {
            visitors = this.getActiveVisitors();
          }

          const now = Date.now();
          const tenMinutesAgo = now - 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç

          let cleaned = 0;
          for (const sessionId in visitors) {
            if (visitors[sessionId].lastActivity < tenMinutesAgo) {
              delete visitors[sessionId];
              cleaned++;
            }
          }

          if (cleaned > 0) {
            console.log(`üßπ –£–¥–∞–ª–µ–Ω–æ ${cleaned} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π`);
            localStorage.setItem("siteVisitors", JSON.stringify(visitors));
          }

          return visitors;
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        startActivityTracking() {
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
          const updateActivity = () => {
            this.lastVisitorActivity = Date.now();
            this.updateVisitorActivity();
          };

          // –°–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          document.addEventListener("mousedown", updateActivity);
          document.addEventListener("keydown", updateActivity);
          document.addEventListener("scroll", updateActivity);
          document.addEventListener("touchstart", updateActivity);

          // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          setInterval(() => {
            this.updateVisitorActivity();
          }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

          // –£–¥–∞–ª—è–µ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
          window.addEventListener("beforeunload", () => {
            this.unregisterVisitor();
          });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        updateVisitorActivity() {
          const visitors = this.getActiveVisitors();

          if (visitors[this.sessionId]) {
            visitors[this.sessionId].lastActivity = this.lastVisitorActivity;
            localStorage.setItem("siteVisitors", JSON.stringify(visitors));
          }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –ø—Ä–∏ —É—Ö–æ–¥–µ
        unregisterVisitor() {
          const visitors = this.getActiveVisitors();
          delete visitors[this.sessionId];
          localStorage.setItem("siteVisitors", JSON.stringify(visitors));
          console.log("üëã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª —Å–∞–π—Ç:", this.sessionId);
        }

        // –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        startVisitorCountUpdates() {
          // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          this.updateVisitorCounter();

          // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
          setInterval(() => {
            this.updateVisitorCounter();
          }, 30000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        updateVisitorCounter() {
          const visitors = this.cleanupOldVisitors();
          const totalVisitors = Object.keys(visitors).length;

          // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
          const globalCountElement =
            document.getElementById("globalOnlineCount");
          const globalStatusElement =
            document.getElementById("globalOnlineStatus");

          if (globalCountElement) {
            globalCountElement.textContent = `üë• –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: ${totalVisitors}`;
          }

          if (globalStatusElement) {
            const now = Date.now();
            const recentVisitors = Object.values(visitors).filter(
              (v) => now - v.lastActivity < 120000, // –ê–∫—Ç–∏–≤–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã
            ).length;

            if (recentVisitors > 1) {
              globalStatusElement.textContent = `‚Ä¢ ${recentVisitors} –∞–∫—Ç–∏–≤–Ω—ã—Ö`;
              globalStatusElement.style.color = "#28a745";
            } else {
              globalStatusElement.textContent = "‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —Å–∞–π—Ç";
              globalStatusElement.style.color = "#6c757d";
            }
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø
          const globalCounter = document.getElementById("globalOnlineCounter");
          if (globalCounter) {
            const recentVisitorsList = Object.values(visitors)
              .filter((v) => Date.now() - v.lastActivity < 300000) // 5 –º–∏–Ω—É—Ç
              .sort((a, b) => b.lastActivity - a.lastActivity)
              .slice(0, 5);

            if (recentVisitorsList.length > 1) {
              const timeInfo = recentVisitorsList.map((v) => {
                const minutesAgo = Math.floor(
                  (Date.now() - v.lastActivity) / 60000,
                );
                return minutesAgo === 0 ? "—Å–µ–π—á–∞—Å" : `${minutesAgo} –º–∏–Ω –Ω–∞–∑–∞–¥`;
              });
              globalCounter.title = `–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${timeInfo.join(", ")}`;
            } else {
              globalCounter.title = "–í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω";
            }
          }

          console.log(
            `üìä –û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: ${totalVisitors} –æ–Ω–ª–∞–π–Ω`,
          );
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        initPageCounter() {
          console.log("üìà –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...");

          // –ö–ª—é—á–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
          this.pageCounterKeys = {
            totalViews: "suslovPA_page_total_views",
            uniqueVisitors: "suslovPA_page_unique_visitors",
            dailyVisitors: "suslovPA_daily_visitors",
            lastResetDate: "suslovPA_last_reset_date",
          };

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±—Ä–æ—Å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          this.checkDailyReset();

          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
          this.incrementPageCounters();

          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          this.updatePageCounterDisplay();

          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
          setInterval(() => {
            this.updatePageCounterDisplay();
          }, 60000);

          console.log("‚úÖ –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–±—Ä–æ—Å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        checkDailyReset() {
          const today = new Date().toDateString();
          const lastResetDate = localStorage.getItem(
            this.pageCounterKeys.lastResetDate,
          );

          if (lastResetDate !== today) {
            // –ù–æ–≤—ã–π –¥–µ–Ω—å - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
            localStorage.setItem(
              this.pageCounterKeys.dailyVisitors,
              JSON.stringify({}),
            );
            localStorage.setItem(this.pageCounterKeys.lastResetDate, today);
            console.log("üåÖ –°–±—Ä–æ—à–µ–Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");
          }
        }

        // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        incrementPageCounters() {
          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
          let totalViews = parseInt(
            localStorage.getItem(this.pageCounterKeys.totalViews) || "0",
          );
          totalViews++;
          localStorage.setItem(
            this.pageCounterKeys.totalViews,
            totalViews.toString(),
          );

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
          let uniqueVisitors = JSON.parse(
            localStorage.getItem(this.pageCounterKeys.uniqueVisitors) || "{}",
          );
          const visitorFingerprint = this.generateVisitorFingerprint();

          if (!uniqueVisitors[visitorFingerprint]) {
            uniqueVisitors[visitorFingerprint] = {
              firstVisit: Date.now(),
              lastVisit: Date.now(),
              visits: 1,
            };
          } else {
            uniqueVisitors[visitorFingerprint].lastVisit = Date.now();
            uniqueVisitors[visitorFingerprint].visits++;
          }

          localStorage.setItem(
            this.pageCounterKeys.uniqueVisitors,
            JSON.stringify(uniqueVisitors),
          );

          // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏
          let dailyVisitors = JSON.parse(
            localStorage.getItem(this.pageCounterKeys.dailyVisitors) || "{}",
          );
          dailyVisitors[visitorFingerprint] = Date.now();
          localStorage.setItem(
            this.pageCounterKeys.dailyVisitors,
            JSON.stringify(dailyVisitors),
          );

          console.log(`üìä –ü—Ä–æ—Å–º–æ—Ç—Ä #${totalViews} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω`);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–ø–µ—á–∞—Ç–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        generateVisitorFingerprint() {
          const screen = `${window.screen.width}x${window.screen.height}`;
          const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          const language = navigator.language;
          const platform = navigator.platform;

          // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ö–µ—à –∏–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –±—Ä–∞—É–∑–µ—Ä–∞
          const fingerprint = `${screen}_${timezone}_${language}_${platform}`;

          // –ü—Ä–æ—Å—Ç–æ–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏
          let hash = 0;
          for (let i = 0; i < fingerprint.length; i++) {
            const char = fingerprint.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash = hash & hash; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ 32-–±–∏—Ç–Ω–æ–µ —á–∏—Å–ª–æ
          }

          return `fp_${Math.abs(hash).toString(36)}`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
        updatePageCounterDisplay() {
          const totalViews = parseInt(
            localStorage.getItem(this.pageCounterKeys.totalViews) || "0",
          );
          const uniqueVisitors = JSON.parse(
            localStorage.getItem(this.pageCounterKeys.uniqueVisitors) || "{}",
          );
          const dailyVisitors = JSON.parse(
            localStorage.getItem(this.pageCounterKeys.dailyVisitors) || "{}",
          );

          const totalUniqueCount = Object.keys(uniqueVisitors).length;
          const dailyUniqueCount = Object.keys(dailyVisitors).length;

          // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          const pageViewsElement = document.getElementById("pageViewsCount");
          const uniqueVisitorsElement = document.getElementById(
            "uniqueVisitorsCount",
          );
          const lastUpdateElement = document.getElementById("lastUpdateTime");

          if (pageViewsElement) {
            pageViewsElement.textContent = this.formatNumber(totalViews);
          }

          if (uniqueVisitorsElement) {
            uniqueVisitorsElement.textContent =
              this.formatNumber(totalUniqueCount);
          }

          if (lastUpdateElement) {
            const now = new Date();
            lastUpdateElement.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${now.toLocaleTimeString()}`;
          }

          // –î–æ–±–∞–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          const widget = document.getElementById("pageCounterWidget");
          if (widget) {
            widget.title = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
üìä –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ${totalViews}
üë§ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: ${totalUniqueCount}
üìÖ –°–µ–≥–æ–¥–Ω—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: ${dailyUniqueCount}
üïê –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleString()}

–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ`;
          }

          console.log(
            `üìà –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω: ${totalViews} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, ${totalUniqueCount} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö`,
          );
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        formatNumber(num) {
          if (num < 1000) return num.toString();
          if (num < 1000000) return (num / 1000).toFixed(1) + "K";
          return (num / 1000000).toFixed(1) + "M";
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        getPageStats() {
          const totalViews = parseInt(
            localStorage.getItem(this.pageCounterKeys.totalViews) || "0",
          );
          const uniqueVisitors = JSON.parse(
            localStorage.getItem(this.pageCounterKeys.uniqueVisitors) || "{}",
          );
          const dailyVisitors = JSON.parse(
            localStorage.getItem(this.pageCounterKeys.dailyVisitors) || "{}",
          );

          return {
            totalViews,
            uniqueVisitors: Object.keys(uniqueVisitors).length,
            dailyVisitors: Object.keys(dailyVisitors).length,
            avgViewsPerVisitor:
              Object.keys(uniqueVisitors).length > 0
                ? (totalViews / Object.keys(uniqueVisitors).length).toFixed(1)
                : 0,
          };
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–∞–π—Ç–∞
        showVisitorStats() {
          console.log("üìä –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π...");

          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 600px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          const visitors = this.cleanupOldVisitors();
          const totalVisitors = Object.keys(visitors).length;
          const now = Date.now();

          // –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          const recentVisitors = Object.values(visitors).filter(
            (v) => now - v.lastActivity < 120000,
          );
          const activeVisitors = Object.values(visitors).filter(
            (v) => now - v.lastActivity < 300000,
          );

          // –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è
          const visitDurations = Object.values(visitors).map((v) => {
            const duration = (v.lastActivity - v.visitTime) / 1000 / 60; // –º–∏–Ω—É—Ç—ã
            return Math.max(duration, 0);
          });

          const avgDuration =
            visitDurations.length > 0
              ? (
                  visitDurations.reduce((a, b) => a + b, 0) /
                  visitDurations.length
                ).toFixed(1)
              : 0;

          content.innerHTML = `
      <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–∞–π—Ç–∞</h3>
      <div id="visitorStatsInfo">
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üìà –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>üë• <strong>–í—Å–µ–≥–æ –æ–Ω–ª–∞–π–Ω:</strong> ${totalVisitors}</div>
            <div>üü¢ <strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö (2 –º–∏–Ω):</strong> ${recentVisitors.length}</div>
            <div>üì± <strong>–ù–∞ —Å–∞–π—Ç–µ (5 –º–∏–Ω):</strong> ${activeVisitors.length}</div>
            <div>‚è±Ô∏è <strong>–°—Ä. –≤—Ä–µ–º—è:</strong> ${avgDuration} –º–∏–Ω</div>
          </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #495057;">üë§ –í–∞—à–∞ —Å–µ—Å—Å–∏—è</h4>
          <div><strong>Session ID:</strong> ${this.sessionId}</div>
          <div><strong>–ù–∞ —Å–∞–π—Ç–µ —Å:</strong> ${new Date(this.visitStartTime).toLocaleTimeString()}</div>
          <div><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${new Date(this.lastVisitorActivity).toLocaleTimeString()}</div>
          <div><strong>–í—Ä–µ–º—è –Ω–∞ —Å–∞–π—Ç–µ:</strong> ${Math.floor((now - this.visitStartTime) / 60000)} –º–∏–Ω</div>
        </div>
        
        ${
          Object.keys(visitors).length > 1
            ? `
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">üåê –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</h4>
            <div style="max-height: 150px; overflow-y: auto;">
              ${Object.values(visitors)
                .sort((a, b) => b.lastActivity - a.lastActivity)
                .map((v, i) => {
                  const minutesAgo = Math.floor((now - v.lastActivity) / 60000);
                  const timeOnSite = Math.floor(
                    (v.lastActivity - v.visitTime) / 60000,
                  );
                  const isYou = v.sessionId === this.sessionId;
                  return `
                    <div style="margin: 5px 0; padding: 5px; background: ${isYou ? "#d4edda" : "#f8f9fa"}; border-radius: 3px; font-size: 11px;">
                      ${isYou ? "üü¢ –í—ã" : `üë§ –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å ${i + 1}`} ‚Ä¢ 
                      –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${minutesAgo === 0 ? "—Å–µ–π—á–∞—Å" : minutesAgo + " –º–∏–Ω –Ω–∞–∑–∞–¥"} ‚Ä¢ 
                      –ù–∞ —Å–∞–π—Ç–µ: ${timeOnSite} –º–∏–Ω
                    </div>
                  `;
                })
                .join("")}
            </div>
          </div>
        `
            : `
          <div style="background: #e2e3e5; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="color: #6c757d;">üë§ –í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω</div>
          </div>
        `
        }
        
        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #0c5460;">‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫</h4>
          <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
            <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–∞–π—Ç–∞ (–Ω–µ Telegram)</li>
            <li>–°—á–∏—Ç–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞</li>
            <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç</li>
            <li>–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</li>
            <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –∫–ª–∏–∫–∏, —Å–∫—Ä–æ–ª–ª, –∫–ª–∞–≤–∏—à–∏</li>
          </ul>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="this.closest('[style*=fixed]').remove()" 
                style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
        <button onclick="multiUserChat.updateVisitorCounter(); this.closest('[style*=fixed]').remove();" 
                style="background: #28a745; color: white; border: none; padding: 10px 20px; margin-left: 10px; border-radius: 5px; cursor: pointer;">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
        </button>
      </div>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);
        }

        initFirebase() {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
          console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–ª–∞—á–Ω–æ–≥–æ —á–∞—Ç–∞");
          this.initCloudChat();
        }

        initCloudChat() {
          // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram Bot API –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—á–∞—Ç–∞
          console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram —á–∞—Ç–∞");

          // Telegram Bot –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –í–ï–†–°–ò–Ø
          this.telegramConfig = {
            enabled: true, // –í–∫–ª—é—á–∞–µ–º Telegram –≤–µ–∑–¥–µ
            // ‚ö†Ô∏è –¢–æ–∫–µ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É!
            botToken: null, // –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            chatId: "@noninput", // –ö–∞–Ω–∞–ª t.me/noninput
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏ API –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            apiUrl:
              (window.getProxyBase
                ? window.getProxyBase()
                : "https://pavell.vercel.app") + "/api/telegram",
            pollInterval: 5000, // –û–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π API
            maxRetries: 2,
            retryDelay: 1000,
            timeout: 10000,
            healthCheckInterval: 120000,
            secureMode: true, // –ò—Å–ø–æ–ª—å–∑—É–µ–º secure —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º CORS-–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            corsMode: false, // –ü—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ Vercel —É–∂–µ CORS-friendly
            fallbackEnabled: true,
          };

          // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
          this.connectionState = {
            isConnected: false,
            lastSuccessfulRequest: 0,
            consecutiveFailures: 0,
            maxConsecutiveFailures: 5,
            reconnectAttempts: 0,
            maxReconnectAttempts: 10,
          };

          // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
          this.proxyUrls = [
            // –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–æ—Å–Ω–æ–≤–Ω–æ–µ)
            "https://api.telegram.org",
            // –ü—É–±–ª–∏—á–Ω—ã–µ CORS –ø—Ä–æ–∫—Å–∏ (—Ä–µ–∑–µ—Ä–≤ - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ)
            "https://api.allorigins.win/get?url=",
            "https://cors.bridged.cc/",
          ];
          this.currentProxyIndex = 0;

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
          if (this.telegramConfig.enabled) {
            this.initTelegramConnection();
          } else {
            this.updateConnectionStatus("–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
          }
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ (—Å —Å–µ—Ä–≤–µ—Ä–∞, –ù–ï –∏–∑ –∫–æ–¥–∞)
        async getSecureBotToken() {
          // –¢–æ–∫–µ–Ω –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ
          try {
            const response = await fetch("/api/auth/telegram-token", {
              method: "GET",
              credentials: "include",
            });

            if (response.ok) {
              const data = await response.json();
              if (data.token) {
                console.log("‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞");
                this.telegramConfig.botToken = data.token;
                return data.token;
              }
            }
          } catch (error) {
            console.error("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞");
          }

          // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
          return null;
        }

        async initTelegramConnection() {
          try {
            if (!this.telegramConfig?.enabled) {
              console.log("‚ÑπÔ∏è Telegram –æ—Ç–∫–ª—é—á—ë–Ω. –†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Ç.");
              this.updateConnectionStatus("–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
              return;
            }

            console.log("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram...");
            this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram...");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–æ—Ç—É
            const botInfo = await this.sendTelegramRequest("getMe");

            if (botInfo && botInfo.ok) {
              console.log("‚úÖ Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω: @" + botInfo.result.username);

              this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)");

              // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              this.loadTelegramMessages();

              // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
              this.startTelegramPolling();
            } else {
              console.log("‚ÑπÔ∏è Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Ç");
              this.updateConnectionStatus("–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
            }
          } catch (error) {
            console.log(
              "‚ÑπÔ∏è Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (" +
                error.message +
                "), —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Ç",
            );
            this.updateConnectionStatus("–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
          }
        }

        async testChannelAccess() {
          try {
            console.log("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É...");
            const testMessage = await this.sendTelegramRequest("sendMessage", {
              chat_id: this.telegramConfig.chatId,
              text: "üîß –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - " + new Date().toLocaleTimeString(),
            });

            if (testMessage && testMessage.ok) {
              console.log("‚úÖ –î–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É —Ä–∞–±–æ—Ç–∞–µ—Ç");
              return true;
            } else {
              console.warn("‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–∞–Ω–∞–ª—É:", testMessage);
              console.log("üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:");
              console.log("- –ö–∞–Ω–∞–ª @noninput —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—É–±–ª–∏—á–Ω—ã–π");
              console.log("- –ë–æ—Ç @Inputlagthebot –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä");
              console.log("- –£ –±–æ—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π");

              if (testMessage?.error_code === 403) {
                console.error("üö´ –ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª");
              } else if (testMessage?.error_code === 400) {
                console.error("üìù –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π chat_id");
              }

              return false;
            }
          } catch (error) {
            console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª:", error);
            return false;
          }
        }

        async sendTelegramRequest(method, params = {}) {
          if (!this.telegramConfig?.enabled) {
            throw new Error("telegram-disabled");
          }

          try {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            const proxyUrl =
              (window.getProxyBase
                ? window.getProxyBase()
                : window.location.origin) + "/api/telegram";

            console.log(`ÔøΩ Telegram –∑–∞–ø—Ä–æ—Å: ${method}`);

            const response = await fetch(proxyUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                method: method,
                params: params,
              }),
              signal: AbortSignal.timeout(this.telegramConfig.timeout || 10000),
            });

            const result = await response.json();

            if (result && result.ok) {
              console.log(`‚úÖ Telegram –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: —É—Å–ø–µ—à–Ω–æ`);

              this.connectionState.isConnected = true;
              this.connectionState.lastSuccessfulRequest = Date.now();
              this.connectionState.consecutiveFailures = 0;

              return result;
            } else {
              console.debug(
                `‚ö†Ô∏è Telegram API –æ—à–∏–±–∫–∞: ${result?.description || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}`,
              );

              this.connectionState.consecutiveFailures++;
              return result || { ok: false };
            }
          } catch (error) {
            // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ä—å–µ–∑–Ω—ã–µ –æ—à–∏–±–∫–∏, CORS –æ—à–∏–±–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (error.name !== "TypeError" && !error.message.includes("CORS")) {
              console.debug(`‚ö†Ô∏è Telegram –∑–∞–ø—Ä–æ—Å –æ—à–∏–±–∫–∞: ${error.message}`);
            }

            this.connectionState.consecutiveFailures++;
            return { ok: false, error: error.message };
          }
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏
        async sendSecureTelegramRequest(method, params = {}) {
          try {
            if (this.isStaticHost)
              throw new Error("secure-endpoint-unavailable");
            console.log(`üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: ${method}`);

            const response = await fetch("/api/telegram/secure", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                "X-Requested-With": "XMLHttpRequest",
              },
              credentials: "include", // –í–∫–ª—é—á–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
              body: JSON.stringify({
                method: method,
                params: params,
                timestamp: Date.now(),
                origin: window.location.origin,
              }),
            });

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`,
              );
            }

            const result = await response.json();

            if (result.success) {
              this.connectionState.isConnected = true;
              this.connectionState.lastSuccessfulRequest = Date.now();
              return { ok: true, result: result.data };
            } else {
              throw new Error(result.error || "Server error");
            }
          } catch (error) {
            console.warn("üîí –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:", error.message);

            // Fallback –∫ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É —Ä–µ–∂–∏–º—É
            this.telegramConfig.secureMode = false;
            return await this.sendTelegramRequest(method, params);
          }
        }

        // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è Telegram –∑–∞–ø—Ä–æ—Å–æ–≤
        async fallbackTelegramRequest(method, params = {}) {
          console.log("üîÑ –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º Telegram –∑–∞–ø—Ä–æ—Å–∞");

          // –ò–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          if (method === "getMe") {
            return {
              ok: true,
              result: {
                id: 12345,
                is_bot: true,
                first_name: "Demo Bot",
                username: "demo_bot",
                can_join_groups: true,
                can_read_all_group_messages: false,
                supports_inline_queries: false,
              },
            };
          }

          if (method === "sendMessage") {
            return {
              ok: true,
              result: {
                message_id: Math.floor(Math.random() * 10000),
                date: Math.floor(Date.now() / 1000),
                chat: {
                  id: -1000000000000,
                  title: "Demo Channel",
                  type: "channel",
                },
                text: params.text,
              },
            };
          }

          if (method === "getUpdates") {
            return {
              ok: true,
              result: [], // –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            };
          }

          return {
            ok: false,
            description: "Fallback mode - method not supported",
          };

          // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á –ø–æ–¥—Ä—è–¥ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
          if (
            this.connectionState.consecutiveFailures >=
            this.connectionState.maxConsecutiveFailures
          ) {
            console.warn(
              "‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫. –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.",
            );
            this.fallbackToLocal();
          }

          return null;
        }

        async loadTelegramMessages() {
          try {
            console.log("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram...");

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ–π –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
            const historyUrl =
              (window.getProxyBase
                ? window.getProxyBase()
                : window.location.origin) + "/api/telegram/updates?limit=500";

            const response = await fetch(historyUrl, {
              method: "GET",
              headers: {
                Accept: "application/json",
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.updates && data.updates.length > 0) {
              console.log(
                `üì¨ –ü–æ–ª—É—á–µ–Ω–æ ${data.updates.length} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (offset: ${data.offset})`,
              );

              const telegramMessages = data.updates.map((update) => ({
                id: "tg_" + update.id,
                text: update.text,
                username: update.from.first_name || "Telegram User",
                userId: "tg_" + update.from.id,
                timestamp: update.timestamp * 1000,
                isCurrentUser: false,
                wasFiltered: false,
                source: "telegram",
              }));

              console.log(
                `üí¨ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ ${telegramMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è`,
              );

              // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              telegramMessages.forEach((tgMsg) => {
                if (
                  !this.messages.find((existing) => existing.id === tgMsg.id)
                ) {
                  this.messages.push(tgMsg);
                }
              });

              this.messages.sort((a, b) => a.timestamp - b.timestamp);
              // –ù–µ –æ–±—Ä–µ–∑–∞–µ–º - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ!

              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
              this.saveMessagesToStorage();

              this.updateMessageCount();
              this.renderMessages();

              console.log(
                `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${telegramMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏`,
              );
            } else if (data.error) {
              console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:", data.error);
            } else {
              console.log("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞");
            }
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ Telegram:", error);
          }
        }

        startTelegramPolling() {
          // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
          if (this.telegramPollInterval) {
            clearInterval(this.telegramPollInterval);
          }
          if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
          }
          if (this.onlineCounterInterval) {
            clearInterval(this.onlineCounterInterval);
          }

          console.log(
            "üîÑ –ó–∞–ø—É—Å–∫ Telegram polling —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º",
            this.telegramConfig.pollInterval,
            "–º—Å",
          );

          // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ pollInterval > 0)
          if (this.telegramConfig.pollInterval > 0) {
            this.telegramPollInterval = setInterval(() => {
              this.checkTelegramUpdates();
            }, this.telegramConfig.pollInterval);
          } else {
            console.log("‚ÑπÔ∏è Polling –æ—Ç–∫–ª—é—á–µ–Ω (pollInterval = 0)");
          }

          // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
          this.healthCheckInterval = setInterval(() => {
            this.performHealthCheck();
          }, this.telegramConfig.healthCheckInterval);

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          this.onlineCounterInterval = setInterval(() => {
            this.updateOnlineCounter();
            this.cleanupOldUsers();
          }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

          // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          this.updateOnlineCounter();

          console.log("‚úÖ Telegram polling –∑–∞–ø—É—â–µ–Ω");
        }

        async performHealthCheck() {
          console.log("üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Telegram —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...");

          const timeSinceLastSuccess =
            Date.now() - this.connectionState.lastSuccessfulRequest;

          if (
            timeSinceLastSuccess >
            this.telegramConfig.healthCheckInterval * 2
          ) {
            console.warn("‚ö†Ô∏è –î–æ–ª–≥–æ –Ω–µ –±—ã–ª–æ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram");
            this.updateConnectionStatus("–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...");

            // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            const healthCheck = await this.sendTelegramRequest("getMe");

            if (healthCheck && healthCheck.ok) {
              console.log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Telegram –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
              this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)");
            } else {
              console.error("‚ùå Health check failed");
              this.connectionState.reconnectAttempts++;

              if (
                this.connectionState.reconnectAttempts >=
                this.connectionState.maxReconnectAttempts
              ) {
                console.error(
                  "üö® –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π. –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.",
                );
                this.fallbackToLocal();
              } else {
                console.log("üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...");
                this.retryTelegramConnection();
              }
            }
          } else {
            console.log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ");
          }
        }

        async checkTelegramUpdates() {
          try {
            console.log("üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram...");

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π update_id –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ offset
            const lastUpdateId = parseInt(
              localStorage.getItem("lastTelegramUpdateId") || "0",
            );

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const updatesUrl =
              (window.getProxyBase
                ? window.getProxyBase()
                : window.location.origin) + "/api/telegram/updates";

            const response = await fetch(
              `${updatesUrl}?lastId=${lastUpdateId}&limit=100`,
              {
                method: "GET",
                headers: {
                  Accept: "application/json",
                },
              },
            );

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`,
              );
            }

            const data = await response.json();

            if (data.success && data.updates && data.updates.length > 0) {
              console.log(
                `üì® –ü–æ–ª—É—á–µ–Ω–æ ${data.updates.length} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Telegram`,
              );

              let newMessagesCount = 0;

              data.updates.forEach((update) => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π update_id
                localStorage.setItem(
                  "lastTelegramUpdateId",
                  update.id.toString(),
                );

                let message = null;

                console.log("üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", {
                  id: update.id,
                  from: update.from.first_name,
                  text: update.text.substring(0, 50),
                });

                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞
                if (update.from.id === 8223995698) {
                  console.log("ü§ñ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞");
                  return;
                }

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                message = {
                  id: "tg_" + update.id,
                  text: update.text || "[–ú–µ–¥–∏–∞]",
                  username: update.from.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram",
                  userId: "tg_" + update.from.id,
                  timestamp: update.timestamp * 1000,
                  isCurrentUser: false,
                  wasFiltered: false,
                  source: "telegram",
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –Ω–æ–≤–æ–µ
                if (
                  message &&
                  !this.messages.find((existing) => existing.id === message.id)
                ) {
                  this.messages.push(message);
                  newMessagesCount++;

                  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                  if (
                    message.username &&
                    message.username !== "–°–∏—Å—Ç–µ–º–∞" &&
                    !message.isCurrentUser
                  ) {
                    this.addUserOnline(message.username, message.userId);
                  }

                  console.log(
                    `‚ûï –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.username}: ${message.text.substring(0, 50)}...`,
                  );
                }
              });

              if (newMessagesCount > 0) {
                console.log(`‚ú® –î–æ–±–∞–≤–ª–µ–Ω–æ ${newMessagesCount} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`);

                this.messages.sort((a, b) => a.timestamp - b.timestamp);
                // –ù–µ –æ–±—Ä–µ–∑–∞–µ–º - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ!

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                this.saveMessagesToStorage();

                this.updateMessageCount();
                this.renderMessages();
                this.showActiveUsers();
              } else {
                console.log("‚ÑπÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã, –Ω–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç");
              }
            } else if (data.error) {
              console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:", data.error);
            }
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Telegram:", error);
          }
        }

        async sendMessageToTelegram(text, username = null) {
          try {
            const currentUsername =
              username ||
              document.getElementById("usernameInput")?.value.trim() ||
              "–ê–Ω–æ–Ω–∏–º–Ω—ã–π";
            const timestamp = new Date().toLocaleTimeString("ru-RU", {
              hour: "2-digit",
              minute: "2-digit",
            });

            const formattedMessage = `üí¨ <b>${currentUsername}</b> (${timestamp}):
${text}

üì± <i>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Frequency Scanner</i>`;

            console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram –∫–∞–Ω–∞–ª:", {
              channel: this.telegramConfig.chatId,
              user: currentUsername,
              message: text.substring(0, 50) + "...",
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–æ—Ç–ø—Ä–∞–≤–∫–∞..."
            this.updateConnectionStatus("–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...");

            const result = await this.sendTelegramRequest("sendMessage", {
              chat_id: this.telegramConfig.chatId,
              text: formattedMessage,
              parse_mode: "HTML",
            });

            if (result && result.ok) {
              console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram –∫–∞–Ω–∞–ª");
              console.log("üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://t.me/noninput");

              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
              this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)");
              return true;
            } else {
              console.error(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram:",
                result,
              );

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
              if (result && result.error_code === 403) {
                console.error(
                  "üö´ –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª",
                );
                this.updateConnectionStatus("–Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞");
              } else if (result && result.error_code === 400) {
                console.error(
                  "üìù –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∫–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω",
                );
                this.updateConnectionStatus("–æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞");
              } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)");
              }

              return false;
            }
          } catch (error) {
            console.error("üö® –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:", error);

            // –ù–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
            // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø–æ—Ä—è–¥–∫–µ, –ø—Ä–æ—Å—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π
            if (error.name === "AbortError") {
              console.warn("‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
              this.updateConnectionStatus("—Ç–∞–π–º–∞—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏");
            } else if (
              error.name === "TypeError" &&
              error.message.includes("Failed to fetch")
            ) {
              console.warn("üåê –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ");
              this.updateConnectionStatus("—Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞");
            } else {
              this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)");
            }

            return false;
          }
        }

        async sendWelcomeMessage() {
          const welcomeText = `üéµ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ Frequency Scanner —á–∞—Ç—É!
üîó Telegram –∫–∞–Ω–∞–ª: t.me/noninput
ü§ñ –ë–æ—Ç: @Inputlagthebot
üìä –ß–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç!`;
          await this.sendMessageToTelegram(welcomeText);
        }

        loadSharedMessages() {
          try {
            const sharedData = localStorage.getItem(this.sharedKey);
            if (sharedData) {
              const parsed = JSON.parse(sharedData);
              this.messages = parsed.messages || [];
              this.lastSyncTime = parsed.lastUpdate || 0;
            } else {
              this.messages = [];
              this.initializeSharedChat();
            }

            this.updateMessageCount();
            this.renderMessages();
            console.log(
              "–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:",
              this.messages.length,
            );
          } catch (error) {
            console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
            this.messages = [];
          }
        }

        initializeSharedChat() {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
          const welcomeMessages = [
            {
              id: "welcome_1",
              text: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç Frequency Scanner! üéâ",
              username: "–°–∏—Å—Ç–µ–º–∞",
              userId: "system",
              timestamp: Date.now() - 10000,
              isCurrentUser: false,
              wasFiltered: false,
            },
            {
              id: "welcome_2",
              text: "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏ –¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º",
              username: "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
              userId: "moderator",
              timestamp: Date.now() - 5000,
              isCurrentUser: false,
              wasFiltered: false,
            },
          ];

          this.messages = welcomeMessages;
          this.saveSharedMessages();
        }

        saveSharedMessages() {
          try {
            const sharedData = {
              messages: this.messages.slice(-100), // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
              lastUpdate: Date.now(),
              userCount: this.getUserCount(),
            };

            localStorage.setItem(this.sharedKey, JSON.stringify(sharedData));
            this.lastSyncTime = sharedData.lastUpdate;

            // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
            window.dispatchEvent(
              new StorageEvent("storage", {
                key: this.sharedKey,
                newValue: JSON.stringify(sharedData),
              }),
            );

            console.log("–°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ");
            return true;
          } catch (error) {
            console.warn("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
            return false;
          }
        }

        checkForUpdates() {
          try {
            const sharedData = localStorage.getItem(this.sharedKey);
            if (sharedData) {
              const parsed = JSON.parse(sharedData);

              if (parsed.lastUpdate > this.lastSyncTime) {
                // –ï—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                console.log("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è");

                const newMessages = parsed.messages || [];

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                newMessages.forEach((msg) => {
                  if (
                    !this.messages.find((existing) => existing.id === msg.id)
                  ) {
                    this.messages.push({
                      ...msg,
                      isCurrentUser: msg.userId === this.userId,
                    });
                  }
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º
                this.messages.sort((a, b) => a.timestamp - b.timestamp);
                this.messages = this.messages.slice(-50);

                this.lastSyncTime = parsed.lastUpdate;
                this.updateMessageCount();
                this.renderMessages();
              }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
            this.showActiveUsers();
          } catch (error) {
            console.warn("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:", error);
          }
        }

        simulateMultiUserActivity() {
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç "–¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          const demoUsers = ["–ê–ª–µ–∫—Å–µ–π", "–ú–∞—Ä–∏—è", "–î–º–∏—Ç—Ä–∏–π", "–ê–Ω–Ω–∞", "–°–µ—Ä–≥–µ–π"];
          const demoMessages = [
            "–ß–∞—Å—Ç–æ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!",
            "–ö—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–æ–±–æ–≤–∞–ª –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ö–∞–ª–º–∞–Ω–∞?",
            "–ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å —Å—Ç–∞–±–∏–ª—å–Ω–æ üëç",
            "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ä–∞–±–æ—Ç–µ",
            "–•–æ—Ä–æ—à–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö!",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ –∞–ª–≥–æ—Ä–∏—Ç–º –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –Ω–∞–≥—Ä—É–∑–∫–µ",
          ];

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è
          setTimeout(
            () => {
              if (Math.random() < 0.3) {
                // 30% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
                const randomUser =
                  demoUsers[Math.floor(Math.random() * demoUsers.length)];
                const randomMessage =
                  demoMessages[Math.floor(Math.random() * demoMessages.length)];

                this.addSimulatedMessage(randomMessage, randomUser);
              }

              // –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
              this.simulateMultiUserActivity();
            },
            Math.random() * 30000 + 15000,
          ); // –û—Ç 15 –¥–æ 45 —Å–µ–∫—É–Ω–¥
        }

        addSimulatedMessage(text, username) {
          const message = {
            id: "sim_" + Date.now() + "_" + Math.random(),
            text: text,
            username: username,
            userId: "simulated_" + username,
            timestamp: Date.now(),
            isCurrentUser: false,
            wasFiltered: false,
          };

          this.messages.push(message);
          this.saveSharedMessages();
          this.updateMessageCount();
          this.renderMessages();
        }

        getUserCount() {
          // –ü–æ–¥—Å—á–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Telegram + –ª–æ–∫–∞–ª—å–Ω—ã–µ
          const uniqueUsers = new Set();

          this.messages.forEach((msg) => {
            if (msg.source === "telegram") {
              uniqueUsers.add(msg.userId);
            }
          });

          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          uniqueUsers.add(this.userId);

          // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ + —Å–ª—É—á–∞–π–Ω—ã–µ –æ–Ω–ª–∞–π–Ω
          if (this.telegramConfig && !this.isLocalMode) {
            return (
              Math.max(uniqueUsers.size, 2) + Math.floor(Math.random() * 3)
            );
          }

          // –ò–Ω–∞—á–µ –∏–º–∏—Ç–∏—Ä—É–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
          return Math.floor(Math.random() * 8) + 2; // –û—Ç 2 –¥–æ 9 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω
        showActiveUsers() {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω
          this.updateOnlineCounter();

          // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          const userCountElement = document.getElementById("userCount");
          if (userCountElement) {
            const activeUsers = this.getUserCount();
            const lastActivity = localStorage.getItem("chatLastActivity");
            const now = Date.now();

            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –Ω–µ–¥–∞–≤–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ 2 –º–∏–Ω—É—Ç), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const recentActivity =
              lastActivity && now - parseInt(lastActivity) < 120000;
            const displayCount = recentActivity
              ? Math.max(activeUsers, 3)
              : activeUsers;

            userCountElement.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: ${displayCount}`;
            userCountElement.style.color =
              displayCount > 2 ? "#4CAF50" : "#9e9e9e";
          }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        updateOnlineCounter() {
          const onlineCountElement =
            document.getElementById("onlineUsersCount");
          const onlineListElement = document.getElementById("onlineUsersList");

          // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
          const recentUsers = this.getRecentActiveUsers();
          const totalOnline = Math.max(recentUsers.size + 1, 1); // +1 –∑–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

          // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –≤ —á–∞—Ç–µ
          if (onlineCountElement) {
            onlineCountElement.textContent = `üë• –û–Ω–ª–∞–π–Ω: ${totalOnline}`;
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –ì–õ–û–ë–ê–õ–¨–ù–´–ô —Å—á–µ—Ç—á–∏–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
          this.updateGlobalOnlineCounter(totalOnline, recentUsers);

          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          if (onlineListElement) {
            const currentUser =
              document.getElementById("usernameInput")?.value?.trim() || "–í—ã";
            const usersList = Array.from(recentUsers).slice(0, 5); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            let usersText = `üü¢ ${currentUser} (–≤—ã)`;
            if (usersList.length > 0) {
              usersText += `, ${usersList.join(", ")}`;
            }

            if (recentUsers.size > 5) {
              usersText += ` –∏ –µ—â–µ ${recentUsers.size - 5}...`;
            }

            onlineListElement.textContent = usersText;
          }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û —Å—á–µ—Ç—á–∏–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        updateGlobalOnlineCounter(totalOnline, recentUsers) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–∞–π—Ç–∞ –≤–º–µ—Å—Ç–æ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          if (this.updateVisitorCounter) {
            this.updateVisitorCounter();
            return; // –í—ã—Ö–æ–¥–∏–º, —Ç–∞–∫ –∫–∞–∫ —Å—á–µ—Ç—á–∏–∫ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
          }

          // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–∏, –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
          const globalCountElement =
            document.getElementById("globalOnlineCount");
          const globalStatusElement =
            document.getElementById("globalOnlineStatus");

          if (globalCountElement) {
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectionStatus =
              document.getElementById("connectionStatus")?.textContent ||
              "–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...";

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á–µ—Ç—á–∏–∫
            globalCountElement.textContent = `üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: ${totalOnline}`;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (globalStatusElement) {
              let statusText = "";
              let statusColor = "";

              if (connectionStatus.includes("–ø–æ–¥–∫–ª—é—á–µ–Ω")) {
                statusText = "‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç";
                statusColor = "#28a745";
              } else if (connectionStatus.includes("–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è")) {
                statusText = "‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
                statusColor = "#ffc107";
              } else if (
                connectionStatus.includes("–æ—à–∏–±–∫–∞") ||
                connectionStatus.includes("–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
              ) {
                statusText = "‚Ä¢ –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º";
                statusColor = "#dc3545";
              } else {
                statusText = `‚Ä¢ ${connectionStatus}`;
                statusColor = "#6c757d";
              }

              globalStatusElement.textContent = statusText;
              globalStatusElement.style.color = statusColor;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            const globalCounter = document.getElementById(
              "globalOnlineCounter",
            );
            if (globalCounter && recentUsers && recentUsers.size > 0) {
              const usersList = Array.from(recentUsers).slice(0, 3).join(", ");
              const moreUsers =
                recentUsers.size > 3 ? ` –∏ –µ—â–µ ${recentUsers.size - 3}...` : "";
              globalCounter.title = `–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${usersList}${moreUsers}`;
            } else if (globalCounter) {
              globalCounter.title = "–í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            }
          }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        getRecentActiveUsers() {
          const recentUsers = new Set();
          const now = Date.now();
          const fiveMinutesAgo = now - 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥

          // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
          this.messages.forEach((message) => {
            if (message.timestamp && message.timestamp > fiveMinutesAgo) {
              if (
                message.username &&
                message.username !== "–°–∏—Å—Ç–µ–º–∞" &&
                !message.isCurrentUser
              ) {
                recentUsers.add(message.username);
              }
            }
          });

          return recentUsers;
        }

        // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω
        addUserOnline(username, userId = null) {
          if (username && username !== "–°–∏—Å—Ç–µ–º–∞") {
            this.onlineUsers.add(userId || username);
            console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);
            this.updateOnlineCounter();
          }
        }

        // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–Ω–ª–∞–π–Ω
        removeUserOnline(username, userId = null) {
          this.onlineUsers.delete(userId || username);
          console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`);
          this.updateOnlineCounter();
        }

        // –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cleanupOldUsers() {
          const now = Date.now();
          const tenMinutesAgo = now - 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥

          // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç
          const activeUserIds = new Set();
          this.messages.forEach((message) => {
            if (message.timestamp && message.timestamp > tenMinutesAgo) {
              if (message.userId && message.username !== "–°–∏—Å—Ç–µ–º–∞") {
                activeUserIds.add(message.userId);
              }
            }
          });

          // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã
          const usersToRemove = [];
          this.onlineUsers.forEach((userId) => {
            if (!activeUserIds.has(userId)) {
              usersToRemove.push(userId);
            }
          });

          usersToRemove.forEach((userId) => {
            this.onlineUsers.delete(userId);
          });

          if (usersToRemove.length > 0) {
            console.log(
              `üßπ –£–¥–∞–ª–µ–Ω–æ ${usersToRemove.length} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`,
            );
            this.updateOnlineCounter();
          }
        }

        // –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        simulateUserActivity() {
          localStorage.setItem("chatLastActivity", Date.now().toString());
          this.showActiveUsers();
        }

        async checkChannelAccess() {
          console.log("üì¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É @noninput...");

          // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 600px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          content.innerHTML = `
      <h3>üì¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É</h3>
      <div id="channelResults">‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É @noninput...</div>
      <button onclick="this.closest('[style*=fixed]').remove()" 
              style="margin-top: 15px; padding: 10px 20px; background: #f44336; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          const resultsDiv = content.querySelector("#channelResults");

          try {
            resultsDiv.innerHTML = `
        <div style="margin-bottom: 10px;">
          üéØ <strong>–¶–µ–ª—å:</strong> –ö–∞–Ω–∞–ª @noninput<br>
          üîó <strong>–°—Å—ã–ª–∫–∞:</strong> <a href="https://t.me/noninput" target="_blank">https://t.me/noninput</a><br>
          ü§ñ <strong>–ë–æ—Ç:</strong> @Inputlagthebot
        </div>
        <div>‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è...</div>
      `;

            // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const testMessage = `üß™ –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É - ${new Date().toLocaleString()}`;

            console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", testMessage);

            const result = await this.sendTelegramRequest("sendMessage", {
              chat_id: this.telegramConfig.chatId,
              text: testMessage,
            });

            if (result && result.ok) {
              // –£—Å–ø–µ—Ö!
              resultsDiv.innerHTML = `
          <div style="color: #4CAF50; font-weight: bold; margin-bottom: 15px;">
            ‚úÖ –î–û–°–¢–£–ü –ö –ö–ê–ù–ê–õ–£ –ï–°–¢–¨!
          </div>
          
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>üéâ –û—Ç–ª–∏—á–Ω–æ!</strong> –ë–æ—Ç –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª @noninput<br><br>
            
            <strong>üìã –î–µ—Ç–∞–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong><br>
            ‚Ä¢ <strong>ID —Å–æ–æ–±—â–µ–Ω–∏—è:</strong> ${result.result.message_id}<br>
            ‚Ä¢ <strong>–î–∞—Ç–∞:</strong> ${new Date(result.result.date * 1000).toLocaleString()}<br>
            ‚Ä¢ <strong>Chat ID:</strong> ${result.result.chat.id}<br>
            ‚Ä¢ <strong>–¢–∏–ø —á–∞—Ç–∞:</strong> ${result.result.chat.type}
          </div>
          
          <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–Ω–∞–ª:</strong><br>
            –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/noninput" target="_blank">t.me/noninput</a> - —Ç–∞–º –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          </div>
          
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
            <strong>‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!</strong><br>
            –ï—Å–ª–∏ —á–∞—Ç –≤—Å–µ –µ—â–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É", –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:<br>
            1. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)<br>
            2. –ù–∞–∂–∞—Ç—å "üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram"<br>
            3. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
          </div>
        `;

              console.log("‚úÖ –î–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É —Ä–∞–±–æ—Ç–∞–µ—Ç:", result);
            } else {
              // –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞
              const errorCode = result?.error_code || "unknown";
              const errorDesc = result?.description || "Unknown error";

              let errorExplanation = "";
              let solution = "";

              switch (errorCode) {
                case 403:
                  errorExplanation =
                    "–ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª";
                  solution = `
              1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/noninput" target="_blank">–∫–∞–Ω–∞–ª @noninput</a><br>
              2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤–≤–µ—Ä—Ö—É<br>
              3. –í—ã–±–µ—Ä–∏—Ç–µ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–º"<br>
              4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"<br>
              5. –ù–∞–π–¥–∏—Ç–µ @Inputlagthebot –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ<br>
              6. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –±–æ—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞:<br>
              &nbsp;&nbsp;&nbsp;‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π<br>
              &nbsp;&nbsp;&nbsp;‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–Ω–∞–ª–∞<br>
              &nbsp;&nbsp;&nbsp;‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
            `;
                  break;
                case 400:
                  if (errorDesc.includes("not found")) {
                    errorExplanation = "–ö–∞–Ω–∞–ª @noninput –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    solution = `
                1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–∞–Ω–∞–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: <a href="https://t.me/noninput" target="_blank">t.me/noninput</a><br>
                2. –ö–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º (–Ω–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º)<br>
                3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è: @noninput<br>
                4. –ï—Å–ª–∏ –∫–∞–Ω–∞–ª–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤ Telegram
              `;
                  } else {
                    errorExplanation =
                      "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç chat_id –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞";
                    solution = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ chat_id —É–∫–∞–∑–∞–Ω –∫–∞–∫ @noninput";
                  }
                  break;
                default:
                  errorExplanation = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API";
                  solution =
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ Telegram";
              }

              resultsDiv.innerHTML = `
          <div style="color: #f44336; font-weight: bold; margin-bottom: 15px;">
            ‚ùå –ù–ï–¢ –î–û–°–¢–£–ü–ê –ö –ö–ê–ù–ê–õ–£!
          </div>
          
          <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>üö® –û—à–∏–±–∫–∞ API:</strong><br>
            ‚Ä¢ <strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> ${errorCode}<br>
            ‚Ä¢ <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${errorDesc}<br>
            ‚Ä¢ <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${errorExplanation}
          </div>
          
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
            <strong>üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</strong><br>
            ${solution}
          </div>
        `;

              console.error("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É:", result);
            }
          } catch (error) {
            console.error("üö® –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞:", error);

            resultsDiv.innerHTML = `
        <div style="color: #f44336; font-weight: bold; margin-bottom: 15px;">
          üö® –û–®–ò–ë–ö–ê –ü–†–û–í–ï–†–ö–ò!
        </div>
        
        <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
          <strong>‚ùå –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:</strong><br>
          ${error.message}
        </div>
        
        <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
          <strong>üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong><br>
          1. –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º<br>
          2. –í—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã<br>
          3. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ Telegram<br><br>
          
          <strong>üîß –ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:</strong><br>
          ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º<br>
          ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram"<br>
          ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ
        </div>
      `;
          }
        }

        async checkBotSettings() {
          console.log("ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞...");

          // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 700px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          content.innerHTML = `
      <h3>ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
      <div id="botSettingsResults">‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞...</div>
      <button onclick="this.closest('[style*=fixed]').remove()" 
              style="margin-top: 15px; padding: 10px 20px; background: #f44336; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          const resultsDiv = content.querySelector("#botSettingsResults");

          try {
            const botInfo = await this.sendTelegramRequest("getMe");

            let html = "";

            if (botInfo && botInfo.ok) {
              const bot = botInfo.result;
              const canReadAll = bot.can_read_all_group_messages;

              html += `
          <div style="background: ${canReadAll ? "#e8f5e8" : "#fff3cd"}; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0;">üîê Privacy Mode (–†–µ–∂–∏–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏)</h4>
            <strong>–ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≥—Ä—É–ø–ø—ã:</strong> 
            <span style="font-weight: bold; color: ${canReadAll ? "#4CAF50" : "#FF9800"};">
              ${canReadAll ? "‚úÖ –í–ö–õ–Æ–ß–ï–ù–û" : "‚ö†Ô∏è –û–¢–ö–õ–Æ–ß–ï–ù–û"}
            </span><br><br>
            
            ${
              canReadAll
                ? '<div style="color: #4CAF50;">‚úÖ <strong>–û—Ç–ª–∏—á–Ω–æ!</strong> –ë–æ—Ç –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø—ã @noninput –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å —Å–∞–π—Ç–æ–º.</div>'
                : `<div style="color: #FF9800;">
                ‚ö†Ô∏è <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞!</strong> –ë–æ—Ç –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ –µ–º—É (@Inputlagthebot).<br><br>
                
                <strong>üîß –ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:</strong><br>
                1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/BotFather" target="_blank" style="color: #1976d2;">@BotFather</a><br>
                2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/mybots</code><br>
                3. –í—ã–±–µ—Ä–∏—Ç–µ <code>@${bot.username}</code><br>
                4. –ù–∞–∂–º–∏—Ç–µ <code>Bot Settings</code><br>
                5. –ù–∞–∂–º–∏—Ç–µ <code>Group Privacy</code><br>
                6. –í—ã–±–µ—Ä–∏—Ç–µ <code>Turn off</code> (–æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)<br>
                7. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è<br><br>
                
                <strong>üîÑ –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:</strong><br>
                ‚Ä¢ –û–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É<br>
                ‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ @noninput<br>
                ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
              </div>`
            }
          </div>
          
          <div style="text-align: center; margin-top: 15px;">
            <button onclick="window.open('https://t.me/noninput', '_blank')" 
                    style="background: #0088cc; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer;">
              üì± –û—Ç–∫—Ä—ã—Ç—å @noninput
            </button>
            <button onclick="window.open('https://t.me/BotFather', '_blank')" 
                    style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer;">
              ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞
            </button>
          </div>
        `;
            }

            resultsDiv.innerHTML = html;
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞:", error);
            resultsDiv.innerHTML = `
        <div style="color: #f44336; font-weight: bold; margin-bottom: 15px;">
          ‚ùå –û–®–ò–ë–ö–ê –ü–†–û–í–ï–†–ö–ò –ù–ê–°–¢–†–û–ï–ö
        </div>
        <div style="background: #ffebee; padding: 10px; border-radius: 5px;">
          <strong>–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:</strong><br>
          ${error.message}
        </div>
      `;
          }
        }

        async checkBotToken() {
          console.log("üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞...");

          // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 500px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          content.innerHTML = `
      <h3>üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞</h3>
      <div id="tokenResults">‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω...</div>
      <button onclick="this.closest('[style*=fixed]').remove()" 
              style="margin-top: 15px; padding: 10px 20px; background: #f44336; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          const resultsDiv = content.querySelector("#tokenResults");

          try {
            resultsDiv.innerHTML = `
        <div style="margin-bottom: 10px;">
          ÔøΩ <strong>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:</strong><br>
          <div style="background: #f5f5f5; padding: 10px; border-radius: 3px; margin-top: 5px;">
            –¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
          </div>
        </div>
        <div>‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
      `;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
            const botInfo = await this.sendTelegramRequest("getMe");

            if (botInfo && botInfo.ok) {
              // –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!
              const bot = botInfo.result;
              resultsDiv.innerHTML = `
          <div style="color: #4CAF50; font-weight: bold; margin-bottom: 15px;">
            ‚úÖ –¢–û–ö–ï–ù –î–ï–ô–°–¢–í–ò–¢–ï–õ–ï–ù –ò –§–£–ù–ö–¶–ò–û–ù–ò–†–£–ï–¢!
          </div>
          
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:</strong><br>
            ‚Ä¢ <strong>–ò–º—è:</strong> ${bot.first_name}<br>
            ‚Ä¢ <strong>Username:</strong> @${bot.username}<br>
            ‚Ä¢ <strong>–ú–æ–∂–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–∞–º:</strong> ${bot.can_join_groups ? "‚úÖ –î–∞" : "‚ùå –ù–µ—Ç"}<br>
            ‚Ä¢ <strong>–ú–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</strong> ${bot.can_read_all_group_messages ? "‚úÖ –î–∞" : "‚ùå –ù–µ—Ç"}<br>
            ‚Ä¢ <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º:</strong> ${bot.supports_inline_queries ? "‚úÖ –î–∞" : "‚ùå –ù–µ—Ç"}
          </div>
          
          <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            üîê <strong>–°—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</strong> –¢–æ–∫–µ–Ω –∑–∞—â–∏—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ<br>
            <strong>üì± –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞:</strong> <a href="https://t.me/${bot.username}" target="_blank">https://t.me/${bot.username}</a>
          </div>
          
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
            <strong>‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</strong><br>
            1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–Ω–∞–ª <a href="https://t.me/noninput" target="_blank">@noninput</a><br>
            2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ @${bot.username} –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞<br>
            3. –î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π<br>
            4. –ù–∞–∂–º–∏—Ç–µ "üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞
          </div>
        `;

              console.log("‚úÖ –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω:", bot);
            } else {
              // –¢–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
              const errorCode = botInfo?.error_code || "unknown";
              const errorDesc = botInfo?.description || "Unknown error";

              resultsDiv.innerHTML = `
          <div style="color: #f44336; font-weight: bold; margin-bottom: 15px;">
            ‚ùå –¢–û–ö–ï–ù –ù–ï –î–ï–ô–°–¢–í–ò–¢–ï–õ–ï–ù!
          </div>
          
          <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>üö® –û—à–∏–±–∫–∞ API:</strong><br>
            ‚Ä¢ <strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> ${errorCode}<br>
            ‚Ä¢ <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${errorDesc}
          </div>
          
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
            <strong>üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</strong><br>
            1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/BotFather" target="_blank">@BotFather</a> –≤ Telegram<br>
            2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /mybots<br>
            3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞<br>
            4. –ù–∞–∂–º–∏—Ç–µ "API Token"<br>
            5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω<br>
            6. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          </div>
        `;

              console.error("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω:", botInfo);
            }
          } catch (error) {
            console.error("üö® –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:", error);

            resultsDiv.innerHTML = `
        <div style="color: #f44336; font-weight: bold; margin-bottom: 15px;">
          üö® –û–®–ò–ë–ö–ê –ü–†–û–í–ï–†–ö–ò!
        </div>
        
        <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
          <strong>‚ùå –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:</strong><br>
          ${error.message}
        </div>
        
        <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
          <strong>üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong><br>
          1. –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º<br>
          2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ CORS (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä)<br>
          3. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ Telegram<br>
          4. –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞<br><br>
          
          <strong>üîß –ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:</strong><br>
          ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ<br>
          ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –æ—à–∏–±–æ–∫<br>
          ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ
        </div>
      `;
          }
        }

        showTelegramDiagnostics() {
          const diagnostics = `
üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM –ù–ê–°–¢–†–û–ï–ö

üìã –¢–ï–ö–£–©–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:
üîê –¢–æ–∫–µ–Ω –±–æ—Ç–∞: –∑–∞—â–∏—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
‚Ä¢ ID –∫–∞–Ω–∞–ª–∞: ${this.telegramConfig.chatId}
‚Ä¢ –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${this.connectionState.isConnected ? "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω" : "‚ùå –û—Ç–∫–ª—é—á–µ–Ω"}
‚Ä¢ –ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: ${this.connectionState.consecutiveFailures}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏: ${this.proxyUrls[this.currentProxyIndex] || "–ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"}

üîß –ü–û–®–ê–ì–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê –ù–ê–°–¢–†–û–ï–ö:

1Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –ë–û–¢–ê @Inputlagthebot:
   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ https://t.me/Inputlagthebot
   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å" –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start
   ‚Ä¢ –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å
   ‚ùå –ï—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç ‚Üí –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω

2Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –ö–ê–ù–ê–õ–ê @noninput:
   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ https://t.me/noninput
   ‚Ä¢ –ö–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø—É–±–ª–∏—á–Ω—ã–π
   ‚ùå –ï—Å–ª–∏ "–∫–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω" ‚Üí –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–∞—Ç–Ω—ã–π

3Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í –ë–û–¢–ê –í –ö–ê–ù–ê–õ–ï:
   ‚Ä¢ –ó–∞–π–¥–∏—Ç–µ –≤ –∫–∞–Ω–∞–ª https://t.me/noninput
   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤–≤–µ—Ä—Ö—É
   ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–º"
   ‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"
   ‚Ä¢ –ù–∞–π–¥–∏—Ç–µ @Inputlagthebot –≤ —Å–ø–∏—Å–∫–µ
   ‚ùå –ï—Å–ª–∏ –±–æ—Ç–∞ –Ω–µ—Ç ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

4Ô∏è‚É£ –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ê–í –ë–û–¢–ê:
   ‚Ä¢ –í —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ @Inputlagthebot
   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤–∫–ª—é—á–µ–Ω—ã –ø—Ä–∞–≤–∞:
     ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
     ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–Ω–∞–ª–∞
     ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   ‚ùå –ï—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç ‚Üí –≤–∫–ª—é—á–∏—Ç–µ –∏—Ö

5Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –¢–û–ö–ï–ù–ê –ë–û–¢–ê:
   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ https://t.me/BotFather
   ‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ /mybots
   ‚Ä¢ –ù–∞–π–¥–∏—Ç–µ Inputlagthebot
   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "API Token"
   üîê –¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

üí° –ë–´–°–¢–†–´–ï –¢–ï–°–¢–´:
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏" –≤—ã—à–µ
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–∞ –æ—à–∏–±–∫–∏
‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Telegram
`;

          // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 600px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          content.innerHTML = `
      <pre style="white-space: pre-wrap; margin: 0; color: var(--text);">${diagnostics}</pre>
      <button onclick="this.closest('[style*=fixed]').remove()" 
              style="margin-top: 15px; padding: 10px 20px; background: #f44336; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
      <button onclick="multiUserChat.runQuickTests(); this.closest('[style*=fixed]').remove();" 
              style="margin-left: 10px; padding: 10px 20px; background: #4CAF50; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
      </button>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
        async forceUpdateGlobalCounter() {
          console.log("üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞...");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é globalCounter –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          if (!this.globalCounter) {
            console.warn(
              "‚ö†Ô∏è globalCounter –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...",
            );

            // –ü—Ä—è–º–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞ initGlobalCounter
            this.globalCounter = {
              apis: [
                // --- –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å—á—ë—Ç—á–∏–∫–∏ (—É–º–µ—é—Ç hit/get)
                {
                  name: "CountAPI",
                  type: "counter", // —É–º–µ–µ—Ç hit/get
                  base: "https://api.countapi.xyz",
                  hit: "/hit/{ns}/{key}",
                  get: "/get/{ns}/{key}",
                  cors: true,
                  notes: "–ü—Ä–æ—Å—Ç–æ–π –ø—É–±–ª–∏—á–Ω—ã–π —Å—á—ë—Ç—á–∏–∫",
                },
                {
                  name: "CounterAPI.dev",
                  type: "counter",
                  base: "https://api.counterapi.dev",
                  hit: "/hit/{ns}/{key}",
                  get: "/get/{ns}/{key}",
                  cors: true,
                  notes: "–ê–Ω–∞–ª–æ–≥ CountAPI",
                },

                // --- –î–∞–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ ¬´–ø–∏–Ω–≥–∏¬ª (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/CORS)
                {
                  name: "ipify",
                  type: "ping", // —Ç–æ–ª—å–∫–æ GET, –±–µ–∑ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
                  base: "https://api.ipify.org",
                  get: "/?format=json",
                  cors: true,
                  notes: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",
                },
                {
                  name: "GitHubZen",
                  type: "ping",
                  base: "https://api.github.com",
                  get: "/zen",
                  cors: true,
                  notes: "–ë—ã—Å—Ç—Ä—ã–π CORS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø–∏–Ω–≥",
                },
                {
                  name: "JSONPlaceholder",
                  type: "ping",
                  base: "https://jsonplaceholder.typicode.com",
                  get: "/posts/1",
                  cors: true,
                  notes: "–ü—É–±–ª–∏—á–Ω—ã–π JSON API –¥–ª—è –ø–∏–Ω–≥–∞",
                },
              ],

              // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
              apiUrls: [
                "https://api.countapi.xyz",
                "https://api.counterapi.dev",
                "https://api.ipify.org",
                "https://api.github.com",
                "https://jsonplaceholder.typicode.com",
              ],

              // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
              namespace: "suslovpa-frequency-scanner",
              key: "global-visitors",

              currentApiIndex: 0, // –∏–Ω–¥–µ–∫—Å —Ä–∞–±–æ—á–µ–≥–æ API –∏–∑ –º–∞—Å—Å–∏–≤–∞ apis
              lastWorkingAPI: null, // —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–≤—à–∏–π –æ–±—ä–µ–∫—Ç API
              failedAPIs: new Set(), // –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö API
              isOnline: false,
              lastUpdate: 0,

              retryCount: 0,
              maxRetries: 8,

              // –†–µ–∂–∏–º—ã
              useHybridMode: true, // –≥–∏–±—Ä–∏–¥: —Ä–µ–∞–ª—å–Ω—ã–µ + —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
              simulatedCount: 1247, // —Å—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
              successRate: 0, // % —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–ª—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏/–ª–æ–≥–æ–≤)

              // –¢–∞–π–º–∞—É—Ç—ã
              connectionTimeout: 12000, // 12 —Å–µ–∫
            };

            console.log("‚úÖ globalCounter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ");
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
          if (!this.globalCounter) {
            console.error(
              "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å globalCounter –¥–∞–∂–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ",
            );
            return;
          }

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–æ–∫
          this.globalCounter.retryCount = 0;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –æ–Ω–ª–∞–π–Ω
          this.updateGlobalStatsWidget(0, true, null, "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ");

          try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é (—Ä–µ–∞–ª—å–Ω—ã–µ API –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è CORS –Ω–∞ GitHub Pages)
            console.log(
              "üé≠ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è (CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–Ω–µ—à–Ω–∏–µ API)",
            );

            const config = this.globalCounter;
            const simulatedCount = await this.simulateGlobalCounter();

            // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ–Ω–ª–∞–π–Ω –≤ —Ä–µ–∂–∏–º–µ —Å–∏–º—É–ª—è—Ü–∏–∏
            config.isOnline = true;
            config.lastUpdate = Date.now();

            this.updateGlobalStatsWidget(
              simulatedCount,
              true,
              null,
              "—Å–∏–º—É–ª—è—Ü–∏—è",
            );

            console.log(
              `‚úÖ –°—á–µ—Ç—á–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: ${simulatedCount} –ø–æ—Å–µ—â–µ–Ω–∏–π`,
            );

            // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
            await this.getVisitorInfo();

            // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);

            // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–æ–Ω–ª–∞–π–Ω" —Ä–µ–∂–∏–º
            const emergencyCount = 1200 + Math.floor(Math.random() * 200);
            this.globalCounter.isOnline = true;
            this.updateGlobalStatsWidget(
              emergencyCount,
              true,
              null,
              "–∞–≤–∞—Ä–∏–π–Ω—ã–π",
            );
          }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö API
        async diagnoseAPIProblems() {
          console.log("üîç –ó–∞–ø—É—Å–∫ —É–ª—É—á—à–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ API –ø—Ä–æ–±–ª–µ–º...");

          const results = {
            internetTest: null,
            networkTest: null,
            corsTest: null,
            dnsTest: null,
            apiTests: [],
            fallbackTests: [],
            environment: this.getEnvironmentInfo(),
            recommendations: [],
            totalScore: 0,
            diagnosis: "",
            solutions: [],
          };

          // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–∞–π—Ç–∞
          console.log("üåê –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...");
          results.internetTest = await this.testInternetConnectivity();

          // –¢–µ—Å—Ç 2: –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏ –∏ CORS
          console.log("üîß –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤...");
          results.networkTest = await this.testNetworkProtocols();
          results.corsTest = await this.testCORSPolicies();

          // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏
          console.log("üì° –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏...");
          results.dnsTest = await this.testDNSResolution();

          // –¢–µ—Å—Ç 4: –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API —Å—á–µ—Ç—á–∏–∫–æ–≤
          console.log("üß™ –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å—á–µ—Ç—á–∏–∫–æ–≤...");
          results.apiTests = await this.testCounterAPIs();

          // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
          console.log("üõ°Ô∏è –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤...");
          results.fallbackTests = await this.testFallbackMethods();

          // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
          const analysis = this.analyzeTestResults(results);
          results.totalScore = analysis.score;
          results.diagnosis = analysis.diagnosis;
          results.solutions = analysis.solutions;
          results.recommendations =
            this.generateImprovedRecommendations(results);

          return results;
        }

        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async testInternetConnectivity() {
          const testServices = [
            { name: "Google", url: "https://www.google.com", type: "search" },
            { name: "Cloudflare", url: "https://1.1.1.1", type: "dns" },
            { name: "GitHub", url: "https://api.github.com", type: "api" },
            { name: "Mozilla", url: "https://mozilla.org", type: "website" },
            {
              name: "JSONPlaceholder",
              url: "https://jsonplaceholder.typicode.com/posts/1",
              type: "test-api",
            },
          ];

          const results = [];
          let successCount = 0;
          let totalResponseTime = 0;

          for (const service of testServices) {
            try {
              const startTime = performance.now();

              const response = await Promise.race([
                fetch(service.url, {
                  method: service.type === "test-api" ? "GET" : "HEAD",
                  mode: service.type === "test-api" ? "cors" : "no-cors",
                  cache: "no-cache",
                  headers: {
                    Accept: "application/json",
                    "User-Agent":
                      "Mozilla/5.0 (compatible; SuslovPA-Diagnostics/1.0)",
                  },
                }),
                new Promise((_, reject) =>
                  setTimeout(() => reject(new Error("Timeout")), 6000),
                ),
              ]);

              const endTime = performance.now();
              const timing = Math.round(endTime - startTime);
              totalResponseTime += timing;

              let status = "–î–æ—Å—Ç—É–ø–µ–Ω";
              if (service.type === "test-api" && response.ok) {
                try {
                  const data = await response.json();
                  status = `–î–æ—Å—Ç—É–ø–µ–Ω (JSON: ${data.id || "OK"})`;
                } catch (e) {
                  status = "–î–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ JSON)";
                }
              }

              results.push({
                name: service.name,
                url: service.url,
                type: service.type,
                success: true,
                timing: timing,
                status: status,
              });

              successCount++;
            } catch (error) {
              results.push({
                name: service.name,
                url: service.url,
                type: service.type,
                success: false,
                error: error.message,
                status: "–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
              });
            }
          }

          const avgResponseTime =
            successCount > 0 ? Math.round(totalResponseTime / successCount) : 0;
          const successRate = (successCount / testServices.length) * 100;

          return {
            success: successCount >= 2, // –ú–∏–Ω–∏–º—É–º 2 —Å–µ—Ä–≤–∏—Å–∞ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å
            successRate: successRate,
            workingServices: successCount,
            totalTested: testServices.length,
            averageResponseTime: avgResponseTime,
            message:
              successCount >= 2
                ? `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (${successCount}/${testServices.length} —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã, —Å—Ä. –≤—Ä–µ–º—è: ${avgResponseTime}–º—Å)`
                : "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ",
            testedServices: results,
            quality: this.assessConnectionQuality(successRate, avgResponseTime),
          };
        }

        // –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        assessConnectionQuality(successRate, avgResponseTime) {
          if (successRate >= 80 && avgResponseTime < 500) return "–æ—Ç–ª–∏—á–Ω–æ–µ";
          if (successRate >= 60 && avgResponseTime < 1000) return "—Ö–æ—Ä–æ—à–µ–µ";
          if (successRate >= 40 && avgResponseTime < 2000)
            return "—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ";
          if (successRate >= 20) return "–ø–ª–æ—Ö–æ–µ";
          return "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ";
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤
        async testNetworkProtocols() {
          const tests = [
            {
              name: "HTTPS GET",
              url: "https://httpbin.org/get",
              method: "GET",
            },
            {
              name: "HTTPS POST",
              url: "https://httpbin.org/post",
              method: "POST",
            },
            {
              name: "JSON API",
              url: "https://jsonplaceholder.typicode.com/posts/1",
              method: "GET",
            },
          ];

          let workingProtocols = 0;
          const results = [];

          for (const test of tests) {
            try {
              const response = await Promise.race([
                fetch(test.url, {
                  method: test.method,
                  mode: "cors",
                  headers: {
                    "Content-Type": "application/json",
                    Accept: "application/json",
                  },
                  body:
                    test.method === "POST"
                      ? JSON.stringify({ test: true })
                      : undefined,
                }),
                new Promise((_, reject) =>
                  setTimeout(() => reject(new Error("Timeout")), 5000),
                ),
              ]);

              if (response.ok) {
                workingProtocols++;
                results.push({
                  name: test.name,
                  success: true,
                  status: response.status,
                });
              } else {
                results.push({
                  name: test.name,
                  success: false,
                  error: `HTTP ${response.status}`,
                });
              }
            } catch (error) {
              results.push({
                name: test.name,
                success: false,
                error: error.message,
              });
            }
          }

          return {
            success: workingProtocols > 0,
            workingProtocols: workingProtocols,
            totalTested: tests.length,
            message:
              workingProtocols > 0
                ? "–°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç"
                : "–°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã",
            results: results,
          };
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CORS –ø–æ–ª–∏—Ç–∏–∫
        async testCORSPolicies() {
          const corsTestUrls = [
            {
              name: "GitHub API",
              url: "https://api.github.com/zen",
              expectsCORS: true,
            },
            {
              name: "JSONPlaceholder",
              url: "https://jsonplaceholder.typicode.com/posts/1",
              expectsCORS: true,
            },
            {
              name: "HTTPBin",
              url: "https://httpbin.org/get",
              expectsCORS: true,
            },
          ];

          let corsWorking = 0;
          const results = [];

          for (const test of corsTestUrls) {
            try {
              const response = await Promise.race([
                fetch(test.url, {
                  method: "GET",
                  mode: "cors",
                  headers: { Accept: "application/json" },
                }),
                new Promise((_, reject) =>
                  setTimeout(() => reject(new Error("Timeout")), 4000),
                ),
              ]);

              if (response.ok) {
                corsWorking++;
                results.push({
                  name: test.name,
                  url: test.url,
                  success: true,
                  status: "CORS —Ä–∞–±–æ—Ç–∞–µ—Ç",
                });
              } else {
                results.push({
                  name: test.name,
                  url: test.url,
                  success: false,
                  error: `HTTP ${response.status}`,
                });
              }
            } catch (error) {
              const isCORSError =
                error.message.includes("CORS") ||
                error.message.includes("Access-Control") ||
                error.message.includes("Cross-Origin");

              results.push({
                name: test.name,
                url: test.url,
                success: false,
                error: error.message,
                isCORSError: isCORSError,
              });
            }
          }

          return {
            success: corsWorking >= 2,
            workingApis: corsWorking,
            totalTested: corsTestUrls.length,
            message:
              corsWorking >= 2
                ? "CORS —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ"
                : "CORS –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",
            results: results,
            severity:
              corsWorking === 0
                ? "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è"
                : corsWorking < 2
                  ? "—Å—Ä–µ–¥–Ω—è—è"
                  : "–Ω–∏–∑–∫–∞—è",
          };
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏
        async testDNSResolution() {
          const dnsTestDomains = [
            "api.countapi.xyz",
            "api.counterapi.dev",
            "counter-api.dev",
            "httpbin.org",
            "api.github.com",
            "google.com",
          ];

          let resolvedDomains = 0;
          const results = [];

          for (const domain of dnsTestDomains) {
            try {
              const response = await Promise.race([
                fetch(`https://${domain}`, {
                  method: "HEAD",
                  mode: "no-cors",
                  cache: "no-cache",
                }),
                new Promise((_, reject) =>
                  setTimeout(() => reject(new Error("DNS Timeout")), 3000),
                ),
              ]);

              resolvedDomains++;
              results.push({
                domain: domain,
                success: true,
                status: "–†–µ–∑–æ–ª–≤–∏—Ç—Å—è",
              });
            } catch (error) {
              const isDNSError =
                error.message.includes("DNS") ||
                error.message.includes("NXDOMAIN") ||
                error.message.includes("resolve");

              // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ CORS, –∑–Ω–∞—á–∏—Ç –¥–æ–º–µ–Ω —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è
              if (
                error.message.includes("CORS") ||
                error.message.includes("Access-Control")
              ) {
                resolvedDomains++;
                results.push({
                  domain: domain,
                  success: true,
                  status: "–†–µ–∑–æ–ª–≤–∏—Ç—Å—è (CORS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)",
                });
              } else {
                results.push({
                  domain: domain,
                  success: false,
                  error: error.message,
                  isDNSError: isDNSError,
                });
              }
            }
          }

          return {
            success: resolvedDomains >= 4,
            resolvedDomains: resolvedDomains,
            totalTested: dnsTestDomains.length,
            message:
              resolvedDomains >= 4
                ? "DNS —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
                : "–ü—Ä–æ–±–ª–µ–º—ã —Å DNS —Ä–µ–∑–æ–ª—é—Ü–∏–µ–π",
            results: results,
          };
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å—á–µ—Ç—á–∏–∫–æ–≤
        async testCounterAPIs() {
          const config = this.globalCounter;
          const results = [];

          for (let i = 0; i < config.apiUrls.length; i++) {
            const apiUrl = config.apiUrls[i];
            const testResult = {
              url: apiUrl,
              name: this.getAPIName(apiUrl),
              index: i,
              success: false,
              error: null,
              response: null,
              timing: null,
              errorType: null,
              httpStatus: null,
            };

            try {
              const startTime = performance.now();
              const result = await this.testAPIEndpoint(apiUrl, "get", 8000);

              testResult.timing = result.responseTime;
              testResult.success = result.success;

              if (result.success) {
                testResult.response = result.data;
                testResult.httpStatus = 200;
              } else {
                testResult.error = result.error;
                testResult.errorType = this.classifyAPIError(result.error);
              }
            } catch (error) {
              testResult.error = error.message;
              testResult.errorType = this.classifyAPIError(error.message);
            }

            results.push(testResult);
          }

          return results;
        }

        // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ API
        classifyAPIError(errorMessage) {
          const error = errorMessage.toLowerCase();

          if (
            error.includes("failed to fetch") ||
            error.includes("network error")
          ) {
            return "network";
          } else if (error.includes("timeout")) {
            return "timeout";
          } else if (
            error.includes("cors") ||
            error.includes("access-control")
          ) {
            return "cors";
          } else if (error.includes("404") || error.includes("not found")) {
            return "not-found";
          } else if (error.includes("403") || error.includes("forbidden")) {
            return "forbidden";
          } else if (
            error.includes("500") ||
            error.includes("internal server")
          ) {
            return "server-error";
          } else if (error.includes("dns") || error.includes("resolve")) {
            return "dns";
          } else {
            return "unknown";
          }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
        async testFallbackMethods() {
          const results = [];

          // –¢–µ—Å—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
          try {
            localStorage.setItem("fallback_test", "test");
            const value = localStorage.getItem("fallback_test");
            localStorage.removeItem("fallback_test");

            results.push({
              name: "LocalStorage",
              type: "local",
              success: value === "test",
              message: "–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç",
            });
          } catch (error) {
            results.push({
              name: "LocalStorage",
              type: "local",
              success: false,
              error: error.message,
            });
          }

          // –¢–µ—Å—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö API
          const fallbackAPIs = [
            { name: "HTTPBin UUID", url: "https://httpbin.org/uuid" },
            { name: "GitHub Zen", url: "https://api.github.com/zen" },
            {
              name: "JSONPlaceholder",
              url: "https://jsonplaceholder.typicode.com/posts/1",
            },
          ];

          for (const api of fallbackAPIs) {
            try {
              const result = await this.testAPIEndpoint(api.url, "get", 5000);
              results.push({
                name: api.name,
                type: "external",
                success: result.success,
                timing: result.responseTime,
                message: result.success ? "–†–∞–±–æ—Ç–∞–µ—Ç" : result.error,
              });
            } catch (error) {
              results.push({
                name: api.name,
                type: "external",
                success: false,
                error: error.message,
              });
            }
          }

          return results;
        }

        // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        analyzeTestResults(results) {
          let score = 0;
          let diagnosis = "";
          let solutions = [];

          // –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–≤–µ—Å: 30%)
          if (results.internetTest?.success) {
            score += 30;
            if (results.internetTest.quality === "–æ—Ç–ª–∏—á–Ω–æ–µ") score += 5;
            else if (results.internetTest.quality === "—Ö–æ—Ä–æ—à–µ–µ") score += 3;
          } else {
            diagnosis = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º";
            solutions.push("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É");
            solutions.push("–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–æ—É—Ç–µ—Ä/–º–æ–¥–µ–º");
            solutions.push("–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞");
          }

          // –ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ (–≤–µ—Å: 20%)
          if (results.networkTest?.success) {
            score += 20;
          } else {
            if (!diagnosis) diagnosis = "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏";
            solutions.push("–û—Ç–∫–ª—é—á–∏—Ç–µ VPN/–ø—Ä–æ–∫—Å–∏");
            solutions.push("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∞–π—Ä–≤–æ–ª–∞");
          }

          // –ê–Ω–∞–ª–∏–∑ CORS (–≤–µ—Å: 25%)
          if (results.corsTest?.success) {
            score += 25;
            if (results.corsTest.severity === "–Ω–∏–∑–∫–∞—è") score += 5;
          } else {
            if (!diagnosis) diagnosis = "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ CORS –ø–æ–ª–∏—Ç–∏–∫–æ–π –±—Ä–∞—É–∑–µ—Ä–∞";
            solutions.push("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä");
            solutions.push("–û—Ç–∫–ª—é—á–∏—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Ä–µ–∫–ª–∞–º—ã");
            solutions.push("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ");
          }

          // –ê–Ω–∞–ª–∏–∑ DNS (–≤–µ—Å: 15%)
          if (results.dnsTest?.success) {
            score += 15;
          } else {
            if (!diagnosis) diagnosis = "–ü—Ä–æ–±–ª–µ–º—ã —Å DNS —Ä–µ–∑–æ–ª—é—Ü–∏–µ–π";
            solutions.push("–°–º–µ–Ω–∏—Ç–µ DNS —Å–µ—Ä–≤–µ—Ä—ã (8.8.8.8, 1.1.1.1)");
            solutions.push("–û—á–∏—Å—Ç–∏—Ç–µ DNS –∫—ç—à");
          }

          // –ê–Ω–∞–ª–∏–∑ API —Å—á–µ—Ç—á–∏–∫–æ–≤ (–≤–µ—Å: 10%)
          const workingAPIs =
            results.apiTests?.filter((test) => test.success).length || 0;
          if (workingAPIs > 0) {
            score += Math.min(10, workingAPIs * 2);
          }

          // –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
          if (score >= 80) {
            diagnosis = "–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ";
          } else if (score >= 60) {
            if (!diagnosis) diagnosis = "–ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º";
          } else if (score >= 40) {
            if (!diagnosis)
              diagnosis = "–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é API";
          } else if (score >= 20) {
            if (!diagnosis)
              diagnosis = "–°–µ—Ä—å–µ–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º";
          } else {
            if (!diagnosis)
              diagnosis =
                "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã - –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
          }

          return {
            score: Math.round(score),
            diagnosis: diagnosis,
            solutions: solutions,
          };
        }

        // –¢–µ—Å—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–∞–π—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
        async testInternetConnectivity() {
          const testServices = [
            { name: "Google", url: "https://www.google.com", timeout: 5000 },
            { name: "Cloudflare", url: "https://1.1.1.1", timeout: 5000 },
            { name: "GitHub", url: "https://api.github.com", timeout: 5000 },
            { name: "Mozilla", url: "https://mozilla.org", timeout: 5000 },
          ];

          const results = [];
          let successCount = 0;

          for (const service of testServices) {
            try {
              const startTime = performance.now();

              const response = await Promise.race([
                fetch(service.url, {
                  method: "HEAD",
                  mode: "no-cors", // –ò—Å–ø–æ–ª—å–∑—É–µ–º no-cors –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è CORS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                  cache: "no-cache",
                }),
                new Promise((_, reject) =>
                  setTimeout(
                    () => reject(new Error("Timeout")),
                    service.timeout,
                  ),
                ),
              ]);

              const endTime = performance.now();
              const timing = Math.round(endTime - startTime);

              results.push({
                name: service.name,
                url: service.url,
                success: true,
                timing: timing,
                status: "–î–æ—Å—Ç—É–ø–µ–Ω",
              });

              successCount++;
            } catch (error) {
              results.push({
                name: service.name,
                url: service.url,
                success: false,
                error: error.message,
                status: "–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
              });
            }
          }

          const successRate = (successCount / testServices.length) * 100;

          return {
            success: successCount > 0,
            successRate: successRate,
            workingServices: successCount,
            totalTested: testServices.length,
            message:
              successCount > 0
                ? `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (${successCount}/${testServices.length} —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã)`
                : "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ",
            testedServices: results,
          };
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏
        getEnvironmentInfo() {
          return {
            userAgent: navigator.userAgent.substring(0, 100),
            browser: this.detectBrowser(),
            isLocal:
              window.location.hostname === "localhost" ||
              window.location.hostname === "127.0.0.1",
            isHTTPS: window.location.protocol === "https:",
            domain: window.location.hostname,
            hasServiceWorker: "serviceWorker" in navigator,
            cookiesEnabled: navigator.cookieEnabled,
            language: navigator.language,
            platform: navigator.platform,
            onlineStatus: navigator.onLine,
          };
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        detectBrowser() {
          const ua = navigator.userAgent;
          if (ua.includes("Chrome")) return "Chrome";
          if (ua.includes("Firefox")) return "Firefox";
          if (ua.includes("Safari")) return "Safari";
          if (ua.includes("Edge")) return "Edge";
          if (ua.includes("Opera")) return "Opera";
          return "Unknown";
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º
        generateAPIRecommendations(results) {
          const recommendations = [];

          // –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Å–∞–π—Ç–∞
          if (
            !results.internetTest?.success ||
            results.internetTest?.successRate < 50
          ) {
            recommendations.push({
              type: "internet",
              title: "üåê –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Å–∞–π—Ç–∞",
              solutions: [
                "–°–∞–π—Ç –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º",
                "–í–æ–∑–º–æ–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞",
                "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–π—Ä–≤–æ–ª –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã",
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
                "–û—Ç–∫–ª—é—á–∏—Ç–µ VPN/–ø—Ä–æ–∫—Å–∏ –Ω–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞",
                "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–µ—Ç–∏ (–µ—Å–ª–∏ –≤ –æ—Ñ–∏—Å–µ)",
              ],
            });
          }

          // –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
          if (!results.networkTest?.success) {
            recommendations.push({
              type: "network",
              title: "üîå –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–≤–æ–π —Å–µ—Ç—å—é",
              solutions: [
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É",
                "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–æ—É—Ç–µ—Ä/–º–æ–¥–µ–º",
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å–µ—Ç—å (–º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)",
                "–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è",
              ],
            });
          }

          // –ü—Ä–æ–±–ª–µ–º—ã —Å CORS
          if (!results.corsTest?.success) {
            recommendations.push({
              type: "cors",
              title: "üîí –ü—Ä–æ–±–ª–µ–º—ã —Å CORS –ø–æ–ª–∏—Ç–∏–∫–æ–π",
              solutions: [
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Safari)",
                "–û—Ç–∫–ª—é—á–∏—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Ä–µ–∫–ª–∞–º—ã –Ω–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞",
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ/–ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞",
              ],
            });
          }

          // –ü—Ä–æ–±–ª–µ–º—ã —Å DNS
          if (!results.dnsTest?.success) {
            recommendations.push({
              type: "dns",
              title: "üì° –ü—Ä–æ–±–ª–µ–º—ã —Å DNS —Ä–µ–∑–æ–ª—é—Ü–∏–µ–π",
              solutions: [
                "–°–º–µ–Ω–∏—Ç–µ DNS —Å–µ—Ä–≤–µ—Ä—ã (8.8.8.8, 1.1.1.1)",
                "–û—á–∏—Å—Ç–∏—Ç–µ DNS –∫—ç—à (ipconfig /flushdns)",
                "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏",
              ],
            });
          }

          // –í—Å–µ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–∏ —Ä–∞–±–æ—á–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
          const workingAPIs = results.apiTests.filter(
            (test) => test.success,
          ).length;
          if (workingAPIs === 0 && results.internetTest?.success) {
            recommendations.push({
              type: "api-blocked",
              title: "üö´ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ API —Å—á–µ—Ç—á–∏–∫–æ–≤",
              solutions: [
                "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å—á–µ—Ç—á–∏–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã",
                "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–π—Ä–≤–æ–ª –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ API —Å—á–µ—Ç—á–∏–∫–æ–≤",
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏",
                "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É",
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VPN –¥–ª—è –æ–±—Ö–æ–¥–∞ –≥–µ–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞/—Ñ–∞–π—Ä–≤–æ–ª–∞",
              ],
            });
          } else if (workingAPIs === 0) {
            recommendations.push({
              type: "apis",
              title: "üö´ –í—Å–µ API —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã",
              solutions: [
                "API —Å–µ—Ä–≤–∏—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã",
                "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–π—Ä–≤–æ–ª –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã",
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ (—á–µ—Ä–µ–∑ 10-15 –º–∏–Ω—É—Ç)",
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å–µ—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
              ],
            });
          }

          // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          if (results.environment.isLocal) {
            recommendations.push({
              type: "local",
              title: "üíª –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞",
              solutions: [
                "CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∂–µ –¥–ª—è localhost",
                "–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Å–∞–π—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –¥–æ–º–µ–Ω–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤–º–µ—Å—Ç–æ HTTP",
                "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS",
              ],
            });
          }

          return recommendations;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–æ–±–ª–µ–º —Å API –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–æ–±–ª–µ–º —Å API –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        async diagnoseAPIIssues() {
          console.log("üîç –ó–∞–ø—É—Å–∫ —É–ª—É—á—à–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ API –ø—Ä–æ–±–ª–µ–º...");

          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 900px; max-height: 85vh; overflow-y: auto;
      font-family: system-ui; font-size: 12px; line-height: 1.4;
    `;

          content.innerHTML = `
      <h3>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö API</h3>
      <div id="diagnosisResults">
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
          <div>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞...</div>
          <div style="font-size: 11px; margin-top: 5px; opacity: 0.7;">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç—å, CORS, DNS –∏ API —Å–µ—Ä–≤–µ—Ä—ã</div>
        </div>
      </div>
      <button onclick="this.closest('[style*=fixed]').remove()" 
              style="margin-top: 15px; padding: 10px 20px; background: #f44336; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          const resultsDiv = content.querySelector("#diagnosisResults");

          try {
            const diagnosis = await this.diagnoseAPIProblems();

            // —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ª–∞–¥–∫–∏
            const working = diagnosis.apiTests.filter((t) => t.success).length;
            const total = diagnosis.apiTests.length || 0;

            resultsDiv.innerHTML = `
        <div style="padding:12px; background:#f8f9fa; border-radius:8px;">
          <h4>üìä –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç</h4>
          <div>API –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: <strong>${working}/${total}</strong></div>
          <div>–û—Ü–µ–Ω–∫–∞: <strong>${diagnosis.totalScore || 0}/100</strong></div>
          <div style="margin-top:8px; font-size:12px; color:#555;">${diagnosis.diagnosis || "–ù–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞"}</div>
        </div>
      `;
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:", err);
            resultsDiv.innerHTML = `<div style="color:#d32f2f; padding:12px;">–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${err.message}</div>`;
          }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏
        getScoreColor(score) {
          if (score >= 80) return "#4CAF50"; // –ó–µ–ª–µ–Ω—ã–π
          if (score >= 60) return "#FF9800"; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
          if (score >= 40) return "#f44336"; // –ö—Ä–∞—Å–Ω—ã–π
          return "#9C27B0"; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–∫—Ä–∏—Ç–∏—á–Ω–æ)
        }

        // –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
        getErrorTypeDescription(errorType) {
          const descriptions = {
            network: "üåê –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞",
            cors: "üõ°Ô∏è CORS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞",
            timeout: "‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è",
            "not-found": "üîç API –Ω–µ –Ω–∞–π–¥–µ–Ω (404)",
            forbidden: "üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (403)",
            "server-error": "üí• –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (5xx)",
            dns: "üì° –û—à–∏–±–∫–∞ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏",
            unknown: "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",
          };

          return descriptions[errorType] || errorType;
        }

        async showDiagnosticReport() {
          try {
            // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
            const diagnosis = await this.diagnoseAPIProblems();

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
            let reportHTML = `
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div style="background: ${diagnosis.internetTest?.success ? "#e8f5e8" : "#ffebee"}; padding: 10px; border-radius: 5px;">
              <strong>üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–∞–π—Ç–∞:</strong> ${diagnosis.internetTest?.success ? "‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç" : "‚ùå –ü—Ä–æ–±–ª–µ–º—ã"}<br>
              <small>${diagnosis.internetTest?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å"}</small>
            </div>
            
            <div style="background: ${diagnosis.networkTest?.success ? "#e8f5e8" : "#ffebee"}; padding: 10px; border-radius: 5px;">
              <strong>üåê –°–µ—Ç—å:</strong> ${diagnosis.networkTest?.success ? "‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç" : "‚ùå –ü—Ä–æ–±–ª–µ–º—ã"}<br>
              <small>${diagnosis.networkTest?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å"}</small>
            </div>
            
            <div style="background: ${diagnosis.corsTest?.success ? "#e8f5e8" : "#ffebee"}; padding: 10px; border-radius: 5px;">
              <strong>üõ°Ô∏è CORS:</strong> ${diagnosis.corsTest?.success ? "‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç" : "‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞"}<br>
              <small>${diagnosis.corsTest?.workingApis || 0}/${diagnosis.corsTest?.totalTested || 0} API –¥–æ—Å—Ç—É–ø–Ω—ã</small>
            </div>
            
            <div style="background: ${diagnosis.apiTests.filter((t) => t.success).length > 0 ? "#e8f5e8" : "#ffebee"}; padding: 10px; border-radius: 5px;">
              <strong>üîß API —Å—á–µ—Ç—á–∏–∫–∏:</strong> ${diagnosis.apiTests.filter((t) => t.success).length > 0 ? "‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ" : "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã"}<br>
              <small>${diagnosis.apiTests.filter((t) => t.success).length}/${diagnosis.apiTests.length} API —Ä–∞–±–æ—Ç–∞—é—Ç</small>
            </div>
          </div>
        </div>
        
        ${
          diagnosis.internetTest?.testedServices
            ? '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
              '<h4 style="margin: 0 0 10px 0; color: #495057;">üåê –¢–µ—Å—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h4>' +
              '<div style="font-size: 11px;">' +
              '<div style="margin-bottom: 8px;"><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ' +
              diagnosis.internetTest.workingServices +
              "/" +
              diagnosis.internetTest.totalTested +
              " —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã</div>" +
              diagnosis.internetTest.testedServices
                .map(
                  (service) =>
                    '<div style="margin: 4px 0; padding: 6px; background: ' +
                    (service.success ? "#e8f5e8" : "#ffebee") +
                    '; border-radius: 3px;">' +
                    "<strong>" +
                    service.name +
                    ":</strong> " +
                    service.status +
                    (service.timing ? " (" + service.timing + "–º—Å)" : "") +
                    (service.error ? " - " + service.error : "") +
                    "</div>",
                )
                .join("") +
              "</div></div>"
            : ""
        }
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #495057;">üñ•Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏</h4>
          <div style="font-size: 11px; display: grid; grid-template-columns: 120px 1fr; gap: 5px;">
            <div><strong>–ë—Ä–∞—É–∑–µ—Ä:</strong></div>
            <div>${diagnosis.environment.browser} (${diagnosis.environment.platform})</div>
            
            <div><strong>–ü—Ä–æ—Ç–æ–∫–æ–ª:</strong></div>
            <div>${diagnosis.environment.isHTTPS ? "üîí HTTPS" : "üîì HTTP"} –Ω–∞ ${diagnosis.environment.domain}</div>
            
            <div><strong>–õ–æ–∫–∞–ª—å–Ω—ã–π:</strong></div>
            <div>${diagnosis.environment.isLocal ? "üíª –î–∞ (localhost)" : "üåê –ù–µ—Ç (—É–¥–∞–ª–µ–Ω–Ω—ã–π)"}</div>
            
            <div><strong>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç:</strong></div>
            <div>${diagnosis.environment.onlineStatus ? "üü¢ –û–Ω–ª–∞–π–Ω" : "üî¥ –û—Ñ–ª–∞–π–Ω"}</div>
            
            <div><strong>–ö—É–∫–∏:</strong></div>
            <div>${diagnosis.environment.cookiesEnabled ? "‚úÖ –í–∫–ª—é—á–µ–Ω—ã" : "‚ùå –û—Ç–∫–ª—é—á–µ–Ω—ã"}</div>
          </div>
        </div>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #856404;">üîß –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API</h4>
          ${diagnosis.apiTests
            .map(
              (test, index) =>
                '<div style="margin: 8px 0; padding: 8px; background: ' +
                (test.success ? "#e8f5e8" : "#ffebee") +
                '; border-radius: 4px; font-size: 11px;">' +
                "<div><strong>API " +
                (index + 1) +
                ":</strong> " +
                test.url +
                "</div>" +
                "<div><strong>–°—Ç–∞—Ç—É—Å:</strong> " +
                (test.success ? "‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç" : "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω") +
                "</div>" +
                (test.timing
                  ? "<div><strong>–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong> " +
                    test.timing +
                    "–º—Å</div>"
                  : "") +
                (test.error
                  ? '<div style="color: #d32f2f;"><strong>–û—à–∏–±–∫–∞:</strong> ' +
                    test.error +
                    "</div>"
                  : "") +
                (test.errorType
                  ? "<div><strong>–¢–∏–ø –æ—à–∏–±–∫–∏:</strong> " +
                    test.errorType +
                    "</div>"
                  : "") +
                "</div>",
            )
            .join("")}
        </div>
        
        ${
          diagnosis.recommendations.length > 0
            ? '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">' +
              '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é</h4>' +
              diagnosis.recommendations
                .map(
                  (rec) =>
                    '<div style="margin-bottom: 12px; padding: 10px; background: var(--panel); color: var(--text); border-radius: 4px;">' +
                    '<h5 style="margin: 0 0 8px 0; color: #1976d2;">' +
                    rec.title +
                    "</h5>" +
                    '<ul style="margin: 0; padding-left: 18px; font-size: 11px;">' +
                    rec.solutions
                      .map(
                        (solution) =>
                          '<li style="margin: 3px 0;">' + solution + "</li>",
                      )
                      .join("") +
                    "</ul></div>",
                )
                .join("") +
              "</div>"
            : ""
        }
      `;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            this.showModal("üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API", reportHTML);
          } catch (error) {
            console.error(
              "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞:",
              error,
            );
            this.showModal(
              "‚ùå –û—à–∏–±–∫–∞",
              "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç.",
            );
          }
        }

        async testGlobalCounter() {
          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 600px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          content.innerHTML = `
      <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ API —Å—á–µ—Ç—á–∏–∫–∞</h3>
      <div id="globalTestResults">
        <div>üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...</div>
      </div>
      <button onclick="this.closest('[style*=fixed]').remove()" 
              style="margin-top: 15px; padding: 10px 20px; background: #f44336; 
                     color: white; border: none; border-radius: 5px; cursor: pointer;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          const resultsDiv = content.querySelector("#globalTestResults");

          try {
            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
            resultsDiv.innerHTML = `
        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
          <strong>üîÑ –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API</strong>
        </div>
        <div>‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º API —Å–µ—Ä–≤–µ—Ä—ã...</div>
      `;

            const config = this.globalCounter;
            let workingAPIs = [];
            let failedAPIs = [];

            for (let i = 0; i < config.apiUrls.length; i++) {
              const apiUrl = config.apiUrls[i];

              try {
                console.log(`üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º API ${i + 1}: ${apiUrl}`);
                const response = await this.makeAPIRequest(apiUrl, "get");

                if (response && response.value !== undefined) {
                  workingAPIs.push({
                    url: apiUrl,
                    response: response,
                    index: i,
                  });
                  console.log(`‚úÖ API ${i + 1} —Ä–∞–±–æ—Ç–∞–µ—Ç:`, response);
                } else {
                  failedAPIs.push({
                    url: apiUrl,
                    error: "–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç API",
                    index: i,
                  });
                }
              } catch (error) {
                failedAPIs.push({
                  url: apiUrl,
                  error: error.message,
                  index: i,
                });
                console.error(`‚ùå API ${i + 1} –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:`, error.message);
              }
            }

            // –¢–µ—Å—Ç 2: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
            resultsDiv.innerHTML += `
        <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0;">
          <strong>üîÑ –¢–µ—Å—Ç 2: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞</strong>
        </div>
      `;

            let incrementTest = null;
            if (workingAPIs.length > 0) {
              try {
                const api = workingAPIs[0];
                const beforeValue = api.response.value;

                console.log(`üìà –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å ${beforeValue}...`);
                const incrementResponse = await this.makeAPIRequest(
                  api.url,
                  "hit",
                );

                if (
                  incrementResponse &&
                  incrementResponse.value > beforeValue
                ) {
                  incrementTest = {
                    success: true,
                    before: beforeValue,
                    after: incrementResponse.value,
                    difference: incrementResponse.value - beforeValue,
                  };
                  console.log(
                    `‚úÖ –°—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω: ${beforeValue} ‚Üí ${incrementResponse.value}`,
                  );
                } else {
                  incrementTest = {
                    success: false,
                    error: "–°—á–µ—Ç—á–∏–∫ –Ω–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è",
                  };
                }
              } catch (error) {
                incrementTest = {
                  success: false,
                  error: error.message,
                };
              }
            }

            // –¢–µ—Å—Ç 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
            resultsDiv.innerHTML += `
        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
          <strong>üîÑ –¢–µ—Å—Ç 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</strong>
        </div>
        <div>‚è≥ –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏...</div>
      `;

            await this.getVisitorInfo();
            const locationTest = this.visitorInfo;

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
            let reportHTML = `
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
          
          <div style="margin-bottom: 15px;">
            <strong>üåê API –°–µ—Ä–≤–µ—Ä—ã (${workingAPIs.length}/${config.apiUrls.length} —Ä–∞–±–æ—Ç–∞—é—Ç):</strong><br>
            ${workingAPIs
              .map(
                (api) => `
              <div style="margin: 5px 0; padding: 5px; background: #e8f5e8; border-radius: 3px;">
                ‚úÖ API ${api.index + 1}: ${api.url}<br>
                <small>–¢–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫: ${api.response.value.toLocaleString()}</small>
              </div>
            `,
              )
              .join("")}
            
            ${failedAPIs
              .map(
                (api) => `
              <div style="margin: 5px 0; padding: 5px; background: #ffebee; border-radius: 3px;">
                ‚ùå API ${api.index + 1}: ${api.url}<br>
                <small>–û—à–∏–±–∫–∞: ${api.error}</small>
              </div>
            `,
              )
              .join("")}
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong>üìà –¢–µ—Å—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞:</strong><br>
            ${
              incrementTest
                ? incrementTest.success
                  ? `
              <div style="margin: 5px 0; padding: 5px; background: #e8f5e8; border-radius: 3px;">
                ‚úÖ –£—Å–ø–µ—à–Ω–æ: ${incrementTest.before.toLocaleString()} ‚Üí ${incrementTest.after.toLocaleString()} (+${incrementTest.difference})
              </div>
            `
                  : `
              <div style="margin: 5px 0; padding: 5px; background: #ffebee; border-radius: 3px;">
                ‚ùå –û—à–∏–±–∫–∞: ${incrementTest.error}
              </div>
            `
                : `
              <div style="margin: 5px 0; padding: 5px; background: #f5f5f5; border-radius: 3px;">
                ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω (–Ω–µ—Ç —Ä–∞–±–æ—á–∏—Ö API)
              </div>
            `
            }
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong>üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:</strong><br>
            <div style="margin: 5px 0; padding: 5px; background: ${locationTest.country !== "Unknown" ? "#e8f5e8" : "#fff3cd"}; border-radius: 3px;">
              ${locationTest.country !== "Unknown" ? "‚úÖ" : "‚ö†Ô∏è"} 
              ${this.getCountryFlag(locationTest.country)} ${locationTest.city}, ${locationTest.country}<br>
              <small>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${locationTest.timezone}</small><br>
              <small>–ü—Ä–æ–≤–∞–π–¥–µ—Ä: ${locationTest.isp}</small>
            </div>
          </div>
        </div>
        
        <div style="background: ${workingAPIs.length > 0 ? "#e8f5e8" : "#ffebee"}; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: ${workingAPIs.length > 0 ? "#4CAF50" : "#f44336"};">
            ${workingAPIs.length > 0 ? "‚úÖ –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´" : "‚ùå –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´"}
          </h4>
          
          <div style="font-size: 12px;">
            ${
              workingAPIs.length > 0
                ? `
              <div>üéâ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</div>
              <div>üìä –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${workingAPIs[0].response.value.toLocaleString()} –ø–æ—Å–µ—â–µ–Ω–∏–π</div>
              <div>üåç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${locationTest.country !== "Unknown" ? "–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ" : "—á–∞—Å—Ç–∏—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"}</div>
              <div>üöÄ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ</div>
            `
                : `
              <div>‚ö†Ô∏è –í—Å–µ API —Å–µ—Ä–≤–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>
              <div>üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</div>
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º</li>
                <li>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ CORS –ø–æ–ª–∏—Ç–∏–∫–æ–π –±—Ä–∞—É–∑–µ—Ä–∞</li>
                <li>–í—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</li>
                <li>–°–µ—Ç–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</li>
              </ul>
              <div>üí° –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ</div>
            `
            }
          </div>
        </div>
      `;

            resultsDiv.innerHTML = reportHTML;
          } catch (error) {
            console.error("üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", error);

            resultsDiv.innerHTML = `
        <div style="color: #f44336; font-weight: bold; margin-bottom: 15px;">
          üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
        </div>
        
        <div style="background: #ffebee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
          <strong>‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:</strong><br>
          ${error.message}
        </div>
        
        <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
          <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>
          1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ<br>
          2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É<br>
          3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)<br>
          4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä
        </div>
      `;
          }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        showPageStats() {
          console.log("üìà –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...");

          const modal = document.createElement("div");
          modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      justify-content: center; align-items: center; padding: 20px;
    `;

          const content = document.createElement("div");
          content.style.cssText = `
      background: var(--panel); color: var(--text); border-radius: 10px; padding: 20px; 
      max-width: 700px; max-height: 80vh; overflow-y: auto;
      font-family: monospace; font-size: 12px; line-height: 1.4;
    `;

          const stats = this.getPageStats();
          const totalViews = parseInt(
            localStorage.getItem(this.pageCounterKeys.totalViews) || "0",
          );

          content.innerHTML = `
      <h3>üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
      
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${this.formatNumber(totalViews)}</div>
            <div style="color: #666;">üëÅÔ∏è –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
          </div>
          <div>
            <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${this.formatNumber(stats.uniqueVisitors)}</div>
            <div style="color: #666;">üë§ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
          </div>
          <div>
            <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${this.formatNumber(stats.dailyVisitors)}</div>
            <div style="color: #666;">üìÖ –°–µ–≥–æ–¥–Ω—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</div>
          </div>
          <div>
            <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${stats.avgViewsPerVisitor}</div>
            <div style="color: #666;">üì± –°—Ä. –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤/–ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å</div>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="this.closest('[style*=fixed]').remove()" 
                style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
        <button onclick="multiUserChat.updatePageCounterDisplay(); this.closest('[style*=fixed]').remove();" 
                style="background: #28a745; color: white; border: none; padding: 10px 20px; margin-left: 10px; border-radius: 5px; cursor: pointer;">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
    `;

          modal.appendChild(content);
          document.body.appendChild(modal);
        }

        async runQuickTests() {
          console.log("üöÄ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤ Telegram...");

          // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞
          console.log("1Ô∏è‚É£ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–æ—Ç—É...");
          const botTest = await this.sendTelegramRequest("getMe");
          if (botTest && botTest.ok) {
            console.log("‚úÖ –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:", botTest.result.username);
          } else {
            console.error("‚ùå –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:", botTest);
          }

          // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª
          console.log("2Ô∏è‚É£ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª...");
          const messageTest = await this.sendMessageToTelegram(
            "üß™ –ê–≤—Ç–æ—Ç–µ—Å—Ç - " + new Date().toLocaleTimeString(),
            "–°–∏—Å—Ç–µ–º–∞",
          );
          if (messageTest) {
            console.log("‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∫–∞–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç");
          } else {
            console.error("‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∫–∞–Ω–∞–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç");
          }

          // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
          console.log("3Ô∏è‚É£ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π...");
          await this.loadTelegramMessages();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          setTimeout(() => {
            alert(
              "üß™ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!\n\n‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\nüì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–Ω–∞–ª t.me/noninput –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\nüîÑ –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—à–µ",
            );
          }, 2000);
        }

        async testTelegramSending() {
          console.log("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram...");
          this.updateConnectionStatus("—Ç–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏...");

          try {
            const testMessage =
              "üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ - " + new Date().toLocaleTimeString();
            const success = await this.sendMessageToTelegram(
              testMessage,
              "–°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
            );

            if (success) {
              alert("‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram –∫–∞–Ω–∞–ª.");
              console.log("‚úÖ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ");
            } else {
              alert("‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –∏ –∫–∞–Ω–∞–ª.");
              console.error("‚ùå –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω");
            }
          } catch (error) {
            console.error("üö® –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
            alert("üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: " + error.message);
          }
        }

        async syncTelegramMessages() {
          console.log("üîÑ –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å Telegram...");
          this.updateConnectionStatus("—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...");

          try {
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            await this.loadTelegramMessages();
            await this.checkTelegramUpdates();

            console.log("‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
            this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)");

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            setTimeout(() => {
              const messageCount = this.messages.filter((m) =>
                m.source?.includes("telegram"),
              ).length;
              alert(
                `üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${messageCount} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram.`,
              );
            }, 500);
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
            this.updateConnectionStatus("–æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");
          }
        }

        async retryTelegramConnection() {
          console.log("üîÑ –†—É—á–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram...");
          this.updateConnectionStatus("–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–∫—Å–∏
          this.currentProxyIndex = 0;

          // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
          if (this.telegramPollInterval) {
            clearInterval(this.telegramPollInterval);
          }

          // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ
          try {
            await this.initTelegramConnection();
          } catch (error) {
            console.error("‚ùå –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:", error);
            this.fallbackToLocal();
          }
        }

        fallbackToLocal() {
          // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
          console.log("üì± –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
          this.isLocalMode = true;
          this.messages = this.loadLocalMessages();
          this.simulateOtherUsers();
          this.renderMessages();
          this.updateConnectionStatus("–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
        }

        updateConnectionStatus(status) {
          const statusElement = document.getElementById("connectionStatus");
          const stabilityElement = document.getElementById(
            "connectionStability",
          );

          if (statusElement) {
            statusElement.textContent = status;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
            this.updateOnlineCounter();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            if (stabilityElement && this.connectionState) {
              const failureRate = this.connectionState.consecutiveFailures;
              const timeSinceLastSuccess =
                Date.now() - this.connectionState.lastSuccessfulRequest;

              let stabilityText = "";
              let stabilityColor = "#666";

              if (status.includes("–ø–æ–¥–∫–ª—é—á–µ–Ω (Telegram)")) {
                if (failureRate === 0 && timeSinceLastSuccess < 30000) {
                  stabilityText = "üü¢ –°—Ç–∞–±–∏–ª—å–Ω–æ";
                  stabilityColor = "#4CAF50";
                } else if (failureRate <= 2) {
                  stabilityText = "üü° –£–º–µ—Ä–µ–Ω–Ω–æ";
                  stabilityColor = "#FF9800";
                } else {
                  stabilityText = "üî¥ –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ";
                  stabilityColor = "#F44336";
                }

                const proxy =
                  this.proxyUrls[this.currentProxyIndex] || "–ø—Ä—è–º–æ–µ";
                stabilityText += ` | ${proxy.split("/")[2] || "–ø—Ä—è–º–æ–µ"}`;
              }

              stabilityElement.textContent = stabilityText;
              stabilityElement.style.color = stabilityColor;
            }

            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            const container = statusElement.closest(".online-count");
            if (container) {
              if (status.includes("–ø–æ–¥–∫–ª—é—á–µ–Ω") || status.includes("–æ–Ω–ª–∞–π–Ω")) {
                container.style.background = "#d4edda";
                container.style.borderColor = "#c3e6cb";
                container.style.color = "#155724";
              } else if (
                status.includes("–æ—à–∏–±–∫–∞") ||
                status.includes("–ª–æ–∫–∞–ª—å–Ω—ã–π")
              ) {
                container.style.background = "#f8d7da";
                container.style.borderColor = "#f5c6cb";
                container.style.color = "#721c24";
              } else {
                container.style.background = "#fff3cd";
                container.style.borderColor = "#ffeaa7";
                container.style.color = "#856404";
              }
            }
          }
        }

        simulateOtherUsers() {
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          const demoMessages = [
            {
              text: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ! üëç",
              username: "–ê–ª–µ–∫—Å–µ–π",
              timestamp: Date.now() - 300000,
            },
            {
              text: "–ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è",
              username: "–ú–∞—Ä–∏—è",
              timestamp: Date.now() - 180000,
            },
            {
              text: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ö–∞–ª–º–∞–Ω–∞ –∑–¥–µ—Å—å?",
              username: "–î–º–∏—Ç—Ä–∏–π",
              timestamp: Date.now() - 120000,
            },
          ];

          // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
          if (this.messages.length === 0) {
            setTimeout(() => {
              demoMessages.forEach((msg, index) => {
                setTimeout(() => {
                  this.addDemoMessage(msg.text, msg.username, msg.timestamp);
                }, index * 2000);
              });
            }, 3000);
          }
        }

        addDemoMessage(text, username, timestamp) {
          const message = {
            id: Date.now() + Math.random(),
            text: text,
            username: username,
            timestamp: timestamp,
            isCurrentUser: false,
            wasFiltered: false,
          };
          this.messages.push(message);
          this.saveLocalMessages();
          this.updateMessageCount();
          this.renderMessages();
        }

        setupRealtimeListeners() {
          if (!this.database) return;

          // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          this.database.ref("chat/messages").on("child_added", (snapshot) => {
            const message = snapshot.val();
            if (message && message.userId !== this.userId) {
              this.addMessageToUI(message);
            }
          });

          // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          this.database.ref("chat/online").on("value", (snapshot) => {
            const online = snapshot.val() || {};
            this.updateOnlineCount(Object.keys(online).length);
          });
        }

        trackOnlineUsers() {
          if (!this.database) return;

          const userRef = this.database.ref(`chat/online/${this.userId}`);
          userRef.set({
            username: this.username || "–ê–Ω–æ–Ω–∏–º–Ω—ã–π",
            timestamp: firebase.database.ServerValue.TIMESTAMP,
          });

          // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
          userRef.onDisconnect().remove();

          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
          setInterval(() => {
            userRef.update({
              timestamp: firebase.database.ServerValue.TIMESTAMP,
            });
          }, 30000);
        }

        generateUserId() {
          return (
            "user_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9)
          );
        }

        initBadWordsFilter() {
          return [
            // –†—É—Å—Å–∫–∏–π
            "–¥—É—Ä–∞–∫",
            "–∏–¥–∏–æ—Ç",
            "—Ç—É–ø–æ–π",
            "–¥–µ–±–∏–ª",
            "—É—Ä–æ–¥",
            "–≥–∞–¥",
            "–º—Ä–∞–∑—å",
            "—Å–≤–æ–ª–æ—á—å",
            "–ø–æ–¥–æ–Ω–æ–∫",
            "–≥–æ–≤–Ω–æ",
            "—Ö—Ä–µ–Ω—å",
            "—Ñ–∏–≥–Ω—è",
            "–±–ª–∏–Ω",
            "—á–µ—Ä—Ç",
            "–¥—å—è–≤–æ–ª",
            "—É–±–ª—é–¥–æ–∫",
            "—Å–∫–æ—Ç–∏–Ω–∞",
            "–∂–∏–≤–æ—Ç–Ω–æ–µ",
            "–∑–∞—Ä–∞–∑–∞",
            // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
            "stupid",
            "idiot",
            "fool",
            "moron",
            "jerk",
            "ass",
            "damn",
            "shit",
            "crap",
            "hell",
            "dumb",
            "loser",
            "freak",
            "retard",
            "bitch",
            "bastard",
            "asshole",
            "dickhead",
            // –î—Ä—É–≥–∏–µ —è–∑—ã–∫–∏...
            "tonto",
            "idiota",
            "est√∫pido",
            "con",
            "stupide",
            "cr√©tin",
            "dumm",
            "scheisse",
          ];
        }

        filterMessage(text) {
          let filteredText = text.toLowerCase();
          let hasBlockedWord = false;

          for (const word of this.badWords) {
            const regex = new RegExp(
              "\\b" + word.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "\\b",
              "gi",
            );
            if (regex.test(filteredText)) {
              hasBlockedWord = true;
              filteredText = filteredText.replace(regex, "***");
            }
          }

          const suspiciousPatterns = [
            /(.)\1{4,}/g,
            /[!@#$%^&*]{3,}/g,
            /(.)(.)\1\2{2,}/g,
          ];

          for (const pattern of suspiciousPatterns) {
            if (pattern.test(text)) {
              hasBlockedWord = true;
              filteredText = filteredText.replace(pattern, "***");
            }
          }

          return {
            text: hasBlockedWord ? filteredText : text,
            wasFiltered: hasBlockedWord,
          };
        }

        loadLocalMessages() {
          try {
            const saved = localStorage.getItem("multiUserChatMessages");
            return saved ? JSON.parse(saved) : [];
          } catch (e) {
            return [];
          }
        }

        saveLocalMessages() {
          try {
            localStorage.setItem(
              "multiUserChatMessages",
              JSON.stringify(this.messages.slice(-50)),
            );
          } catch (e) {
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ localStorage");
          }
        }

        addMessage(text) {
          console.log("addMessage –≤—ã–∑–≤–∞–Ω–∞ —Å —Ç–µ–∫—Å—Ç–æ–º:", text); // –û—Ç–ª–∞–¥–∫–∞

          // ===== –ó–ê–©–ò–¢–ê: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è =====
          if (!window.SecurityManager.validateMessage(text)) {
            console.warn("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—à–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏");
            return false;
          }

          // ===== –ó–ê–©–ò–¢–ê: Rate limiting =====
          if (
            !window.SecurityManager.checkRateLimit(
              "message_" + this.userId,
              20,
              60000,
            )
          ) {
            console.warn("‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π (20 –∑–∞ –º–∏–Ω—É—Ç—É)");
            alert(
              "‚ö†Ô∏è –í—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.",
            );
            return false;
          }

          // ===== –ó–ê–©–ò–¢–ê: –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML =====
          text = window.SecurityManager.sanitizeHtml(text);

          const filtered = this.filterMessage(text);
          const currentUsername =
            document.getElementById("usernameInput").value.trim() ||
            "–ê–Ω–æ–Ω–∏–º–Ω—ã–π";

          // ===== –ó–ê–©–ò–¢–ê: –í–∞–ª–∏–¥–∞—Ü–∏—è username =====
          if (
            currentUsername.length > 1 &&
            !window.SecurityManager.validateUsername(
              currentUsername.replace(/\s+/g, "_"),
            )
          ) {
            console.warn("‚ö†Ô∏è Username —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã");
            return false;
          }

          const message = {
            id: this.userId + "_" + Date.now() + "_" + Math.random(),
            text: filtered.text,
            username: window.SecurityManager.sanitizeHtml(currentUsername),
            userId: this.userId,
            timestamp: Date.now(),
            isCurrentUser: true,
            wasFiltered: filtered.wasFiltered,
            source: "web",
          };

          console.log("–°–æ–∑–¥–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", message); // –û—Ç–ª–∞–¥–∫–∞

          // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          this.addUserOnline(currentUsername, this.userId);
          this.simulateUserActivity();

          // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
          this.messages.push(message);
          this.saveMessagesToStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          if (this.telegramConfig && !this.isLocalMode) {
            this.sendMessageToTelegram(filtered.text, currentUsername)
              .then((success) => {
                if (success) {
                  console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram —á–∞—Ç");
                } else {
                  console.warn(
                    "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram, –Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ",
                  );
                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
                  this.saveSharedMessages();
                }
              })
              .catch((error) => {
                console.error(
                  "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:",
                  error,
                );
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
                this.saveSharedMessages();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                this.connectionState.consecutiveFailures++;
                if (this.connectionState.consecutiveFailures >= 3) {
                  console.warn(
                    "üîÑ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...",
                  );
                  this.performHealthCheck();
                }
              });
          } else {
            // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            const success = this.saveSharedMessages();
            if (success) {
              console.log("üíæ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ");
              this.updateConnectionStatus("–ø–æ–¥–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å)");
            } else {
              console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
              this.updateConnectionStatus("–æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
            }
          }

          this.addMessageToUI(message);

          console.log(
            "–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∞—Å—Å–∏–≤, –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:",
            this.messages.length,
          ); // –û—Ç–ª–∞–¥–∫–∞

          return filtered.wasFiltered;
        }

        addMessageToUI(message) {
          this.updateMessageCount();
          this.renderMessages();
        }

        updateMessageCount() {
          const countElement = document.getElementById("messageCount");
          if (countElement) {
            countElement.textContent = this.messages.length;
          }
        }

        updateOnlineCount(count) {
          const onlineElement = document.getElementById("onlineUsers");
          if (onlineElement) {
            onlineElement.textContent = Math.max(1, count);
          }
        }

        renderMessages() {
          const container = document.getElementById("chatMessages");
          if (!container) return;

          const systemMessage = container.querySelector(".message.system");
          container.innerHTML = "";

          if (systemMessage) {
            container.appendChild(systemMessage);
          }

          const recentMessages = this.messages.slice(-20);

          recentMessages.forEach((message) => {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${message.isCurrentUser ? "user" : "other"}`;

            const timeStr = new Date(message.timestamp).toLocaleTimeString(
              "ru-RU",
              {
                hour: "2-digit",
                minute: "2-digit",
              },
            );

            let filteredIndicator = message.wasFiltered ? " üõ°Ô∏è" : "";
            const username = message.username || "–ê–Ω–æ–Ω–∏–º–Ω—ã–π";

            messageDiv.innerHTML = `
        <div>${this.escapeHtml(message.text)}</div>
        <div class="message-meta">${username} ‚Ä¢ ${timeStr}${filteredIndicator}</div>
      `;

            container.appendChild(messageDiv);
          });

          container.scrollTop = container.scrollHeight;
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ localStorage
        saveMessagesToStorage() {
          try {
            const toSave = this.messages.slice(-100); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100
            localStorage.setItem("chatMessages", JSON.stringify(toSave));
            console.log(
              `üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${toSave.length} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ localStorage`,
            );
          } catch (error) {
            console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:", error.message);
          }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ localStorage
        loadMessagesFromStorage() {
          try {
            const stored = localStorage.getItem("chatMessages");
            if (stored) {
              this.messages = JSON.parse(stored);
              console.log(
                `üì• –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ localStorage`,
              );
            }
          } catch (error) {
            console.warn(
              "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ localStorage:",
              error.message,
            );
            this.messages = [];
          }
        }
      }

      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞
      let multiUserChat;

      function sendMessage() {
        console.log("sendMessage –≤—ã–∑–≤–∞–Ω–∞"); // –û—Ç–ª–∞–¥–∫–∞

        const input = document.getElementById("messageInput");
        const button = document.getElementById("sendButton");

        if (!input) {
          console.error("–≠–ª–µ–º–µ–Ω—Ç messageInput –Ω–µ –Ω–∞–π–¥–µ–Ω");
          return;
        }

        if (!multiUserChat) {
          console.error("multiUserChat –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
          // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
          if (button) button.disabled = false;
          return;
        }

        const text = input.value.trim();
        console.log("–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:", text); // –û—Ç–ª–∞–¥–∫–∞

        if (!text) {
          console.log("–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
          return;
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
        if (button) {
          button.disabled = true;
          button.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
        }
        input.disabled = true;

        try {
          const wasFiltered = multiUserChat.addMessage(text);

          if (wasFiltered) {
            setTimeout(() => {
              alert(
                "‚ö†Ô∏è –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–ª–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –±—ã–ª–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ.",
              );
            }, 100);
          }

          // –°–∏–º—É–ª–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          multiUserChat.simulateUserActivity();

          // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
          input.value = "";
          console.log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ");
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
        }

        // –ë—ã—Å—Ç—Ä–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        setTimeout(() => {
          if (button) {
            button.disabled = false;
            button.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
          }
          input.disabled = false;
          input.focus();
        }, 300); // –£–º–µ–Ω—å—à–∏–ª–∏ –≤—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç"); // –û—Ç–ª–∞–¥–∫–∞

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ –¢–ï–ú =====
        initThemeSystem();

        // NOTE: –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è runtime ‚Äî heavy –ø—Ä–æ—Ü–µ—Å—Å—ã (—á–∞—Ç, –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ –∏ –¥—Ä.)
        // –±—É–¥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ ¬´–°—Ç–∞—Ä—Ç¬ª. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–∏—à–Ω—é—é
        // –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–æ —è–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        console.log("[INIT] Runtime deferred until user presses Start");

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        const sendButton = document.getElementById("sendButton");
        if (sendButton) {
          sendButton.addEventListener("click", function () {
            console.log("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞"); // –û—Ç–ª–∞–¥–∫–∞
            if (!window.__appInitialized) {
              alert(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ ‚ñ∂ –°—Ç–∞—Ä—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤.",
              );
              return;
            }
            sendMessage();
          });
          console.log("–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–∞"); // –û—Ç–ª–∞–¥–∫–∞
        } else {
          console.error("–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const messageInput = document.getElementById("messageInput");
        if (messageInput) {
          messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              console.log("Enter –Ω–∞–∂–∞—Ç"); // –û—Ç–ª–∞–¥–∫–∞
              if (!window.__appInitialized) {
                alert(
                  "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ ‚ñ∂ –°—Ç–∞—Ä—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤.",
                );
                return;
              }
              sendMessage();
            }
          });
          console.log("–ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–æ"); // –û—Ç–ª–∞–¥–∫–∞
        } else {
          console.error("–ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        }
      });

      class CpuJitterSampler {
        static RB_SIZE = 16384;
        static MASK = CpuJitterSampler.RB_SIZE - 1;
        constructor() {
          this.rb = new Float64Array(CpuJitterSampler.RB_SIZE);
          this.ts = new Float64Array(CpuJitterSampler.RB_SIZE);
          this.widx = 0;
          this.target_ms = 2.0;
          this.iters = 800;
          this.iters_min = 120;
          this.iters_max = 150000;
          this.alpha = 0.008;
          this.ema = 0;
          this.rms = 0;
          this.dynamic_n = 64;
          this.actual_fs = 500;
          this.sample_count = 0;
          this.last_widx = 0;
          this.last_check = performance.now();
          this.stall_count = 0;
          this._medBuf = new Float64Array(9);
          this._mi = 0;
          this._mlen = 0;
        }
        _kernel(n) {
          let x = 1.0001;
          for (let i = 0; i < n; i++) {
            x *= 1.00000001;
            x /= 1.000000009;
          }
        }
        _median9(x) {
          const n = this._mlen < 9 ? ++this._mlen : 9;
          this._medBuf[this._mi] = x;
          this._mi = (this._mi + 1) % 9;
          const t = Array.from(this._medBuf.slice(0, n)).sort((a, b) => a - b);
          return t[n >> 1];
        }
        sample() {
          const t0 = performance.now();
          this._kernel(this.iters);
          let dt = performance.now() - t0;
          dt = this._median9(dt);
          if (!this.ema) this.ema = dt;
          this.ema = (1 - this.alpha) * this.ema + this.alpha * dt;
          const jitter = dt - this.ema;
          const idx = this.widx++ & CpuJitterSampler.MASK;
          this.rb[idx] = jitter;
          this.ts[idx] = t0;
          this.sample_count++;
          this.rms = (1 - this.alpha) * this.rms + this.alpha * jitter * jitter;
          if ((this.sample_count & 0x7f) === 0) {
            const ratio = this.ema / Math.max(0.25, this.target_ms);
            const k = Math.max(0.65, Math.min(1.5, 1 / ratio));
            this.iters = Math.max(
              this.iters_min,
              Math.min(this.iters_max, Math.round(this.iters * k)),
            );
            this.actual_fs = 1000 / Math.max(0.25, this.ema);
            this.dynamic_n = Math.max(
              48,
              Math.min(512, Math.ceil(0.3 * this.actual_fs)),
            );
          }
        }
        checkStall() {
          const now = performance.now();
          if (now - this.last_check > 1000 && this.widx === this.last_widx) {
            this.stall_count++;
            if (this.stall_count > 2) {
              this.iters = Math.max(this.iters_min, (this.iters / 1.8) | 0);
              this.target_ms = Math.min(6.0, this.target_ms * 1.12);
              this.stall_count = 0;
            }
            return true;
          }
          this.last_check = now;
          this.last_widx = this.widx;
          this.stall_count = 0;
          return false;
        }
      }

      /* ======================= Goertzel ======================= */
      class Goertzel {
        init(n, fs, f) {
          this.N = n;
          const k = Math.floor(0.5 + (n * f) / fs);
          const w = (2 * Math.PI * k) / n;
          this.cw = Math.cos(w);
          this.sw = Math.sin(w);
          this.s1 = 0;
          this.s2 = 0;
        }
        push(x) {
          const s = x + 2 * this.cw * this.s1 - this.s2;
          this.s2 = this.s1;
          this.s1 = s;
        }
        result() {
          const re = this.s1 - this.s2 * this.cw,
            im = this.s2 * this.sw;
          const mag = Math.hypot(re, im) / (this.N > 1 ? this.N / 2 : 1);
          const ph = Math.atan2(im, re);
          return { mag, ph };
        }
      }

      /* ===================== OutputBlender ==================== */
      class OutputBlender {
        constructor() {
          this.ready = false;
          this.ramp = 0;
          this.last = { f: 0, conf: 0, inertia: 0, state: "SEARCHING" };
        }
        blend(cur, step = 0.18) {
          if (!this.ready) {
            this.last = { ...cur };
            this.ready = true;
            this.ramp = Math.min(1, this.ramp + step);
            return cur;
          }
          const a = Math.min(1, this.ramp + step);
          this.ramp = a;
          const mix = (p, q) => p * (1 - a) + q * a;
          const out = {
            f: mix(this.last.f, cur.f),
            conf: mix(this.last.conf, cur.conf),
            inertia: mix(this.last.inertia, cur.inertia),
            state: cur.state,
          };
          this.last = out;
          return out;
        }
        hold(step = 0.08) {
          this.ramp = Math.min(1, this.ramp + step);
          return this.last;
        }
      }

      /* ======================== Kalman ======================== */
      class Kalman {
        constructor(x0, v0, qpos, qvel) {
          this.qp = qpos;
          this.qv = qvel;
          this.reset(x0, v0);
        }
        reset(x, v) {
          this.x = x;
          this.v = v;
          this.p00 = 1;
          this.p01 = 0;
          this.p10 = 0;
          this.p11 = 1;
        }
        predict(dt) {
          this.x += this.v * dt;
          this.p00 += dt * (this.p10 + this.p01) + dt * dt * this.p11;
          this.p01 += dt * this.p11;
          this.p10 += dt * this.p11;
          this.p00 += this.qp;
          this.p11 += this.qv;
        }
        update(z, r) {
          const y = z - this.x,
            s = this.p00 + r;
          if (Math.abs(s) < 1e-9) return;
          const k0 = this.p00 / s,
            k1 = this.p10 / s;
          this.x += k0 * y;
          this.v += k1 * y;
          const p00 = this.p00,
            p01 = this.p01;
          this.p00 -= k0 * p00;
          this.p01 -= k0 * p01;
          this.p10 -= k1 * p00;
          this.p11 -= k1 * p01;
        }
      }

      /* =================== –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–∞–º—è—Ç–∏ =================== */
      class MemoryPool {
        constructor(maxBuffers = 100) {
          this.buffers = {};
          this.maxBuffers = maxBuffers;
          this.stats = { allocated: 0, pooled: 0, reused: 0 };
        }
        acquire(size) {
          const key = size;
          if (!this.buffers[key]) this.buffers[key] = [];
          if (this.buffers[key].length > 0) {
            const buf = this.buffers[key].pop();
            buf.fill(0);
            this.stats.reused++;
            return buf;
          }
          this.stats.allocated++;
          return new Float64Array(size);
        }
        release(buffer, size) {
          const key = size || buffer.length;
          if (!this.buffers[key]) this.buffers[key] = [];
          if (this.buffers[key].length < this.maxBuffers) {
            buffer.fill(0);
            this.buffers[key].push(buffer);
            this.stats.pooled++;
          }
        }
      }

      class BatchLimiter {
        constructor(maxIterPerFrame = 4, maxTimeMs = 14) {
          this.maxIter = maxIterPerFrame;
          this.maxTimeMs = maxTimeMs;
          this.iterCount = 0;
          this.startTime = 0;
        }
        begin() {
          this.iterCount = 0;
          this.startTime = performance.now();
        }
        shouldContinue() {
          this.iterCount++;
          if (this.iterCount >= this.maxIter) return false;
          const elapsed = performance.now() - this.startTime;
          return elapsed < this.maxTimeMs;
        }
      }

      class AdaptiveMode {
        constructor() {
          this.precision = "full";
          this.memoryPressure = 0;
          this.lastCheckTime = 0;
          this.checkIntervalMs = 500;
        }
        checkMemory() {
          const now = performance.now();
          if (now - this.lastCheckTime < this.checkIntervalMs) return;
          this.lastCheckTime = now;

          if (performance.memory) {
            const used = performance.memory.usedJSHeapSize;
            const limit = performance.memory.jsHeapSizeLimit;
            this.memoryPressure = used / limit;

            if (this.memoryPressure > 0.9) this.precision = "light";
            else if (this.memoryPressure > 0.75) this.precision = "medium";
            else this.precision = "full";
          }
        }
        getHiddenUnits() {
          if (this.precision === "light") return 4;
          if (this.precision === "medium") return 6;
          return 8;
        }
      }

      /* =================== –ù–µ–π—Ä–æ-–≥–æ–º–µ–æ—Å—Ç–∞–∑ (—Å lock –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π) =================== */
      /**
       * Anti-Oscillation Damping Module for NeuroHomeostasis Algorithm
       * Implements multi-layer protection against system instability and oscillatory behavior
       *
       * Features:
       * - Gradient clipping with dynamic thresholds
       * - Deadzone filtering on errors
       * - Low-pass filtering on aggregator updates (exponential moving average)
       * - Anti-windup limiter for integral accumulation
       * - Weight delta clipping to prevent divergence
       * - Spike detection with learning rate throttling
       * - Momentum dampening with exponential decay
       * - Frequency-domain oscillation detection
       */

      class OscillationDamper {
        constructor(config = {}) {
          // ===== GRADIENT PROTECTION =====
          this.gradientClipValue = config.gradientClipValue ?? 5.0; // Max gradient magnitude
          this.gradientL2Norm = config.gradientL2Norm ?? null; // Optional L2 norm clipping

          // ===== ERROR DEADZONE =====
          this.deadzoneTolerance = config.deadzoneTolerance ?? 0.001; // Ignore errors below this
          this.deadzoneMode = config.deadzoneMode ?? "soft"; // 'soft' (smooth) or 'hard' (zero)

          // ===== LOW-PASS FILTERING =====
          this.lowPassAlpha = config.lowPassAlpha ?? 0.2; // EMA coefficient (0-1, lower=more damping)
          this.filteredAggr = 0; // EMA state
          this.firstAggr = true;

          // ===== INTEGRAL ANTI-WINDUP =====
          this.integralClipValue = config.integralClipValue ?? 3.0; // Max integral term
          this.integralSaturationThresh =
            config.integralSaturationThresh ?? 0.8; // When to warn

          // ===== WEIGHT UPDATE PROTECTION =====
          this.weightDeltaClip = config.weightDeltaClip ?? 0.1; // Max delta per weight per step
          this.momentumDecay = config.momentumDecay ?? 0.95; // Exponential decay of momentum
          this.momentum = {}; // Track per-weight momentum

          // ===== SPIKE DETECTION =====
          this.spikeThreshold = config.spikeThreshold ?? 3.0; // Relative change threshold
          this.spikeWindow = config.spikeWindow ?? 50; // Detect spike over N iterations
          this.spikeBuffer = []; // History of |dJ|
          this.spikeCount = 0;
          this.inSpike = false;

          // ===== OSCILLATION DETECTION (FREQUENCY DOMAIN) =====
          this.oscDetectionWindow = config.oscDetectionWindow ?? 100; // Buffer size for FFT
          this.oscBuffer = []; // History of cost values
          this.oscThreshold = config.oscThreshold ?? 0.3; // Peak power ratio for oscillation

          // ===== LEARNING RATE MANAGEMENT =====
          this.lrScale = 1.0; // Current scaling factor (0-1)
          this.lrRecoveryRate = config.lrRecoveryRate ?? 0.02; // Per-step recovery
          this.spikeLrPenalty = config.spikeLrPenalty ?? 0.1; // Reduce LR to 10% during spike

          // ===== STATISTICS =====
          this.stats = {
            clipsApplied: 0,
            deadzonesApplied: 0,
            spikesDetected: 0,
            oscillationsDetected: 0,
            momentumApplied: 0,
          };

          this.iterCount = 0;
        }

        /**
         * Clip gradient to safe range
         * @param {number} gradient - Gradient value to protect
         * @returns {number} - Clipped gradient
         */
        clipGradient(gradient) {
          if (Math.abs(gradient) > this.gradientClipValue) {
            this.stats.clipsApplied++;
            const sign = Math.sign(gradient);
            return sign * this.gradientClipValue;
          }
          return gradient;
        }

        /**
         * Apply L2 norm clipping to gradient array
         * @param {Float64Array} gradients - Gradient vector
         * @returns {Float64Array} - Clipped gradients
         */
        clipGradientL2(gradients) {
          if (!this.gradientL2Norm) return gradients;

          let norm = 0;
          for (let i = 0; i < gradients.length; i++) {
            norm += gradients[i] ** 2;
          }
          norm = Math.sqrt(norm);

          if (norm > this.gradientL2Norm) {
            const scale = this.gradientL2Norm / (norm + 1e-8);
            for (let i = 0; i < gradients.length; i++) {
              gradients[i] *= scale;
            }
            this.stats.clipsApplied++;
          }
          return gradients;
        }

        /**
         * Apply deadzone to error signal (suppress small errors)
         * @param {number} error - Error magnitude
         * @returns {number} - Deadzoned error
         */
        applyDeadzone(error) {
          const absErr = Math.abs(error);
          if (absErr < this.deadzoneTolerance) {
            this.stats.deadzonesApplied++;
            if (this.deadzoneMode === "hard") {
              return 0;
            } else {
              // Soft deadzone: smooth transition
              const ratio = absErr / this.deadzoneTolerance;
              return error * ratio ** 2; // Smooth S-curve
            }
          }
          return error;
        }

        /**
         * Apply low-pass filter to aggregator (exponential moving average)
         * @param {number} newValue - New aggregator value
         * @returns {number} - Filtered value
         */
        filterAggregator(newValue) {
          if (this.firstAggr) {
            this.filteredAggr = newValue;
            this.firstAggr = false;
            return newValue;
          }

          this.filteredAggr =
            this.lowPassAlpha * newValue +
            (1 - this.lowPassAlpha) * this.filteredAggr;
          return this.filteredAggr;
        }

        /**
         * Limit integral term to prevent windup
         * @param {number} integral - Current integral accumulation
         * @returns {number} - Clipped integral
         */
        limitIntegralWindup(integral) {
          const absInt = Math.abs(integral);
          if (absInt > this.integralSaturationThresh * this.integralClipValue) {
            console.warn(
              `‚ö†Ô∏è Integral saturation detected: ${absInt.toFixed(4)}`,
            );
          }
          return Math.max(
            -this.integralClipValue,
            Math.min(this.integralClipValue, integral),
          );
        }

        /**
         * Detect cost spikes and return LR scale factor
         * @param {number} costValue - Current cost J
         * @param {number} prevCost - Previous cost value
         * @returns {number} - LR scale factor (1.0 = no change, <1 = reduce)
         */
        detectSpike(costValue, prevCost) {
          if (prevCost === null || prevCost === undefined) {
            return 1.0;
          }

          const costDelta = Math.abs(costValue - prevCost);
          this.spikeBuffer.push(costDelta);

          if (this.spikeBuffer.length > this.spikeWindow) {
            this.spikeBuffer.shift();
          }

          // Compute mean of recent deltas
          const mean =
            this.spikeBuffer.reduce((a, b) => a + b, 0) /
            this.spikeBuffer.length;
          const std = Math.sqrt(
            this.spikeBuffer.reduce((a, val) => a + (val - mean) ** 2, 0) /
              this.spikeBuffer.length +
              1e-8,
          );

          // Spike detection: cost delta exceeds threshold multiple times
          const zScore = std > 1e-8 ? (costDelta - mean) / std : 0;
          if (zScore > this.spikeThreshold && this.spikeBuffer.length > 10) {
            this.inSpike = true;
            this.spikeCount++;
            this.stats.spikesDetected++;
            return this.spikeLrPenalty; // Reduce LR during spike
          }

          // Recover from spike
          if (this.inSpike && zScore < 1.0) {
            this.inSpike = false;
          }

          return 1.0;
        }

        /**
         * Detect oscillatory behavior in cost history (frequency domain)
         * @param {number} costValue - Current cost value
         * @returns {boolean} - True if oscillation detected
         */
        detectOscillation(costValue) {
          this.oscBuffer.push(costValue);
          if (this.oscBuffer.length > this.oscDetectionWindow) {
            this.oscBuffer.shift();
          }

          if (this.oscBuffer.length < this.oscDetectionWindow / 2) {
            return false; // Not enough history
          }

          // Simple oscillation detection: count sign changes in cost deltas
          let signChanges = 0;
          for (let i = 1; i < this.oscBuffer.length; i++) {
            const prevDelta = this.oscBuffer[i] - this.oscBuffer[i - 1];
            const currDelta = this.oscBuffer[i + 1] - this.oscBuffer[i];
            if (prevDelta * currDelta < 0) {
              signChanges++;
            }
          }

          const expectedChanges = this.oscBuffer.length * 0.2; // ~20% changes in stable state
          const oscillating = signChanges > expectedChanges * 1.5;

          if (oscillating) {
            this.stats.oscillationsDetected++;
            return true;
          }
          return false;
        }

        /**
         * Apply momentum dampening to weight deltas
         * @param {string} key - Unique identifier for weight (e.g., "W1[0][1]")
         * @param {number} delta - Weight update delta
         * @returns {number} - Dampened delta
         */
        applyMomentum(key, delta) {
          if (!this.momentum[key]) {
            this.momentum[key] = 0;
          }

          // Exponential decay of momentum: apply old momentum, then accumulate new
          this.momentum[key] =
            this.momentumDecay * this.momentum[key] +
            (1 - this.momentumDecay) * delta;

          // Combine current update with momentum
          const dampedDelta = 0.7 * delta + 0.3 * this.momentum[key];

          if (Math.abs(dampedDelta) > 1e-8) {
            this.stats.momentumApplied++;
          }

          return dampedDelta;
        }

        /**
         * Clip weight delta to prevent divergence
         * @param {number} delta - Weight update delta
         * @returns {number} - Clipped delta
         */
        clipWeightDelta(delta) {
          return Math.max(
            -this.weightDeltaClip,
            Math.min(this.weightDeltaClip, delta),
          );
        }

        /**
         * Main protection pipeline: apply all damping mechanisms
         * @param {object} state - Algorithm state object
         * @returns {object} - Protected state with applied damping
         */
        protect(state) {
          this.iterCount++;

          // --- GRADIENT PROTECTION ---
          if (state.dJdy !== undefined) {
            state.dJdy = this.clipGradient(state.dJdy);
          }

          // --- ERROR DEADZONE ---
          if (state.error !== undefined) {
            state.error = this.applyDeadzone(state.error);
          }

          // --- AGGREGATOR LOW-PASS FILTER ---
          if (state.aggr !== undefined) {
            state.aggr = this.filterAggregator(state.aggr);
          }

          // --- INTEGRAL ANTI-WINDUP ---
          if (state.I !== undefined) {
            state.I = this.limitIntegralWindup(state.I);
          }

          // --- SPIKE DETECTION & LR SCALING ---
          const spikeLRScale = this.detectSpike(state.J, state.prevJ);
          this.lrScale = Math.max(
            this.spikeLrPenalty,
            Math.min(1.0, this.lrScale + this.lrRecoveryRate),
          );
          this.lrScale *= spikeLRScale;
          state.lrScale = this.lrScale;

          // --- OSCILLATION DETECTION ---
          if (state.J !== undefined) {
            const oscillating = this.detectOscillation(state.J);
            if (oscillating) {
              state.oscillationDetected = true;
              this.lrScale *= 0.8; // Additional damping
            }
          }

          return state;
        }

        /**
         * Apply weight protection to weight updates
         * @param {Float64Array} weights - Weight array
         * @param {Float64Array} gradients - Gradient array
         * @param {number} lr - Learning rate
         * @returns {Float64Array} - Updated weights with damping applied
         */
        protectWeightUpdate(weights, gradients, lr, weightKey = "W") {
          const effectiveLR = lr * this.lrScale;

          for (let i = 0; i < gradients.length; i++) {
            let delta = -effectiveLR * gradients[i];

            // Apply momentum dampening
            const key = `${weightKey}[${i}]`;
            delta = this.applyMomentum(key, delta);

            // Clip weight delta
            delta = this.clipWeightDelta(delta);

            weights[i] += delta;
          }

          return weights;
        }

        /**
         * Get current damping statistics
         * @returns {object} - Stats object
         */
        getStats() {
          return {
            ...this.stats,
            lrScale: this.lrScale.toFixed(4),
            spikeDetected: this.inSpike,
            iterCount: this.iterCount,
            bufferSizes: {
              spike: this.spikeBuffer.length,
              oscillation: this.oscBuffer.length,
              momentum: Object.keys(this.momentum).length,
            },
          };
        }

        /**
         * Reset damper state (e.g., between training phases)
         */
        reset() {
          this.filteredAggr = 0;
          this.firstAggr = true;
          this.spikeBuffer = [];
          this.spikeCount = 0;
          this.inSpike = false;
          this.oscBuffer = [];
          this.lrScale = 1.0;
          this.momentum = {};
          this.iterCount = 0;
        }

        /**
         * Reconfigure damper at runtime
         * @param {object} config - New configuration parameters
         */
        reconfigure(config) {
          Object.assign(this, config);
        }
      }

      class NeuroHomeo {
        constructor(enableOptimization = true) {
          // ===== ANTI-OSCILLATION DAMPING (NEW) =====
          this.damper = new OscillationDamper({
            gradientClipValue: 5.0,
            deadzoneTolerance: 0.0005, // Very small deadzone
            lowPassAlpha: 0.15, // Strong damping on aggregator
            integralClipValue: 2.5, // Tighter integral bounds
            integralSaturationThresh: 0.7,
            weightDeltaClip: 0.08,
            momentumDecay: 0.93,
            spikeThreshold: 2.5,
            spikeWindow: 40,
            oscDetectionWindow: 80,
            oscThreshold: 0.35,
            lrRecoveryRate: 0.01,
            spikeLrPenalty: 0.15,
          });
          // ===== –í–ï–°–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í COST FUNCTION (–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò –ê–î–ê–ü–¢–ò–†–£–Æ–¢–°–Ø) =====
          this.w_phi = 1.0;
          this.w_df = 0.8;
          this.w_var = 0.9;
          this.w_u = 0.7;
          this.w_c = 0.9;
          this.w_i = 0.7;
          this.w_res = 0.4; // w_res: –ù–û–í–û–ï - —à—Ç—Ä–∞—Ñ –∑–∞ —Ä–µ—Å—É—Ä—Å—ã!

          // ===== –ê–î–ê–ü–¢–ò–í–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ (–ü–û–î–°–¢–†–ê–ò–í–ê–Æ–¢–°–Ø –í RUNTIME) =====
          this.a = 0.12; // EMA –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è)
          this.emaAbsPhi = 0;
          this.emaAbsDf = 0;
          this.emaVarDf = 0;
          this.emaAbsU = 0;
          this.emaOneMinConf = 1;
          this.emaOneMinIner = 1;
          this.emaResourceUsage = 0; // –ù–û–í–û–ï - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

          // ===== –ê–í–¢–û–ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–´ –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô =====
          this.HMin = 4; // –ú–∏–Ω–∏–º—É–º 4 –Ω–µ–π—Ä–æ–Ω–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
          this.HStep = 2; // –®–∞–≥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (4‚Üí6‚Üí8‚Üí10...)
          // –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –í–•–û–î–ù–´–ï –ü–†–ò–ó–ù–ê–ö–ò (–∞–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
          this.DBase = 9; // –ë–∞–∑–æ–≤–æ–µ —á–∏—Å–ª–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
          this.D = this.DBase; // –¢–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (–º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏)
          this.maxDynamicD = 24; // –ú–∞–∫—Å–∏–º—É–º –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (–º—è–≥–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
          this.DStep = 2; // –®–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
          this.H = this.HMin; // –ù–∞—á–∏–Ω–∞–µ–º —Å –º–∏–Ω–∏–º—É–º–∞
          this.Htarget = this.HMin; // –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ H
          this.HscaleUpThreshold = 0.7; // –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã—à–µ 70%, –º–æ–∂–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å
          this.HscaleDownThreshold = 0.3; // –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∏–∂–µ 30%, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º H
          this.maxDynamicH = 64; // –ú—è–≥–∫–∏–π –ª–∏–º–∏—Ç (–Ω–µ –∂–µ—Å—Ç–∫–∏–π) –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
          this.dynamicMaxH = this.maxDynamicH; // –ê–í–¢–û-–õ–ò–ú–ò–¢ –¥–ª—è H (—Å–∞–º–æ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)

          // –í–µ—Å–∞ –∏ —Å–º–µ—â–µ–Ω–∏—è (–±—É–¥—É—Ç –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏)
          this.reinitializeWeights();

          // ===== –ê–î–ê–ü–¢–ò–í–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–ê–ú–ò =====
          this.lr = 0.03;
          this.l2 = 1e-4;
          this.mix = 0.75;
          this.lrAdaptive = true;
          this.mixAdaptive = true;
          this.KpAdaptive = true;

          this.aggr = 1.0;
          this.I = 0;
          this.Imax = 3.0;
          this.Kp = 0.35;
          this.Ki = 0.1;
          this.KpBase = 0.35;
          this.KiBase = 0.1;
          this.prevJ = null;
          this.prevAggr = null;
          this.eps = 1e-6;
          this._x = new Float64Array(this.D);
          this._x_ext = new Float64Array(this.maxDynamicD); // –ë—É—Ñ–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
          this.activeFeatureIdx = Array.from({ length: this.D }, (_, i) => i); // –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
          this.featureScores = new Float64Array(this.maxDynamicD); // –≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
          this.prev_df = 0;
          this.prev_phi = 0; // –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö
          this.dynamicMaxD = this.maxDynamicD; // –ê–í–¢–û-–õ–ò–ú–ò–¢ –¥–ª—è —á–∏—Å–ª–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
          this._h = new Float64Array(this.maxDynamicH); // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º—É–º –±—É—Ñ–µ—Ä–∞
          this._h_lin = new Float64Array(this.maxDynamicH);

          // lock-–∑–∞—â–∏—Ç–∞
          this.locked = false;
          this.lockUntil = 0;
          this.lockMs = 3000;
          this.lrBase = this.lr;
          this.lrMin = 0.003;
          this.lrRecoverMs = 3000;
          this.lastUnlockTime = performance.now();
          this.snap = null;
          this.spikeJ = 0.25;
          this.dropC = 0.25;

          // ===== –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –†–ï–°–£–†–°–û–í =====
          if (enableOptimization) {
            this.memPool = new MemoryPool(80);
            this.batchLimiter = new BatchLimiter(4, 14);
            this.adaptiveMode = new AdaptiveMode();
            this.iterCount = 0;
            this.gcInterval = 100;
            this.resourceTarget = 0; // –ù–û–í–û–ï - —Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ = 0!
          }
          this.enableOpt = enableOptimization;

          // ===== –ú–ï–¢–†–ò–ö–ò –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø =====
          this.scaleCheckInterval = 50;
          this.lastScaleCheck = 0;
          this.qualityHistory = []; // –ò—Å—Ç–æ—Ä–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–∞
          this.frozenWeights = false; // –ó–∞–º–æ—Ä–æ–∑–∫–∞ –≤–µ—Å–æ–≤ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
          this.useFloat32 = false; // –ò—Å–ø–æ–ª—å–∑—É–µ–º float32 –µ—Å–ª–∏ —Ä–µ—Å—É—Ä—Å—ã –∫—Ä–∏—Ç–∏—á–Ω—ã
        }

        // –ù–û–í–û–ï: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Å–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ H
        reinitializeWeights() {
          this.W1 = new Float64Array(this.H * this.D);
          this.b1 = new Float64Array(this.H);
          this.W2 = new Float64Array(this.H);
          this.b2 = 0;
          const r1 = Math.sqrt(2 / this.D);
          for (let i = 0; i < this.H * this.D; i++)
            this.W1[i] = (Math.random() * 2 - 1) * r1;
          for (let i = 0; i < this.H; i++) this.b1[i] = 0;
          const r2 = Math.sqrt(2 / this.H);
          for (let i = 0; i < this.H; i++)
            this.W2[i] = (Math.random() * 2 - 1) * r2;
        }

        // –°–∞–º–æ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –º–∞–∫—Å–∏–º—É–º–æ–≤ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É/—Ä–µ—Å—É—Ä—Å–∞–º/—Ç—Ä–µ–Ω–¥—É
        updateDynamicCaps(avgQuality, resourceUsage, trend) {
          // –°—É–∂–∞–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –º–∞–∫—Å–∏–º—É–º—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ/—Ö–æ—Ä–æ—à–µ–º –∫–∞—á–µ—Å—Ç–≤–µ
          if (resourceUsage > 0.85 || avgQuality > 0.85) {
            this.dynamicMaxH = Math.max(
              this.H,
              Math.max(this.HMin, this.dynamicMaxH - this.HStep),
            );
            this.dynamicMaxD = Math.max(
              this.D,
              Math.max(this.DBase, this.dynamicMaxD - this.DStep),
            );
          }
          // –ü–ª–∞–≤–Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ–º, –µ—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∏–∑–∫–æ–µ –∏ —Ä–µ—Å—É—Ä—Å—ã —Å–≤–æ–±–æ–¥–Ω—ã
          else if (avgQuality < 0.35 && resourceUsage < 0.45 && trend >= 0) {
            this.dynamicMaxH = Math.min(
              this.maxDynamicH,
              this.dynamicMaxH + this.HStep,
            );
            this.dynamicMaxD = Math.min(
              this.maxDynamicD,
              this.dynamicMaxD + this.DStep,
            );
          }
          // –ì–∞—Ä–∞–Ω—Ç–∏–∏: –∫–∞–ø—ã –Ω–µ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ –±–∞–∑–æ–≤—ã—Ö –ª–∏–º–∏—Ç–æ–≤
          this.dynamicMaxH = Math.max(
            this.H,
            Math.min(this.dynamicMaxH, this.maxDynamicH),
          );
          this.dynamicMaxD = Math.max(
            this.D,
            Math.min(this.dynamicMaxD, this.maxDynamicD),
          );
        }

        // –°–æ–±–∏—Ä–∞–µ–º –í–°–ï (–±–∞–∑–∞ + –∫–∞–Ω–¥–∏–¥–∞—Ç—ã) –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ _x_ext, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –∏ –¥–ª–∏–Ω—É
        _computeAllFeatures({ phi, df, u, conf, inertia, fs, peak }) {
          const clip = (v, a, b) => Math.max(a, Math.min(b, v));
          const mphi = clip(Math.abs(phi) / Math.PI, 0, 1);
          const mdf = clip(Math.abs(df) / 50, 0, 1);
          const mu = clip(Math.abs(u) / 300, 0, 1);
          const mc = clip(1 - conf, 0, 1);
          const mi = clip(1 - inertia, 0, 1);
          const mfs = clip(fs / 240, 0, 1);
          const mpk = clip(peak / 2.5, 0, 1);
          const sDf = clip(Math.sqrt(Math.max(0, this.emaVarDf)) / 50, 0, 1);
          // –ë–ê–ó–ê (9)
          this._x_ext[0] = 1;
          this._x_ext[1] = mphi;
          this._x_ext[2] = mdf;
          this._x_ext[3] = sDf;
          this._x_ext[4] = mu;
          this._x_ext[5] = mc;
          this._x_ext[6] = mi;
          this._x_ext[7] = mfs;
          this._x_ext[8] = mpk;
          // –ö–ê–ù–î–ò–î–ê–¢–´ (–∞–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ) ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ
          const idx0 = 9;
          const ddf = clip(Math.abs(df - this.prev_df) / 50, 0, 1);
          const dphi = clip(
            Math.abs(
              Math.atan2(
                Math.sin(phi - this.prev_phi),
                Math.cos(phi - this.prev_phi),
              ),
            ) / Math.PI,
            0,
            1,
          );
          const stability = clip(conf * inertia, 0, 1);
          const invPeak = clip(1 / (1 + Math.max(0, peak)), 0, 1);
          const inter1 = clip(mdf * mc, 0, 1);
          const inter2 = clip(mphi * mi, 0, 1);
          const varBoost = clip(
            Math.sqrt(Math.max(0, this.emaVarDf)) / 25,
            0,
            1,
          );
          const uEff = clip(this.emaAbsU / (1 + this.emaAbsDf), 0, 1);
          this._x_ext[idx0 + 0] = ddf;
          this._x_ext[idx0 + 1] = dphi;
          this._x_ext[idx0 + 2] = stability;
          this._x_ext[idx0 + 3] = invPeak;
          this._x_ext[idx0 + 4] = inter1;
          this._x_ext[idx0 + 5] = inter2;
          this._x_ext[idx0 + 6] = varBoost;
          this._x_ext[idx0 + 7] = uEff;
          return idx0 + 8; // –¥–ª–∏–Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∞–∂–Ω–æ—Å—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—à–∏–±–∫–∏ J (—á–µ–º J –≤—ã—à–µ, —Ç–µ–º —Ü–µ–Ω–Ω–µ–µ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫)
        _updateFeatureScores(J, lenAll) {
          const a = 0.05;
          for (let i = this.DBase; i < lenAll && i < this.maxDynamicD; i++) {
            const v = Math.abs(this._x_ext[i]);
            const s = v * Math.max(0, Math.min(1, J));
            this.featureScores[i] = (1 - a) * this.featureScores[i] + a * s;
          }
        }

        // –ê–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –∫–æ–≥–¥–∞ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∏–∑–∫–æ–µ –∏ —Ä–µ—Å—É—Ä—Å—ã –ø–æ–∑–≤–æ–ª—è—é—Ç
        autoExpandFeatures(quality, resourceUsage, lenAll) {
          if (quality >= 0.6) return; // –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ ‚Äî –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ–º
          if (resourceUsage >= 0.5) return; // –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ–º
          if (this.D >= this.dynamicMaxD) return; // –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –∞–≤—Ç–æ-–ª–∏–º–∏—Ç
          // –°–æ–±–µ—Ä—ë–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö
          const active = new Set(this.activeFeatureIdx);
          const cands = [];
          for (let i = this.DBase; i < lenAll && i < this.maxDynamicD; i++) {
            if (!active.has(i)) cands.push(i);
          }
          if (cands.length === 0) return;
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
          cands.sort((i, j) => this.featureScores[j] - this.featureScores[i]);
          // –ü–æ—Ä–æ–≥ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –ø–æ–ª—å–∑—ã, —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å —à—É–º
          const minScore = 0.02;
          let added = 0;
          for (const idx of cands) {
            if (this.D >= this.dynamicMaxD) break;
            if (this.featureScores[idx] < minScore) break;
            this.activeFeatureIdx.push(idx);
            this.D++;
            added++;
            if (added >= this.DStep || this.D >= this.maxDynamicD) break;
          }
          if (added > 0) {
            // –ü–µ—Ä–µ–≤—ã–¥–µ–ª—è–µ–º –≤—Ö–æ–¥–Ω–æ–π –±—É—Ñ–µ—Ä –∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ—Å–∞ –ø–æ–¥ –Ω–æ–≤–æ–µ D
            this._x = new Float64Array(this.D);
            this.reinitializeWeights();
          }
        }

        // –ù–û–í–û–ï: –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–ë–ï–ó –ñ–ï–°–¢–ö–ò–• –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô)
        autoScaleArchitecture(quality, resourceUsage) {
          this.iterCount = (this.iterCount || 0) + 1;
          if (this.iterCount % this.scaleCheckInterval !== 0) return;

          // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–∞—á–µ—Å—Ç–≤–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∏—Ç–µ—Ä–∞—Ü–∏–π)
          this.qualityHistory.push(quality);
          if (this.qualityHistory.length > 20) this.qualityHistory.shift();

          const avgQuality =
            this.qualityHistory.reduce((a, b) => a + b, 0) /
            this.qualityHistory.length;
          const trend =
            this.qualityHistory.length > 10
              ? (this.qualityHistory[this.qualityHistory.length - 1] -
                  this.qualityHistory[0]) /
                10
              : 0;

          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ-–∫–∞–ø –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º —Ä–µ—à–µ–Ω–∏—è
          this.updateDynamicCaps(avgQuality, resourceUsage, trend);

          // –õ–û–ì–ò–ö–ê –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø (–ë–ï–ó –í–ï–†–•–ù–ï–ì–û –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø - –°–ï–¢–¨ –°–ê–ú–ê –ö–û–ù–¢–†–û–õ–ò–†–£–ï–¢)
          // 1. –ï—Å–ª–∏ —Ä–µ—Å—É—Ä—Å—ã –∫—Ä–∏—Ç–∏—á–Ω—ã (>80%) - —É–º–µ–Ω—å—à–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ò –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –≤–µ—Å–∞
          if (resourceUsage > 0.8) {
            if (this.H > this.HMin) {
              this.H = Math.max(this.HMin, this.H - this.HStep);
              this.reinitializeWeights();
            }
            this.frozenWeights = true;
            this.lr = this.lrMin; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–º–æ—Ä–æ–∑–∫–µ
          }
          // 2. –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –ø–ª–æ—Ö–æ–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (–ë–ï–ó –í–ï–†–•–ù–ï–ì–û –ü–†–ï–î–ï–õ–ê)
          else if (
            avgQuality < this.HscaleDownThreshold &&
            resourceUsage < 0.5
          ) {
            this.Htarget = Math.min(this.dynamicMaxH, this.H + this.HStep);
            if (this.Htarget > this.H) {
              this.H = this.Htarget;
              this.reinitializeWeights();
            }
            this.frozenWeights = false;
          }
          // 3. –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ö–æ—Ä–æ—à–µ–µ –ò —Ä–µ—Å—É—Ä—Å—ã –Ω–∏–∑–∫–∏–µ - –º–æ–∂–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
          else if (
            avgQuality > this.HscaleUpThreshold &&
            trend > 0 &&
            resourceUsage < 0.4
          ) {
            this.Htarget = Math.min(this.dynamicMaxH, this.H + this.HStep);
            if (this.Htarget > this.H) {
              this.H = this.Htarget;
              this.reinitializeWeights();
            }
            this.frozenWeights = false;
          }
          // 4. –ï—Å–ª–∏ —Ä–µ—Å—É—Ä—Å—ã —Å—Ä–µ–¥–Ω–∏–µ –∏ –∫–∞—á–µ—Å—Ç–≤–æ —É–ª—É—á—à–∞–µ—Ç—Å—è - –ø—ã—Ç–∞–µ–º—Å—è —É–º–µ–Ω—å—à–∞—Ç—å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
          else if (
            resourceUsage > 0.5 &&
            avgQuality > 0.5 &&
            this.H > this.HMin
          ) {
            this.H = Math.max(this.HMin, this.H - this.HStep);
            this.reinitializeWeights();
            this.frozenWeights = false;
          } else {
            this.frozenWeights = false;
          }
        }
        snapshot() {
          this.snap = {
            W1: new Float64Array(this.W1),
            b1: new Float64Array(this.b1),
            W2: new Float64Array(this.W2),
            b2: this.b2,
            aggr: this.aggr,
          };
        }
        restore() {
          if (this.snap) {
            this.W1.set(this.snap.W1);
            this.b1.set(this.snap.b1);
            this.W2.set(this.snap.W2);
            this.b2 = this.snap.b2;
            this.aggr = this.snap.aggr;
          }
        }

        _features(state) {
          const lenAll = this._computeAllFeatures(state);
          // –ü—Ä–æ–µ—Ü–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ activeFeatureIdx –≤ —Ç–µ–∫—É—â–∏–π –≤–µ–∫—Ç–æ—Ä _x
          for (let i = 0; i < this.D; i++) {
            const srcIdx = this.activeFeatureIdx[i] || 0;
            this._x[i] = this._x_ext[srcIdx];
          }
          return this._x;
        }
        updateMetrics({ phi, df, u, conf, inertia }) {
          const a = this.a;
          this.emaAbsPhi = (1 - a) * this.emaAbsPhi + a * Math.abs(phi);
          this.emaAbsDf = (1 - a) * this.emaAbsDf + a * Math.abs(df);
          this.emaVarDf = (1 - a) * this.emaVarDf + a * (df * df);
          this.emaAbsU = (1 - a) * this.emaAbsU + a * Math.abs(u);
          // –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ conf –∏ inertia –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0-1 –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
          const conf_bounded = Math.max(0, Math.min(1, conf));
          const inertia_bounded = Math.max(0, Math.min(1, inertia));
          this.emaOneMinConf =
            (1 - a) * this.emaOneMinConf + a * (1 - conf_bounded);
          this.emaOneMinIner =
            (1 - a) * this.emaOneMinIner + a * (1 - inertia_bounded);
        }
        cost() {
          const sigmaDf = Math.sqrt(Math.max(0, this.emaVarDf));

          // ===== –ó–ê–©–ò–¢–ê –û–¢ NaN =====
          if (!isFinite(this.emaAbsPhi)) this.emaAbsPhi = 0;
          if (!isFinite(this.emaAbsDf)) this.emaAbsDf = 0;
          if (!isFinite(this.emaAbsU)) this.emaAbsU = 0;
          if (!isFinite(this.emaOneMinConf)) this.emaOneMinConf = 1;
          if (!isFinite(this.emaOneMinIner)) this.emaOneMinIner = 1;
          if (!isFinite(this.emaResourceUsage)) this.emaResourceUsage = 0;

          // ===== –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –ö–û–ú–ü–û–ù–ï–ù–¢–û–í –î–õ–Ø –≠–ö–û–ù–û–ú–ò–ò –†–ï–°–£–†–°–û–í =====
          // –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞, –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          const w_phi = this.emaAbsPhi < 0.1 ? this.w_phi * 0.3 : this.w_phi; // –ú–µ–Ω—å—à–µ –≤–µ—Å–∞ –µ—Å–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ
          const w_df = sigmaDf < 0.05 ? this.w_df * 0.1 : this.w_df; // –ü–æ—á—Ç–∏ –æ—Ç–∫–ª—é—á–∞–µ–º –µ—Å–ª–∏ –º–∞–ª–æ –¥—Ä–µ–π—Ñ–∞
          const w_var = sigmaDf < 0.05 ? this.w_var * 0.1 : this.w_var; // –ú–∞–ª–æ –≤–∞—Ä–∏–∞—Ü–∏–∏ = –º–∞–ª–æ –≤–µ—Å–∞
          const w_u = this.emaAbsU < 0.1 ? this.w_u * 0.2 : this.w_u; // –ú–∞–ª–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è = –º–∞–ª–æ –≤–µ—Å–∞

          // –û—Å–Ω–æ–≤–Ω–æ–π cost —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –≤–µ—Å–∞–º–∏
          const baseCost =
            w_phi * this.emaAbsPhi +
            w_df * this.emaAbsDf +
            w_var * sigmaDf +
            w_u * this.emaAbsU +
            this.w_c * this.emaOneMinConf +
            this.w_i * this.emaOneMinIner;

          const resourcePenalty =
            this.w_res * Math.max(0, Math.min(1, this.emaResourceUsage));
          const result = baseCost + resourcePenalty;

          // –§–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç NaN
          return isFinite(result) ? result : 0;
        }

        // ===== –ù–û–í–û–ï: –ê–î–ê–ü–¢–ê–¶–ò–Ø –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–û–í –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –°–û–°–¢–û–Ø–ù–ò–Ø =====
        adaptParameters(J, conf, inertia, resourceUsage) {
          const a = 0.15; // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

          // –û–±–Ω–æ–≤–ª—è–µ–º EMA –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (–ù–û–í–û–ï!)
          this.emaResourceUsage =
            (1 - a) * this.emaResourceUsage + a * resourceUsage;

          // –ê–î–ê–ü–¢–ò–í–ù–´–ô LEARNING RATE - —Å–Ω–∏–∂–∞–µ–º –∫–æ–≥–¥–∞ –ø–ª–æ—Ö–æ, –ø–æ–≤—ã—à–∞–µ–º –∫–æ–≥–¥–∞ —Ö–æ—Ä–æ—à–æ
          if (this.lrAdaptive) {
            const goodState =
              conf > 0.6 && inertia > 0.5 && this.emaResourceUsage < 0.3;
            const badState = conf < 0.3 || inertia < 0.2;

            if (goodState) {
              this.lr = Math.min(this.lrBase, this.lr * 1.05); // –û—Å—Ç–æ—Ä–æ–∂–Ω–æ —Ä–∞—Å—Ç–µ—Ç
            } else if (badState) {
              this.lr = Math.max(this.lrMin, this.lr * 0.8); // –ë—ã—Å—Ç—Ä–æ –ø–∞–¥–∞–µ—Ç
            } else {
              this.lr = this.lrBase * 0.9; // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±–∞–∑–µ
            }
          }

          // –ê–î–ê–ü–¢–ò–í–ù–´–ô MIX - –±–æ–ª—å—à–µ —Å–µ—Ç–∏ –∫–æ–≥–¥–∞ —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –±–æ–ª—å—à–µ PID –∫–æ–≥–¥–∞ –ø–ª–æ—Ö–æ
          if (this.mixAdaptive) {
            const nnQuality = 1.0 - this.emaOneMinConf; // –°–µ—Ç—å —Ö–æ—Ä–æ—à–∞ –∫–æ–≥–¥–∞ conf –≤—ã—Å–æ–∫
            const pidQuality = Math.min(
              1,
              (1 - this.emaResourceUsage) * (0.5 + 0.5 * inertia),
            );

            const totalQuality = nnQuality + pidQuality;
            if (totalQuality > 1e-6) {
              this.mix = 0.5 + 0.45 * (nnQuality / totalQuality); // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –≤–µ—Å
            }
          }

          // –ê–î–ê–ü–¢–ò–í–ù–´–ï PID –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–´ - –∑–∞–≤–∏—Å—è—Ç –æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
          if (this.KpAdaptive) {
            const confidence = Math.max(0, Math.min(1, conf));
            this.Kp = this.KpBase * (0.5 + 1.5 * confidence); // –†–∞—Å—Ç–µ—Ç —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é
            this.Ki = this.KiBase * (0.3 + 1.7 * confidence); // Ki –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–µ–Ω
          }

          // –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –†–ï–ì–£–õ–ò–†–û–í–ö–ê –í–ï–°–û–í - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à—Ç—Ä–∞—Ñ –∑–∞ —Ä–µ—Å—É—Ä—Å—ã –µ—Å–ª–∏ –æ–Ω–∏ –≤—ã—Å–æ–∫–∏–µ
          if (this.emaResourceUsage > 0.6) {
            this.w_res = Math.min(1.0, this.w_res * 1.1); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à—Ç—Ä–∞—Ñ
          } else if (this.emaResourceUsage < 0.2) {
            this.w_res = Math.max(0.2, this.w_res * 0.95); // –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∞–µ–º
          }

          // ===== –ù–û–í–û–ï: FREEZE LEARNING –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ —Ö–æ—Ä–æ—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ =====
          const quality = 1.0 - J; // –ö–∞—á–µ—Å—Ç–≤–æ = 1 - –æ—à–∏–±–∫–∞
          if (resourceUsage > 0.85 || (quality > 0.95 && resourceUsage > 0.7)) {
            this.frozenWeights = true;
            this.lr = this.lrMin * 0.5; // –ü–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
          } else if (resourceUsage < 0.5 && quality < 0.8) {
            this.frozenWeights = false; // –†–∞–∑–º–æ—Ä–æ–∑–∫–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
          }

          // ===== –ù–û–í–û–ï: –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –¢–û–ß–ù–û–°–¢–¨ –í–´–ß–ò–°–õ–ï–ù–ò–ô =====
          if (resourceUsage > 0.8) {
            this.useFloat32 = true; // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ float32 –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö
          } else if (resourceUsage < 0.6) {
            this.useFloat32 = false; // –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ float64 –∫–æ–≥–¥–∞ —Ä–µ—Å—É—Ä—Å—ã –≤ –Ω–æ—Ä–º–µ
          }
        }
        _forward(x) {
          const H = this.H,
            D = this.D;
          const h = this._h,
            hl = this._h_lin;
          for (let i = 0; i < H; i++) {
            let s = this.b1[i];
            const off = i * D;
            for (let j = 0; j < D; j++) s += this.W1[off + j] * x[j];
            hl[i] = s;
            h[i] = Math.tanh(s);
          }
          let y = this.b2;
          for (let i = 0; i < H; i++) y += this.W2[i] * h[i];
          const aggr = 0.5 + 1.5 * (1 / (1 + Math.exp(-y)));
          return { y, aggr };
        }
        _backward(dJdy) {
          // ===== OSCILLATION PROTECTION: CLIP GRADIENT (NEW) =====
          dJdy = this.damper.clipGradient(dJdy);

          // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–º–æ—Ä–æ–∑–µ–Ω—ã –ª–∏ –≤–µ—Å–∞
          if (this.frozenWeights) return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–∞ –µ—Å–ª–∏ –∑–∞–º–æ—Ä–æ–∑–µ–Ω—ã  // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–∞ –µ—Å–ª–∏ –∑–∞–º–æ—Ä–æ–∑–µ–Ω—ã

          const H = this.H,
            D = this.D,
            x = this._x,
            h = this._h,
            hl = this._h_lin;
          const dJdb2 = dJdy;
          for (let i = 0; i < H; i++) {
            const dW2_raw = dJdy * h[i] + this.l2 * this.W2[i];
            let dW2 = this.damper.applyMomentum(`W2[${i}]`, dW2_raw);
            dW2 = this.damper.clipWeightDelta(dW2);
            this.W2[i] -= this.damper.lrScale * dW2; // ===== PROTECTED UPDATE (NEW) =====
          }
          this.b2 -= this.lr * dJdb2;
          const dJdh = new Float64Array(H);
          for (let i = 0; i < H; i++) dJdh[i] = dJdy * this.W2[i];
          for (let i = 0; i < H; i++) {
            const sech2 = 1 - Math.tanh(hl[i]) ** 2;
            const g = dJdh[i] * sech2;
            const off = i * D;
            for (let j = 0; j < D; j++) {
              const dW1_raw = g * x[j] + this.l2 * this.W1[off + j];
              let dW1 = this.damper.applyMomentum(`W1[${off}+${j}]`, dW1_raw);
              dW1 = this.damper.clipWeightDelta(dW1);
              this.W1[off + j] -= this.damper.lrScale * dW1; // ===== PROTECTED UPDATE (NEW) =====
            }
            this.b1[i] -= this.lr * g;
          }
        }
        maybeLock(J, conf, inertia) {
          const now = performance.now();
          if (this.prevJ == null) {
            this.snapshot();
            return;
          }
          const relSpike =
            (J - this.prevJ) / Math.max(1e-6, Math.abs(this.prevJ));
          const poor = 1 - conf > this.dropC || 1 - inertia > this.dropC;
          if (relSpike > this.spikeJ && poor) {
            this.restore();
            this.locked = true;
            this.lockUntil = now + this.lockMs;
            this.lr = Math.max(this.lrMin, this.lrBase * 0.25);
          }
          if (this.locked && now >= this.lockUntil) {
            this.locked = false;
            this.lastUnlockTime = now;
          }
        }
        recoverLr() {
          if (this.locked) return;
          const t = Math.min(
            1,
            (performance.now() - this.lastUnlockTime) / this.lrRecoverMs,
          );
          this.lr = this.lrBase * (0.25 + 0.75 * t);
        }
        step(state) {
          const { phi, df, u, conf, inertia, fs, peak } = state;
          const x = this._features({ phi, df, u, conf, inertia, fs, peak });
          const { y, aggr: aggr_nn } = this._forward(x);

          const J = this.cost();
          // ===== OSCILLATION PROTECTION (NEW) =====
          this.damper.protect({
            J: J,
            prevJ: this.prevJ,
            dJdy: 0, // Placeholder, will be set in backward
            error: -J,
            aggr: this.aggr,
            I: this.I,
            lrScale: this.lr,
          });
          this.maybeLock(J, conf, inertia);

          // ===== –ù–û–í–û–ï: –í–´–ß–ò–°–õ–Ø–ï–ú –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –†–ï–°–£–†–°–û–í (0-1) =====
          const resourceUsage = this.calcResourceUsage();

          // ===== –ù–û–í–û–ï: –ê–î–ê–ü–¢–ò–†–£–ï–ú –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–†–ï–î –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï–ú =====
          this.adaptParameters(J, conf, inertia, resourceUsage);

          // ===== –ù–û–í–û–ï: –ê–í–¢–û–ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–´ –ò –ü–†–ò–ó–ù–ê–ö–û–í =====
          const quality = Math.max(0, 1.0 - J); // –ö–∞—á–µ—Å—Ç–≤–æ = 1 - –æ—à–∏–±–∫–∞
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∞–∂–Ω–æ—Å—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä, –ø–æ—Å—á–∏—Ç–∞–Ω–Ω—ã–π –≤ _features —Ä–∞–Ω–µ–µ)
          const lenAll = this._computeAllFeatures({
            phi,
            df,
            u,
            conf,
            inertia,
            fs,
            peak,
          });
          this._updateFeatureScores(J, lenAll);
          this.autoExpandFeatures(quality, resourceUsage, lenAll);
          this.autoScaleArchitecture(quality, resourceUsage);

          const e = -J;
          this.I = Math.max(
            -this.Imax,
            Math.min(this.Imax, this.I + this.Ki * e),
          );
          this.I = this.damper.limitIntegralWindup(this.I); // ===== ANTI-WINDUP (NEW) =====
          let aggr_pi = this.aggr + this.Kp * e + this.I;
          aggr_pi = Math.max(0.5, Math.min(2.0, aggr_pi));

          let aggr;
          if (this.locked) {
            aggr = aggr_pi;
          } else {
            const noise = (Math.random() * 2 - 1) * 0.03;
            aggr = Math.max(
              0.5,
              Math.min(
                2.0,
                this.mix * aggr_nn + (1 - this.mix) * aggr_pi + noise,
              ),
            );
          }

          if (!this.locked && this.prevJ !== null && this.prevAggr !== null) {
            const dJdaggr =
              (J - this.prevJ) / (aggr - this.prevAggr + this.eps);
            const sig = 1 / (1 + Math.exp(-y));
            const daggr_dy = 1.5 * sig * (1 - sig) + 1e-6;
            let dJdy = dJdaggr * daggr_dy;
            dJdy = Math.max(-5, Math.min(5, dJdy));
            this._backward(dJdy);
          }

          if (!this.locked) this.snapshot();
          this.recoverLr();

          this.prevJ = J;
          this.prevAggr = aggr;
          this.aggr = aggr;
          // –û–±–Ω–æ–≤–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
          this.prev_df = df;
          this.prev_phi = phi;

          const snr = Math.max(0.05, Math.min(1.0, conf));
          const baseFrac = 0.035 + 0.025 * snr;
          let bw = fs * baseFrac * aggr;
          bw = Math.max(1.5, Math.min(fs / 3, bw));
          const zeta = 0.8 + (0.5 * (1 - snr) * (2.0 - aggr)) / 1.5;
          const twoPiBw = 2 * Math.PI * bw;
          const scale = 1 / Math.max(40, fs);
          let kp = 2 * zeta * twoPiBw * scale;
          let kv = twoPiBw * twoPiBw * scale * 0.25;
          let ki = kp * 0.12 * (0.25 + 0.75 * snr);
          const slew = 10 + 140 * snr * aggr;
          const eco = 0.88 + 0.12 * snr;
          kp *= eco;
          kv *= eco;
          ki *= eco;
          return {
            J,
            aggr,
            kp: Math.max(1e-4, kp),
            kv: Math.max(1e-5, kv),
            ki: Math.max(1e-6, ki),
            slew,
            resourceUsage,
            H: this.H,
            frozenWeights: this.frozenWeights,
            quality,
          }; // –ù–û–í–û–ï: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Å—Ç–∞—Ç—É—Å
        }

        // ===== –ù–û–í–û–ï: –í–´–ß–ò–°–õ–ï–ù–ò–ï –ú–ï–¢–†–ò–ö–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –†–ï–°–£–†–°–û–í (0-1) =====
        calcResourceUsage() {
          if (!this.enableOpt) return 0;

          // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –≤ –æ–¥–∏–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (0-1)
          const lrPressure = Math.min(1, this.lr / this.lrBase); // LR –≤—ã—à–µ –±–∞–∑–æ–≤–æ–≥–æ = –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤
          const lockPressure = this.locked ? 1 : 0; // Locked = –º–∞–∫—Å–∏–º—É–º
          const memPressure = this.adaptiveMode?.memoryPressure || 0; // –î–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

          // –í–∑–≤–µ—à–µ–Ω–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è
          return Math.min(
            1,
            Math.max(
              0,
              0.3 * lrPressure + 0.3 * lockPressure + 0.4 * memPressure,
            ),
          );
        }

        // ===== –ö–û–ù–¢–†–û–õ–¨ –ü–ê–ú–Ø–¢–ò –ò –ê–î–ê–ü–¢–ê–¶–ò–Ø =====
        checkMemoryAndAdapt() {
          if (!this.enableOpt) return;

          this.iterCount++;
          this.adaptiveMode.checkMemory();

          // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
          if (this.iterCount % this.gcInterval === 0) {
            if (this.adaptiveMode.memoryPressure > 0.8) {
              console.warn(
                `üß† Memory ${(this.adaptiveMode.memoryPressure * 100).toFixed(1)}% ‚Äî GC triggered`,
              );
              // –û—Ç–ø—É—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±—É—Ñ–µ—Ä—ã –∏–∑ –ø—É–ª–∞
              if (this.memPool) {
                Object.keys(this.memPool.buffers).forEach((key) => {
                  const arr = this.memPool.buffers[key];
                  if (arr.length > 20) {
                    this.memPool.buffers[key] = arr.slice(-10);
                  }
                });
              }
            }
          }
        }

        getOptimizationStats() {
          if (!this.enableOpt) return null;
          return {
            precision: this.adaptiveMode.precision,
            memory: (this.adaptiveMode.memoryPressure * 100).toFixed(1) + "%",
            poolReused: this.memPool.stats.reused,
            poolAllocated: this.memPool.stats.allocated,
          };
        }

        calcResourcePenalty() {
          if (!this.enableOpt) return 0;

          // –†–∞—Å—á—ë—Ç —à—Ç—Ä–∞—Ñ–æ–≤ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
          const lrPenalty = Math.max(0, this.lr - this.lrBase) * 100; // —à—Ç—Ä–∞—Ñ –∑–∞ –≤—ã—Å–æ–∫–∏–π LR
          const updatePenalty = this.iterCount % this.gcInterval === 0 ? 5 : 0; // —à—Ç—Ä–∞—Ñ –ø—Ä–∏ GC
          const aggrPenalty = Math.abs(this.aggr - 1.0) * 10; // —à—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ aggr
          const driftPenalty = this.emaVarDf * 0.5; // —à—Ç—Ä–∞—Ñ –∑–∞ –¥—Ä–µ–π—Ñ
          const lockPenalty = this.locked ? 20 : 0; // —à—Ç—Ä–∞—Ñ –µ—Å–ª–∏ locked

          this.iterCount++;

          const totalPenalty =
            lrPenalty +
            updatePenalty +
            aggrPenalty +
            driftPenalty +
            lockPenalty;
          // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0-100 –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å UI –ª–æ–≥–∏–∫–æ–π
          return Math.min(
            100,
            Math.max(0, totalPenalty / (1 + totalPenalty / 100)),
          );
        }
      }

      /* ====================== –ß–∞—Å—Ç–æ—Ç–Ω—ã–π —Å–∫–∞–Ω–µ—Ä ====================== */
      class FrequencyScanner {
        constructor(s) {
          this.s = s;
          this.kf = new Kalman(0, 0, 0.001, 0.008);
          this.vco = 0;
          this.phi = 0;
          this.inertia = 0;
          this.state = "SEARCHING";

          this.r = 0;
          this.N = this.s.dynamic_n;
          this.hopRatio = Math.min(
            0.4,
            Math.max(0.1, 0.9 / Math.sqrt((this.s.actual_fs || 60) / 60)),
          );
          this.hop = Math.max(8, Math.floor(this.N * this.hopRatio));
          this.booted = false;

          this.win = new Float64Array(this.N);
          this.block = new Float64Array(this.N);
          this.tst = new Float64Array(this.N);
          this._needWin = true;

          this.fmax = 50;
          this.fstep = 0.1;
          this.maxPoints = 240;

          this.phase_dead = 0.02;
          this.f_ema = 0;

          this.out_f = 0;
          this.out_conf = 0;
          this.out_inertia = 0;
          this.out_state = "SEARCHING";
          this.out_peak = 0;
          this.dt = 0;
          this.fs = 0;

          this.u_int = 0;
          this.u_int_max = 3.0;
          this.lastUpdateMs = performance.now();

          this.kp = 0.1;
          this.kv = 0.01;
          this.ki = 0.002;
          this.slew = 40;

          this.tuner = new NeuroHomeo();
          this.lastDfApplied = 0;
        }

        _wrap(a) {
          return Math.atan2(Math.sin(a), Math.cos(a));
        }
        _ensureWin() {
          if (!this._needWin) return;
          const N = this.N;
          for (let n = 0; n < N; n++)
            this.win[n] = 0.5 * (1 - Math.cos((2 * Math.PI * n) / (N - 1)));
          this._needWin = false;
        }
        _refresh() {
          if (this.N !== this.s.dynamic_n) {
            this.N = this.s.dynamic_n;
            this.hopRatio = Math.min(
              0.4,
              Math.max(0.1, 0.9 / Math.sqrt((this.s.actual_fs || 60) / 60)),
            );
            this.hop = Math.max(8, Math.floor(this.N * this.hopRatio));
            this.win = new Float64Array(this.N);
            this.block = new Float64Array(this.N);
            this.tst = new Float64Array(this.N);
            this._needWin = true;
          }
          this._ensureWin();
        }
        needCount() {
          return this.booted ? this.hop : this.N;
        }
        _grab() {
          this._refresh();
          const need = this.needCount();
          const avail = (this.s.widx - this.r) & CpuJitterSampler.MASK;
          if (avail < need) return false;

          for (let i = 0; i < this.N; i++) {
            const idx = (this.r + i) & CpuJitterSampler.MASK;
            this.block[i] = this.s.rb[idx] * this.win[i];
            this.tst[i] = this.s.ts[idx];
          }
          const total = this.tst[this.N - 1] - this.tst[0];
          this.dt = total / 1000 / Math.max(1, this.N - 1);
          this.fs = 1.0 / Math.max(1e-6, this.dt);

          this.r = (this.r + need) & CpuJitterSampler.MASK;
          this.booted = true;
          return true;
        }
        _evalAt(f) {
          const g = new Goertzel();
          g.init(this.N, this.fs, Math.max(0, Math.min(this.fmax, f)));
          for (let i = 0; i < this.N; i++) g.push(this.block[i]);
          return g.result();
        }

        processOnce() {
          if (!this._grab()) return;

          this.fmax = Math.min(100, this.s.actual_fs / 2);
          this.fstep = Math.max(0.02, this.fmax / 260);

          let fmin = 0,
            fmax = this.fmax,
            fstep = this.fstep;
          if (this.state === "TRACKING") {
            const span = 0.1 * this.fmax;
            fmin = Math.max(0, this.vco - span);
            fmax = Math.min(this.fmax, this.vco + span);
            fstep = Math.max(this.fstep / 5, 0.01);
          }
          let steps = Math.floor((fmax - fmin) / fstep);
          if (steps > this.maxPoints) fstep = (fmax - fmin) / this.maxPoints;

          let bestF = this.vco,
            bestMag = -1,
            best = null,
            sumMag = 0,
            cnt = 0;
          for (let f = fmin; f <= fmax + 1e-9; f += fstep) {
            const r = this._evalAt(f);
            sumMag += r.mag;
            cnt++;
            if (r.mag > bestMag) {
              bestMag = r.mag;
              bestF = f;
              best = r;
            }
          }
          const avgMag = cnt ? sumMag / cnt : 0;
          const cur = best || this._evalAt(this.vco);

          let local = Number.EPSILON;
          for (let df = -2; df <= 2; ++df)
            local += this._evalAt(this.vco + df * fstep).mag;
          // –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç confidence - –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
          const conf_raw = local > 0 ? cur.mag / local : 0;
          const conf = Math.max(0, Math.min(1, conf_raw));
          const peak = avgMag > 0 ? cur.mag / avgMag : 0;
          this.out_peak = peak;

          if (conf > 0.07 || peak > 1.05)
            this.inertia += 0.4 * (1 - this.inertia);
          else this.inertia *= 0.988;
          this.inertia = Math.max(0, Math.min(1, this.inertia));

          if (this.inertia < 0.05 && this.state === "TRACKING")
            this.state = "SEARCHING";
          else if (this.inertia > 0.34 && this.state === "SEARCHING") {
            this.state = "TRACKING";
            this.kf.reset(0, 0);
          }

          if (this.state !== "TRACKING") {
            if (!this.f_ema) this.f_ema = bestF;
            const searchGain = Math.min(
              0.6,
              0.08 + 0.52 * Math.min(1, peak / 1.2),
            );
            this.f_ema = (1 - searchGain) * this.f_ema + searchGain * bestF;
            this.vco = this.f_ema;
          }

          let ephi = this._wrap(cur.ph - this.phi);
          if (Math.abs(ephi) < this.phase_dead) ephi = 0;

          this.kf.predict(this.dt);
          const rMeas = 0.05 + (1 - conf) * 3.0 + (1 - this.inertia) * 10.0;
          this.kf.update(ephi, rMeas);
          const u = this.kf.x;

          const df_obs = bestF - this.vco;
          let u_ctrl = this.kp * u + this.kv * this.kf.v + this.u_int;

          // –∞–≤—Ç–æ/—Ä—É—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–±–µ—Ä—ë–º –∏–∑ UI)
          // –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ –ø–µ—Ä–µ–¥ processOnce()

          // —à–∞–≥ —Ç—é–Ω–µ—Ä–∞ (–¥–∞—ë—Ç –Ω–æ–≤—ã–µ kp/kv/ki/slew)
          const neu = this.tuner.step({
            phi: ephi,
            df: df_obs,
            u: u_ctrl,
            conf,
            inertia: this.inertia,
            fs: this.fs,
            peak,
          });

          this.u_int += neu.ki * ephi * this.dt;
          const uMax = this.u_int_max * (0.8 + 1.2 * conf);
          this.u_int = Math.max(-uMax, Math.min(uMax, this.u_int));

          u_ctrl = neu.kp * u + neu.kv * this.kf.v + this.u_int;

          const now = performance.now();
          const dtMs = Math.max(1, now - this.lastUpdateMs);
          this.lastUpdateMs = now;
          const maxStep = neu.slew * (dtMs / 1000);

          const df_applied = Math.max(-maxStep, Math.min(maxStep, u_ctrl));
          if (df_applied !== u_ctrl) this.u_int *= 0.95;
          this.lastDfApplied = df_applied;

          this.vco = Math.max(0, Math.min(this.fmax, this.vco + df_applied));
          this.phi = this._wrap(this.phi + 2 * Math.PI * this.vco * this.dt);

          this.kp = neu.kp;
          this.kv = neu.kv;
          this.ki = neu.ki;
          this.slew = neu.slew;

          // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Ö–æ–¥—ã —Ç—é–Ω–µ—Ä–∞ –¥–ª—è UI
          this.out_f = this.vco;
          this.out_conf = conf;
          this.out_inertia = this.inertia;
          this.out_state = this.state;
          this.out_resourceUsage = isFinite(neu.resourceUsage)
            ? neu.resourceUsage
            : this.tuner.emaResourceUsage || 0;
          this.out_H = isFinite(neu.H) ? neu.H : this.tuner.H;
          this.out_frozen = !!neu.frozenWeights;
          this.out_J = isFinite(neu.J)
            ? neu.J
            : (this.tuner.prevJ ?? undefined);
          this.out_quality = isFinite(neu.quality)
            ? neu.quality
            : isFinite(this.tuner.prevJ)
              ? Math.max(0, 1 - this.tuner.prevJ)
              : undefined;
        }
      }

      /* ============================ UI ============================ */
      document.addEventListener("DOMContentLoaded", () => {
        // DOM helpers used by telemetry and UI (make them available to telemetry handler)
        const $_p = (id) => document.getElementById(id);
        const setT = (id, v) => {
          const el = $_p(id);
          if (el) el.textContent = v;
        };
        const setW = (id, p) => {
          const el = $_p(id);
          if (el)
            el.style.width = Math.max(0, Math.min(100, p)).toFixed(0) + "%";
        };
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π scope –¥–ª—è IIFE
        window.__setT = setT;
        window.__setW = setW;
        window.__$ = $_p;

        // –ü—Å–µ–≤–¥–æ—Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞—â–∏—â—ë–Ω–Ω–æ–π –ø–µ—Å–æ—á–Ω–∏—Ü—ã
        // ÔøΩ –ü—Å–µ–≤–¥–æ-—Ä–µ–∂–∏–º –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º!

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–π—Ä–æ-–∞–Ω–∏–º–∞—Ü–∏–µ–π (–æ–≤–µ—Ä–ª–µ–π) =====
        const OVERLAY_KEY = "neuroOverlayEnabled";
        function isOverlayEnabled() {
          const v = localStorage.getItem(OVERLAY_KEY);
          return v === null ? true : v === "1";
        }
        function setOverlayEnabled(on) {
          localStorage.setItem(OVERLAY_KEY, on ? "1" : "0");
          const cb = $("toggleNeuroAnim");
          if (cb) cb.checked = !!on;
          setNeuroOverlayVisible(!!on);
        }
        function setNeuroOverlayVisible(show) {
          const overlay = $("neuroOverlay");
          if (!overlay) return;
          if (show) {
            overlay.classList.add("visible", "buff");
          } else {
            overlay.classList.remove("buff", "visible");
          }
        }

        let shellInstance = null;
        function attachTelemetryHandler(SecureShell) {
          shellInstance = new SecureShell({
            onTelemetry: (m) => {
              const f = Number(m.f || 0);
              const conf = Math.max(0, Math.min(1, Number(m.conf || 0)));
              const inertia = Math.max(0, Math.min(1, Number(m.inertia || 0)));
            window.__setT("freqValue", f.toFixed(3));
              setW("freqBar", Math.max(0, Math.min(100, f)));
            window.__setT("inertiaValue", (inertia * 100).toFixed(0));
              setW("inertiaBar", inertia * 100);
            window.__setT("confValue", (conf * 100).toFixed(0));
              setW("confBar", conf * 100);
            window.__setT(
                "info",
                `Sandbox mode ‚Ä¢ f=${f.toFixed(2)} Hz | conf=${(conf * 100).toFixed(0)}% | inertia=${(inertia * 100).toFixed(0)}% | fs=${m.fs}`,
              );
            },
          });
        }

        // Safe helper to update #startStatus without throwing if element is missing
        function safeSetStartStatus(v) {
          const el = document.getElementById("startStatus");
          if (el) el.textContent = v;
        }

        async function startSecure() {
          // Ensure heavy runtime parts (chat, counters) are initialized before starting algorithm
          try {
            await ensureRuntimeInitialized();
          } catch (e) {
            console.warn("Runtime init failed or skipped", e);
          }
          const sr = Math.max(
            10,
            Math.min(240, parseInt($("#startSampleRate")?.value || "60", 10)),
          );
          const frz = !!$("#startFreeze")?.checked;
          console.log("[ALG] startSecure clicked", { sr, frz });
          const changelog = document.getElementById("algoChangeLog");
          if (changelog) changelog.textContent = "–ó–∞–ø—É—Å–∫: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...";
          safeSetStartStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶");
          if (typeof window.__loadSecureShell === "function") {
            try {
              const SecureShell = await window.__loadSecureShell();
              attachTelemetryHandler(SecureShell);
              await shellInstance.init();
              await shellInstance.start({ sampleRate: sr, freeze: frz });
              // –ö—Ä–∞—Å–∏–≤–æ –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø—É—Å–∫ ‚Äî —Ä–∞–¥—É–∂–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∏ –±–∞—Ñ-–≤–æ–ª–Ω–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
              if (isOverlayEnabled()) {
                showNeuroBuff();
                // –ø–æ–ø—ã—Ç–∫–∞ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏–ª –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(ensureNeuroAnimation, 120);
                setTimeout(ensureNeuroAnimation, 450);
              }
              try {
                Object.defineProperty(window, "__loadSecureShell", {
                  value: undefined,
                  writable: false,
                  configurable: false,
                });
              } catch (_) {}
              safeSetStartStatus(`–ó–∞–ø—É—â–µ–Ω–æ (SR=${sr}${frz ? ", freeze" : ""})`);
              if (changelog)
                changelog.textContent = `–ó–∞–ø—É—â–µ–Ω–æ (SR=${sr}${frz ? ", freeze" : ""})`;
            } catch (e) {
              console.error("Secure start failed", e);
              safeSetStartStatus("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞, –∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è");
              if (isOverlayEnabled()) showNeuroBuff();
              // –ó–∞–ø—É—Å–∫–∞–µ–º –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
              if (window.__legacyEngine && window.__legacyEngine.start) {
                window.__legacyEngine.start();
              } else {
                console.error("CRITICAL: Legacy engine not available!");
                safeSetStartStatus("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
              }
            }
          } else {
            safeSetStartStatus("–ó–∞–≥—Ä—É–∑—á–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è");
            if (isOverlayEnabled()) showNeuroBuff();
            const changelog = document.getElementById("algoChangeLog");
            if (changelog) changelog.textContent = "–õ–æ–∫–∞–ª—å–Ω—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å: –∑–∞–ø—É—â–µ–Ω–æ";
            // –ó–∞–ø—É—Å–∫–∞–µ–º –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
            if (window.__legacyEngine && window.__legacyEngine.start) {
              window.__legacyEngine.start();
            } else {
              console.error("CRITICAL: Legacy engine not available!");
              safeSetStartStatus("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
            }
          }
        }

        function stopSecure() {
          try {
            shellInstance && shellInstance.pause && shellInstance.pause();
          } catch (_) {}
          $("#startStatus").textContent = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ";
          const changelog = document.getElementById("algoChangeLog");
          if (changelog) changelog.textContent = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º";
          // –ü–æ –∂–µ–ª–∞–Ω–∏—é —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –ø—Ä–∏ —Å—Ç–æ–ø–µ
          const overlay = document.getElementById("neuroOverlay");
          if (overlay) {
            overlay.classList.remove("buff", "visible");
          }
        }

        // Bind Start/Stop handlers robustly (direct + delegated fallback)
        try {
          const startBtn = document.getElementById("btnStartAlgo");
          const stopBtn = document.getElementById("btnStopAlgo");
          console.log(
            "[INIT] binding Start/Stop handlers, startBtn=",
            startBtn,
            "stopBtn=",
            stopBtn,
          );
          if (startBtn) {
            // extra check: ensure click produces visible output
            startBtn.addEventListener("click", async (e) => {
              try {
                console.log("[HANDLER] startBtn click handler invoked");
                startBtn.disabled = false;
                await startSecure();
              } catch (er) {
                console.error("start handler error", er);
              } finally {
                startBtn.disabled = false;
              }
            });
            console.log("[INIT] start handler bound");
          } else {
            document.addEventListener("click", (e) => {
              const el = e.target;
              if (
                el &&
                (el.id === "btnStartAlgo" ||
                  (el.closest && el.closest("#btnStartAlgo")))
              ) {
                startSecure();
              }
            });
            console.warn(
              "[INIT] start button not found, using delegated click",
            );
          }
          if (stopBtn) {
            stopBtn.addEventListener("click", (e) => {
              try {
                stopSecure();
              } catch (er) {
                console.error("stop handler error", er);
              }
            });
            console.log("[INIT] stop handler bound");
          } else {
            document.addEventListener("click", (e) => {
              const el = e.target;
              if (
                el &&
                (el.id === "btnStopAlgo" ||
                  (el.closest && el.closest("#btnStopAlgo")))
              ) {
                stopSecure();
              }
            });
            console.warn("[INIT] stop button not found, using delegated click");
          }
        } catch (bindErr) {
          console.error("Error binding Start/Stop handlers", bindErr);
        }
        // –¢—É–º–±–ª–µ—Ä: –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
        const _initOverlayToggle = () => {
          const enabled = isOverlayEnabled();
          const cb = $("toggleNeuroAnim");
          if (cb) {
            cb.checked = enabled;
            cb.addEventListener("change", (e) =>
              setOverlayEnabled(!!e.target.checked),
            );
          }
          if (!enabled) setNeuroOverlayVisible(false);
        };

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–¥—É–∂–Ω—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∏ ¬´–±–∞—Ñ¬ª-–≤–æ–ª–Ω—É –Ω–∞ 1.6‚Äì2.4s
        function showNeuroBuff() {
          const overlay = document.getElementById("neuroOverlay");
          if (!overlay) return;
          // Respect reduced motion preference
          const reduce =
            window.matchMedia &&
            window.matchMedia("(prefers-reduced-motion: reduce)").matches;
          if (reduce) {
            // show a subtle static indicator instead of full animation
            overlay.classList.add("visible");
            overlay.classList.remove("buff");
            overlay.setAttribute("aria-hidden", "false");
            return;
          }

          // Try to start animations ‚Äî add classes, then ensure animation-play-state running
          overlay.classList.add("visible", "buff");
          overlay.setAttribute("aria-hidden", "false");
          // Force restart of CSS animations in case browser suppressed them
          requestAnimationFrame(() => {
            try {
              const svg = overlay.querySelector(".neuro-svg");
              const buff = overlay.querySelector(".buff-wave");
              // toggle to restart
              if (svg) {
                svg.style.animationPlayState = "running";
                svg.getBoundingClientRect();
                svg.style.animation = svg.style.animation || "";
              }
              if (buff) {
                buff.style.animationPlayState = "running";
                buff.getBoundingClientRect();
                buff.style.animation = buff.style.animation || "";
              }
              // some browsers need class toggle
              overlay.classList.remove("visible");
              void overlay.offsetWidth;
              overlay.classList.add("visible");
            } catch (e) {
              /* ignore */
            }
          });
        }
        function ensureNeuroAnimation() {
          const overlay = document.getElementById("neuroOverlay");
          if (!overlay) return;
          const reduce =
            window.matchMedia &&
            window.matchMedia("(prefers-reduced-motion: reduce)").matches;
          if (reduce) return;
          // If overlay visible but animations not running, try again
          const svg = overlay.querySelector(".neuro-svg");
          const buff = overlay.querySelector(".buff-wave");
          const cs = svg ? getComputedStyle(svg) : null;
          const cb = buff ? getComputedStyle(buff) : null;
          const animStopped =
            (cs &&
              (cs.animationPlayState === "paused" ||
                cs.animationName === "none")) ||
            (cb &&
              (cb.animationPlayState === "paused" ||
                cb.animationName === "none"));
          if (animStopped) {
            // try restart
            overlay.classList.remove("visible", "buff");
            void overlay.offsetWidth;
            overlay.classList.add("visible", "buff");
            if (svg) svg.style.animationPlayState = "running";
            if (buff) buff.style.animationPlayState = "running";
          }
        }
        function hideNeuroBuff() {
          const overlay = document.getElementById("neuroOverlay");
          if (!overlay) return;
          overlay.classList.remove("visible", "buff");
          overlay.setAttribute("aria-hidden", "true");
        }
        // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—É–º–±–ª–µ—Ä–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ DOM
        _initOverlayToggle();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤—ã—à–µ)
        (function () {
          /* legacy local engine disabled (isolated scope) */

          const s = new CpuJitterSampler();
          const scan = new FrequencyScanner(s);
          const blender = new OutputBlender();

          // –ú—è–≥–∫–∞—è —Ñ–æ–Ω–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (CPU worker)
          let worker = null;
          try {
            const code = `let it=900,tick=12;
onmessage=e=>{it=e.data.it||it;tick=e.data.dt||tick;};
function step(){let x=1.0001;for(let i=0;i<it;i++){x*=1.00000001;x/=1.000000009;} setTimeout(()=>postMessage(1),tick);}
setInterval(step,12);`;
            worker = new Worker(
              URL.createObjectURL(
                new Blob([code], { type: "application/javascript" }),
              ),
            );
            worker.onmessage = () => {};
          } catch (_) {}

          // –ò–°–ü–û–õ–¨–ó–£–ï–ú setT –ò setW –ò–ó –í–ù–ï–®–ù–ï–ì–û SCOPE (–∏–∑ DOMContentLoaded)
          const $ = (id) => document.getElementById(id);

          // === –°–ª–∞–π–¥–µ—Ä—ã –∏ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º—ã ===
          const lrSlider = $("lrSlider");
          const l2Slider = $("l2Slider");
          const mixSlider = $("mixSlider");
          const lrVal = $("lrVal");
          const l2Val = $("l2Val");
          const mixVal = $("mixVal");
          const lrAuto = $("lrAuto");
          const l2Auto = $("l2Auto");
          const mixAuto = $("mixAuto");

          // –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –∞–≤—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          const AUTO = {
            lrMin: 0.005,
            lrMax: 0.08,
            l2Min: 0.00005,
            l2Max: 0.003,
            mixMin: 0.3,
            mixMax: 0.95,
          };

          function weightsNorm2(t) {
            let ssum = 0;
            for (let i = 0; i < t.W1.length; i++) ssum += t.W1[i] * t.W1[i];
            for (let i = 0; i < t.W2.length; i++) ssum += t.W2[i] * t.W2[i];
            return Math.sqrt(ssum / (t.W1.length + t.W2.length));
          }

          function render(out) {
            // DEBUG
            if (typeof window.__telemetryDebug === 'undefined') {
              window.__telemetryDebug = 0;
            }
            window.__telemetryDebug++;
            if (window.__telemetryDebug <= 5) {
              console.log(`[RENDER ${window.__telemetryDebug}] out=`, out, 'scan=', typeof scan, 'setT=', typeof setT);
            }
            
            const fmax = Math.max(1, scan.fmax);
            window.__setT("freqValue", out.f.toFixed(3));
            window.__setW("freqBar", (100 * out.f) / fmax);
            window.__setT("inertiaValue", (out.inertia * 100).toFixed(0));
            window.__setW("inertiaBar", out.inertia * 100);
            window.__setT("confValue", (out.conf * 100).toFixed(0));
            window.__setW("confBar", out.conf * 100);

            // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            const resUse = isFinite(scan.out_resourceUsage)
              ? scan.out_resourceUsage
              : scan.tuner.emaResourceUsage || 0;
            window.__setT("resourceValue", (resUse * 100).toFixed(0) + "%");
            window.__setW("resourceBar", resUse * 100);
            window.__setT("lrAdaptValue", scan.tuner.lr.toFixed(4));
            window.__setT("mixAdaptValue", (scan.tuner.mix * 100).toFixed(0) + "%");
            window.__setT("KpAdaptValue", scan.tuner.Kp.toFixed(4));

            // === –†–ï–ê–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–õ–ó–£–ù–ö–û–í –ò PROGRESS BARS ===
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
            if (lrSlider && !lrAuto.checked) {
              lrSlider.value = Math.max(0.001, Math.min(0.2, scan.tuner.lrBase || scan.tuner.lr)).toFixed(3);
              setW("lrBar", ((lrSlider.value - 0.001) / (0.2 - 0.001)) * 100);
            window.__setT("lrVal", lrSlider.value);
            }
            if (l2Slider && !l2Auto.checked) {
              l2Slider.value = Math.max(0, Math.min(0.01, scan.tuner.l2 || 0.0001)).toFixed(4);
              setW("l2Bar", (l2Slider.value / 0.01) * 100);
            window.__setT("l2Val", l2Slider.value);
            }
            if (mixSlider && !mixAuto.checked) {
              mixSlider.value = Math.max(0, Math.min(1, scan.tuner.mix || 0.75)).toFixed(2);
              setW("mixBar", (mixSlider.value * 100));
            window.__setT("mixVal", mixSlider.value);
            }

            // Progress bars –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            if (lrAuto && lrAuto.checked) {
              const lrAutoVal = Math.max(0.001, Math.min(0.2, scan.tuner.lrBase || 0.030));
              setW("lrBar", ((lrAutoVal - 0.001) / (0.2 - 0.001)) * 100);
            window.__setT("lrVal", lrAutoVal.toFixed(3) + " (auto)");
            }
            if (l2Auto && l2Auto.checked) {
              const l2AutoVal = Math.max(0, Math.min(0.01, scan.tuner.l2 || 0.0001));
              setW("l2Bar", (l2AutoVal / 0.01) * 100);
            window.__setT("l2Val", l2AutoVal.toFixed(4) + " (auto)");
            }
            if (mixAuto && mixAuto.checked) {
              const mixAutoVal = Math.max(0, Math.min(1, scan.tuner.mix || 0.75));
              setW("mixBar", (mixAutoVal * 100));
            window.__setT("mixVal", mixAutoVal.toFixed(2) + " (auto)");
            }

            // –ù–û–í–û–ï: –ú–µ—Ç—Ä–∏–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (—Å NaN-–∑–∞—â–∏—Ç–æ–π)
            const hVal = isFinite(scan.out_H) ? scan.out_H : scan.tuner.H || 4;
            const jVal = isFinite(scan.out_J)
              ? scan.out_J
              : isFinite(scan.tuner.prevJ)
                ? scan.tuner.prevJ
                : 1;
            const qDirect = isFinite(scan.out_quality)
              ? scan.out_quality
              : undefined;
            const qualityVal = isFinite(qDirect)
              ? qDirect
              : Math.max(0, 1.0 - jVal);
            const qualityPercent = isFinite(qualityVal)
              ? (qualityVal * 100).toFixed(0)
              : "?";

            window.__setT("HValue", hVal);
            window.__setT("qualityValue", qualityPercent + "%");
            window.__setW("qualityBar", Math.max(0, Math.min(100, qualityVal * 100)));
            const frozenNow = !!(scan.out_frozen || scan.tuner.frozenWeights);
            window.__setT("freezeStatusValue", frozenNow ? "üîí Frozen" : "üîì Learning");
            if (frozenNow) {
              const freezeEl = $("freezeStatusValue");
              if (freezeEl) freezeEl.style.color = "#ff6b6b";
            } else {
              const freezeEl = $("freezeStatusValue");
              if (freezeEl) freezeEl.style.color = "#00aa00";
            }
            window.__setT(
              "precisionValue",
              scan.tuner.useFloat32 ? "float32" : "float64",
            );

            // –û–±–Ω–æ–≤–ª—è–µ–º statusText –∏ loadingBar
            window.__setT("statusText", `–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è‚Ä¶ (f=${out.f.toFixed(1)} –ì—Ü)`);
            window.__setW("loadingBar", Math.max(0, Math.min(100, (out.conf || 0) * 100)));

            window.__setT(
              "info",
              `–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${out.state} | f=${out.f.toFixed(3)} –ì—Ü | ` +
                `–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: ${(out.inertia * 100).toFixed(0)}% | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(out.conf * 100).toFixed(0)}% | ` +
                `fs: ${s.actual_fs.toFixed(1)} –ì—Ü | N: ${s.dynamic_n} (hop=${scan.hop}) | ` +
                `kp=${scan.kp.toFixed(4)} kv=${scan.kv.toFixed(5)} ki=${scan.ki.toFixed(5)} | ` +
                `üß† H=${hVal} D=${scan.tuner.D} | –†–µ—Å—É—Ä—Å—ã: ${(resUse * 100).toFixed(0)}% | LR: ${scan.tuner.lr.toFixed(4)} | Quality: ${qualityPercent}%`,
            );
          }

          function emulateLoad(it) {
            let x = 1.0001;
            for (let i = 0; i < it; i++) {
              x *= 1.00000001;
              x /= 1.000000009;
            }
          }

          function loop() {
            try {
              const needCnt = scan.needCount();
              const avail = (s.widx - scan.r) & CpuJitterSampler.MASK;
              const need = avail < needCnt;

              if (need) {
                for (let i = 0; i < 180; i++) s.sample();
                if (!worker) emulateLoad(450);
                const fill = Math.min(
                  100,
                  (avail / Math.max(1, needCnt)) * 100,
                );
                setW("loadingBar", fill);
            window.__setT("statusText", `–ü–ª–∞–≤–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ‚Ä¶ (${fill.toFixed(0)}%)`);
                render(blender.hold());
                return setTimeout(loop, 80);
              }

              // === AUTO/Manual –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —à–∞–≥–æ–º ===
              const confPrev = scan.out_conf || 0;
              const inerPrev = scan.out_inertia || 0;
              const peakPrev = scan.out_peak || 0;
              const Jprev = scan.tuner.prevJ;

              // lr
              if (lrAuto && lrAuto.checked) {
                let trend = 0;
                if (Jprev != null && scan.tuner._lastJforAuto != null) {
                  trend = scan.tuner._lastJforAuto - Jprev;
                }
                scan.tuner._lastJforAuto = Jprev == null ? 0 : Jprev;
                const stability = Math.min(
                  1,
                  Math.max(0, 0.5 * confPrev + 0.5 * inerPrev),
                );
                const speedBias = trend > 0 ? 0.2 : trend < 0 ? -0.2 : 0;
                let lrAutoVal =
                  AUTO.lrMin +
                  (AUTO.lrMax - AUTO.lrMin) *
                    (0.65 * stability + 0.35 * Math.max(0, peakPrev / 2.0)) +
                  speedBias * (AUTO.lrMax - AUTO.lrMin) * 0.25;
                if (scan.tuner.locked)
                  lrAutoVal = Math.max(AUTO.lrMin, lrAutoVal * 0.3);
                lrAutoVal = Math.min(
                  AUTO.lrMax,
                  Math.max(AUTO.lrMin, lrAutoVal),
                );
                scan.tuner.lrBase = lrAutoVal;
                lrSlider.value = lrAutoVal.toFixed(3);
                lrVal.textContent = lrAutoVal.toFixed(3) + " (auto)";
              } else {
                scan.tuner.lrBase = parseFloat(lrSlider.value);
                lrVal.textContent = parseFloat(lrSlider.value).toFixed(3);
              }

              // l2
              if (l2Auto && l2Auto.checked) {
                const wnorm = weightsNorm2(scan.tuner);
                const poor = 1 - confPrev + (1 - inerPrev);
                let l2AutoVal =
                  AUTO.l2Min +
                  (AUTO.l2Max - AUTO.l2Min) *
                    (0.6 * poor + 0.4 * Math.min(1, wnorm / 0.8));
                if (scan.tuner.locked)
                  l2AutoVal = Math.min(AUTO.l2Max, l2AutoVal * 1.4);
                l2AutoVal = Math.min(
                  AUTO.l2Max,
                  Math.max(AUTO.l2Min, l2AutoVal),
                );
                scan.tuner.l2 = l2AutoVal;
                l2Slider.value = l2AutoVal.toFixed(4);
                l2Val.textContent = l2AutoVal.toFixed(4) + " (auto)";
              } else {
                scan.tuner.l2 = parseFloat(l2Slider.value);
                l2Val.textContent = parseFloat(l2Slider.value).toFixed(4);
              }

              // mix
              if (mixAuto && mixAuto.checked) {
                const stability = Math.min(
                  1,
                  Math.max(0, 0.5 * confPrev + 0.5 * inerPrev),
                );
                let mixAutoVal = 0.3 + (0.95 - 0.3) * stability;
                if (scan.tuner.locked)
                  mixAutoVal = Math.max(0.3, mixAutoVal * 0.6);
                mixAutoVal = Math.min(0.95, Math.max(0.3, mixAutoVal));
                scan.tuner.mix = mixAutoVal;
                mixSlider.value = mixAutoVal.toFixed(2);
                mixVal.textContent = mixAutoVal.toFixed(2) + " (auto)";
              } else {
                scan.tuner.mix = parseFloat(mixSlider.value);
                mixVal.textContent = parseFloat(mixSlider.value).toFixed(2);
              }

              // –û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥
              scan.processOnce();

              // ===== –ö–û–ù–¢–†–û–õ–¨ –†–ï–°–£–†–°–û–í =====
              scan.tuner.checkMemoryAndAdapt();

              // –∞–≤—Ç–æ-–Ω–∞–≥—Ä—É–∑–∫–∞ CPU –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–π —á–∞—Å—Ç–æ—Ç—ã —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è
              const peak = scan.out_peak || 0;
              if (worker) {
                const base = 700;
                const extra = Math.max(
                  0,
                  Math.min(
                    8000,
                    Math.round((1.0 - Math.min(1, peak / 1.2)) * 6000),
                  ),
                );
                worker.postMessage({ it: base + extra, dt: 12 });
              }

              if (s.actual_fs < 45)
            window.__setT(
                  "statusText",
                  "–ù–∏–∑–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è (<45 –ì—Ü). –î–æ–±–∞–≤—å—Ç–µ –ª—ë–≥–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
                );
              else setT("statusText", "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è‚Ä¶ (neuro-homeostasis J‚Üí0)");

              render(
                blender.blend({
                  f: scan.out_f,
                  conf: scan.out_conf,
                  inertia: scan.out_inertia,
                  state: scan.out_state,
                }),
              );
              setTimeout(loop, 160);
            } catch (e) {
            window.__setT(
                "info",
                `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.`,
              );
              console.error(e);
              setTimeout(loop, 700);
            }
          }
          // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è: –æ–Ω –º–µ—à–∞–ª –æ–∂–∏–¥–∞–Ω–∏—é –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ ¬´–°—Ç–∞—Ä—Ç¬ª.
          // –¢–µ–ø–µ—Ä—å –µ–≥–æ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ñ–ª–∞–π–Ω-–¥–µ–º–æ).
          window.__legacyEngine = {
            start() {
              try {
                loop();
              } catch (e) {
                console.error(e);
              }
            },
          };
        })();
      });

      // Lazy initialization of heavy runtime parts (chat, counters, global services)
      window.__appInitialized = false;
      async function initializeRuntime() {
        if (window.__appInitialized) return;
        console.log("[INIT] initializeRuntime: starting heavy services...");
        try {
          // Create multiUserChat and start its background jobs
          multiUserChat = new MultiUserChatSystem();
          console.log("[INIT] multiUserChat created");

          // allow multiUserChat to render and then start counters/updates
          setTimeout(() => {
            try {
              if (multiUserChat && multiUserChat.showActiveUsers)
                multiUserChat.showActiveUsers();
              if (multiUserChat && multiUserChat.forceUpdateGlobalCounter)
                multiUserChat.forceUpdateGlobalCounter();
              else if (multiUserChat && multiUserChat.updateVisitorCounter)
                multiUserChat.updateVisitorCounter();
              else if (multiUserChat && multiUserChat.updateOnlineCounter)
                multiUserChat.updateOnlineCounter();
            } catch (_) {
              /* ignore */
            }
          }, 600);

          // storage sync listener
          window.addEventListener("storage", (e) => {
            try {
              if (
                multiUserChat &&
                e.key === multiUserChat.sharedKey &&
                e.newValue
              )
                multiUserChat.checkForUpdates();
            } catch (_) {}
          });

          window.__appInitialized = true;
          console.log("[INIT] initializeRuntime: completed");
        } catch (err) {
          console.error("[INIT] initializeRuntime failed", err);
        }
      }

      async function ensureRuntimeInitialized() {
        if (!window.__appInitialized) await initializeRuntime();
      }
    </script>

    <!-- –í–∏–¥–∂–µ—Ç —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div
      class="page-counter-widget"
      id="pageCounterWidget"
      onclick="multiUserChat.showPageStats()"
    >
      <div class="counter-row">
        <span>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:</span>
        <span class="counter-number" id="pageViewsCount">0</span>
      </div>
      <div class="counter-row">
        <span>üë§ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö:</span>
        <span class="counter-number" id="uniqueVisitorsCount">0</span>
      </div>
      <div
        style="font-size: 10px; opacity: 0.8; margin-top: 3px"
        id="lastUpdateTime"
      >
        –û–±–Ω–æ–≤–ª–µ–Ω–æ: –∑–∞–≥—Ä—É–∑–∫–∞...
      </div>
    </div>

    <!-- –í–∏–¥–∂–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="global-stats-widget" id="globalStatsWidget">
      <div style="display: flex; align-items: center; margin-bottom: 5px">
        <div class="global-stats-indicator"></div>
        <strong>üåç –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
      </div>

      <div style="font-size: 10px; margin-bottom: 5px">
        üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É API...
      </div>

      <div class="world-map-mini">üåê –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...</div>

      <div style="font-size: 9px; opacity: 0.8; margin-top: 3px">
        –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
      </div>
    </div>

    <!-- NEURO OVERLAY (Hidden by default) -->
    <div id="neuroOverlay" class="neuro-overlay" aria-hidden="true">
      <div class="neuro-scene">
        <svg
          class="neuro-svg"
          viewBox="0 0 800 600"
          role="img"
          aria-label="Neural rainbow"
        >
          <defs>
            <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#ff0040" />
              <stop offset="20%" stop-color="#ff7a00" />
              <stop offset="40%" stop-color="#ffee00" />
              <stop offset="60%" stop-color="#00d084" />
              <stop offset="80%" stop-color="#007cff" />
              <stop offset="100%" stop-color="#a100ff" />
            </linearGradient>
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="b" />
              <feMerge>
                <feMergeNode in="b" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>
          <!-- Curved neural paths -->
          <path
            class="neuro-path"
            d="M50,500 C180,350 260,420 380,300 C500,180 620,260 760,120"
          />
          <path
            class="neuro-path"
            d="M60,120 C240,240 300,180 420,300 C540,420 620,360 740,500"
          />
          <path
            class="neuro-path"
            d="M100,300 C220,220 300,340 400,260 C540,160 620,220 720,200"
          />
          <!-- Nodes -->
          <circle class="neuro-node" cx="120" cy="420" r="8" />
          <circle class="neuro-node" cx="220" cy="360" r="7" />
          <circle class="neuro-node" cx="320" cy="300" r="9" />
          <circle class="neuro-node" cx="420" cy="240" r="7" />
          <circle class="neuro-node" cx="520" cy="200" r="8" />
          <circle class="neuro-node" cx="640" cy="180" r="7" />
        </svg>
        <div class="buff-wave"></div>
      </div>
    </div>
  </body>
</html>
