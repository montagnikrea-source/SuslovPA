<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frequency Scanner Web App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        canvas { max-width: 100%; }
        #info { margin-top: 20px; font-size: 16px; }
    </style>
</head>
<body>
    <canvas id="freqChart"></canvas>
    <div id="info"></div>
    <script>
        // Безопасный fallback для работы вне клиента Telegram
        const TG = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : (function(){
            console.warn('Telegram.WebApp not available — running in standalone mode');
            return {
                ready: () => { /* noop */ },
                expand: () => { /* noop */ },
                isExpanded: true,
                sendData: (d) => { console.log('WebApp.sendData', d); alert('sendData: ' + d); },
                onEvent: (evt, cb) => { /* noop */ }
            };
        })();

        // Автозапуск: при загрузке DOM — инициализировать TG, попытаться развернуть WebApp и стартануть цикл
        function startApp() {
            try {
                TG.ready();
                // В Telegram попытаемся развернуть WebApp для видимости
                if (typeof TG.expand === 'function') {
                    try { TG.expand(); } catch (e) { /* ignore */ }
                }
            } catch (e) {
                console.warn('TG init failed', e);
            }
            // Запуск основного цикла графика/сканера
            try { updateChart(); } catch (e) { console.error(e); }
        }

        // Если DOM уже загружен — стартуем сразу, иначе — по событию
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startApp, { once: true });
        } else {
            startApp();
        }

        // Обработчик изменения viewport (безопасно через TG)
        if (typeof TG.onEvent === 'function') {
            TG.onEvent('viewportChanged', () => {
                if (!TG.isExpanded) {
                    running = false;
                }
            });
        }
    </script>
</body>
</html>